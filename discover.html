<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MatesInvest ‚Äì Investment Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --navy: #002040;
        --cyan: #00bfff;
        --bg: #f5f7fb;
        --card: #ffffff;
        --muted: #64748b;
        --muted-2: #94a3b8;
        --accent: var(--cyan);
        --accent-strong: #0093cc;
        --accent-soft: rgba(0, 191, 255, 0.1);
        --border: #e2e8f0;
        --card-border: #e2e8f0;
        --glass: rgba(255, 255, 255, 0.92);
        --radius: 18px;
        --gap: 1rem;
        --slip-share-btn-height: 72px;
      }
      /* ---------- HOME-STYLE TOP NAV (matches styles.css) ---------- */
.container {
  max-width: 1240px;
  margin: 0 auto;
  padding: 0 1.25rem;
}

header.nav {
  position: sticky;
  top: 0;
  z-index: 50;
  background: #fff;
  border-bottom: 1px solid #eef1f6;
}

.nav-inner {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 64px;
}

.brand {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
  color: var(--navy);
}

.brand .logo {
  height: 28px;
}

header.nav nav {
  display: flex;
  align-items: center;
}

header.nav nav a {
  margin: 0 10px;
  color: #0b1220;
  text-decoration: none;
  font-weight: 600;
}

.menu-btn {
  display: none;
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
}

/* Mobile menu behaviour (matches styles.css) */
@media (max-width: 768px) {
  .menu-btn {
    display: block;
  }

  header.nav nav {
    display: none;
  }

  body.nav-open header.nav nav {
    display: flex;
    flex-direction: column;
    position: absolute;
    left: 0.75rem;
    right: 0.75rem;
    top: 56px;
    background: #ffffff;
    border-radius: 16px;
    padding: 0.75rem 1rem;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.20);
    gap: 0.5rem;
    z-index: 1000;
  }

  body.nav-open header.nav nav a {
    padding: 0.4rem 0;
    text-align: left;
    margin: 0;
  }

  body.nav-open header.nav nav .btn {
    width: 100%;
    text-align: center;
    margin-top: 0.25rem;
  }
}

/* Give your page wrapper some spacing now that nav is above it */
.page {
  padding-top: 1.1rem;
}


      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        max-width: 100%;
  overflow-x: auto;   /* allow table scrollbar */
        font-family: Inter, system-ui, -apple-system, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #dbeafe 0, #f5f7fb 55%);
        color: var(--navy);
      }

      .page {
        max-width: 1240px;
        margin: 0 auto;
        padding: 1.5rem 2rem 2.5rem;
      }

      /* ---------- TOP NAV ---------- */

      .top-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.25rem;
      }

      .nav-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-logo {
        display: flex;
        align-items: center;
        gap: 0.45rem;
        text-decoration: none;
        color: inherit;
      }

      .nav-logo-img {
        height: 32px;
        width: auto;
        display: block;
      }

      .nav-logo-text {
        font-weight: 700;
        letter-spacing: -0.02em;
        font-size: 1rem;
      }

      .nav-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-link {
        font-size: 0.85rem;
        text-decoration: none;
        color: var(--navy);
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
        border: 1px solid transparent;
      }

      .nav-link:hover {
        background: rgba(15, 23, 42, 0.02);
      }

      header {
        margin-bottom: 1rem;
      }

      h1 {
        margin: 1rem auto;
        padding: 0 1.5rem;
        text-align: center;
        font-size: 1.8rem;
        letter-spacing: -0.02em;
      }

      .muted {
        color: var(--muted);
        font-size: 0.9rem;
        padding: 0 1.5rem;
        text-align: center;
      }

      /* ---------- FILTER CARD (COLLAPSIBLE) ---------- */

      .filters-card {
        background: var(--glass);
        border-radius: var(--radius);
        border: 1px solid var(--card-border);
        box-shadow: 0 10px 26px rgba(15, 23, 42, 0.09);
        padding: 0.4rem 0.75rem 0.45rem;
        margin-bottom: 0.9rem;
      }

      .filters-toggle {
        all: unset;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        cursor: pointer;
      }

      .filters-toggle-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 0;
      }

      .filters-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.72rem;
        padding: 0.15rem 0.6rem;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--navy);
        font-weight: 500;
        flex-shrink: 0;
      }

      .filters-chip-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: var(--accent-strong);
      }

      .filters-caption {
        font-size: 0.75rem;
        color: var(--muted-2);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .filters-toggle-icon {
        font-size: 0.9rem;
        color: var(--muted-2);
        margin-left: 0.5rem;
        transition: transform 0.18s ease;
      }

      .filters-card.open .filters-toggle-icon {
        transform: rotate(180deg);
      }

      .filters-body {
        display: none;
        margin-top: 0.45rem;
      }

      .filters-card.open .filters-body {
        display: block;
      }

      .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 0.6rem;
        align-items: flex-end;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
      }

      .filter-label {
        font-size: 0.72rem;
        color: var(--muted-2);
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      input,
      select {
        font: inherit;
        padding: 0.28rem 0.55rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        outline: none;
        background: #f8fafc;
        font-size: 0.82rem;
        width: 100%;
      }

      input::placeholder {
        color: #cbd5f5;
      }

      input:focus,
      select:focus {
        border-color: var(--accent);
        background: #ffffff;
        box-shadow: 0 0 0 1px rgba(0, 191, 255, 0.08);
      }

      /* ---------- NEW: Thinking-style preset buttons ---------- */

      .preset-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
        align-items: center;
        margin: 0.55rem 0 0.55rem;
        padding: 0.55rem 0.55rem 0.6rem;
        border-radius: 16px;
        border: 1px solid rgba(0, 32, 64, 0.08);
        background: rgba(255, 255, 255, 0.75);
      }

      .preset-title {
        font-size: 0.78rem;
        color: var(--muted);
        margin-right: 0.25rem;
        white-space: nowrap;
      }

      .preset-btn {
        border: 1px solid rgba(0, 32, 64, 0.12);
        background: rgba(255, 255, 255, 0.9);
        color: #0b1220;
        border-radius: 999px;
        padding: 0.42rem 0.7rem;
        font-size: 0.82rem;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
        transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
      }

      .preset-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 22px rgba(15, 23, 42, 0.1);
        background: #ffffff;
      }

      .preset-btn:active {
        transform: translateY(0px);
      }

      .preset-btn.active {
        border-color: rgba(0, 191, 255, 0.55);
        background: rgba(0, 191, 255, 0.12);
      }

      .preset-btn.secondary {
        font-weight: 600;
        background: rgba(15, 23, 42, 0.04);
      }

      .preset-hint {
        width: 100%;
        font-size: 0.78rem;
        color: var(--muted);
        margin-top: 0.2rem;
      }
/* ---------- TABLE / LAYOUT ---------- */

.table-wrapper {
  background: var(--glass);
  border-radius: var(--radius);
  border: 1px solid var(--card-border);
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
  overflow: visible;              /* IMPORTANT: allow scroll container to work */
  min-width: 0;                   /* Flexbox safety */
}

.table-scroll {
  width: 100%;
  max-height: calc(100vh - 260px);
  overflow-x: auto;               /* DESKTOP scrollbar */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  position: relative;
}

/* Force horizontal overflow so scrollbar appears */
.table-scroll table {
  width: max-content;             /* let columns define width */
  min-width: 2200px;              /* hard floor for current column count */
  border-collapse: collapse;
  font-size: 0.84rem;
}

thead {
  background: #f1f5f9;
}

thead th {
  position: sticky;
  top: 0;
  z-index: 3;
  background: #f1f5f9;
}

th,
td {
  padding: 0.5rem 0.6rem;
  text-align: right;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}

th:first-child,
td:first-child {
  text-align: left;
}

th:nth-child(2),
td:nth-child(2),
th:nth-child(3),
td:nth-child(3) {
  text-align: left;
}

th.sortable {
  cursor: pointer;
  user-select: none;
  font-weight: 500;
  font-size: 0.8rem;
  color: #0b1220;
}

th.sortable span {
  margin-left: 0.25rem;
  font-size: 0.65rem;
  opacity: 0.6;
}

tbody tr:nth-child(even) {
  background: #f8fafc;
}
/* ---------- Status bar (bottom of table) ---------- */
.status-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-top: 1px solid rgba(0, 32, 64, 0.08);
  color: var(--muted);
  font-size: 12px;
  background: rgba(255, 255, 255, 0.55);
  border-bottom-left-radius: var(--radius);
  border-bottom-right-radius: var(--radius);
}

.status-bar #statusCount {
  font-weight: 650;
  color: #0b1220;
}

.status-bar #statusMeta {
  white-space: nowrap;
  opacity: 0.9;
}

@media (max-width: 640px) {
  .status-bar {
    padding: 8px 10px;
    font-size: 11px;
  }
}

      /* ---------- STICKY FIRST COLUMN (CODE) ---------- */

      th.sticky-col {
        position: sticky;
        top: 0;
        left: 0;
        z-index: 4;
        background: #f1f5f9;
      }

      td.sticky-col {
        position: sticky;
        left: 0;
        z-index: 2;
        background: #ffffff;
      }

      tbody tr:nth-child(even) td.sticky-col {
        background: #f8fafc;
      }

      /* ---------- MOBILE TWEAKS ---------- */

      @media (max-width: 768px) {
        .page {
          padding-inline: 0.85rem;
        }

        th,
        td {
          padding: 0.45rem 0.4rem;
        }

        h1 {
          font-size: 1.5rem;
        }

        .filters-card {
          padding-inline: 0.55rem;
        }
      }

      @media (max-width: 640px) {
        .filters {
          grid-template-columns: 1fr;
        }

        .filters-caption {
          display: none;
        }

        .preset-title {
          width: 100%;
        }
      }

      /* ---------- LANDSCAPE / SHORT-HEIGHT PHONE FIX ---------- */
@media screen and (max-height: 500px) {
        
        /* Hide Market Pulse cards to save vertical space in landscape */
        .mp-wrap {
          display: none;
        }

        /* Reduce page padding */
        .page {
          padding-top: 0.5rem;
          padding-bottom: 1rem;
        }

        header {
          margin-bottom: 0.35rem;
        }

        h1 {
          font-size: 1.3rem;
          margin-bottom: 0.1rem;
        }

        .muted {
          font-size: 0.75rem;
        }

        .filters-card {
          padding: 0.3rem 0.6rem 0.4rem;
          margin-bottom: 0.4rem;
        }

        /* Maximize table height for landscape viewing
           Subtract: sticky nav (~60px) + page header (~50px) + filters (~40px) + 
           status bar (~40px) + spacing/padding (~40px) = ~230px total */
        .table-scroll {
          max-height: calc(100vh - 230px);
          min-height: 250px;
        }

        /* Make table more compact in landscape */
        th, td {
          padding: 0.35rem 0.4rem;
          font-size: 0.78rem;
        }

        th.sortable {
          font-size: 0.72rem;
        }
      }

      /* ---------- Instrument modal ---------- */

      .mi-ins-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .mi-ins-modal {
        background: #0b1020;
        color: #f9fafb;
        border-radius: 18px;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        width: 100%;
        padding: 20px 22px 22px;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
        border: 1px solid rgba(148, 163, 184, 0.25);
        position: relative;
      }

      .mi-ins-header {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 14px;
        position: sticky;
        top: 0;
        background: #0b1020;
        z-index: 50;
        padding-bottom: 8px;
        padding-top: 6px;
      }

      .mi-ins-title {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
      }

      .mi-ins-subtitle {
        margin-top: 4px;
        font-size: 13px;
        color: #9ca3af;
      }

      .mi-ins-price-block {
        text-align: right;
      }

      .mi-ins-price {
        font-size: 20px;
        font-weight: 600;
      }

      .mi-ins-change {
        font-size: 13px;
        margin-top: 2px;
      }

      .mi-ins-change.up {
        color: #4ade80;
      }

      .mi-ins-change.down {
        color: #f97373;
      }

      .mi-ins-date {
        font-size: 11px;
        color: #6b7280;
        margin-top: 3px;
      }

      .mi-ins-close {
        position: absolute;
        top: 8px;
        right: 12px;
        font-size: 20px;
        color: #9ca3af;
        background: transparent;
        border: none;
        cursor: pointer;
        z-index: 200;
      }

      .mi-ins-close:hover {
        color: #e5e7eb;
      }

      .mi-ins-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 16px;
      }

      .mi-ins-tag {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(31, 41, 55, 0.85);
        color: #e5e7eb;
        border: 1px solid rgba(55, 65, 81, 0.9);
      }

      .mi-ins-section {
        margin-bottom: 14px;
      }

      .mi-ins-section-title {
        font-size: 13px;
        font-weight: 600;
        margin: 0 0 8px;
        color: #d1d5db;
      }

      .mi-ins-stats-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px 16px;
      }

      .mi-ins-stat-item {
        font-size: 12px;
      }

      .mi-ins-stat-label {
        color: #9ca3af;
        display: block;
        margin-bottom: 2px;
      }

      .mi-ins-stat-value {
        font-weight: 500;
      }

      .mi-ins-history-summary {
        font-size: 12px;
        color: #9ca3af;
        margin-bottom: 6px;
      }

      #mi-ins-chart {
        width: 100%;
        height: 220px;
        margin-top: 10px;
        background: rgba(15, 23, 42, 0.7);
        border-radius: 12px;
      }

      .mi-ins-ai-summary {
        font-size: 0.9rem;
        color: #e5e7eb;
        background: rgba(15, 23, 42, 0.65);
        border-radius: 12px;
        padding: 10px 12px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        line-height: 1.4;
      }

      .mi-ins-news-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 0.82rem;
      }

      .mi-ins-news-item {
        padding: 8px 9px;
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.6);
      }

      .mi-ins-news-item-title {
        font-weight: 500;
        margin-bottom: 2px;
      }

      .mi-ins-news-item-meta {
        font-size: 0.75rem;
        color: #9ca3af;
      }

      .mi-ins-news-item a {
        color: #38bdf8;
        text-decoration: none;
        font-size: 0.8rem;
      }

      .mi-ins-news-item a:hover {
        text-decoration: underline;
      }

      @media (max-width: 640px) {
        .mi-ins-modal {
          margin: 10px;
          padding: 16px 14px 18px;
        }

        .mi-ins-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .mi-ins-price-block {
          text-align: left;
        }

        .mi-ins-stats-grid {
          grid-template-columns: 1fr;
        }
      }

      .mi-ins-details-btn {
        margin: 0.6rem 0 0.4rem;
        width: 100%;
        padding: 10px 14px;
        border-radius: 999px;
        background: #38bdf8;
        color: #001220;
        font-size: 14px;
        font-weight: 600;
        border: none;
        cursor: pointer;
      }

      .mi-ins-details-btn:hover {
        background: #0ea5e9;
      }
      /* ---------- Market Pulse cards (embedded on screener) ---------- */
.mp-wrap {
  background: var(--glass);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  box-shadow: 0 10px 26px rgba(15, 23, 42, 0.09);
  padding: 0.9rem 0.95rem;
  margin-bottom: 0.9rem;
}

.mp-date-header {
  text-align: center;
  margin-bottom: 0.75rem;
  font-size: 0.85rem;
  color: var(--muted);
  font-weight: 600;
  letter-spacing: 0.02em;
}

.mp-head {
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}

.mp-title {
  font-weight: 750;
  letter-spacing: -0.02em;
  font-size: 1.05rem;
}

.mp-meta {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  justify-content: flex-end;
}

.mp-pill {
  display: inline-flex;
  padding: 0.35rem 0.7rem;
  border-radius: 999px;
  border: 1px solid rgba(0, 32, 64, 0.12);
  background: rgba(255, 255, 255, 0.85);
  font-size: 0.85rem;
}

.mp-pill.muted {
  color: var(--muted);
}

.mp-grid {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 0.75rem;
}

.mp-card {
  background: #fff;
  border: 1px solid rgba(0, 32, 64, 0.10);
  border-radius: 16px;
  padding: 0.75rem 0.8rem;
}

.mp-label {
  font-size: 0.72rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted-2);
  font-weight: 650;
}

.mp-value {
  margin-top: 0.35rem;
  font-size: 1.55rem;
  font-weight: 800;
  letter-spacing: -0.02em;
}

.mp-sub {
  margin-top: 0.25rem;
  font-size: 0.82rem;
  color: var(--muted);
}

.mp-spark {
  margin-top: 0.5rem;
  height: 8px;
  background: rgba(15, 23, 42, 0.06);
  border-radius: 999px;
  overflow: hidden;
}
.mp-spark span {
  display: block;
  height: 100%;
  width: 50%;
  background: rgba(0, 191, 255, 0.55);
}

.mp-movers {
  margin-top: 0.75rem;
}
.mp-movers-summary {
  list-style: none;
  cursor: pointer;
  font-weight: 750;
  color: #0f172a;
  margin: 0.25rem 0 0.6rem;
}
.mp-movers-summary::-webkit-details-marker { display: none; }

.mp-movers-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.75rem;
}

.mp-mini {
  background: rgba(255,255,255,0.9);
  border: 1px solid rgba(0, 32, 64, 0.10);
  border-radius: 16px;
  padding: 0.75rem 0.8rem;
}
.mp-mini h3 {
  margin: 0 0 0.5rem;
  font-size: 0.95rem;
}
.mp-mini ul { list-style: none; padding: 0; margin: 0; }
.mp-mini li { padding: 0.35rem 0; border-bottom: 1px solid rgba(0,0,0,0.04); }
.mp-mini li:last-child { border-bottom: none; }

/* Movers row (ticker + name 1-line + pct) */
.mover-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
.mover-left { min-width: 0; }
.mover-code { font-weight: 800; font-size: 0.9rem; line-height: 1.1; }
.mover-name {
  font-size: 0.78rem;
  color: var(--muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

.pct.up { color: #16a34a; font-weight: 700; }
.pct.down { color: #dc2626; font-weight: 700; }

/* Mobile */
@media (max-width: 640px) {
  .mp-grid { grid-template-columns: 1fr 1fr; gap: 0.6rem; }
  .mp-value { font-size: 1.25rem; }
  #mpAD { white-space: nowrap; } /* keep Adv/Dec on one line */
  .mp-movers-grid { grid-template-columns: 1fr; }
}
      /* ======================================================
   EQUITY SCREENER ‚Äì MOBILE CLEANUP & SPACING OVERRIDES
   (Page-local only ‚Äì does NOT touch styles.css)
   ====================================================== */

/* Reduce visual density on mobile */
@media (max-width: 768px) {

  /* Page padding ‚Äì breathe again */
  .page {
    padding: 1rem 0.85rem 2rem;
  }

  /* Market Pulse cards */
  .mp-wrap {
    padding: 0.8rem;
  }

  .mp-date-header {
    font-size: 0.78rem;
    margin-bottom: 0.65rem;
  }

  .mp-grid {
    grid-template-columns: 1fr 1fr;
    gap: 0.6rem;
  }

  .mp-card {
    padding: 0.6rem 0.65rem;
  }

  .mp-label {
    font-size: 0.65rem;
    letter-spacing: 0.08em;
  }

  .mp-value {
    font-size: 1.2rem; /* ‚Üì was too big */
  }

  .mp-sub {
    font-size: 0.75rem;
  }

  /* Force Adv / Dec onto one line */
  #mpAD {
    white-space: nowrap;
    font-size: 1.15rem;
  }

  /* Filters card spacing */
  .filters-card {
    padding: 0.45rem 0.6rem;
  }

  .filters-chip {
    font-size: 0.7rem;
  }

  /* Table wrapper spacing */
  .table-wrapper {
    margin-top: 0.75rem;
  }

  /* Table text slightly smaller */
  table {
    font-size: 0.8rem;
  }

  th.sortable {
    font-size: 0.75rem;
  }

  td {
    font-size: 0.8rem;
  }
}

/* ======================================================
   TOP MOVERS ‚Äì single heading + one-line names
   ====================================================== */

/* Prevent duplicate-looking headings */
.mp-movers-summary {
  font-size: 1rem;
  font-weight: 700;
  margin: 0.5rem 0 0.6rem;
}

/* Each mover row */
.mover-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

/* Left side (code + name) */
.mover-left {
  min-width: 0;
}

/* Code */
.mover-code {
  font-size: 0.85rem;
  font-weight: 800;
  line-height: 1.1;
}

/* Company name ‚Äì FORCE single line */
.mover-name {
  font-size: 0.75rem;
  color: var(--muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* Percentage */
.pct {
  font-size: 0.8rem;
  font-weight: 700;
}

/* ======================================================
   NAV MENU ‚Äì stop it squishing content visually
   ====================================================== */

/* ======================================================
   SECTOR CHART ‚Äì consistent with asx-dashboard.html
   ====================================================== */

.sector-chart-wrap {
  background: var(--glass);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  box-shadow: 0 10px 26px rgba(15, 23, 42, 0.09);
  padding: 0.9rem 0.95rem;
  margin-bottom: 0.9rem;
}

.sector-chart-card {
  background: var(--card);
  border-radius: 16px;
}

.sector-chart-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
}

.sector-chart-title {
  font-weight: 750;
  letter-spacing: -0.02em;
  font-size: 1.05rem;
  margin: 0;
}

.mi-toggle {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
  justify-content: flex-end;
}

.mi-toggle button {
  appearance: none;
  border: 1px solid rgba(148, 163, 184, 0.55);
  background: #fff;
  color: #0f172a;
  font-size: 0.85rem;
  padding: 6px 10px;
  border-radius: 999px;
  cursor: pointer;
  transition: transform 0.05s ease, background 0.15s ease, border-color 0.15s ease;
}

.mi-toggle button:hover {
  transform: translateY(-1px);
}

.mi-toggle button.active {
  background: #e7f7ff;
  border-color: #c5e5ff;
  color: #083a59;
  font-weight: 600;
}

.sector-chart-content {
  position: relative;
}

.mi-chart-wrap {
  position: relative;
  height: 320px;
  padding: 10px 4px 2px;
  cursor: pointer;
}

.mi-chart-msg {
  display: none;
  padding: 14px 14px;
  border-radius: 12px;
  background: rgba(241, 245, 249, 0.8);
  border: 1px solid rgba(203, 213, 225, 0.65);
  color: var(--muted, #64748b);
  font-size: 0.95rem;
  line-height: 1.4;
}

.mi-chart-subtle {
  color: var(--muted, #64748b);
  font-size: 0.9rem;
  margin-top: 8px;
}

/* Mobile adjustments for sector chart */
@media (max-width: 768px) {
  .sector-chart-wrap {
    padding: 0.8rem;
  }

  .sector-chart-title {
    font-size: 0.95rem;
  }

  .mi-toggle {
    gap: 6px;
  }

  .mi-toggle button {
    padding: 6px 10px;
    font-size: 12px;
  }

  .mi-chart-wrap {
    height: 240px;
    padding: 6px 0 0;
  }

  .mi-chart-subtle {
    font-size: 12px;
    margin-top: 6px;
  }
}

/* Landscape mobile: ensure chart is scrollable */
@media screen and (max-height: 500px),
  screen and (orientation: landscape) and (max-width: 1024px) {
  
  .sector-chart-wrap {
    margin-bottom: 0.6rem;
    padding: 0.6rem;
  }

  .mi-chart-wrap {
    height: 200px;
    padding: 4px 0 0;
  }

  .sector-chart-title {
    font-size: 0.9rem;
  }

  .mi-toggle button {
    font-size: 11px;
    padding: 5px 8px;
  }
}
/* ================================
   Across Markets (slim strip)
   ================================ */
.across-markets{
  margin: 12px 0 12px;
  padding: 10px 12px;
  border: 1px solid rgba(148,163,184,.35);
  background: rgba(255,255,255,.9);
  border-radius: 14px;
  box-shadow: 0 10px 26px rgba(15, 23, 42, 0.06);
}

.across-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:8px;
}

.across-title{
  font-size: 12px;
  font-weight: 700;
  color:#0f172a;
  letter-spacing:.2px;
}

.across-meta{
  font-size: 11px;
  color:#64748b;
  white-space:nowrap;
}

.across-scroll{
  display:flex;
  gap:8px;
  overflow-x:auto;
  padding-bottom:2px;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none; /* Firefox */
}
.across-scroll::-webkit-scrollbar{ display:none; }

.across-chip{
  flex: 0 0 auto;
  display:flex;
  align-items:center;
  gap:10px;
  padding: 8px 10px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,.35);
  background: #ffffff;
  transition: transform .12s ease, box-shadow .12s ease;
}

.across-chip:hover{
  transform: translateY(-1px);
  box-shadow: 0 10px 18px rgba(15,23,42,.08);
}

.across-chip .k{
  display:flex;
  flex-direction:column;
  line-height:1.05;
}

.across-chip .sym{
  font-size: 11px;
  font-weight: 800;
  color:#0f172a;
}

.across-chip .lbl{
  font-size: 10px;
  color:#64748b;
}

.across-chip .v{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  line-height:1.05;
}

.across-chip .px{
  font-size: 12px;
  font-weight: 800;
  color:#0f172a;
  white-space:nowrap;
}

.across-chip .chg{
  font-size: 10px;
  font-weight: 800;
  white-space:nowrap;
}

.chg.pos{ color:#16a34a; }
.chg.neg{ color:#ef4444; }
.chg.neu{ color:#64748b; }
/* ---------- Invest Slip ---------- */
.mi-ins-slip-btn{
  margin: 0.4rem 0 0.35rem;
  width: 100%;
  padding: 10px 14px;
  border-radius: 999px;
  background: rgba(56,189,248,0.15);
  color: #e5e7eb;
  font-size: 14px;
  font-weight: 700;
  border: 1px solid rgba(56,189,248,0.45);
  cursor: pointer;
}
.mi-ins-slip-btn:hover{
  background: rgba(56,189,248,0.22);
}

.mi-slip-overlay{
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.70);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.mi-slip-modal{
  width: 100%;
  max-width: 560px;
  margin: 12px;
  background: radial-gradient(1200px 600px at 50% -200px, rgba(56,189,248,0.14), rgba(5,8,18,0) 60%),
              #050812;
  border: 1px solid rgba(148,163,184,0.25);
  border-radius: 20px;
  padding: 16px 16px 14px;
  color: #f9fafb;
  box-shadow: 0 18px 40px rgba(0,0,0,0.45);
  position: relative;
}

.mi-slip-close{
  position:absolute;
  top: 10px;
  right: 12px;
  font-size: 18px;
  color: #9ca3af;
  background: transparent;
  border: none;
  cursor: pointer;
}
.mi-slip-close:hover{ color:#e5e7eb; }

.mi-slip-top{
  display:flex;
  justify-content: space-between;
  align-items:center;
  gap: 10px;
  margin-bottom: 10px;
}
.mi-slip-badge{
  font-size: 12px;
  font-weight: 900;
  letter-spacing: 0.12em;
  color:#a5d8ff;
  text-shadow: 0 0 18px rgba(56,189,248,0.25);
}
.mi-slip-pill{
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.35);
  background: rgba(15,23,42,0.55);
  color:#e5e7eb;
  font-weight: 800;
}

.mi-slip-hero{
  text-align:center;
  margin-top: 2px;
}
.mi-slip-code{
  font-size: 28px;
  font-weight: 900;
  letter-spacing: -0.02em;
}
.mi-slip-name{
  font-size: 13px;
  color: #cbd5e1;
  margin-top: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.mi-slip-sub{
  font-size: 12px;
  color:#94a3b8;
  margin-top: 4px;
}

.mi-slip-price-row{
  display:flex;
  justify-content: center;
  align-items: baseline;
  gap: 10px;
  margin-top: 10px;
}
.mi-slip-price{ font-size: 18px; font-weight: 900; }
.mi-slip-chg{
  font-size: 13px;
  font-weight: 900;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(148,163,184,0.28);
  background: rgba(15,23,42,0.45);
}

.mi-slip-chart-wrap{
  margin-top: 12px;
  padding: 10px 10px 6px;
  border-radius: 14px;
  background: rgba(15,23,42,0.55);
  border: 1px solid rgba(148,163,184,0.22);
}
#mi-slip-chart{ width: 100%; height: 160px; display:block; }
.mi-slip-chart-meta{
  margin-top: 6px;
  font-size: 11px;
  color:#9ca3af;
  text-align: right;
}
      .mi-slip-chart-wrap{
  background: linear-gradient(
    to bottom,
    rgba(15,23,42,0.65),
    rgba(15,23,42,0.35)
  );
}


.mi-slip-section{ margin-top: 12px; }
.mi-slip-section-title{
  font-size: 12px;
  color:#d1d5db;
  font-weight: 800;
  margin-bottom: 8px;
}
.mi-slip-bullets{
  margin: 0;
  padding-left: 18px;
  color:#e5e7eb;
  font-size: 13px;
  line-height: 1.35;
}
.mi-slip-bullets li{ margin: 6px 0; }

.mi-slip-fundamentals{
  margin-top: 12px;
}
.mi-slip-fundamentals-grid{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.mi-slip-fund-col{
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.mi-slip-fund-item{
  font-size: 12px;
}
.mi-slip-fund-label{
  color: #9ca3af;
  display: block;
  margin-bottom: 2px;
  font-size: 11px;
}
.mi-slip-fund-value{
  font-weight: 700;
  color: #e5e7eb;
}

.mi-slip-overlay{
  position: fixed;
  inset: 0;
  background: #050812;           /* no dim background */
  display: none;
  z-index: 10000;
}

/* full page */
.mi-slip-modal{
  width: 100vw;
  height: 100vh;
  max-width: none;
  margin: 0;
  border-radius: 0;
  border: none;
  box-shadow: none;
  padding: 16px;
  overflow-y: auto;

  /* respect iOS safe areas */
  padding-top: calc(16px + env(safe-area-inset-top));
  padding-bottom: calc(16px + env(safe-area-inset-bottom));
}

/* optional: keep content nicely centred on desktop */
.mi-slip-modal > *{
  max-width: 560px;
  margin-left: auto;
  margin-right: auto;
}

/* Invest slip modal bottom padding to accommodate share button + spacing */
.mi-slip-modal{
  padding-bottom: calc(var(--slip-share-btn-height) + 34px + env(safe-area-inset-bottom));
}


.mi-slip-close{
  position: fixed; /* keep it always accessible */
  top: calc(10px + env(safe-area-inset-top));
  left: 12px; /* moved to left side to avoid risk label */
  z-index: 10001;
  font-size: 22px;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: rgba(15,23,42,0.60);
  border: 1px solid rgba(148,163,184,0.25);
}
      .mi-slip-bullets li{
  color: #e2e8f0;
}


.mi-slip-share{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 10001;

  height: var(--slip-share-btn-height);
  padding-bottom: env(safe-area-inset-bottom);

  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;

  background: linear-gradient(
    to top,
    rgba(2,6,23,0.98),
    rgba(2,6,23,0.94)
  );
  border-top: 1px solid rgba(56,189,248,0.25);
  box-shadow: 0 -4px 16px rgba(0,0,0,0.25);

  color: #f9fafb;
  font-size: 17px;
  font-weight: 800;
  letter-spacing: 0.02em;
  text-transform: uppercase;

  cursor: pointer;
  transition: all 0.2s ease;
}

.mi-slip-share:hover {
  background: linear-gradient(
    to top,
    rgba(56,189,248,0.15),
    rgba(56,189,248,0.08)
  );
  border-top-color: rgba(56,189,248,0.45);
}

.mi-slip-share:active {
  transform: scale(0.98);
}

/* arrow icon */
.mi-slip-share::before{
  content: "‚Üó";
  font-size: 22px;
  opacity: 1;
  font-weight: 900;
}

/* Optional: if you want text instead of icon, remove ::before and use the button text */

/* Deep Dive button - slick styling matching the invest slip theme */
.mi-slip-deepdive-btn{
  width: 100%;
  max-width: 280px;
  padding: 14px 18px;
  margin: 16px auto 0;
  display: block;
  border: none;
  border-radius: 14px;
  background: linear-gradient(
    135deg,
    rgba(56,189,248,0.15),
    rgba(56,189,248,0.08)
  );
  border: 1px solid rgba(56,189,248,0.35);
  color: #f9fafb;
  font-size: 16px;
  font-weight: 800;
  letter-spacing: 0.02em;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.mi-slip-deepdive-btn:hover{
  background: linear-gradient(
    135deg,
    rgba(56,189,248,0.25),
    rgba(56,189,248,0.15)
  );
  border-color: rgba(56,189,248,0.55);
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}

.mi-slip-deepdive-btn:active{
  transform: translateY(0px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

/* Deep link display - shows above share button */
.mi-slip-deeplink{
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 14px;
  margin: 8px 0 0;
  border-radius: 12px;
  background: rgba(15,23,42,0.55);
  border: 1px solid rgba(148,163,184,0.22);
  font-size: 12px;
  color: #9ca3af;
}

.mi-slip-deeplink-label{
  font-weight: 600;
  color: #cbd5e1;
}

.mi-slip-deeplink-url{
  color: #38bdf8;
  text-decoration: none;
  font-weight: 600;
  word-break: break-all;
}

.mi-slip-deeplink-url:hover{
  text-decoration: underline;
}
      /* Hide deep link display (not needed in UI) */
.mi-slip-deeplink{
  display: none !important;
}
/* Across chips = clickable filters */
.across-chip {
  cursor: pointer;
  user-select: none;
}

.across-chip.active {
  border-color: rgba(0, 191, 255, 0.55);
  background: rgba(0, 191, 255, 0.12);
}
      h1 {
  margin: 0.6rem auto 0.35rem;
  padding: 0 1.5rem;
  text-align: center;
  font-size: 1.35rem;       /* smaller */
  font-weight: 800;
  letter-spacing: -0.02em;
}

/* NEW: tiny landscape tip under Across Markets */
.mi-tip {
  margin: -2px 0 10px;
  text-align: center;
  font-size: 11px;
  color: var(--muted-2);
  line-height: 1.25;
}
.mi-tip strong { font-weight: 700; }

/* Mobile tweak */
@media (max-width: 768px) {
  h1 { font-size: 1.18rem; }
  .mi-tip { font-size: 10.5px; }
}

    </style>
  </head>

<body>
  <!-- NAV OUTSIDE .page -->
  <header class="nav">
    <div class="container nav-inner">
      <div class="brand">
        <img src="/assets/favicon.png" alt="MatesInvest logo" class="logo" />
        <span>MatesInvest</span>
      </div>

<nav>
  <a href="/">Home</a>
  <a href="/join.html" class="btn btn-outline">Join</a>
  <a href="/mates-feedback.html">Feedback</a>
</nav>

      <button class="menu-btn" aria-label="Toggle navigation">‚ò∞</button>
    </div>
  </header>
<header>
  <h1>Investment Dashboard</h1>
</header>

<!-- Market Pulse (cards) -->
<section class="mp-wrap" aria-label="Market pulse summary">
  <div class="mp-date-header" id="mpDateHeader">Loading...</div>
  <div class="mp-grid">
    <div class="mp-card">
      <div class="mp-label">ASX 200</div>
      <div class="mp-value" id="mpXJO">‚Äî</div>
      <div class="mp-sub">ASX 200 Index</div>
    </div>

    <div class="mp-card">
      <div class="mp-label">Market mood</div>
      <div class="mp-value" id="mpMood">‚Äî</div>
      <div class="mp-sub" id="mpMoodSub">‚Äî</div>
    </div>

    <div class="mp-card">
      <div class="mp-label">Adv / Dec</div>
      <div class="mp-value" id="mpAD">‚Äî</div>
      <div class="mp-sub">Stocks up vs down</div>
      <div class="mp-spark"><span id="mpADBar"></span></div>
    </div>

    <div class="mp-card">
      <div class="mp-label">Turnover</div>
      <div class="mp-value" id="mpTurnover">‚Äî</div>
      <div class="mp-sub" id="mpCoverage">Coverage: ‚Äî</div>
    </div>
  </div>
</section>

<!-- Sector Performance Chart -->
<section class="sector-chart-wrap" aria-label="Sector performance chart">
  <div class="sector-chart-card">
    <div class="sector-chart-head">
      <h2 class="sector-chart-title">Sector performance</h2>
      <div class="mi-toggle" aria-label="Sector performance period">
        <button type="button" class="active" data-period="1d">1D</button>
        <button type="button" data-period="5d">5D</button>
        <button type="button" data-period="1m">1M</button>
      </div>
    </div>
    <div class="sector-chart-content">
      <div class="mi-chart-wrap">
        <canvas id="sectorChart"></canvas>
        <div id="sectorChartMessage" class="mi-chart-msg"></div>
      </div>
      <div class="mi-chart-subtle" id="sectorChartMeta">Loading‚Ä¶</div>
    </div>
  </div>
</section>
<!-- Across Markets (small + slick) -->
<section class="across-markets" aria-label="Across Markets">
  <div class="across-head">
    <span class="across-title">Across markets (1D AUD)</span>
    <span class="across-meta" id="acrossMeta">Live snapshot</span>
  </div>
  <div class="across-scroll" id="acrossItems">
    <!-- chips render here -->
  </div>
</section>
<div class="mi-tip">
  Tip: best viewed in <strong>landscape</strong> on mobile (turn your phone sideways).
</div>

      <section class="filters-card" id="filtersCard">
        <button type="button" class="filters-toggle" id="filtersToggle">
          <div class="filters-toggle-left">
            <div class="filters-chip">
              <span class="filters-chip-dot"></span>
              Filters
            </div>
            <div class="filters-caption">
              Search, narrow by sector, and screen for value or income ideas.
            </div>
          </div>
          <span class="filters-toggle-icon" id="filtersToggleIcon">‚ñæ</span>
        </button>

        <div class="filters-body" id="filtersBody">
          <!-- NEW: Thinking-style presets -->
          <div class="preset-bar" aria-label="Thinking style presets">
            <div class="preset-title">Pick a style (optional):</div>

            <button class="preset-btn" type="button" data-preset="technical">
              üß† Numbers mode
            </button>
            <button class="preset-btn" type="button" data-preset="value">
              üìã Planner mode
            </button>
            <button class="preset-btn" type="button" data-preset="long_term">
              üå± Long-game mode
            </button>
            <button class="preset-btn" type="button" data-preset="trader">
              ‚ö° Fast-mover mode
            </button>
            <button class="preset-btn" type="button" data-preset="social">
              üó£Ô∏è Talk-it-through mode
            </button>

            <button class="preset-btn secondary" type="button" id="presetClearBtn">
              Clear
            </button>

            <div class="preset-hint">
              These are just filter shortcuts ‚Äî not advice. You‚Äôre in control of
              what you click.
            </div>
          </div>

          <div class="filters">
            <div class="filter-group">
              <label class="filter-label" for="searchInput">Search</label>
              <input
                id="searchInput"
                type="text"
                placeholder="Code or name (e.g. BHP, CSL)"
              />
            </div>
            <div class="filter-group">
  <label class="filter-label" for="top200Only">
    <span style="display:flex;align-items:center;gap:0.35rem">
      <input id="top200Only" type="checkbox" checked style="width:auto;margin:0" />
      <span>Top 200 by market cap</span>
    </span>
  </label>
</div>

            <div class="filter-group">
              <label class="filter-label" for="sectorSelect">Sector</label>
              <select id="sectorSelect">
                <option value="">All sectors</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">P/E (min ‚Äì max)</label>
              <div style="display: flex; gap: 0.25rem">
                <input
                  id="peMin"
                  type="number"
                  step="0.1"
                  placeholder="0"
                  style="flex: 1"
                />
                <input
                  id="peMax"
                  type="number"
                  step="0.1"
                  placeholder="50"
                  style="flex: 1"
                />
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Mkt cap (A$bn, min ‚Äì max)</label>
              <div style="display: flex; gap: 0.25rem">
                <input
                  id="mcMin"
                  type="number"
                  step="1"
                  placeholder="0"
                  style="flex: 1"
                />
                <input
                  id="mcMax"
                  type="number"
                  step="1"
                  placeholder="300"
                  style="flex: 1"
                />
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Div. yield (min %)</label>
              <input id="dyMin" type="number" step="0.1" placeholder="0" />
            </div>

            <div class="filter-group">
              <label class="filter-label" for="hideEtfs">
                <span style="display: flex; align-items: center; gap: 0.35rem">
                  <input
                    id="hideEtfs"
                    type="checkbox"
                    checked
                    style="width: auto; margin: 0"
                  />
                  <span>Hide ETFs (name ends in ‚ÄúETF‚Äù)</span>
                </span>
              </label>
            </div>
          </div>
        </div>
      </section>

      <section class="table-wrapper">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th class="sortable sticky-col" data-sort="code">
                  Code <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="name">
                  Name <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="sector">
                  Sector <span>‚Üï</span>
                </th>
<th class="sortable" data-sort="price">
  Price (last close) <span>‚Üï</span>
</th>

<th class="sortable" data-sort="pctChange">
  % Chg <span>‚Üï</span>
</th>

<th class="sortable" data-sort="marketCap">
  Mkt Cap (A$m) <span>‚Üï</span>
</th>


                <th class="sortable" data-sort="peRatio">
                  P/E <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="eps">
                  EPS <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="bookValue">
                  Book value <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="dividendPerShare">
                  Div / share <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="dividendYield">
                  Div yield % <span>‚Üï</span>
                </th>

                <th class="sortable" data-sort="profitMargin">
                  Profit margin % <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="operatingMargin">
                  Operating margin % <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="returnOnAssets">
                  ROA % <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="returnOnEquity">
                  ROE % <span>‚Üï</span>
                </th>

                <th class="sortable" data-sort="revenue">
                  Revenue (A$m) <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="revenuePerShare">
                  Revenue / share <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="grossProfit">
                  Gross profit (A$m) <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="dilutedEps">
                  Diluted EPS <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="quarterlyRevenueGrowthYoy">
                  Q rev growth YoY % <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="quarterlyEarningsGrowthYoy">
                  Q EPS growth YoY % <span>‚Üï</span>
                </th>

                <th class="sortable" data-sort="trailingPE">
                  Trailing P/E <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="forwardPE">
                  Forward P/E <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="priceToSales">
                  Price / sales <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="priceToBook">
                  Price / book <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="enterpriseValue">
                  EV (A$m) <span>‚Üï</span>
                </th>
                <th class="sortable" data-sort="evToRevenue">
                  EV / revenue <span>‚Üï</span>
                </th>
              </tr>
            </thead>

            <tbody id="tableBody">
              <tr>
                <td colspan="31" style="text-align: center; padding: 1rem">
                  Loading companies‚Ä¶
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="status-bar">
          <span id="statusCount">0 companies</span>
          <span id="statusMeta"></span>
        </div>
      </section>
    </div>

    <!-- Instrument details modal -->
    <div id="mi-instrument-overlay" class="mi-ins-overlay" aria-hidden="true">
      <div
        class="mi-ins-modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="mi-ins-title"
      >
        <div class="mi-ins-header">
          <div>
            <h2 id="mi-ins-title" class="mi-ins-title">Instrument name</h2>
            <div id="mi-ins-subtitle" class="mi-ins-subtitle">CODE ‚Ä¢ Sector</div>
          </div>
          <div class="mi-ins-price-block">
            <div id="mi-ins-price" class="mi-ins-price">$0.00</div>
            <div id="mi-ins-change" class="mi-ins-change">+0.0% today</div>
            <div id="mi-ins-date" class="mi-ins-date">as at ‚Äî</div>
<button id="mi-ins-slip-btn" class="mi-ins-slip-btn" type="button">
  üéüÔ∏è Invest Slip
</button>
<button id="mi-ins-details-btn" class="mi-ins-details-btn" type="button">
  Deep Dive ‚Üí
</button>
          </div>
          <button
            class="mi-ins-close"
            type="button"
            id="mi-ins-close-btn"
            aria-label="Close"
          >
            ‚úï
          </button>
        </div>

        <div id="mi-ins-tags" class="mi-ins-tags"></div>

        <div class="mi-ins-section">
          <h3 class="mi-ins-section-title">Key stats</h3>
          <div id="mi-ins-stats" class="mi-ins-stats-grid"></div>
        </div>

        <div class="mi-ins-section">
          <h3 class="mi-ins-section-title">Price history</h3>
          <div class="mi-ins-history">
            <div id="mi-ins-history-summary" class="mi-ins-history-summary">
              Showing last 6 months of daily closes.
            </div>
            <canvas id="mi-ins-chart" width="600" height="220"></canvas>
          </div>
        </div>

        <div class="mi-ins-section">
          <h3 class="mi-ins-section-title">Company snapshot</h3>
          <div id="mi-ins-ai-summary" class="mi-ins-ai-summary">
            We‚Äôre loading a short AI summary for this company‚Ä¶
          </div>
        </div>

        <div class="mi-ins-section">
          <h3 class="mi-ins-section-title">Latest news</h3>
          <div id="mi-ins-news">Loading headlines for this name‚Ä¶</div>
        </div>
      </div>
    </div>
<!-- Invest Slip overlay -->
<div id="mi-slip-overlay" class="mi-slip-overlay" aria-hidden="true">
  <div class="mi-slip-modal" role="dialog" aria-modal="true" aria-labelledby="mi-slip-title">
    <button class="mi-slip-close" type="button" id="mi-slip-close-btn" aria-label="Close">‚úï</button>
    
    <div class="mi-slip-deeplink" id="mi-slip-deeplink-container">
      <span class="mi-slip-deeplink-label">Direct link:</span>
      <a class="mi-slip-deeplink-url" id="mi-slip-deeplink" href="#" target="_blank" rel="noopener noreferrer">‚Äî</a>
    </div>
    
    <button class="mi-slip-share" id="mi-slip-share-btn" type="button">Share invest slip</button>

    <div class="mi-slip-top">
      <div class="mi-slip-badge">INVEST SLIP</div>
      <div class="mi-slip-pill" id="mi-slip-risk">Risk: ‚Äî</div>
    </div>

    <div class="mi-slip-hero">
      <div class="mi-slip-code" id="mi-slip-code">‚Äî</div>
      <div class="mi-slip-name" id="mi-slip-name">‚Äî</div>
      <div class="mi-slip-sub" id="mi-slip-sub">‚Äî</div>
    </div>

    <div class="mi-slip-price-row">
      <div class="mi-slip-price" id="mi-slip-price">‚Äî</div>
      <div class="mi-slip-chg" id="mi-slip-chg">‚Äî</div>
    </div>

    <div class="mi-slip-chart-wrap">
      <canvas id="mi-slip-chart" width="520" height="160"></canvas>
      <div class="mi-slip-chart-meta" id="mi-slip-chart-meta">Last 30 days</div>
    </div>

    <div class="mi-slip-section">
      <div class="mi-slip-section-title">Why it‚Äôs interesting</div>
      <ul class="mi-slip-bullets" id="mi-slip-bullets"></ul>
    </div>

    <div class="mi-slip-section mi-slip-fundamentals">
      <div class="mi-slip-section-title">Company fundamentals</div>
      <div class="mi-slip-fundamentals-grid">
        <div class="mi-slip-fund-col">
          <div class="mi-slip-fund-item">
            <span class="mi-slip-fund-label">Market cap</span>
            <span class="mi-slip-fund-value" id="mi-slip-fund-mktcap">‚Äî</span>
          </div>
          <div class="mi-slip-fund-item">
            <span class="mi-slip-fund-label">Revenue</span>
            <span class="mi-slip-fund-value" id="mi-slip-fund-revenue">‚Äî</span>
          </div>
          <div class="mi-slip-fund-item">
            <span class="mi-slip-fund-label">Gross profit</span>
            <span class="mi-slip-fund-value" id="mi-slip-fund-gp">‚Äî</span>
          </div>
        </div>
        <div class="mi-slip-fund-col">
          <div class="mi-slip-fund-item">
            <span class="mi-slip-fund-label">Price to Earnings</span>
            <span class="mi-slip-fund-value" id="mi-slip-fund-pe">‚Äî</span>
          </div>
          <div class="mi-slip-fund-item">
            <span class="mi-slip-fund-label">Price to Book</span>
            <span class="mi-slip-fund-value" id="mi-slip-fund-pb">‚Äî</span>
          </div>
          <div class="mi-slip-fund-item">
            <span class="mi-slip-fund-label">Price to Sales</span>
            <span class="mi-slip-fund-value" id="mi-slip-fund-ps">‚Äî</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Deep Dive button -->
    <button class="mi-slip-deepdive-btn" type="button" id="mi-slip-deepdive-btn">
      Deep Dive ‚Üí
    </button>
  </div>
</div>
    <script>
      const API_URL = "/.netlify/functions/equity-screener";
const MORNING_BRIEF_URL = "/.netlify/functions/morning-brief";
      const tableBody = document.getElementById("tableBody");
      const searchInput = document.getElementById("searchInput");
      const sectorSelect = document.getElementById("sectorSelect");
      const peMinInput = document.getElementById("peMin");
      const peMaxInput = document.getElementById("peMax");
      const mcMinInput = document.getElementById("mcMin");
      const mcMaxInput = document.getElementById("mcMax");
      const dyMinInput = document.getElementById("dyMin");
      const statusCount = document.getElementById("statusCount");
      const statusMeta = document.getElementById("statusMeta");
      const ths = document.querySelectorAll("th.sortable");
      const hideEtfsInput = document.getElementById("hideEtfs");
      const top200OnlyInput = document.getElementById("top200Only");

      const filtersCard = document.getElementById("filtersCard");
      const filtersToggle = document.getElementById("filtersToggle");
      const filtersToggleIcon = document.getElementById("filtersToggleIcon");

      const presetButtons = Array.from(document.querySelectorAll(".preset-btn[data-preset]"));
      const presetClearBtn = document.getElementById("presetClearBtn");

      let rawItems = [];
      let filteredItems = [];
      let miCurrentCode = null;

      let sortState = { key: "marketCap", direction: "desc" };
      let activePresetId = null;
      // Across-markets chip -> screener tag filter
let activeAcrossTag = null;

// Map chip symbol -> fundamentals tag
const ACROSS_TAG_MAP = {
  XAU: "Gold",
  XAG: "Silver", 
  IRON: "Iron Ore",
  URANIUM: "Uranium",
  NI: "Nickel",
  "LITH-CAR": "Lithium",

  // Any of these = show Crypto-tagged equities
  BTC: "Crypto",
  ETH: "Crypto",
  SOL: "Crypto",
};

function normalizeTag(s) {
  return String(s || "").trim().toLowerCase();
}

function itemHasTag(item, tag) {
  const want = normalizeTag(tag);
  const tags = Array.isArray(item?.tags) ? item.tags : [];
  return tags.some((t) => normalizeTag(t) === want);
}

function setAcrossActiveUI() {
  const wrap = document.getElementById("acrossItems");
  if (!wrap) return;
  wrap.querySelectorAll(".across-chip").forEach((el) => {
    const tag = el.getAttribute("data-tag");
    el.classList.toggle("active", !!tag && normalizeTag(tag) === normalizeTag(activeAcrossTag));
  });
}


// Fast-mover ‚Äúvolatile‚Äù threshold (daily move). Tweak anytime.
const FAST_MOVER_MIN_ABS_PCT = 3; // 3%+


      // Filters dropdown toggle
      filtersToggle.addEventListener("click", () => {
        const isOpen = filtersCard.classList.toggle("open");
        filtersToggleIcon.textContent = isOpen ? "‚ñ¥" : "‚ñæ";
      });
function fmtMoneyAUD(n) {
  if (typeof n !== "number" || !Number.isFinite(n)) return "‚Äî";
  // compact-ish but still readable
  if (n >= 1_000_000) return "$" + (n / 1_000_000).toFixed(2) + "m";
  if (n >= 1_000) return "$" + Math.round(n).toLocaleString("en-AU");
  return "$" + n.toFixed(2);
}

function fmtPct(p) {
  if (typeof p !== "number" || !Number.isFinite(p)) return "‚Äî";
  const sign = p > 0 ? "+" : "";
  return `${sign}${p.toFixed(2)}%`;
}

function pctClass(p) {
  if (typeof p !== "number" || !Number.isFinite(p)) return "neu";
  if (p > 0) return "pos";
  if (p < 0) return "neg";
  return "neu";
}

async function loadAcrossMarkets() {
  const wrap = document.getElementById("acrossItems");
  const meta = document.getElementById("acrossMeta");
  if (!wrap) return;

  // Which chips we want (keep it tight)
  const metalsOrder = [
    { key: "XAU", label: "Gold" },
    { key: "XAG", label: "Silver" }, 
    { key: "IRON", label: "Iron ore" },
    { key: "URANIUM", label: "Uranium" },
    { key: "NI", label: "Nickel" },
    { key: "LITH-CAR", label: "Lithium" },
  ];

  const cryptoOrder = [
    { key: "BTC", label: "Bitcoin" },
    { key: "ETH", label: "Ethereum" },
    { key: "SOL", label: "Solana" },
  ];

  try {
    wrap.innerHTML = ""; // clear
    meta.textContent = "Loading‚Ä¶";

    const res = await fetch(MORNING_BRIEF_URL, { cache: "no-store" });
    const data = await res.json();

    const chips = [];

    // Metals chips
    for (const m of metalsOrder) {
      const row = data?.metals?.[m.key];
      if (!row) continue;
      chips.push({
        sym: m.key,
        lbl: m.label,
        px: row.priceAUD,
        chg: row.pctChange,
      });
    }

    // Crypto chips
    for (const c of cryptoOrder) {
      const row = data?.crypto?.[c.key];
      if (!row) continue;
      chips.push({
        sym: c.key,
        lbl: c.label,
        px: row.priceAUD,
        chg: row.pctChange,
      });
    }

    // Render
wrap.innerHTML = chips
  .map((x) => {
    const chgTxt = x.chg == null ? "‚Äî" : fmtPct(x.chg);
    const cls = pctClass(x.chg);

const isCrypto = (x.sym === "BTC" || x.sym === "ETH" || x.sym === "SOL");
const tag = isCrypto ? "" : (ACROSS_TAG_MAP[x.sym] || "");

    return `
      <div class="across-chip" title="${x.lbl}" data-sym="${x.sym}" data-tag="${tag}">
        <div class="k">
          <div class="sym">${x.sym}</div>
          <div class="lbl">${x.lbl}</div>
        </div>
        <div class="v">
          <div class="px">${fmtMoneyAUD(x.px)}</div>
          <div class="chg ${cls}">${chgTxt}</div>
        </div>
      </div>
    `;
  })
  .join("");

// NEW: apply active styling after render
setAcrossActiveUI();


    // Meta (timestamp)
    const ts =
      data?.metals?.XAU?.priceTimestamp ||
      data?.crypto?.BTC?.priceTimestamp ||
      data?.generatedAt ||
      null;

    meta.textContent = ts ? `As of ${new Date(ts).toLocaleString("en-AU")}` : "Snapshot";
  } catch (e) {
    console.warn("Across markets failed:", e?.message || e);
    meta.textContent = "Snapshot unavailable";
    // keep it quiet ‚Äî don‚Äôt break screener
    wrap.innerHTML = `
      <div class="across-chip">
        <div class="k">
          <div class="sym">‚Äî</div>
          <div class="lbl">Across markets</div>
        </div>
        <div class="v">
          <div class="px">Unavailable</div>
          <div class="chg neu">‚Äî</div>
        </div>
      </div>
    `;
  }
}
(function autoScrollAcrossMarkets() {
  const scroller = document.getElementById("acrossItems");
  if (!scroller) return;

  let rafId = null;
  let paused = false;
  let resumeTimer = null;

  const SPEED = 0.25;        // px per frame (slow + classy)
  const RESUME_DELAY = 2000; // ms after user interaction

  function step() {
    if (!paused) {
      scroller.scrollLeft += SPEED;

      // Loop back to start when near the end
      if (scroller.scrollLeft + scroller.clientWidth >= scroller.scrollWidth - 2) {
        scroller.scrollLeft = 0;
      }
    }
    rafId = requestAnimationFrame(step);
  }

  function pause() {
    paused = true;
    clearTimeout(resumeTimer);
    resumeTimer = setTimeout(() => {
      paused = false;
    }, RESUME_DELAY);
  }

  // Pause on any user intent
  ["wheel", "touchstart", "mousedown", "mouseenter"].forEach(evt =>
    scroller.addEventListener(evt, pause, { passive: true })
  );

  // Resume when pointer leaves (desktop)
  scroller.addEventListener("mouseleave", () => {
    paused = false;
  });

  // Kick it off
  step();
})();
      // ----------------------------
      // NEW: Style presets (no JSON file needed)
      // ----------------------------

function setActivePreset(id) {
  activePresetId = id || null;
  presetButtons.forEach((b) => b.classList.toggle("active", b.dataset.preset === id));
}


      function clearPresetUI() {
        setActivePreset(null);
      }

      function clearAllInputs() {
        searchInput.value = "";
        sectorSelect.value = "";
        peMinInput.value = "";
        peMaxInput.value = "";
        mcMinInput.value = "";
        mcMaxInput.value = "";
        dyMinInput.value = "";
        if (hideEtfsInput) hideEtfsInput.checked = true;
        sortState = { key: "marketCap", direction: "desc" };
      }

      // These are intentionally ‚Äúsoft‚Äù defaults ‚Äî just shortcuts, not advice.
      function applyStylePreset(id) {
        clearAllInputs();

        // Keep ETFs hidden by default (you already do this)
        if (hideEtfsInput) hideEtfsInput.checked = true;

        switch (id) {
          case "technical": {
            // Numbers mode: prefer larger + more ‚Äúestablished‚Äù datapoints
            mcMinInput.value = "1"; // >= $1bn
            peMaxInput.value = "35";
            sortState = { key: "marketCap", direction: "desc" };
            break;
          }
          case "value": {
            // Planner mode: tilt to dividends + not-crazy PE
            dyMinInput.value = "3"; // >= 3%
            peMaxInput.value = "20";
            sortState = { key: "dividendYield", direction: "desc" };
            break;
          }
          case "long_term": {
            // Long-game: big-ish names + avoid extremes
            mcMinInput.value = "2"; // >= $2bn
            peMinInput.value = "5";
            peMaxInput.value = "30";
            sortState = { key: "marketCap", direction: "desc" };
            break;
          }
case "trader": {
  // Fast-mover: volatile movers (big up or down), still avoid micro illiquid names
  mcMinInput.value = "1"; // >= $1bn

  // Sort by ABS % change (custom key handled in applySort)
  sortState = { key: "absPctChange", direction: "desc" };
  break;
}
          case "social": {
            // Talk-it-through: big, well-known names (easy to discuss + find info)
            mcMinInput.value = "5"; // >= $5bn
            sortState = { key: "marketCap", direction: "desc" };
            break;
          }
          default:
            break;
        }

        setActivePreset(id);
        applyFilters();
      }

      function readPresetFromUrl() {
        const params = new URLSearchParams(window.location.search);

        // support quiz param ?r=technical etc
        const r = params.get("r");

        // also allow ?preset=technical,value...
        const p = params.get("preset");

        // priority: explicit preset param, else quiz r=
        const picked = (p || r || "").trim();

        if (!picked) return null;

        // allow comma list, apply first only (clean/simple)
        const first = picked.split(",").map((s) => s.trim()).filter(Boolean)[0] || null;
        return first;
      }

      presetButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.preset;
          applyStylePreset(id);
        });
      });

      presetClearBtn?.addEventListener("click", () => {
        clearPresetUI();
        clearAllInputs();
        applyFilters();
      });

      // ----------------------------
      // Data load + filtering
      // ----------------------------

      async function loadData() {
        try {
          const res = await fetch(API_URL);
          if (!res.ok) throw new Error("Network error " + res.status);

          const data = await res.json();
          rawItems = data.items || [];

const updatedDate = data.generatedAt
  ? new Date(data.generatedAt).toLocaleDateString("en-AU", {
      day: "2-digit",
      month: "short",
      year: "numeric",
    })
  : "n/a";

statusMeta.textContent = `Updated ${updatedDate}`;

          populateSectorFilter(rawItems);

          // Apply URL preset after data exists
          const presetFromUrl = readPresetFromUrl();
          if (presetFromUrl) {
            filtersCard.classList.add("open");
            filtersToggleIcon.textContent = "‚ñ¥";
            applyStylePreset(presetFromUrl);
          } else {
            applyFilters();
          }

          // Check for deep link stock parameter
          const params = new URLSearchParams(window.location.search);
          const stockParam = params.get("stock");
          if (stockParam) {
            // Auto-open the stock slip for the specified stock code
            const stockCode = stockParam.trim().toUpperCase();
            // Use requestAnimationFrame to ensure DOM is ready
            requestAnimationFrame(async () => {
              try {
                const data = await miFetchInstrumentDetails("equity", stockCode);
                miOpenInstrumentModal(data);
                // Wait for modal to render before opening slip
                await new Promise(resolve => requestAnimationFrame(resolve));
                // Find the item in filteredItems to get the table's pctChange value
                const tableItem = filteredItems.find(item => item.code === stockCode);
                const tablePctChange = tableItem?.pctChange;
                miOpenSlipFromCurrent(tablePctChange);
              } catch (err) {
                console.error("Failed to auto-open stock slip:", err);
                // Show user-friendly message
                alert(`Could not load stock "${stockCode}". It may not be in our database.`);
              }
            });
          }
        } catch (e) {
          console.error(e);
          tableBody.innerHTML =
            '<tr><td colspan="31" style="text-align:center;padding:1rem;color:#dc2626">Failed to load data. Refresh to try again.</td></tr>';
        }
      }

      function populateSectorFilter(items) {
        const sectors = Array.from(
          new Set(
            items
              .map((i) => i.sector || "Unknown")
              .filter((s) => s && s.trim() !== "")
          )
        ).sort();

        sectors.forEach((sector) => {
          const opt = document.createElement("option");
          opt.value = sector;
          opt.textContent = sector;
          sectorSelect.appendChild(opt);
        });
      }

      function applyFilters() {
        const q = searchInput.value.trim().toLowerCase();
        const sector = sectorSelect.value;
        const peMin = parseFloat(peMinInput.value);
        const peMax = parseFloat(peMaxInput.value);
        const mcMinBn = parseFloat(mcMinInput.value);
        const mcMaxBn = parseFloat(mcMaxInput.value);
        const dyMin = parseFloat(dyMinInput.value);
        const hideEtfs = hideEtfsInput && hideEtfsInput.checked;
        const tagFilter = activeAcrossTag;

        filteredItems = rawItems.filter((item) => {
          if (q) {
            const haystack = `${item.code} ${item.name}`.toLowerCase();
            if (!haystack.includes(q)) return false;
          }

          if (sector && item.sector !== sector) return false;
// Across Markets tag filter (Gold / Uranium / Crypto etc)
if (tagFilter) {
  if (!itemHasTag(item, tagFilter)) return false;
}
          // only exact 3-letter codes
          const code = (item.code || "").trim();
          if (!code || code.length !== 3) return false;

          const pe = Number(item.peRatio);
          if (!Number.isNaN(pe)) {
            if (!Number.isNaN(peMin) && pe < peMin) return false;
            if (!Number.isNaN(peMax) && pe > peMax) return false;
          }

          const mc = Number(item.marketCap);
          const mcBn = Number.isNaN(mc) ? NaN : mc / 1_000_000_000;
          if (!Number.isNaN(mcBn)) {
            if (!Number.isNaN(mcMinBn) && mcBn < mcMinBn) return false;
            if (!Number.isNaN(mcMaxBn) && mcBn > mcMaxBn) return false;
          }

          const dy = Number(item.dividendYield);
          if (!Number.isNaN(dy) && !Number.isNaN(dyMin)) {
            const dyPct = dy <= 1 && dy >= -1 ? dy * 100 : dy;
            if (dyPct < dyMin) return false;
          }

          if (
            hideEtfs &&
            typeof item.name === "string" &&
            item.name.trim().toUpperCase().endsWith("ETF")
          ) {
            return false;
          }
// Fast-mover volatility screen: require meaningful daily move
if (activePresetId === "trader") {
  const pc = Number(item.pctChange);
  if (Number.isNaN(pc) || Math.abs(pc) < FAST_MOVER_MIN_ABS_PCT) return false;
}
          return true;
        });
// Default universe: top 200 by market cap (still sortable after this)
if (top200OnlyInput && top200OnlyInput.checked) {
  const top200 = [...filteredItems]
    .sort((a, b) => (Number(b.marketCap) || -Infinity) - (Number(a.marketCap) || -Infinity))
    .slice(0, 200);

  filteredItems = top200;
}
        applySort();
        renderTable();
      }

      function applySort() {
        const { key, direction } = sortState;
        const dir = direction === "asc" ? 1 : -1;

filteredItems.sort((a, b) => {
  // Custom: absolute % change
  if (key === "absPctChange") {
    const aa = Math.abs(Number(a.pctChange));
    const bb = Math.abs(Number(b.pctChange));
    const na = Number.isFinite(aa) ? aa : -Infinity;
    const nb = Number.isFinite(bb) ? bb : -Infinity;
    return (na - nb) * dir;
  }

  const va = a[key];
  const vb = b[key];

          const na = Number(va);
          const nb = Number(vb);
          const bothNumeric = !Number.isNaN(na) && !Number.isNaN(nb) && key !== "name";

          if (bothNumeric) {
            if (na < nb) return -1 * dir;
            if (na > nb) return 1 * dir;
            return 0;
          } else {
            const sa = (va ?? "").toString().toLowerCase();
            const sb = (vb ?? "").toString().toLowerCase();
            if (sa < sb) return -1 * dir;
            if (sa > sb) return 1 * dir;
            return 0;
          }
        });
      }

      function renderTable() {
        if (!filteredItems.length) {
          tableBody.innerHTML =
            '<tr><td colspan="31" style="text-align:center;padding:1rem;">No companies match your filters.</td></tr>';
          statusCount.textContent = "0 companies";
          return;
        }

        const rows = filteredItems
          .map((item) => {
            const mcM = toMillions(item.marketCap);
            const revM = toMillions(item.revenue);
            const gpM = toMillions(item.grossProfit);
            const evM = toMillions(item.enterpriseValue);

            return `
              <tr data-code="${item.code}" data-type="equity">
                <td class="sticky-col"><strong>${item.code}</strong></td>
                <td>${item.name || ""}</td>
                <td><span class="pill">${item.sector || "Unknown"}</span></td>
<td>${formatPrice(item.price)}</td>
<td>${formatPct(item.pctChange)}</td>
<td>${mcM}</td>
                <td>${formatNumber(item.peRatio)}</td>
                <td>${formatNumber(item.eps)}</td>
                <td>${formatNumber(item.bookValue)}</td>
                <td>${formatNumber(item.dividendPerShare)}</td>
                <td>${formatPercentFrac(item.dividendYield)}</td>

                <td>${formatPercentFrac(item.profitMargin)}</td>
                <td>${formatPercentFrac(item.operatingMargin)}</td>
                <td>${formatPercentFrac(item.returnOnAssets)}</td>
                <td>${formatPercentFrac(item.returnOnEquity)}</td>

                <td>${revM}</td>
                <td>${formatNumber(item.revenuePerShare)}</td>
                <td>${gpM}</td>
                <td>${formatNumber(item.dilutedEps)}</td>
                <td>${formatPercentFrac(item.quarterlyRevenueGrowthYoy)}</td>
                <td>${formatPercentFrac(item.quarterlyEarningsGrowthYoy)}</td>

                <td>${formatNumber(item.trailingPE)}</td>
                <td>${formatNumber(item.forwardPE)}</td>
                <td>${formatNumber(item.priceToSales)}</td>
                <td>${formatNumber(item.priceToBook)}</td>
                <td>${evM}</td>
                <td>${formatNumber(item.evToRevenue)}</td>
              </tr>
            `;
          })
          .join("");

        tableBody.innerHTML = rows;

        statusCount.textContent = `${filteredItems.length} compan${
          filteredItems.length === 1 ? "y" : "ies"
        }`;
      }

      function toMillions(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "-";
        const m = n / 1_000_000;
        return m.toLocaleString(undefined, { maximumFractionDigits: 1 });
      }

      function formatNumber(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "-";
        return n.toLocaleString(undefined, { maximumFractionDigits: 2 });
      }
      function formatPct(v) {
  if (typeof v !== "number" || !Number.isFinite(v)) return "‚Äî";
  const sign = v > 0 ? "+" : "";
  return `${sign}${v.toFixed(2)}%`;
}
      function formatPrice(v) {
  if (typeof v !== "number" || !Number.isFinite(v)) return "‚Äî";
  return v.toFixed(3);
}
      function formatPercentFrac(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "-";
        const pct = Math.abs(n) <= 1 ? n * 100 : n;
        return `${pct.toFixed(2)}%`;
      }

      // Wire up filter inputs
      searchInput.addEventListener("input", () => { clearPresetUI(); applyFilters(); });
      sectorSelect.addEventListener("change", () => { clearPresetUI(); applyFilters(); });
      peMinInput.addEventListener("input", () => { clearPresetUI(); applyFilters(); });
      peMaxInput.addEventListener("input", () => { clearPresetUI(); applyFilters(); });
      mcMinInput.addEventListener("input", () => { clearPresetUI(); applyFilters(); });
      mcMaxInput.addEventListener("input", () => { clearPresetUI(); applyFilters(); });
      dyMinInput.addEventListener("input", () => { clearPresetUI(); applyFilters(); });
      hideEtfsInput.addEventListener("change", () => { clearPresetUI(); applyFilters(); });
      top200OnlyInput?.addEventListener("change", () => { clearPresetUI(); applyFilters(); });

      // Sorting clicks
      ths.forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.sort;
          if (!key) return;
          if (sortState.key === key) {
            sortState.direction = sortState.direction === "asc" ? "desc" : "asc";
          } else {
            sortState.key = key;
            sortState.direction = "asc";
          }
          applySort();
          renderTable();
        });
      });

      // Start
      loadData();

      // ---------- Instrument helpers ----------

      async function miFetchInstrumentDetails(type, code) {
        const url = `/.netlify/functions/instrument-details?type=${encodeURIComponent(
          type
        )}&code=${encodeURIComponent(code)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`instrument-details failed: ${res.status}`);
        return res.json();
      }

      async function miFetchAiSummary(type, code) {
        const url = `/.netlify/functions/instrument-ai-summary?type=${encodeURIComponent(
          type
        )}&code=${encodeURIComponent(code)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`instrument-ai-summary failed: ${res.status}`);
        return res.json();
      }

      async function miFetchInstrumentNews(code) {
        const params = new URLSearchParams({
          symbols: `${code}.AX`,
          per_page: "6",
        });
        const res = await fetch("/.netlify/functions/newsFeed?" + params.toString());
        if (!res.ok) throw new Error(`newsFeed failed: ${res.status}`);
        const data = await res.json();
        return data.articles || [];
      }

      function miFormatCurrency(n, currency = "AUD") {
        if (typeof n !== "number" || !isFinite(n)) return null;
        try {
          return new Intl.NumberFormat("en-AU", {
            style: "currency",
            currency,
            maximumFractionDigits: 2,
          }).format(n);
        } catch {
          return n.toFixed(2);
        }
      }

      function miFormatCompactNumber(n) {
        if (typeof n !== "number" || !isFinite(n)) return null;
        const abs = Math.abs(n);
        if (abs >= 1_000_000_000) return (n / 1_000_000_000).toFixed(1) + "B";
        if (abs >= 1_000_000) return (n / 1_000_000).toFixed(1) + "M";
        if (abs >= 1_000) return (n / 1_000).toFixed(1) + "k";
        return n.toFixed(0);
      }

      function miFormatPercent(n, digits = 2) {
        if (typeof n !== "number" || !isFinite(n)) return null;
        return n.toFixed(digits) + "%";
      }

      function miFormatDate(dateStr) {
        if (!dateStr) return null;
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return null;
        return d.toLocaleDateString("en-AU", { day: "2-digit", month: "short", year: "numeric" });
      }

      function miRenderChart(history) {
        const canvas = document.getElementById("mi-ins-chart");
        if (!canvas || !history || !Array.isArray(history.points)) return;

        const ctx = canvas.getContext("2d");
        const pts = history.points.map((p) => p[1]).filter((x) => typeof x === "number");

        const w = canvas.width;
        const h = canvas.height;

        ctx.clearRect(0, 0, w, h);

        if (pts.length < 2) {
          ctx.fillStyle = "#9ca3af";
          ctx.font = "12px system-ui";
          ctx.fillText("No chart data available", 12, 20);
          return;
        }

        const min = Math.min(...pts);
        const max = Math.max(...pts);
        const padX = 20;
        const padY = 10;

        ctx.lineWidth = 2;
        ctx.strokeStyle = "#38bdf8";
        ctx.beginPath();

        pts.forEach((v, i) => {
          const x = padX + (i / (pts.length - 1)) * (w - padX * 2);
          const y = h - padY - ((v - min) / (max - min)) * (h - padY * 2);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });

        ctx.stroke();

        const gradient = ctx.createLinearGradient(0, padY, 0, h);
        gradient.addColorStop(0, "rgba(56,189,248,0.25)");
        gradient.addColorStop(1, "rgba(56,189,248,0.0)");

        ctx.lineTo(w - padX, h - padY);
        ctx.lineTo(padX, h - padY);
        ctx.closePath();
        ctx.fillStyle = gradient;
        ctx.fill();
      }

      function miOpenInstrumentModal(data) {
        miLastInstrumentData = data;
        miCurrentCode = data.code || data.ticker || null;
        const overlay = document.getElementById("mi-instrument-overlay");
        if (!overlay) return;

        const latest = data.latest || {};
        const f = data.fundamentals || {};

        const titleEl = document.getElementById("mi-ins-title");
        const subtitleEl = document.getElementById("mi-ins-subtitle");
        const priceEl = document.getElementById("mi-ins-price");
        const changeEl = document.getElementById("mi-ins-change");
        const dateEl = document.getElementById("mi-ins-date");
        const tagsEl = document.getElementById("mi-ins-tags");
        const statsEl = document.getElementById("mi-ins-stats");
        const historySummaryEl = document.getElementById("mi-ins-history-summary");
        const aiSummaryEl = document.getElementById("mi-ins-ai-summary");
        const newsEl = document.getElementById("mi-ins-news");

        const name = data.name || data.code || "";
        const code = data.code || "";
        const sector = f.sector || "";
        const industry = f.industry || "";
        const sizeBucket = f.sizeBucket || null;

        if (titleEl) titleEl.textContent = name;
        if (subtitleEl) {
          const bits = [];
          if (code) bits.push(code);
          if (sector) bits.push(sector);
          subtitleEl.textContent = bits.join(" ‚Ä¢ ") || "";
        }

        const priceNum =
          typeof latest.price === "number" && isFinite(latest.price) ? latest.price : null;
        const pctChange =
          typeof latest.pctChange === "number" && isFinite(latest.pctChange) ? latest.pctChange : null;

        if (priceEl) {
          priceEl.textContent =
            priceNum !== null ? miFormatCurrency(priceNum, f.currency || "AUD") : "‚Äî";
        }

        if (changeEl) {
          changeEl.classList.remove("up", "down");
          if (pctChange === null) {
            changeEl.textContent = "Change: ‚Äî";
          } else {
            const arrow = pctChange > 0 ? "‚ñ≤" : pctChange < 0 ? "‚ñº" : "‚Ä¢";
            changeEl.textContent = `${arrow} ${pctChange.toFixed(2)}% yesterday`;
            if (pctChange > 0) changeEl.classList.add("up");
            else if (pctChange < 0) changeEl.classList.add("down");
          }
        }

        if (dateEl) {
          const d = miFormatDate(latest.date);
          dateEl.textContent = d ? `as at ${d}` : "";
        }

        if (tagsEl) {
          tagsEl.innerHTML = "";
          const tags = [];
          if (sizeBucket) {
            const label =
              sizeBucket === "mega"
                ? "Mega cap"
                : sizeBucket === "large"
                ? "Large cap"
                : sizeBucket === "mid"
                ? "Mid cap"
                : sizeBucket === "small"
                ? "Small cap"
                : null;
            if (label) tags.push(label);
          }
          if (sector) tags.push(sector);
          if (industry) tags.push(industry);

          tags.forEach((t) => {
            const span = document.createElement("span");
            span.className = "mi-ins-tag";
            span.textContent = t;
            tagsEl.appendChild(span);
          });
        }

        if (statsEl) {
          statsEl.innerHTML = "";
          const addStat = (label, valueStr) => {
            if (!valueStr) return;
            const item = document.createElement("div");
            item.className = "mi-ins-stat-item";
            const lab = document.createElement("span");
            lab.className = "mi-ins-stat-label";
            lab.textContent = label;
            const val = document.createElement("span");
            val.className = "mi-ins-stat-value";
            val.textContent = valueStr;
            item.appendChild(lab);
            item.appendChild(val);
            statsEl.appendChild(item);
          };

          if (typeof f.marketCap === "number" && isFinite(f.marketCap)) {
            addStat("Market cap", miFormatCompactNumber(f.marketCap));
          }
          if (typeof f.revenueLastYear === "number" && isFinite(f.revenueLastYear)) {
            addStat("Revenue (last year)", miFormatCompactNumber(f.revenueLastYear));
          }
          if (typeof f.netIncomeLastYear === "number" && isFinite(f.netIncomeLastYear)) {
            addStat("Net profit (last year)", miFormatCompactNumber(f.netIncomeLastYear));
          }
          if (typeof f.pe === "number" && isFinite(f.pe)) {
            addStat("P/E ratio", f.pe.toFixed(2) + "√ó");
          }
          if (typeof f.dividendYield === "number" && isFinite(f.dividendYield)) {
            addStat("Dividend yield", miFormatPercent(f.dividendYield, 2));
          }
          if (typeof f.paysDividend === "boolean") {
            addStat("Pays dividend", f.paysDividend ? "Yes" : "No");
          }
          if (typeof f.eps === "number" && isFinite(f.eps)) {
            addStat("Earnings per share", f.eps.toFixed(2));
          }
        }

        const h = data.history;
        if (historySummaryEl) {
          if (h && Array.isArray(h.points) && h.points.length > 1) {
            const start = miFormatDate(h.startDate);
            const end = miFormatDate(h.endDate);
            historySummaryEl.textContent =
              start && end ? `Showing daily closes from ${start} to ${end}.` : "Showing last 6 months of daily closes.";
          } else {
            historySummaryEl.textContent = "Price history not available.";
          }
        }
        if (h) miRenderChart(h);

        if (aiSummaryEl) {
          aiSummaryEl.textContent = "We‚Äôre loading a short AI snapshot for this company‚Ä¶";
          miFetchAiSummary("equity", data.code || "")
            .then((s) => {
              aiSummaryEl.textContent = s && s.summary ? s.summary : "We couldn‚Äôt generate a summary right now.";
            })
            .catch((err) => {
              console.error("AI summary error", err);
              aiSummaryEl.textContent = "We couldn‚Äôt generate a summary right now.";
            });
        }

        if (newsEl) {
          newsEl.textContent = "Loading headlines for this name‚Ä¶";
          miFetchInstrumentNews(code)
            .then((articles) => {
              if (!articles.length) {
                newsEl.textContent = "No recent headlines found for this code.";
                return;
              }
              const html = articles
                .slice(0, 6)
                .map((a) => {
                  const when = a.publishedAt || a.published || "";
                  const d = miFormatDate(when) || "";
                  const source = a.source || "";
                  const title = a.title || "";
                  return `
                    <div class="mi-ins-news-item">
                      <div class="mi-ins-news-item-title">${title}</div>
                      <div class="mi-ins-news-item-meta">
                        ${source}${d ? " ‚Ä¢ " + d : ""}
                      </div>
                      ${
                        a.url
                          ? `<a href="${a.url}" target="_blank" rel="noopener">Read original ‚Üí</a>`
                          : ""
                      }
                    </div>
                  `;
                })
                .join("");
              newsEl.innerHTML = `<div class="mi-ins-news-list">${html}</div>`;
            })
            .catch((err) => {
              console.error("Instrument news error", err);
              newsEl.textContent = "Couldn‚Äôt load news right now.";
            });
        }

        overlay.style.display = "flex";
        overlay.setAttribute("aria-hidden", "false");
      }
      // Keep the latest instrument payload so the slip can reuse it
let miLastInstrumentData = null;

// ---------- Invest Slip helpers ----------
function miClamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function miFmtX(n, digits=2){
  return (typeof n === "number" && Number.isFinite(n)) ? n.toFixed(digits) : null;
}

function miPct(n, digits=2){
  if (typeof n !== "number" || !Number.isFinite(n)) return null;
  const sign = n > 0 ? "+" : "";
  return `${sign}${n.toFixed(digits)}%`;
}

function miPickHistoryWindowPoints(history, days=30){
  if (!history || !Array.isArray(history.points)) return [];
  const pts = history.points
    .map(p => Array.isArray(p) ? { d: p[0], v: p[1] } : null)
    .filter(x => x && typeof x.v === "number" && Number.isFinite(x.v));

  if (pts.length < 2) return pts;

  // Use last N points (trading days). 30D ‚âà 22 trading days.
  const n = Math.min(pts.length, Math.max(10, Math.round(days * 0.72)));
  return pts.slice(-n);
}

function miCalcMovePct(points){
  if (!Array.isArray(points) || points.length < 2) return null;
  const first = points[0]?.v;
  const last  = points[points.length - 1]?.v;
  if (typeof first !== "number" || typeof last !== "number" || first === 0) return null;
  return ((last - first) / first) * 100;
}

function miCalcNearHighLow(points){
  if (!Array.isArray(points) || points.length < 2) return null;
  const vals = points.map(p => p.v).filter(v => Number.isFinite(v));
  if (vals.length < 2) return null;
  const lo = Math.min(...vals);
  const hi = Math.max(...vals);
  const last = vals[vals.length - 1];
  const range = hi - lo;
  if (range <= 0) return null;
  const pos = (last - lo) / range; // 0 near low, 1 near high
  return { lo, hi, last, pos };
}

function miRiskLabel({ latestPct, eps, netIncome, pe, dividendYield, move30d }) {
  // Very High if loss-making OR very volatile
  const lossLike =
    (typeof eps === "number" && eps < 0) ||
    (typeof netIncome === "number" && netIncome < 0);

  const veryVol =
    (typeof latestPct === "number" && Math.abs(latestPct) >= 8) ||
    (typeof move30d === "number" && Math.abs(move30d) >= 30);

  const highValStretch =
    (typeof pe === "number" && pe >= 40);

  const incomeStable =
    (typeof dividendYield === "number" && dividendYield >= 4) && !lossLike;

  if (lossLike || veryVol) return "Very High";
  if (highValStretch) return "High";
  if (incomeStable) return "Medium";
  return "High";
}

function miTimeframeLabel({ move30d }) {
  if (typeof move30d === "number" && Math.abs(move30d) >= 20) return "Days ‚Üí Weeks";
  return "Weeks ‚Üí Months";
}

function miBuildSlipBullets(data){
  const latest = data?.latest || {};
  const f = data?.fundamentals || {};
  const history = data?.history || null;

  const pts30 = miPickHistoryWindowPoints(history, 30);
  const move30 = miCalcMovePct(pts30);
  const hl = miCalcNearHighLow(pts30);

  const bullets = [];

  // 1) Movement (prefer 30D if available, else daily)
  if (typeof move30 === "number" && Number.isFinite(move30)) {
    bullets.push(`${move30 >= 0 ? "Up" : "Down"} ${Math.abs(move30).toFixed(0)}% in ~30D`);
  } else if (typeof latest.pctChange === "number" && Number.isFinite(latest.pctChange)) {
    bullets.push(`${latest.pctChange >= 0 ? "Up" : "Down"} ${Math.abs(latest.pctChange).toFixed(1)}% yesterday`);
  }

  // 2) ‚ÄúNear highs/lows‚Äù (bet-slip vibes)
  if (hl && typeof hl.pos === "number") {
    if (hl.pos >= 0.85) bullets.push("Near 30D highs");
    else if (hl.pos <= 0.15) bullets.push("Near 30D lows");
  }

  // 3) Valuation / quality
  const pe = (typeof f.pe === "number" && Number.isFinite(f.pe)) ? f.pe : null;
  const dy = (typeof f.dividendYield === "number" && Number.isFinite(f.dividendYield)) ? f.dividendYield : null;
  const eps = (typeof f.eps === "number" && Number.isFinite(f.eps)) ? f.eps : null;
  const ni  = (typeof f.netIncomeLastYear === "number" && Number.isFinite(f.netIncomeLastYear)) ? f.netIncomeLastYear : null;

  if (eps !== null && eps < 0) bullets.push("Loss-making (EPS < 0)");
  else if (ni !== null && ni < 0) bullets.push("Loss-making (net profit < 0)");
  else if (pe !== null) {
    if (pe <= 8) bullets.push(`P/E ~${pe.toFixed(1)}√ó (low multiple)`);
    else if (pe >= 40) bullets.push(`P/E ~${pe.toFixed(0)}√ó (high multiple)`);
    else bullets.push(`P/E ~${pe.toFixed(1)}√ó`);
  } else if (dy !== null && dy > 0) {
    bullets.push(`Yield ~${dy.toFixed(1)}%`);
  }

  // Fill remaining slots (exactly 3)
  const sector = f.sector ? String(f.sector) : null;
  const size = f.sizeBucket ? String(f.sizeBucket) : null;

  while (bullets.length < 3) {
    if (bullets.length === 2 && sector) bullets.push(`Sector: ${sector}`);
    else if (bullets.length === 2 && size) bullets.push(`${size.toUpperCase()} cap bucket`);
    else bullets.push("Volatility watch");
  }

  return {
    bullets: bullets.slice(0,3),
    move30d: move30,
    risk: miRiskLabel({
      latestPct: latest?.pctChange,
      eps,
      netIncome: ni,
      pe,
      dividendYield: dy,
      move30d: move30,
    }),
    timeframe: miTimeframeLabel({ move30d: move30 }),
  };
}

function miRenderSlipChart(history){
  const canvas = document.getElementById("mi-slip-chart");
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  const ptsObj = miPickHistoryWindowPoints(history, 30);
  const pts = ptsObj.map(p => p.v).filter(v => Number.isFinite(v));

  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  // Clean font stack
  const FONT = '600 11px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  const FONT_SM = '600 10px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';

  if (pts.length < 2) {
    ctx.fillStyle = "#9ca3af";
    ctx.font = FONT;
    ctx.fillText("No chart data", 12, 18);
    return;
  }

  const min = Math.min(...pts);
  const max = Math.max(...pts);
  const last = pts[pts.length - 1];

  const padX = 14;
  const padY = 16;
  const denom = (max - min) || 1;

  const xAt = (i) => padX + (i/(pts.length-1))*(w - padX*2);
  const yAt = (v) => h - padY - ((v - min)/denom)*(h - padY*2);

  const fmtPrice = (v) => {
    if (!Number.isFinite(v)) return "";
    if (v >= 1000) return v.toFixed(0);
    if (v >= 10) return v.toFixed(2);
    return v.toFixed(3);
  };

  // --- subtle midline (helps read the shape) ---
  ctx.strokeStyle = "rgba(148,163,184,0.10)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padX, Math.round(h/2));
  ctx.lineTo(w - padX, Math.round(h/2));
  ctx.stroke();

  // --- line ---
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#38bdf8";
  ctx.beginPath();
  pts.forEach((v,i)=>{
    const x = xAt(i);
    const y = yAt(v);
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // --- fill ---
  const grad = ctx.createLinearGradient(0, padY, 0, h);
  grad.addColorStop(0, "rgba(56,189,248,0.18)");
  grad.addColorStop(1, "rgba(56,189,248,0)");
  ctx.lineTo(w - padX, h - padY);
  ctx.lineTo(padX, h - padY);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // --- last point dot ---
  const lx = xAt(pts.length - 1);
  const ly = yAt(last);

  ctx.beginPath();
  ctx.arc(lx, ly, 3.2, 0, Math.PI * 2);
  ctx.fillStyle = "#38bdf8";
  ctx.fill();
}

// ---------- Invest Slip open/close ----------
function miOpenSlipFromCurrent(tablePctChange){
  const data = miLastInstrumentData;
  if (!data) return;

  const f = data.fundamentals || {};
  const latest = data.latest || {};
  const built = miBuildSlipBullets(data);

  document.getElementById("mi-slip-code").textContent = (data.code || "‚Äî") + ".ASX";
  document.getElementById("mi-slip-name").textContent = data.name || "‚Äî";

  const subBits = [];
  if (f.sector) subBits.push(f.sector);
  if (f.industry) subBits.push(f.industry);
  document.getElementById("mi-slip-sub").textContent = subBits.join(" ‚Ä¢ ") || "‚Äî";

  const px = (typeof latest.price === "number" && Number.isFinite(latest.price))
    ? miFormatCurrency(latest.price, f.currency || "AUD")
    : "‚Äî";
  document.getElementById("mi-slip-price").textContent = px;

const chgEl = document.getElementById("mi-slip-chg");
// Use table's pctChange if provided, otherwise fall back to API's latest.pctChange
const pct = (typeof tablePctChange === "number" && Number.isFinite(tablePctChange)) 
  ? tablePctChange 
  : (typeof latest.pctChange === "number" && Number.isFinite(latest.pctChange)) ? latest.pctChange : null;

if (pct == null) {
  chgEl.textContent = "‚Äî";
  chgEl.style.color = "#cbd5e1";
} else {
  chgEl.textContent = `${pct >= 0 ? "‚ñ≤" : "‚ñº"} ${miPct(pct, 2)} yesterday`;
  chgEl.style.color = pct >= 0 ? "#4ade80" : "#fb7185";
}

  document.getElementById("mi-slip-risk").textContent = `Risk: ${built.risk}`;

  const ul = document.getElementById("mi-slip-bullets");
  ul.innerHTML = built.bullets.map(b => `<li>${b}</li>`).join("");

  // Populate fundamentals section
  document.getElementById("mi-slip-fund-mktcap").textContent = 
    (typeof f.marketCap === "number" && Number.isFinite(f.marketCap)) 
      ? miFormatCompactNumber(f.marketCap) 
      : "‚Äî";
  
  document.getElementById("mi-slip-fund-revenue").textContent = 
    (typeof f.revenueLastYear === "number" && Number.isFinite(f.revenueLastYear)) 
      ? miFormatCompactNumber(f.revenueLastYear) 
      : "‚Äî";
  
  document.getElementById("mi-slip-fund-gp").textContent = 
    (typeof f.grossProfitLastYear === "number" && Number.isFinite(f.grossProfitLastYear)) 
      ? miFormatCompactNumber(f.grossProfitLastYear) 
      : "‚Äî";
  
  document.getElementById("mi-slip-fund-pe").textContent = 
    (typeof f.pe === "number" && Number.isFinite(f.pe)) 
      ? f.pe.toFixed(2) + "√ó" 
      : "‚Äî";
  
  document.getElementById("mi-slip-fund-pb").textContent = 
    (typeof f.priceToBook === "number" && Number.isFinite(f.priceToBook)) 
      ? f.priceToBook.toFixed(2) + "√ó" 
      : "‚Äî";
  
  document.getElementById("mi-slip-fund-ps").textContent = 
    (typeof f.priceToSales === "number" && Number.isFinite(f.priceToSales)) 
      ? f.priceToSales.toFixed(2) + "√ó" 
      : "‚Äî";

  miRenderSlipChart(data.history);

  // Set deep link URL
  const stockCode = data.code || "";
  const deepLinkUrl = stockCode 
    ? `${window.location.origin}${window.location.pathname}?stock=${encodeURIComponent(stockCode)}`
    : window.location.href;
  
  const deepLinkEl = document.getElementById("mi-slip-deeplink");
  if (deepLinkEl) {
    deepLinkEl.href = deepLinkUrl;
    // Extract hostname from URL for display
    const displayHost = window.location.hostname;
    deepLinkEl.textContent = stockCode ? `${displayHost}/...?stock=${stockCode}` : "‚Äî";
  }

  const overlay = document.getElementById("mi-slip-overlay");
  overlay.style.display = "flex";
  overlay.setAttribute("aria-hidden", "false");
}

function miCloseSlip(){
  const overlay = document.getElementById("mi-slip-overlay");
  if (!overlay) return;
  overlay.style.display = "none";
  overlay.setAttribute("aria-hidden", "true");
  
  // Also close the old instrument modal to ensure we return to the discover table
  const instrumentOverlay = document.getElementById("mi-instrument-overlay");
  if (instrumentOverlay) {
    instrumentOverlay.style.display = "none";
    instrumentOverlay.setAttribute("aria-hidden", "true");
  }
}
async function miShareSlip() {
  const el = document.querySelector(".mi-slip-modal");
  if (!el) return;

  const codeEl = document.getElementById("mi-slip-code");
  const codeText = (codeEl?.textContent || "Invest Slip").trim();

  // Strip exchange suffix (e.g. ".ASX")
  const stockCode = codeText.replace(/\.[A-Z0-9]+$/i, "").trim();

  const deepLinkUrl = stockCode
    ? `${window.location.origin}${window.location.pathname}?stock=${encodeURIComponent(stockCode)}`
    : `${window.location.origin}${window.location.pathname}`;

  const shareTitle = `Invest Slip ‚Äî ${codeText}`;
  // Keep text short (Messenger especially tends to drop/trim)
  const shareText = `Invest Slip ‚Äî ${codeText}\n${deepLinkUrl}`;

  // --- IMPORTANT: copy FIRST while we still have the click "gesture" ---
  // This massively increases the chance Android actually writes to clipboard.
  let clipboardOk = false;
  try {
    if (navigator.clipboard?.writeText) {
      await navigator.clipboard.writeText(deepLinkUrl);
      clipboardOk = true;
    }
  } catch (_) {
    clipboardOk = false;
  }

  // ---------- Attempt 1: Share image (best UX) ----------
  // Store close button reference for restoration
  let closeBtn = null;
  let closeBtnWasVisible = false;
  
  try {
    if (typeof html2canvas !== "function") throw new Error("html2canvas not available");

    // Hide close button before screenshot
    closeBtn = document.getElementById("mi-slip-close-btn");
    closeBtnWasVisible = closeBtn && getComputedStyle(closeBtn).display !== "none";
    if (closeBtn) closeBtn.style.display = "none";

    const canvas = await html2canvas(el, {
      backgroundColor: "#050812",
      scale: 2,
      useCORS: true,
      scrollX: 0,
      scrollY: -window.scrollY,
    });

    const blob = await new Promise((res) => canvas.toBlob(res, "image/png", 1.0));
    if (!blob) throw new Error("Image blob failed");

    const safeName = String(codeText).replace(/[^\w\-\.]+/g, "_").slice(0, 40);
    const file = new File([blob], `${safeName}.png`, { type: "image/png" });

    // Share file. Many apps (Messenger) ignore url/text when files are present.
    if (navigator.share && navigator.canShare?.({ files: [file] })) {
      await navigator.share({
        title: shareTitle,
        // Some apps ignore this with files; harmless to include
        text: shareText,
        url: deepLinkUrl,
        files: [file],
      });

      // After the share returns, remind user link is ready to paste
      if (clipboardOk) miSlipToast("Link copied ‚Äî paste into Messenger");
      else miSlipToast("Paste the link manually (copy failed)");

      return;
    }
  } catch (_) {
    // fall through
  } finally {
    // Always restore close button visibility
    if (closeBtn && closeBtnWasVisible) closeBtn.style.display = "";
  }

  // ---------- Attempt 2: Link-only share (most reliable for Messenger preview) ----------
  try {
    if (navigator.share) {
      await navigator.share({
        title: shareTitle,
        text: shareText,
        url: deepLinkUrl,
      });
      return;
    }
  } catch (_) {
    // fall through
  }

  // ---------- Attempt 3: Clipboard fallback ----------
  if (clipboardOk) {
    miSlipToast("Link copied to clipboard");
  } else {
    // Last resort
    alert(deepLinkUrl);
  }
}

function miSlipToast(msg) {
  let el = document.getElementById("mi-slip-toast");
  if (!el) {
    el = document.createElement("div");
    el.id = "mi-slip-toast";
    el.style.position = "fixed";
    el.style.left = "50%";
    el.style.bottom = "78px"; // sits above share bar
    el.style.transform = "translateX(-50%)";
    el.style.background = "rgba(2,6,23,0.94)";
    el.style.border = "1px solid rgba(148,163,184,0.18)";
    el.style.color = "#e5e7eb";
    el.style.padding = "10px 14px";
    el.style.borderRadius = "14px";
    el.style.fontSize = "12px";
    el.style.fontWeight = "800";
    el.style.zIndex = "10002";
    el.style.maxWidth = "92vw";
    el.style.textAlign = "center";
    el.style.opacity = "0";
    el.style.transition = "opacity 0.25s ease";
    document.body.appendChild(el);
  }

  el.textContent = msg;
  el.style.opacity = "1";

  clearTimeout(el._t);
  el._t = setTimeout(() => {
    el.style.opacity = "0";
  }, 2200);
}

// keep this binding
document.getElementById("mi-slip-share-btn")?.addEventListener("click", miShareSlip);

// Wire buttons (Invest Slip)
document.getElementById("mi-ins-slip-btn")?.addEventListener("click", () => {
  // Find the item in filteredItems to get the table's pctChange value
  if (miCurrentCode) {
    const tableItem = filteredItems.find(item => item.code === miCurrentCode);
    const tablePctChange = tableItem?.pctChange;
    miOpenSlipFromCurrent(tablePctChange);
  } else {
    miOpenSlipFromCurrent();
  }
});

document.getElementById("mi-slip-close-btn")?.addEventListener("click", miCloseSlip);
document.getElementById("mi-slip-overlay")?.addEventListener("click", (e) => {
  if (e.target && e.target.id === "mi-slip-overlay") miCloseSlip();
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") miCloseSlip();
});

// Wire Deep Dive button in slip
document.getElementById("mi-slip-deepdive-btn")?.addEventListener("click", () => {
  if (!miCurrentCode) return;
  window.location.href = `/stocks/${miCurrentCode}.html`;
});

      function miCloseInstrumentModal() {
        const overlay = document.getElementById("mi-instrument-overlay");
        if (!overlay) return;
        overlay.style.display = "none";
        overlay.setAttribute("aria-hidden", "true");
      }

      // Row clicks open invest slip directly
      tableBody.addEventListener("click", async (e) => {
        const row = e.target.closest("tr[data-code]");
        if (!row) return;

        const code = row.getAttribute("data-code");
        const type = row.getAttribute("data-type") || "equity";

        // Find the item in filteredItems to get the table's pctChange value
        const tableItem = filteredItems.find(item => item.code === code);
        const tablePctChange = tableItem?.pctChange;

        try {
          const data = await miFetchInstrumentDetails(type, code);
          // Store data for slip to use
          miLastInstrumentData = data;
          miCurrentCode = data.code || data.ticker || null;
          // Open invest slip directly, passing the table's pctChange
          miOpenSlipFromCurrent(tablePctChange);
        } catch (err) {
          console.error("Failed to load instrument details", err);
          alert("Sorry, we couldn't load that company at the moment.");
        }
      });

      // Close handlers
      document.getElementById("mi-ins-close-btn")?.addEventListener("click", miCloseInstrumentModal);

      document.getElementById("mi-instrument-overlay")?.addEventListener("click", (e) => {
        if (e.target.id === "mi-instrument-overlay") miCloseInstrumentModal();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") miCloseInstrumentModal();
      });

      document.getElementById("mi-ins-details-btn")?.addEventListener("click", () => {
        if (!miCurrentCode) return;
        window.location.href = `/stocks/${miCurrentCode}.html`;
      });
    // ----------------------------
// Market Pulse cards loader
// ----------------------------
function mpEl(id) { return document.getElementById(id); }

function mpEscape(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function mpFmtPct(x, dp = 2) {
  if (typeof x !== "number" || !Number.isFinite(x)) return "‚Äî";
  const sign = x > 0 ? "+" : "";
  return `${sign}${x.toFixed(dp)}%`;
}

function mpFormatAUD(n) {
  if (typeof n !== "number" || !Number.isFinite(n)) return "‚Äî";
  const abs = Math.abs(n);
  if (abs >= 1e9) return `$${(n / 1e9).toFixed(2)}B`;
  if (abs >= 1e6) return `$${(n / 1e6).toFixed(2)}M`;
  if (abs >= 1e3) return `$${(n / 1e3).toFixed(0)}k`;
  return `$${Math.round(n)}`;
}

function mpSetBar(spanId, pct) {
  const s = mpEl(spanId);
  if (!s) return;
  const clamped =
    typeof pct === "number" && Number.isFinite(pct) ? Math.max(0, Math.min(100, pct)) : 50;
  s.style.width = clamped.toFixed(0) + "%";
}

function mpFormatDate(dateStr) {
  if (!dateStr) return null;
  try {
    // Parse YYYY-MM-DD format
    const parts = String(dateStr).split("-");
    if (parts.length !== 3) return null;
    const [year, month, day] = parts.map(p => parseInt(p, 10));
    if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
    
    // Validate the date is real (e.g., not Feb 30th)
    const testDate = new Date(year, month - 1, day);
    if (testDate.getFullYear() !== year || 
        testDate.getMonth() !== month - 1 || 
        testDate.getDate() !== day) {
      return null;
    }
    
    // Format as DD/MM/YYYY
    const dd = String(day).padStart(2, "0");
    const mm = String(month).padStart(2, "0");
    const yyyy = String(year);
    return `${dd}/${mm}/${yyyy}`;
  } catch {
    return null;
  }
}

function mpMarketMood(breadthPct) {
  if (typeof breadthPct !== "number" || !Number.isFinite(breadthPct)) {
    return { label: "‚Äî", sub: "‚Äî" };
  }
  if (breadthPct >= 55) return { label: "Positive", sub: `${breadthPct.toFixed(0)}% of stocks up` };
  if (breadthPct <= 45) return { label: "Negative", sub: `${breadthPct.toFixed(0)}% of stocks up` };
  return { label: "Mixed", sub: `${breadthPct.toFixed(0)}% of stocks up` };
}

function mpRenderList(listId, rows) {
  const ul = mpEl(listId);
  if (!ul) return;

  ul.innerHTML = "";
  if (!Array.isArray(rows) || rows.length === 0) {
    ul.innerHTML = `<li class="mover-row"><div class="mover-left"><div class="mover-code">‚Äî</div><div class="mover-name">‚Äî</div></div><span class="pct">‚Äî</span></li>`;
    return;
  }

  for (const r of rows) {
    const code = r?.code ? String(r.code) : "‚Äî";
    const name = r?.name ? String(r.name) : "";
    const pct = typeof r?.pct === "number" && Number.isFinite(r.pct) ? r.pct : null;

    const pctText = pct == null ? "‚Äî" : pct >= 0 ? `+${pct.toFixed(2)}%` : `${pct.toFixed(2)}%`;
    const pctClass = pct == null ? "" : pct >= 0 ? "up" : "down";

    ul.insertAdjacentHTML(
      "beforeend",
      `
      <li class="mover-row">
        <div class="mover-left">
          <div class="mover-code">${mpEscape(code)}</div>
          <div class="mover-name" title="${mpEscape(name)}">${mpEscape(name)}</div>
        </div>
        <span class="pct ${pctClass}">${pctText}</span>
      </li>
      `
    );
  }
}

async function loadMarketPulseCards(period = "1d") {
  try {
    const res = await fetch(`/.netlify/functions/market-pulse-read?period=${encodeURIComponent(period)}`, { cache: "no-store" });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.error || "Failed to load pulse");

    // Update date header
    const dateHeader = mpEl("mpDateHeader");
    if (dateHeader) {
      const formattedDate = mpFormatDate(data.asOfDate);
      if (formattedDate) {
        // Check if the data is from today by comparing with current date (using UTC to avoid timezone issues)
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Normalize to start of day
        
        const asOfParts = String(data.asOfDate).split("-");
        const asOfDate = asOfParts.length === 3 
          ? new Date(parseInt(asOfParts[0]), parseInt(asOfParts[1]) - 1, parseInt(asOfParts[2]))
          : null;
        
        if (asOfDate) {
          asOfDate.setHours(0, 0, 0, 0); // Normalize to start of day
        }
        
        const isToday = asOfDate && asOfDate.getTime() === today.getTime();
        
        dateHeader.textContent = isToday 
          ? `Market data as of ${formattedDate}`
          : `Previous trading day: ${formattedDate}`;
      } else {
        dateHeader.textContent = "Market data";
      }
    }

    if (mpEl("mpAsOf")) mpEl("mpAsOf").textContent = data.asOfDate ? `As of ${data.asOfDate}` : "As of ‚Äî";
    if (mpEl("mpUniverse")) mpEl("mpUniverse").textContent = `Universe: ${data.universeCount ?? "‚Äî"}`;

    if (mpEl("mpXJO")) mpEl("mpXJO").textContent =
      (data.asx200 && typeof data.asx200.pct === "number") ? mpFmtPct(data.asx200.pct, 2) : "‚Äî";

    const mood = mpMarketMood(data.breadthPct);
    if (mpEl("mpMood")) mpEl("mpMood").textContent = mood.label;
    if (mpEl("mpMoodSub")) mpEl("mpMoodSub").textContent = mood.sub;

    if (mpEl("mpAD")) mpEl("mpAD").textContent = `${data.advancers ?? "‚Äî"} / ${data.decliners ?? "‚Äî"}`;
    const den = (data.advancers ?? 0) + (data.decliners ?? 0);
    const adPct = den > 0 ? ((data.advancers ?? 0) / den) * 100 : null;
    mpSetBar("mpADBar", adPct);

    if (mpEl("mpTurnover")) mpEl("mpTurnover").textContent = mpFormatAUD(data.totalTurnoverAud);
    if (mpEl("mpCoverage")) mpEl("mpCoverage").textContent =
      data.turnoverCoverage != null ? `Coverage: ${data.turnoverCoverage} stocks (price√óvolume)` : "Coverage: ‚Äî";

    mpRenderList("mpGainers", data.topGainers);
    mpRenderList("mpLosers", data.topLosers);

    // Start collapsed on mobile
    const movers = document.getElementById("mpMovers");
    if (movers && window.innerWidth <= 640) movers.removeAttribute("open");
  } catch (e) {
    console.warn("Market Pulse cards failed:", e?.message || e);
  }
}
// ----------------------------------------------------
// Across Markets click -> toggle tag filter
document.getElementById("acrossItems")?.addEventListener("click", (e) => {
  const chip = e.target.closest(".across-chip");
  if (!chip) return;

  const tag = chip.getAttribute("data-tag") || "";
  if (!tag) return; // chips without tags do nothing

  // Toggle on/off
  activeAcrossTag = (normalizeTag(activeAcrossTag) === normalizeTag(tag)) ? null : tag;

  // Optional: clear presets so they don't "fight" the user‚Äôs intent
  clearPresetUI();

  setAcrossActiveUI();
  applyFilters();
});

// kick it off
loadMarketPulseCards("1d"); 
      loadAcrossMarkets();

    </script>

    <!-- Chart.js library -->
<!-- Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>


    <!-- Sector Chart Module -->
    <script>
    (function() {
      function sectorChartModule() {
        const canvas = document.getElementById("sectorChart");
        const msg = document.getElementById("sectorChartMessage");
        const meta = document.getElementById("sectorChartMeta");
        const buttons = document.querySelectorAll(".sector-chart-wrap .mi-toggle button");
        const sectorSelect = document.getElementById("sectorSelect");
        
        if (!canvas) return;

        let chart = null;
        const cache = new Map();
        const inflight = new Map();

        function showMessage(text) {
          msg.textContent = text;
          msg.style.display = "block";
          canvas.style.display = "none";
        }
        
        function hideMessage() {
          msg.style.display = "none";
          canvas.style.display = "block";
        }
        
        function labelFor(period) {
          if (period === "1d") return "1D";
          if (period === "5d") return "5D";
          if (period === "1m") return "1M";
          return period;
        }

        function isMobile() {
          return window.innerWidth <= 640;
        }

        function shortenSectorLabel(label) {
          if (!isMobile() || typeof label !== "string") return label;

          return label
            .replace("Communication Services", "Comm Services")
            .replace("Consumer Defensive", "Cons Defensive")
            .replace("Consumer Cyclical", "Cons Cyclical")
            .replace("Financial Services", "Fin Services")
            .replace("Basic Materials", "Materials");
        }

        function fmtTick(v) {
          const n = Number(v);
          if (!Number.isFinite(n)) return `${v}%`;
          const r = Math.round(n * 10) / 10;
          const clean = Math.abs(r) < 0.05 ? 0 : r;
          return `${clean.toFixed(1)}%`;
        }

        function applyToChart(json, period) {
          const rows = Array.isArray(json.sectors) ? json.sectors : [];
          if (!rows.length) throw new Error("No sector data");

          const labels = rows.map((r) => shortenSectorLabel(r.sector));
          const fullLabels = rows.map((r) => r.sector); // Store full labels for filtering
          const valuesPct = rows.map((r) => Number(r.value) * 100);

          const bg = valuesPct.map((v) =>
            v >= 0 ? "rgba(34,197,94,0.70)" : "rgba(239,68,68,0.70)"
          );
          const border = valuesPct.map((v) =>
            v >= 0 ? "rgba(34,197,94,1)" : "rgba(239,68,68,1)"
          );

          const baseOptions = {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            animation: false,
            layout: {
              padding: { left: isMobile() ? 10 : 6, right: 8, top: 0, bottom: 0 },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const v = Number(ctx.raw);
                    const sign = v > 0 ? "+" : "";
                    return `${sign}${v.toFixed(2)}%`;
                  },
                },
              },
            },
            scales: {
              x: {
                grid: { color: "rgba(15,23,42,0.06)" },
                ticks: { callback: (v) => fmtTick(v) },
              },
              y: {
                grid: { display: false },
                ticks: { padding: isMobile() ? 6 : 8 },
              },
            },
            onClick: (event, elements) => {
              // Make chart clickable - filter by sector when bar is clicked
              if (elements.length > 0) {
                const index = elements[0].index;
                // Use chart.fullLabels to get current period's sector data
                const sector = chart && chart.fullLabels ? chart.fullLabels[index] : fullLabels[index];
                
                // Set the sector dropdown to the clicked sector
                if (sectorSelect) {
                  sectorSelect.value = sector;
                  
                  // Trigger change event to apply filter
                  const changeEvent = new Event('change', { bubbles: true });
                  sectorSelect.dispatchEvent(changeEvent);
                  
                  // Scroll to the table so user can see the filtered results
                  const tableWrapper = document.querySelector('.table-wrapper');
                  if (tableWrapper) {
                    tableWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
                  }
                }
              }
            },
          };

          if (!chart) {
            chart = new Chart(canvas, {
              type: "bar",
              data: {
                labels,
                datasets: [
                  {
                    data: valuesPct,
                    backgroundColor: bg,
                    borderColor: border,
                    borderWidth: 1,
                    borderRadius: 8,
                    barThickness: 14,
                  },
                ],
              },
              options: baseOptions,
            });

            // Store full labels for click handling
            chart.fullLabels = fullLabels;

            window.addEventListener("resize", () => {
              if (!chart || !chart.fullLabels?.length) return;
              chart.data.labels = chart.fullLabels.map((l) => shortenSectorLabel(l));
              chart.options.layout.padding.left = isMobile() ? 10 : 6;
              chart.options.scales.y.ticks.padding = isMobile() ? 6 : 8;
              chart.update("none");
            });
          } else {
            chart.data.labels = labels;
            chart.fullLabels = fullLabels;
            chart.data.datasets[0].data = valuesPct;
            chart.data.datasets[0].backgroundColor = bg;
            chart.data.datasets[0].borderColor = border;

            chart.options.layout.padding.left = isMobile() ? 10 : 6;
            chart.options.scales.y.ticks.padding = isMobile() ? 6 : 8;

            chart.update("none");
          }

          meta.textContent =
            `${labelFor(period)} ¬∑ As of ${json.asOf}` +
            (json.baseDate ? ` (vs ${json.baseDate})` : "");
        }


        async function fetchPeriod(period) {
          if (cache.has(period)) return cache.get(period);
          if (inflight.has(period)) return inflight.get(period);

          const p = (async () => {
const res = await fetch(`/.netlify/functions/get-sector-performance?period=${period}&_=${Date.now()}`, {
  cache: "no-store",
});
            const json = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(json?.error || "Not available");
            cache.set(period, json);
            return json;
          })();

          inflight.set(period, p);
          try {
            return await p;
          } finally {
            inflight.delete(period);
          }
        }

        async function load(period) {
          buttons.forEach((b) => b.classList.toggle("active", b.dataset.period === period));
          hideMessage();
          meta.textContent = "Loading‚Ä¶";

          try {
            const json = await fetchPeriod(period);
            applyToChart(json, period);
          } catch (e) {
            showMessage("Not enough history yet for this period.");
            meta.textContent = "‚Äî";
          }
        }

buttons.forEach((btn) =>
  btn.addEventListener("click", () => {
    const p = btn.dataset.period || "1d";
    load(p);                 // sector chart
    loadMarketPulseCards(p); // market pulse cards
  })
);
        
        // Load default period and prefetch others
        load("1d").then(() => Promise.allSettled([fetchPeriod("5d"), fetchPeriod("1m")]));
      }

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', sectorChartModule);
      } else {
        sectorChartModule();
      }
    })();
    </script>

    <script>
  // Mobile nav toggle (matches CSS: body.nav-open header.nav nav {...})
  (function () {
    const btn = document.querySelector(".menu-btn");
    const body = document.body;
    const nav = document.querySelector("header.nav nav");
    if (!btn || !nav) return;

    btn.addEventListener("click", function () {
      body.classList.toggle("nav-open");
    });

    // Close menu when a nav link is tapped
    nav.addEventListener("click", function (evt) {
      const target = evt.target;
      if (target && target.tagName.toLowerCase() === "a") {
        body.classList.remove("nav-open");
      }
    });
  })();
</script>

    <!-- REPEAT USER TRACKING (Option 1) -->
    <script>
      (() => {
        const KEY = "mates_user_id_v1";

        let uid = localStorage.getItem(KEY);
        if (!uid) {
          uid = (crypto?.randomUUID?.() || String(Math.random()).slice(2) + Date.now());
          localStorage.setItem(KEY, uid);
        }

        fetch("/.netlify/functions/track-visit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            uid,
            path: window.location.pathname,
            ts: Date.now()
          })
        }).catch(() => {});
      })();
    </script>

  </body>
</html>
