<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>MatesFeed â€“ Plain-English market summaries | MatesInvest</title>
  <meta name="description" content="MatesFeed delivers live market headlines and plain-English AI summaries built for Australian retail investors.">

  <link rel="icon" type="image/png" href="/assets/img/favicon.png">
  <link rel="apple-touch-icon" href="/assets/img/favicon.png">

  <style>
    :root{
      --navy: #002040;
      --cyan: #00BFFF;
      --bg: #f5f7fb;
      --card: #ffffff;
      --muted: #64748b;
      --muted-2: #94a3b8;
      --accent: var(--cyan);
      --accent-strong: #0093cc;
      --accent-soft: rgba(0,191,255,0.10);
      --border: #e2e8f0;
      --card-border: #e2e8f0;
      --glass: rgba(255,255,255,0.9);
      --radius: 18px;
      --gap: 1rem;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(circle at top left, #e2ebff 0, #f5f7fb 55%);
      color:#0b1220;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.4;
      padding-bottom:3rem;
    }

    .page-shell{
      max-width:1080px;
      margin:0 auto;
      padding:1.5rem 1.25rem 3rem;
      position:relative;
    }

    /* Decorative square pattern in top-right */
    .corner-pattern {
      position:absolute;
      top:-18px;
      right:0;
      width:150px;
      height:150px;
      background:
        linear-gradient(135deg, rgba(0,191,255,0.25), rgba(0,32,64,0.05)),
        linear-gradient(90deg, rgba(148,163,184,0.35) 1px, transparent 1px),
        linear-gradient(180deg, rgba(148,163,184,0.35) 1px, transparent 1px);
      background-size: 100% 100%, 18px 18px, 18px 18px;
      border-radius: 24px;
      opacity:0.7;
      pointer-events:none;
      z-index:-1;
    }

    /* Accessible visually-hidden utility (keeps H1 for SEO / screen readers) */
    .visually-hidden {
      position: absolute !important;
      height: 1px;
      width: 1px;
      overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap;
      border: 0;
      padding: 0;
      margin: -1px;
    }

    /* NAV â€“ aligned to main site/app */
    .nav{
      position:sticky;
      top:0;
      z-index:30;
      backdrop-filter: blur(12px);
      background: rgba(255,255,255,0.96);
      border-bottom: 1px solid #eef1f6;
    }
    .nav-inner{
      max-width:1080px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
      padding:0.7rem 1.25rem;
    }
    .nav-left{display:flex;align-items:center;gap:0.75rem}
    .nav-logo{height:40px;width:40px;border-radius:10px;object-fit:cover}
    .nav-title{font-weight:700;font-size:1.05rem;color:var(--navy)}
    .nav-pill{
      padding:0.15rem 0.65rem;
      border-radius:999px;
      font-size:0.75rem;
      background:#e7f7ff;
      color:#083a59;
      border:1px solid #c5e5ff;
    }
    .nav-right{
      font-size:0.82rem;
      color:var(--muted);
      display:flex;
      gap:0.75rem;
      align-items:center
    }
    .nav-home-link{
      padding:0.4rem 0.9rem;
      border-radius:999px;
      border:1px solid #cfd8e3;
      text-decoration:none;
      color:#0b1220;
      background:#ffffff;
      font-weight:600;
      font-size:0.86rem;
    }
    .nav-home-link:hover{
      background:#f3f6fb;
    }

    /* Generic card */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding:1.25rem 1.4rem;
      margin-bottom:1.1rem;
      border:1px solid var(--card-border);
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
    }
    .card h2{
      margin:0;
      font-size:1.25rem;
      color:var(--navy);
    }

    /* Morning brief header */
    .brief-header {
      display:flex;
      align-items:center;
      gap:0.75rem;
      justify-content:space-between;
    }
    .brief-header small {
      color:var(--muted);
    }
    .brief-controls {
      display:flex;
      gap:0.5rem;
      align-items:center;
    }
    .brief-toggle {
      padding:0.4rem 0.8rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:#ffffff;
      color:var(--muted);
      cursor:pointer;
      font-size:0.85rem;
    }
    .brief-toggle.primary {
      background:var(--accent);
      color:#001220;
      font-weight:700;
      border:1px solid rgba(0,0,0,0.04);
    }

    .brief-content {
      margin-top:0.9rem;
      display:none;
    }
    .brief-loading {
      color:var(--muted);
      font-size:0.95rem;
    }

    /* Top meta (As of / source) */
    .brief-top-meta {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
      color:var(--muted);
      font-size:0.9rem;
    }

    /* Percent badges */
    .brief-badge {
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-weight:700;
      font-size:0.9rem;
    }
    .brief-badge.up {
      background:rgba(22,163,74,0.08);
      color:#15803d;
      border:1px solid rgba(22,163,74,0.25);
    }
    .brief-badge.down {
      background:rgba(220,38,38,0.06);
      color:#b91c1c;
      border:1px solid rgba(220,38,38,0.22);
    }
    .brief-badge.neutral {
      background:rgba(148,163,184,0.1);
      color:#475569;
    }
    .brief-badge.no-data {
      background:transparent;
      color:var(--muted);
      font-weight:600;
      border-radius:999px;
      padding:3px 6px;
      opacity:0.9;
    }

    /* Morning brief grid & cards */
    .brief-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      margin-top: 8px;
      align-items: start;
    }

    .brief-top-cards {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width:800px) {
      .brief-top-cards { grid-template-columns: 1fr; }
    }

      .card-metal {
      padding: 0.9rem 1rem;
      border-radius: 16px;
      background: #f9fbff;
      border: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 84px;
      box-shadow: 0 14px 30px rgba(15,23,42,0.10);
      transition: transform 140ms ease, box-shadow 140ms ease, background 140ms ease;
      color:#0f172a;
    }
    .card-metal:hover {
      transform: translateY(-3px);
      background:#ffffff;
      box-shadow: 0 18px 40px rgba(15,23,42,0.16);
    }
    .metal-head {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .metal-name {
      font-size:0.9rem;
      font-weight:600;
      color:#0f172a;
    }
    .metal-price {
      font-weight:800;
      font-size:1.05rem;
      color:#0f172a;
      margin-top:4px;
    }
    .metal-sub {
      font-size:0.82rem;
      color:var(--muted-2);
    }

    /* Mates Morning Note & SOTD cards */
    .mates-note {
      background:#f9fbff;
      border: 1px solid #dbeafe;
      padding: 0.9rem 1rem;
      border-radius: 14px;
    }
    .mates-note-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:0.4rem;
    }
    .mates-note-header .pill {
      background: var(--accent-soft);
      color: var(--accent-strong);
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      border:1px solid rgba(0,191,255,0.35);
    }
    .mates-note-body { font-size:0.92rem; color:#0b1220; line-height:1.45; }
    .mates-note .timestamp { font-size:0.78rem; color: var(--muted-2); }

    .sotd-card {
      background:#f9fbff;
      border: 1px solid #dbeafe;
      border-radius: 14px;
      padding: 0.9rem 1rem;
    }
    .sotd-header { display:flex; justify-content:space-between; align-items:center; gap:0.75rem; flex-wrap:wrap; margin-bottom:0.4rem; }
    .sotd-title-left { display:flex; align-items:center; gap:0.4rem; flex-wrap:wrap; }
    .sotd-pill { background: var(--accent-soft); color: var(--accent-strong); padding: 3px 10px; border-radius: 999px; font-size: 0.78rem; border:1px solid rgba(0,191,255,0.35); }
    .sotd-ticker { font-weight:600; letter-spacing:0.04em; font-size:0.9rem; color:var(--navy); }
    .sotd-name { font-size:0.9rem; color:var(--muted); }
    .sotd-exchange { font-size:0.8rem; color:var(--muted-2); }
    .sotd-summary { font-size:0.9rem; line-height:1.45; color:#0b1220; margin-bottom:0.35rem; }
    .sotd-disclaimer { font-size:0.78rem;color:var(--muted-2); }

    /* Top performers UI */
    .top-performers {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }
    .perf-card {
      background:#f9fafb;
      border: 1px solid #e2e8f0;
      padding: 10px;
      border-radius: 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:72px;
      justify-content:center;
    }
    .perf-top { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .perf-symbol { font-weight:800; font-size:1rem; color:#0f172a; }
    .perf-exch { font-size:0.78rem; color:var(--muted-2); }
    .perf-last { font-size:0.95rem; font-weight:700; color:#0f172a; }
    .perf-pct { font-weight:700; font-size:0.86rem; padding:4px 8px; border-radius:999px; align-self:flex-start; }
    .perf-pct.up { background: rgba(22,163,74,0.06); color: #15803d; border: 1px solid rgba(22,163,74,0.22); }
    .perf-pct.down { background: rgba(220,38,38,0.06); color: #b91c1c; border: 1px solid rgba(220,38,38,0.22); }
    .perf-pct.neutral { background:rgba(148,163,184,0.08); color:#475569; }
    .perf-note { color:var(--muted-2); font-size:0.82rem; }
    @media (max-width:560px) {
      .top-performers { grid-template-columns: repeat(2, 1fr); }
    }

    /* Controls & chips */
    .controls {
      display:flex;
      gap:var(--gap);
      align-items:center;
      flex-wrap:wrap;
      margin-top:0.6rem;
    }
    .segmented {
      display:inline-flex;
      background:#f1f5f9;
      border-radius:999px;
      padding:3px;
      gap:4px;
      border:1px solid var(--border);
    }
    .segmented button{
      background:transparent;
      border:0;
      padding:0.45rem 0.85rem;
      color:var(--muted);
      border-radius:999px;
      cursor:pointer;
      font-size:0.88rem;
      transition: all .16s ease;
    }
    .segmented button.active{
      background: linear-gradient(180deg,var(--accent), var(--accent-strong));
      color:#001220;
      box-shadow: 0 6px 18px rgba(15,23,42,0.2);
    }

    .chip-row{
      display:flex;
      gap:0.5rem;
      flex-wrap:wrap;
      margin-top:0.6rem;
    }
    .chip{
      padding:0.32rem 0.7rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:#ffffff;
      color:var(--muted);
      cursor:pointer;
      font-size:0.82rem;
      transition: all .14s ease;
    }
    .chip:hover{background:#f8fafc}
    .chip-active{
      background:var(--accent-soft);
      color:#001220;
      border-color:var(--accent);
      font-weight:600;
    }

    .sport-row{
      display:flex;
      gap:0.5rem;
      flex-wrap:wrap;
      margin-top:0.6rem;
    }
    .sport-chip{
      padding:0.28rem 0.6rem;
      border-radius:999px;
      border:1px solid #e2e8f0;
      background:#f9fafb;
      color:var(--muted);
      cursor:pointer;
      font-size:0.82rem;
    }
    .sport-chip.active{
      background:#e0f2fe;
      border-color:#bae6fd;
      color:#0b1220;
      box-shadow:0 1px 0 rgba(15,23,42,0.07);
    }
    .sport-tag{
      display:inline-block;
      padding:0.12rem 0.5rem;
      border-radius:999px;
      background:#e2e8f0;
      font-size:0.78rem;
      color:#475569;
      border:1px solid #cbd5e1;
    }

    /* News list */
    #newsList{
      margin-top:0.85rem;
      display:flex;
      flex-direction:column;
      gap:0.85rem;
    }
    .headline{
      display:block;
      padding:0.95rem;
      border-radius:12px;
      background:#f9fbff;
      border:1px solid #e2e8f0;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .headline:hover{
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(15,23,42,0.18);
      background:#ffffff;
    }

    .meta-row{
      display:flex;
      align-items:center;
      gap:0.6rem;
      justify-content:space-between;
    }
    .meta-left{
      display:flex;
      align-items:center;
      gap:0.65rem;
      min-width:0;
    }
    .headline h3{
      margin:0 0 0.25rem 0;
      font-size:1rem;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      color:#0b1220;
    }
    .headline small{
      color:var(--muted-2);
      font-size:0.82rem;
      display:block;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .headline .actions{
      display:flex;
      gap:0.6rem;
      align-items:center;
      margin-top:0.6rem;
    }

    .btn{
      background:var(--accent);
      border:none;
      padding:0.5rem 0.95rem;
      border-radius:999px;
      cursor:pointer;
      color:#001220;
      font-weight:700;
      font-size:0.86rem;
      transition: transform .08s ease, opacity .12s ease, box-shadow .12s ease;
      box-shadow:0 5px 14px rgba(15,23,42,0.22);
    }
    .btn:active{ transform: translateY(1px) }
    .btn:disabled{ opacity:0.6; cursor:default }

    .link-min{
      background:#ffffff;
      border:1px solid var(--border);
      color:#0b1220;
      padding:0.42rem 0.7rem;
      border-radius:999px;
      text-decoration:none;
      font-size:0.83rem;
    }
    .link-min:hover{ background:#f8fafc }

    .summary-output{ margin-top:0.65rem }

    .summary-block{
      margin-top:0.45rem;
      border-top:1px dashed #e2e8f0;
      padding-top:0.6rem;
      font-size:0.95rem;
      color:#0b1220;
    }
    .summary-block p{margin:0.45rem 0}
    .tldr-list{
      margin:0.35rem 0 0 0.85rem;
      padding:0;
      list-style:none;
      color:var(--muted);
    }
    .tldr-list li{
      margin:0.25rem 0;
      position:relative;
      padding-left:1.05rem;
    }
    .tldr-list li::before{
      content:"";
      width:8px;height:8px;
      border-radius:2px;
      background:var(--accent);
      position:absolute;
      left:0.15rem;
      top:0.55rem;
      box-shadow:0 1px 0 rgba(15,23,42,0.25);
    }

    .summary-meta{
      color:var(--muted-2);
      font-size:0.82rem;
      margin-top:0.45rem;
    }

    /* Timeline & stats styles */
    .event-timeline {
      display:flex;
      flex-direction:column;
      gap:0.45rem;
      margin-top:0.4rem;
    }
    .timeline-item {
      display:flex;
      gap:0.6rem;
      align-items:flex-start;
      font-size:0.92rem;
      color:var(--muted-2);
    }
    .timeline-bullet {
      width:10px;
      height:10px;
      border-radius:999px;
      background:var(--accent);
      margin-top:4px;
      flex-shrink:0;
    }
    .timeline-min {
      width:36px;
      color:var(--muted);
      font-weight:600;
    }
    .lineup-block {
      background:#f9fafb;
      padding:0.6rem;
      border-radius:8px;
      margin-top:0.5rem;
      color:var(--muted-2);
      border:1px solid #e2e8f0;
    }
    .stat-row {
      display:flex;
      gap:1rem;
      flex-wrap:wrap;
      color:var(--muted-2);
      font-size:0.92rem;
      margin-top:0.45rem;
    }
    .stat-pill {
      padding:0.18rem 0.6rem;
      border-radius:999px;
      background:#f9fafb;
      border:1px solid #e2e8f0;
    }

    .skeleton{
      background:linear-gradient(90deg, #e5e7eb, #f3f4f6, #e5e7eb);
      border-radius:8px;
      height:68px;
      animation: shimmer 1.2s linear infinite;
      background-size:220px 100%;
    }
    @keyframes shimmer{
      0%{ background-position:-120px 0 }
      100%{ background-position:220px 0 }
    }

    @media (max-width:640px){
      .meta-row{ flex-direction:column; align-items:flex-start; gap:0.5rem }
      .headline h3{
        white-space:normal;
        display:-webkit-box;
        -webkit-line-clamp:2;
        -webkit-box-orient:vertical;
        overflow:hidden;
      }
    }

    /* MOBILE tidy-up */
    @media (max-width: 480px) {
      .page-shell { padding: 0.9rem 1rem 2rem; }

      .nav-inner { padding: 0.55rem 1rem; gap:0.5rem; }
      .nav-logo { height:32px; width:32px; }
      .nav-title { font-size:0.98rem; }
      .nav-pill { display:none; }
      .nav-right { font-size:0.78rem; gap:0.5rem; }

      .brief-header {
        flex-direction: column;
        align-items:flex-start;
        gap:0.6rem;
      }
      .brief-controls {
        width:100%;
        flex-wrap:wrap;
      }

      .card { padding:1rem; border-radius:16px; }
      .card-metal { padding:0.7rem; min-height:72px; }

      .chip-row {
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
        padding-bottom:6px;
      }
      .chip { white-space:nowrap; }

      .btn, .link-min { padding:0.42rem 0.75rem; font-size:0.82rem; }

      body { padding-bottom:2rem; }
    }
    /* Overlay */
.mi-ins-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.55); /* slate-ish overlay */
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* Modal */
.mi-ins-modal {
  background: #0b1020;
  color: #f9fafb;
  border-radius: 18px;
  max-width: 700px;
  width: 100%;
  padding: 20px 22px 22px;
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
  border: 1px solid rgba(148, 163, 184, 0.25);
  position: relative;
}

/* Close button */
.mi-ins-close {
  position: absolute;
  top: 10px;
  right: 12px;
  border: none;
  background: transparent;
  color: #9ca3af;
  font-size: 18px;
  cursor: pointer;
}
.mi-ins-close:hover {
  color: #e5e7eb;
}

/* Header */
.mi-ins-header {
  display: flex;
  justify-content: space-between;
  gap: 16px;
  margin-bottom: 14px;
}

.mi-ins-title {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
}

.mi-ins-subtitle {
  margin-top: 4px;
  font-size: 13px;
  color: #9ca3af;
}

/* Price block */
.mi-ins-price-block {
  text-align: right;
}

.mi-ins-price {
  font-size: 20px;
  font-weight: 600;
}

.mi-ins-change {
  font-size: 13px;
  margin-top: 2px;
}

.mi-ins-change.up {
  color: #4ade80; /* green-ish */
}

.mi-ins-change.down {
  color: #f97373; /* red-ish */
}

.mi-ins-date {
  font-size: 11px;
  color: #6b7280;
  margin-top: 3px;
}

/* Tags */
.mi-ins-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 16px;
}

.mi-ins-tag {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 999px;
  background: rgba(31, 41, 55, 0.85);
  color: #e5e7eb;
  border: 1px solid rgba(55, 65, 81, 0.9);
}

/* Sections */
.mi-ins-section {
  margin-bottom: 14px;
}

.mi-ins-section-title {
  font-size: 13px;
  font-weight: 600;
  margin: 0 0 8px;
  color: #d1d5db;
}

/* Stats grid */
.mi-ins-stats-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px 16px;
}

.mi-ins-stat-item {
  font-size: 12px;
}

.mi-ins-stat-label {
  color: #9ca3af;
  display: block;
  margin-bottom: 2px;
}

.mi-ins-stat-value {
  font-weight: 500;
}

/* History placeholder */
.mi-ins-history-summary {
  font-size: 12px;
  color: #9ca3af;
  margin-bottom: 6px;
}

.mi-ins-history-placeholder {
  font-size: 11px;
  color: #6b7280;
  padding: 10px;
  border-radius: 12px;
  border: 1px dashed rgba(75, 85, 99, 0.8);
}

/* Mobile */
@media (max-width: 640px) {
  .mi-ins-modal {
    margin: 10px;
    padding: 16px 14px 18px;
  }

  .mi-ins-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .mi-ins-price-block {
    text-align: left;
  }

  .mi-ins-stats-grid {
    grid-template-columns: 1fr;
  }
}
    #mi-ins-chart {
  width: 100%;
  height: 220px;
  margin-top: 10px;
}

  </style>

</head>

<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="nav-left">
        <img src="/assets/img/logo-placeholder.png" class="nav-logo" alt="MatesInvest logo">
        <div>
          <div class="nav-title">MatesInvest</div>
          <div class="nav-pill">MatesFeed Â· Prototype</div>
        </div>
      </div>
      <div class="nav-right">
        <span>Live AI summaries Â· Not financial advice</span>
        <a href="/" class="nav-home-link">Home</a>
      </div>
    </div>
  </div>

  <div class="page-shell">
    <div class="corner-pattern" aria-hidden="true"></div>

    <!-- HERO (kept for accessibility/SEO but visually hidden) -->
    <h1 class="visually-hidden">MatesFeed</h1>

    <!-- MORNING BRIEF -->
    <section id="morningBrief" class="card">
      <div class="brief-header">
        <div>
          <h2 style="margin:0">Morning Briefing</h2>
          <div style="color:var(--muted);font-size:0.92rem;margin-top:0.35rem">
            A short note on what could move markets in Australia today.
          </div>
        </div>

<div class="brief-controls">
  <button id="openBrief" class="brief-toggle primary">Open morning brief</button>
</div>

      </div>

      <div id="briefContent" class="brief-content" aria-live="polite">
        <!-- injected by JS -->
      </div>
    </section>

    <!-- LATEST HEADLINES -->
    <section id="news" class="card" aria-labelledby="latest-headlines">
      <h2 id="latest-headlines">Latest Headlines</h2>

      <div class="controls">
        <div class="segmented" role="tablist" aria-label="View mode">
          <button id="toggleMarket" class="active" role="tab" aria-selected="true">Market Mode</button>
          <button id="toggleMates" role="tab" aria-selected="false">MatesMode</button>
        </div>

        <div style="flex:1"></div>

        <div style="display:flex;align-items:center;gap:0.5rem;color:var(--muted);font-size:0.88rem">
          <span id="feedStatus">Live</span>
        </div>
      </div>

      <div class="chip-row" id="categoryRow" aria-label="Categories">
        <button class="chip chip-active" data-category="all">All</button>
        <button class="chip" data-category="energy">Energy</button>
        <button class="chip" data-category="tech">Tech</button>
        <button class="chip" data-category="macro">Macro</button>
        <button class="chip" data-category="other">Other</button>
      </div>

      <div id="sportFilterRow" class="sport-row" style="display:none; margin-top:0.6rem;" aria-label="Filter sports"></div>

      <div id="newsList" style="margin-top:0.9rem;">Loadingâ€¦</div>
    </section>
  </div>

  <!-- All JS from your existing page, unchanged -->
  <script>
    /* ---------- Globals & helpers ---------- */
    const newsList = document.getElementById("newsList");
    const toggleMarket = document.getElementById("toggleMarket");
    const toggleMates = document.getElementById("toggleMates");
    const categoryRow = document.getElementById("categoryRow");
    const feedStatus = document.getElementById("feedStatus");
    const sportFilterRow = document.getElementById("sportFilterRow");

const openBriefBtn = document.getElementById("openBrief");
const briefContent = document.getElementById("briefContent");


    let allArticles = [];
    let currentCategory = "all";
    const selectedSports = new Set();
    let briefLoadedFor = null; // tracks which region the brief was loaded for

    function escapeHtml(str = "") {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function formatTime(iso) {
      try {
        const d = new Date(iso);
        if (isNaN(d)) return "";
        return new Intl.DateTimeFormat(undefined, { dateStyle:'short', timeStyle:'short' }).format(d);
      } catch { return iso || ""; }
    }

/* ---------- Mates Morning Note & Stock of the Day loaders ---------- */
async function loadMatesMorningNote() {
  const container = document.getElementById("matesMorningNote");
  const textBox = document.getElementById("matesNoteText");
  const timeBox = document.getElementById("matesNoteTimestamp");

  if (!container || !textBox || !timeBox) return;

  try {
    const res = await fetch("/.netlify/functions/matesMorningNote");
    const data = await res.json();

    const note = data.note || "No update available.";
    textBox.textContent = note;

    // FIXED DAILY TIMESTAMP (matches scheduled 6am AEST generation)
    timeBox.textContent = "Updated 6:00am AEST";

    container.style.display = "block";
  } catch (err) {
    console.error("Failed to load Morning Note", err);
    if (textBox) textBox.textContent = "Unable to load todayâ€™s note.";
    if (container) container.style.display = "block";
  }
}


// replace the start of loadStockOfTheDay() with this version

  async function loadStockOfTheDay() {
    const container = document.getElementById("stockOfDay");
    if (!container) return;

    const tickerEl = document.getElementById("sotdTicker");
    const nameEl = document.getElementById("sotdName");
    const exchEl = document.getElementById("sotdExchange");
    const summaryEl = document.getElementById("sotdSummary");

    if (!tickerEl || !nameEl || !exchEl || !summaryEl) return;

    // Use the same stock that was chosen in renderMorningBrief()
    // Try the global first, then fall back to data- attributes on the placeholder
    let candidate = window._mates_sotd || null;
    if (!candidate || !candidate.symbol) {
      // fallback: read from placeholder dataset
      const ds = container.dataset || {};
      if (ds.symbol) {
        candidate = {
          symbol: ds.symbol,
          name: ds.name || ""
        };
      }
    }

    if (!candidate || !candidate.symbol) {
      // Nothing selected â€“ hide the card quietly
      container.style.display = "none";
      return;
    }

    try {
      const params = new URLSearchParams();
      params.set("symbol", candidate.symbol);
      if (candidate.name) params.set("name", candidate.name);
      params.set("exchange", "ASX");

      const res = await fetch(
        "/.netlify/functions/stockOfTheDay?" + params.toString()
      );
      const data = await res.json();

      tickerEl.textContent = data.ticker || candidate.symbol || "â€”";
      nameEl.textContent = data.name || candidate.name || "";
      exchEl.textContent = (data.exchange || "ASX").toUpperCase();
      summaryEl.textContent =
        data.summary || "No snapshot available today.";

      container.style.display = "block";
    } catch (err) {
      console.error("loadStockOfTheDay failed", err);
      summaryEl.textContent =
        "Unable to load todayâ€™s Stock of the Day.";
      container.style.display = "block"; // still show the card with message
    }
  }
    /* ---------- Feeds ---------- */
    async function getMarketFeed() {
      try {
        const res = await fetch("/.netlify/functions/newsFeed");
        const data = await res.json();
        return data.articles || [];
      } catch (e) {
        console.warn("Market feed failed", e);
        return [];
      }
    }

    async function getSportsFeed() {
      try {
        const res = await fetch("/.netlify/functions/sports-test");
        return await res.json();
      } catch (e) {
        console.warn("Sports feed failed", e);
        return [];
      }
    }

    function showSkeleton(count = 4) {
      newsList.innerHTML = "";
      for (let i=0;i<count;i++){
        const div = document.createElement("div");
        div.className = "headline";
        div.innerHTML = `<div style="display:flex;align-items:center;gap:0.75rem">
          <div style="flex:1">
            <div class="skeleton" style="height:14px;width:60%"></div>
            <div style="height:8px"></div>
            <div class="skeleton" style="height:12px;width:30%"></div>
          </div>
        </div>`;
        newsList.appendChild(div);
      }
    }

    /* ---------- Mates/OpenAI summary helper ---------- */
    async function callMatesSummary(payload) {
      const res = await fetch("/.netlify/functions/matesSummary", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("Summary request failed");
      return res.json();
    }

    /* ---------- Category detection ---------- */
    function categoryFromArticle(article) {
      const title = (article.title || "").toLowerCase();
      if (title.match(/energy|oil|coal|gas|mining/)) return "energy";
      if (title.match(/tech|software|ai|chip|cloud/)) return "tech";
      if (title.match(/inflation|rate|central bank|macro/)) return "macro";
      return "other";
    }

    /* ---------- Rendering market & mates mode ---------- */
    function renderSummary(s) {
      if (!s) return `<div class="summary-block">No summary available.</div>`;
      const bullets = (s.tldrBullets || []).map(b => `<li>${escapeHtml(b)}</li>`).join("");
      return `
        <div class="summary-block">
          ${bullets ? `<strong>TL;DR</strong><ul class="tldr-list">${bullets}</ul>` : ""}
          <details open>
            <summary style="cursor:pointer;color:var(--muted-2)">Full summary</summary>
            <div style="margin-top:0.5rem">
              <p><strong>What's Happening:</strong><br>${escapeHtml(s.whatsHappening || "")}</p>
              <p><strong>Why It Matters:</strong><br>${escapeHtml(s.whyItMatters || "")}</p>
              <p><strong>Risks / Watch Outs:</strong><br>${escapeHtml(s.riskNote || "")}</p>
              <p class="summary-meta" style="opacity:0.7">${escapeHtml(s.disclaimer || "")}</p>
            </div>
          </details>
        </div>
      `;
    }

    function renderSportsSummary(s, icon) {
      return `
        <div class="summary-block">
          <strong>${escapeHtml(s.oneLiner || "")}</strong>
          <p><strong>What Actually Happened:</strong><br>${escapeHtml(s.whatsHappening || "")}</p>
        </div>
      `;
    }

    function getSportIcon(ev) {
      const league = (ev.league || "").toLowerCase();
      const sport = (ev.sport || "").toLowerCase();

      if (league.includes("nrl") || sport.includes("league")) return "ðŸ‰";
      if (league.includes("afl")) return "ðŸ‰";
      if (league.includes("nba") || sport.includes("basketball")) return "ðŸ€";
      if (league.includes("epl") || league.includes("premier") || sport.includes("soccer")) return "âš½";
      if (sport.includes("cricket") || league.includes("bbl")) return "ðŸ";
      if (league.includes("mlb") || sport.includes("baseball")) return "âš¾";
      if (league.includes("nfl") || sport.includes("football")) return "ðŸˆ";
      if (league.includes("nhl") || sport.includes("hockey")) return "ðŸ’";
      if (sport.includes("f1") || sport.includes("formula")) return "ðŸŽï¸";
      if (sport.includes("tennis")) return "ðŸŽ¾";
      if (sport.includes("golf")) return "â›³";
      return "ðŸŽ¯";
    }

    async function renderMarketMode() {
      sportFilterRow.style.display = "none";
      newsList.innerHTML = "";
      const filtered = allArticles.filter(a =>
        currentCategory === "all" || categoryFromArticle(a) === currentCategory
      );

      if (!filtered.length) {
        newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">No market headlines yet.</small></div>`;
        return;
      }

      filtered.forEach(a => {
        const item = document.createElement("div");
        item.className = "headline";

        const published = formatTime(a.publishedAt || a.published || "");

        item.innerHTML = `
          <div class="meta-row">
            <div class="meta-left">
              <div style="min-width:0">
                <h3 title="${escapeHtml(a.title || '')}">${escapeHtml(a.title || '')}</h3>
                <small>${escapeHtml(a.source || "")} Â· ${escapeHtml(published)}</small>
              </div>
            </div>
            <div style="display:flex;gap:0.5rem;align-items:center">
              <a class="link-min" href="${a.url || "#"}" target="_blank" rel="noopener">Read original</a>
            </div>
          </div>

          <div class="actions">
            <button class="btn" aria-label="Generate summary for article">MatesInvest summary</button>
          </div>
          <div class="summary-output"></div>
        `;

        const btn = item.querySelector("button");
        const output = item.querySelector(".summary-output");
        let busy = false;

        btn.addEventListener("click", async () => {
          if (busy) return;
          busy = true;
          btn.disabled = true;
          const origText = btn.textContent;
          btn.textContent = "Summarisingâ€¦";

          try {
            const summary = await callMatesSummary({
              text: `${a.title}\n\n${a.description || ""}`,
              sourceType: "news_article",
              headline: a.title,
            });

            output.innerHTML = renderSummary(summary);
          } catch (err) {
            console.error(err);
            output.textContent = "Summary failed.";
          } finally {
            btn.disabled = false;
            btn.textContent = origText;
            busy = false;
          }
        });

        newsList.appendChild(item);
      });
    }

  async function renderMatesMode() {
    showSkeleton(5);
    try {
      const market = await getMarketFeed();
      const sports = await getSportsFeed() || [];

      const sportSet = new Set();
      (sports || []).forEach(ev => {
        const s = (ev.sport || ev.league || "").toString().trim();
        if (s) {
          const key = ev.sport ? ev.sport.toString().trim() : (ev.league || "").toString().trim();
          const label = key.split(" ").map(w => w && (w[0].toUpperCase() + w.slice(1).toLowerCase())).join(" ");
          sportSet.add(label);
        }
      });

      renderSportFilters(Array.from(sportSet));

      const sportsCards = (sports || []).map(ev => ({
        type: "sport",
        title: `${ev.home} vs ${ev.away}`,
        subtitle: ev.league || "",
        sportLabel: (ev.sport || ev.league || "").toString().trim(),
        time: ev.localTime || ev.utcTime || ev.time,
        raw: ev
      }));

      const marketCards = (market || []).map(a => ({
        type: "market",
        title: a.title,
        subtitle: a.source || "",
        url: a.url,
        description: a.description || "",
        time: a.publishedAt || a.published || new Date().toISOString(),
        raw: a
      }));

      let combined = [...marketCards, ...sportsCards]
        .sort((a,b) => new Date(b.time) - new Date(a.time));

      if (selectedSports.size > 0) {
        combined = combined.filter(item => {
          if (item.type !== "sport") return true;
          const sportVal = (item.sportLabel || "").toLowerCase();
          return selectedSports.has(sportVal);
        });
      }

      combined = combined.filter(item => {
        if (item.type === "market") {
          return currentCategory === "all" || categoryFromArticle(item.raw) === currentCategory;
        }
        return true;
      });

      newsList.innerHTML = "";

      combined.forEach(item => {
        const div = document.createElement("div");
        div.className = "headline";

        if (item.type === "sport") {
          const icon = getSportIcon(item.raw);
          const ev = item.raw;
          const when = formatTime(item.time);
          const sportBadge = escapeHtml((item.sportLabel || "").toString());

          div.innerHTML = `
            <div class="meta-row">
              <div class="meta-left" style="min-width:0">
                <div>
                  <h3>${escapeHtml(item.title || "")}</h3>
                  <small>${icon} ${escapeHtml(item.subtitle || "")} Â· ${escapeHtml(when)}</small>
                </div>
              </div>
              <div style="display:flex;gap:0.5rem;align-items:center">
                <span class="sport-tag">${sportBadge}</span>
              </div>
            </div>

            <div class="actions">
              <button class="btn">MatesInvest summary</button>
              <button class="link-min" data-toggle-stats>Stats</button>
            </div>

            <div class="summary-output"></div>
            <div class="sports-stats" style="margin-top:0.6rem; display:none;"></div>
          `;

          const btn = div.querySelector("button.btn");
          const output = div.querySelector(".summary-output");
          const statsBtn = div.querySelector('button[data-toggle-stats]');
          const statsArea = div.querySelector(".sports-stats");
          let busy = false;

          btn.onclick = async () => {
            if (busy) return;
            busy = true;
            btn.disabled = true;
            const prev = btn.textContent;
            btn.textContent = "Summarisingâ€¦";

            try {
              const summary = await callMatesSummary({
                sourceType: "sports_event",
                headline: `${ev.home} vs ${ev.away}`,
                text: `
League: ${ev.league}
Sport: ${ev.sport}
Score: ${ev.home} ${ev.homeScore} - ${ev.awayScore} ${ev.away}
Status: ${ev.status}
`,
              });

              output.innerHTML = renderSportsSummary(summary, icon);
            } catch (err) {
              console.error(err);
              output.textContent = "Summary failed.";
            } finally {
              btn.disabled = false;
              btn.textContent = prev;
              busy = false;
            }
          };

          // Attach stats handler (on-demand event-details)
          attachStatsHandler(statsBtn, statsArea, ev);

          newsList.appendChild(div);
        } else {
          const when = formatTime(item.time);
          div.innerHTML = `
            <div class="meta-row">
              <div class="meta-left">
                <div style="min-width:0">
                  <h3>${escapeHtml(item.title || "")}</h3>
                  <small>${escapeHtml(item.subtitle || "")} Â· ${escapeHtml(when)}</small>
                </div>
              </div>
              <div style="display:flex;gap:0.5rem;align-items:center">
                <a class="link-min" href="${item.url || "#"}" target="_blank" rel="noopener">Read original</a>
              </div>
            </div>

            <div class="actions">
              <button class="btn">MatesInvest summary</button>
            </div>
            <div class="summary-output"></div>
          `;

          const btn = div.querySelector("button");
          const output = div.querySelector(".summary-output");
          let busy = false;

          btn.onclick = async () => {
            if (busy) return;
            busy = true;
            btn.disabled = true;
            const prev = btn.textContent;
            btn.textContent = "Summarisingâ€¦";

            try {
              const summary = await callMatesSummary({
                text: `${item.title}\n\n${item.description}`,
                sourceType: "news_article",
                headline: item.title,
              });

              output.innerHTML = renderSummary(summary);
            } catch (err) {
              console.error(err);
              output.textContent = "Summary failed.";
            } finally {
              btn.disabled = false;
              btn.textContent = prev;
              busy = false;
            }
          };

          newsList.appendChild(div);
        }
      });

      if (!combined.length) {
        newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">No items found.</small></div>`;
      }

    } catch (err) {
      console.error("Error rendering MatesMode", err);
      newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">Failed to load feed.</small></div>`;
    }
  }

  /* ---------- RICH STATS HELPERS (event-details client) ---------- */

  async function fetchEventDetails(eventId) {
    const res = await fetch(`/.netlify/functions/event-details?id=${encodeURIComponent(eventId)}`);
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`Event details request failed: ${res.status} ${txt}`);
    }
    return res.json();
  }

  function parseGoalDetails(raw) {
    if (!raw || !raw.trim()) return [];
    const parts = raw.split(/;|\n/).map(p => p.trim()).filter(Boolean);
    const events = parts.map(p => {
      const m = p.match(/^(\d+\+?\d*)'?[\s-â€“:]?\s*(.+)$/);
      if (m) {
        return { minute: m[1] + "'", text: m[2] };
      }
      return { minute: '', text: p };
    });
    return events;
  }

  function renderLineupSection(title, lineupStr) {
    if (!lineupStr || !lineupStr.trim()) return '';
    const players = lineupStr.split(/, ?/).map(s => s.trim()).filter(Boolean);
    return `<div class="lineup-block" role="group" aria-label="${escapeHtml(title)}">
      <strong style="color:var(--muted)">${escapeHtml(title)}</strong>
      <div style="margin-top:0.35rem">${players.map(p => `<div>${escapeHtml(p)}</div>`).join('')}</div>
    </div>`;
  }

  function renderBoxScoreAndPlayers(ev) {
    if (!ev) return `<div style="color:var(--muted)">No stats available.</div>`;

    const home = escapeHtml(ev.home || '');
    const away = escapeHtml(ev.away || '');
    const homeScore = (ev.homeScore !== null && ev.homeScore !== undefined) ? escapeHtml(String(ev.homeScore)) : 'â€”';
    const awayScore = (ev.awayScore !== null && ev.awayScore !== undefined) ? escapeHtml(String(ev.awayScore)) : 'â€”';

    const shotsRow = (ev.homeShots !== null || ev.awayShots !== null)
      ? `<div class="stat-row"><div class="stat-pill">Shots: ${ev.homeShots !== null ? escapeHtml(String(ev.homeShots)) : 'â€”'} â€” ${ev.awayShots !== null ? escapeHtml(String(ev.awayShots)) : 'â€”'}</div></div>`
      : '';

    const timelineItems = [];
    (parseGoalDetails(ev.homeGoalDetails || ev.raw?.strHomeGoalDetails || '')).forEach(it => timelineItems.push({side:'home', ...it}));
    (parseGoalDetails(ev.awayGoalDetails || ev.raw?.strAwayGoalDetails || '')).forEach(it => timelineItems.push({side:'away', ...it}));

    const minuteToNumber = m => {
      if (!m) return 9999;
      const clean = m.replace("'", "");
      if (clean.includes('+')) {
        const [base, extra] = clean.split('+').map(Number);
        return base * 100 + (extra || 0);
      }
      return Number(clean);
    };
    timelineItems.sort((a,b) => minuteToNumber(a.minute) - minuteToNumber(b.minute));

    const timelineHtml = timelineItems.length ? `
      <div style="margin-top:0.45rem"><strong style="color:var(--muted-2)">Timeline</strong>
        <div class="event-timeline">
          ${timelineItems.map(it => `
            <div class="timeline-item">
              <div class="timeline-bullet" aria-hidden="true" style="background:${it.side === 'home' ? 'var(--accent)' : 'rgba(255,255,255,0.16)'}"></div>
              <div style="display:flex;gap:0.5rem;align-items:flex-start">
                <div class="timeline-min">${escapeHtml(it.minute || '')}</div>
                <div style="max-width:680px;color:var(--muted)">${escapeHtml(it.text || '')}</div>
              </div>
            </div>`).join('')}
        </div>
      </div>` : '';

    const homeLineupHtml = ev.homeLineupGoalkeeper || ev.homeLineupDefense || ev.homeLineupMidfield || ev.homeLineupForward
      ? renderLineupSection('Home lineups', (ev.homeLineupGoalkeeper || '') + (ev.homeLineupDefense ? ', ' + ev.homeLineupDefense : '') + (ev.homeLineupMidfield ? ', ' + ev.homeLineupMidfield : '') + (ev.homeLineupForward ? ', ' + ev.homeLineupForward : ''))
      : '';
    const awayLineupHtml = ev.awayLineupGoalkeeper || ev.awayLineupDefense || ev.awayLineupMidfield || ev.awayLineupForward
      ? renderLineupSection('Away lineups', (ev.awayLineupGoalkeeper || '') + (ev.awayLineupDefense ? ', ' + ev.awayLineupDefense : '') + (ev.awayLineupMidfield ? ', ' + ev.awayLineupMidfield : '') + (ev.awayLineupForward ? ', ' + ev.awayLineupForward : ''))
      : '';

    let playersHtml = '';
    if (Array.isArray(ev.raw?.player) && ev.raw.player.length) {
      playersHtml = `<div style="margin-top:0.5rem"><strong style="color:var(--muted-2)">Players</strong>
        <div style="margin-top:0.4rem">
          ${ev.raw.player.map(p => `<div style="display:flex;gap:0.8rem;align-items:center"><div style="width:36px">${escapeHtml(p.number || '')}</div><div><strong>${escapeHtml(p.name)}</strong> <div style="color:var(--muted-2);font-size:0.9rem">${escapeHtml(p.position || '')} ${p.goals ? `â€¢ Goals: ${escapeHtml(String(p.goals))}` : ''}</div></div></div>`).join('')}
        </div></div>`;
    } else {
      playersHtml = `<div style="margin-top:0.35rem;color:var(--muted)">Per-player box stats not available from TheSportsDB for this event. Use a sport-specific provider (e.g. balldontlie for NBA) for full box scores.</div>`;
    }

    const notesHtml = ev.description ? `<details style="margin-top:0.5rem"><summary style="cursor:pointer;color:var(--muted-2)">Match notes</summary><div style="margin-top:0.4rem;color:var(--muted-2)">${escapeHtml(ev.description)}</div></details>` : '';

    return `
      <div class="summary-block">
        <div class="stat-row">
          <div class="stat-pill"><strong>${home}</strong> ${homeScore}</div>
          <div style="align-self:center;color:var(--muted)">vs</div>
          <div class="stat-pill"><strong>${away}</strong> ${awayScore}</div>
          <div style="margin-left:auto;color:var(--muted)">${escapeHtml(ev.status || '')}</div>
        </div>

        ${shotsRow}
        ${timelineHtml}
        ${homeLineupHtml}
        ${awayLineupHtml}
        ${playersHtml}
        ${notesHtml}
      </div>
    `;
  }

  /* ---------- Morning brief handlers (cleaned & robust) ---------- */

function formatMoney(n) {
  try {
    if (n === null || typeof n === 'undefined') return null;
    return Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  } catch { return String(n); }
}

function relativeTime(iso) {
  try {
    const date = new Date(iso);
    const now = new Date();
    const diffMs = now - date;
    const diffMin = Math.round(diffMs / 60000);
    if (Math.abs(diffMin) < 1) return 'just now';
    if (Math.abs(diffMin) < 60) return `${diffMin}m`;
    const diffHours = Math.round(diffMin / 60);
    if (Math.abs(diffHours) < 24) return `${diffHours}h`;
    const diffDays = Math.round(diffHours / 24);
    return `${diffDays}d`;
  } catch { return iso || ''; }
}

/*
  Render the morning brief:
  - Inserts placeholders for Mates Morning Note and Stock of the Day (so loaders can populate them)
  - Renders metals grid using payload.symbols or payload.metals
  - Renders topPerformers (from EODHD) if present
*/
function renderMorningBrief(payload) {
  if (!payload) {
    briefContent.innerHTML = `<div class="brief-loading">No briefing available.</div>`;
    return;
  }

const sourceNote = (payload._debug && payload._debug.fxSource)
  ? `Source: Metals-API Â· FX: ${payload._debug.fxSource}`
  : 'Source: Metals-API';

const cachedHint = (payload._debug && payload._debug.cached)
  ? '<span style="color:var(--muted);font-size:0.7rem"> Â· cached</span>'
  : '';


  // Accept either payload.metals (old) or payload.symbols (snapshot-metals.js)
  const metalsObj = (payload.metals && typeof payload.metals === 'object')
    ? payload.metals
    : (payload.symbols && typeof payload.symbols === 'object')
      ? payload.symbols
      : null;

  // Build top performers HTML if present
  let topPerfHtml = '';
  if (Array.isArray(payload.topPerformers) && payload.topPerformers.length) {
const items = payload.topPerformers.map(tp => {
  const pct = (typeof tp.pctGain === 'number') ? tp.pctGain : (tp.pctGain ? Number(tp.pctGain) : null);
  const pctClass = (pct === null) ? 'perf-pct neutral' : (pct > 0 ? 'perf-pct up' : (pct < 0 ? 'perf-pct down' : 'perf-pct neutral'));
  const lastClose = (typeof tp.lastClose === 'number') ? `$${formatMoney(tp.lastClose)}` : (tp.lastClose ? escapeHtml(String(tp.lastClose)) : 'â€”');
  // NOTE: removed the small company name under the ticker (kept perf-note at bottom)
  return `
    <button
      type="button"
      class="perf-card mi-performer-chip"
      data-type="equity"
      data-code="${escapeHtml(tp.symbol || '')}"
      aria-label="Top performer ${escapeHtml(tp.symbol || '')}"
    >
      <div class="perf-top">
        <div>
          <div class="perf-symbol">${escapeHtml(tp.symbol || '')}</div>
        </div>
        <div>
          <div class="perf-last">${lastClose}</div>
          <div class="${pctClass}">
            ${
              pct === null
                ? 'â€”'
                : (pct > 0
                    ? 'â–² ' + Math.abs(pct).toFixed(2) + '%'
                    : (pct < 0
                        ? 'â–¼ ' + Math.abs(pct).toFixed(2) + '%'
                        : `${pct}%`))
            }
          </div>
        </div>
      </div>
      <div class="perf-note">${escapeHtml(tp.name || '')}</div>
    </button>
  `;

}).join('');
    topPerfHtml = `
      <div>
        <strong style="display:block;margin-bottom:6px">Yesterday's Top Performers</strong>
        <div class="top-performers">
          ${items}
        </div>
      </div>
    `;
  }

  // Top meta row + placeholders for Mates note and SOTD
// INSERT/REPLACE this block inside renderMorningBrief(), right after topMetaHtml is defined
  const topMetaHtml = `<div class="brief-top-meta"><div></div><div style="text-align:right">${escapeHtml(sourceNote)}${cachedHint}</div></div>`;

  // Choose "Stock of the Day" candidate from top performers (if any)
  let sotdCandidate = null;
  if (Array.isArray(payload.topPerformers) && payload.topPerformers.length) {
    const pool = payload.topPerformers.slice(0, 5); // only the first 5
    const idx = Math.floor(Math.random() * pool.length); // or 0 if you always want #1
    sotdCandidate = pool[idx] || pool[0];
  }
  // Expose globally so loadStockOfTheDay() can use the same stock
  window._mates_sotd = sotdCandidate;

  // Build placeholders for Mates Morning Note and Stock of the Day
  const matesPlaceholder = `
    <div id="matesMorningNote" class="mates-note" style="display:none;">
      <div class="mates-note-header">
        <span class="pill">Mates Morning Note</span>
        <span id="matesNoteTimestamp" class="timestamp">Updated â€”</span>
      </div>
      <div id="matesNoteText" class="mates-note-body">Loading todayâ€™s noteâ€¦</div>
    </div>
  `;

  // SOTD placeholder (include data-* attrs + summary area)
  const sotdTickerText = sotdCandidate && (sotdCandidate.symbol || sotdCandidate.ticker) ? escapeHtml(sotdCandidate.symbol || sotdCandidate.ticker) : 'â€”';
  const sotdNameText = sotdCandidate && sotdCandidate.name ? escapeHtml(sotdCandidate.name) : '';
  const sotdPlaceholder = `
    <div id="stockOfDay" class="sotd-card" style="display:none;"
         data-symbol="${sotdCandidate ? escapeHtml(sotdCandidate.symbol || sotdCandidate.ticker || '') : ''}"
         data-name="${sotdCandidate ? escapeHtml(sotdCandidate.name || '') : ''}">
      <div class="sotd-header">
        <div class="sotd-title-left">
          <span class="sotd-pill">Stock of the Day</span>
          <span id="sotdTicker" class="sotd-ticker">${sotdTickerText}</span>
          <span id="sotdName" class="sotd-name">${sotdNameText}</span>
        </div>
        <span id="sotdExchange" class="sotd-exchange">ASX</span>
      </div>

      <!-- Summary area that loadStockOfTheDay() expects -->
      <div id="sotdSummary" class="sotd-summary" style="min-height:48px;color:#0b1220">
        Loading Stock of the Dayâ€¦
      </div>

      <!-- small disclaimer / footer -->
      <div class="sotd-disclaimer" style="margin-top:8px;color:var(--muted-2);font-size:0.78rem">
        Not financial advice â€” brief informational snapshot only.
      </div>
    </div>
  `;
    if (metalsObj) {
    const symbols = Object.keys(metalsObj);
    const friendly = { XAU: 'Gold', XAG: 'Silver', IRON: 'Iron Ore 62% Fe', 'LITH-CAR':'Lithium Carbonate', NI: 'Nickel', URANIUM: 'Uranium' };

    const cards = symbols.map(sym => {
      const m = metalsObj[sym] || {};
      const priceAUDraw = (typeof m.priceAUD === 'number') ? m.priceAUD : null;
      const pct = (typeof m.pctChange === 'number') ? m.pctChange : null;

      // Prefer explicit unit from snapshot; fallback to heuristic
      const unitFromSnapshot = (m.unit || m.unit === '' ? m.unit : (m.unitName || '')).toString().trim();
      const unit = unitFromSnapshot || ((sym === 'XAU' || sym === 'XAG') ? 'oz' : (sym === 'IRON' ? 'tonne' : 'unit'));

const priceDisplay = priceAUDraw !== null 
    ? `$${formatMoney(priceAUDraw)}`
    : '<span style="color:#ffd166">Unavailable</span>';


      // pct badge
      let pctHtml = `<span class="brief-badge no-data" aria-hidden="true">â€”</span>`;
      if (pct !== null) {
        if (pct > 0) pctHtml = `<span class="brief-badge up" aria-label="${pct}% up">â–² ${Math.abs(pct)}%</span>`;
        else if (pct < 0) pctHtml = `<span class="brief-badge down" aria-label="${pct}% down">â–¼ ${Math.abs(pct)}%</span>`;
        else pctHtml = `<span class="brief-badge neutral" aria-label="unchanged">â€” 0%</span>`;
      }

      // optional trace: show original API USD (apiPriceUSD) small hint if present
      const apiUsdRaw = (typeof m.apiPriceUSD === 'number') ? m.apiPriceUSD : (typeof m.apiPriceUsd === 'number' ? m.apiPriceUsd : null);
      const apiHint = (apiUsdRaw !== null) ? `<div style="font-size:0.72rem;color:var(--muted);margin-top:6px">api: $${formatMoney(apiUsdRaw)} USD</div>` : '';

      return `
        <div class="card-metal" role="group" aria-label="${escapeHtml(friendly[sym] || sym)} price card">
          <div class="metal-head">
            <div>
              <div class="metal-name"><strong>${escapeHtml(friendly[sym] || sym)}</strong> <small style="color:var(--muted)">(${escapeHtml(sym)})</small></div>
              <div class="metal-price">${priceDisplay} <small class="metal-sub" style="color:var(--muted);font-weight:600">${escapeHtml('/' + unit)}</small></div>
            </div>
            <div style="text-align:right">
              ${pctHtml}
            </div>
          </div>
          ${apiHint}
        </div>
      `;
    }).join("");

    // Assemble final HTML: topMeta, topPerformers (if any), top two cards (mates note & sotd), then metals grid
    briefContent.innerHTML = `
      ${topMetaHtml}
      ${topPerfHtml}
      <div class="brief-top-cards">
        ${matesPlaceholder}
        ${sotdPlaceholder}
      </div>
      <div class="brief-grid">
        ${cards}
      </div>
    `;

    return;
  }

  // Fallback: old single-gold payload shape â€” include top performers if present
  const narrative = payload.narrative || (payload.priceAUD ? `The spot gold price is currently $${payload.priceAUD} AUD.` : 'The spot gold price is currently unavailable.');
  const fallbackHtml = `
    ${topMetaHtml}
    ${topPerfHtml}
    <div style="padding:0.6rem;border-radius:8px;background:linear-gradient(180deg, rgba(20,24,40,0.84), rgba(12,14,26,0.78));border:1px solid rgba(255,255,255,0.03)">
      <div style="font-size:0.9rem;color:var(--muted)"><strong>Spot gold</strong></div>
      <div style="margin-top:0.35rem;color:#fff;font-weight:600">${escapeHtml(narrative)}</div>
    </div>
  `;
  briefContent.innerHTML = fallbackHtml;
}

/* ---------- open / refresh handlers (updated to load Mates note + SOTD after rendering) ---------- */
openBriefBtn.addEventListener("click", async () => {
  const region = "au";
  if (briefContent.style.display === "block") {
    briefContent.style.display = "none";
    openBriefBtn.textContent = "Open morning brief";
    return;
  }

  briefContent.style.display = "block";
  openBriefBtn.textContent = "Hide brief";

  briefContent.innerHTML = `<div class="brief-loading">Loading briefingâ€¦</div>`;
  try {
    const res = await fetch(`/.netlify/functions/morning-brief?region=${encodeURIComponent(region)}`);
    if (!res.ok) {
      const t = await res.text();
      throw new Error(t || 'Brief fetch failed');
    }
    const payload = await res.json();
    renderMorningBrief(payload);

    // Now load the Mates Morning Note and Stock of the Day into the placeholders we injected
    loadMatesMorningNote();
    loadStockOfTheDay();

  } catch (err) {
    console.error('Morning brief failed', err);
    briefContent.innerHTML = `<div class="brief-loading">Failed to load morning brief.</div>`;
  }
});

/* ---------- Toggles & category handling (unchanged) ---------- */

function setActiveToggle(isMarket) {
  if (isMarket) {
    toggleMarket.classList.add("active");
    toggleMarket.setAttribute("aria-selected","true");
    toggleMates.classList.remove("active");
    toggleMates.setAttribute("aria-selected","false");
  } else {
    toggleMates.classList.add("active");
    toggleMates.setAttribute("aria-selected","true");
    toggleMarket.classList.remove("active");
    toggleMarket.setAttribute("aria-selected","false");
  }
}

toggleMarket.onclick = async () => {
  setActiveToggle(true);
  feedStatus.textContent = "Market mode";
  showSkeleton(4);
  allArticles = await getMarketFeed();
  renderMarketMode();
};

toggleMates.onclick = () => {
  setActiveToggle(false);
  feedStatus.textContent = "MatesMode";
  renderMatesMode();
};

categoryRow.onclick = (e) => {
  const btn = e.target.closest(".chip");
  if (!btn) return;
  currentCategory = btn.dataset.category;

  [...categoryRow.children].forEach(b => b.classList.remove("chip-active"));
  btn.classList.add("chip-active");

  if (toggleMates.classList.contains("active")) {
    renderMatesMode();
  } else {
    renderMarketMode();
  }
};

/* ---------- Initial load ---------- */
(async function init() {
  try {
    feedStatus.textContent = "Loadingâ€¦";
    showSkeleton(4);
    allArticles = await getMarketFeed();
    renderMarketMode();
    feedStatus.textContent = "Live";

    // Note: Mates Morning Note and Stock of the Day are loaded when the morning brief is opened.
  } catch (err) {
    console.error(err);
    newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">Failed to load initial feed.</small></div>`;
    feedStatus.textContent = "Offline";
  }
})();
</script>
<!-- Instrument details modal -->
<div id="mi-instrument-overlay" class="mi-ins-overlay" aria-hidden="true">
  <div class="mi-ins-modal" role="dialog" aria-modal="true" aria-labelledby="mi-ins-title">
    <button class="mi-ins-close" type="button" id="mi-ins-close-btn" aria-label="Close">
      âœ•
    </button>

    <div class="mi-ins-header">
      <div>
        <h2 id="mi-ins-title" class="mi-ins-title">Instrument name</h2>
        <div class="mi-ins-subtitle" id="mi-ins-subtitle">TICKER â€¢ Sector</div>
      </div>
      <div class="mi-ins-price-block">
        <div class="mi-ins-price" id="mi-ins-price">$0.00</div>
        <div class="mi-ins-change" id="mi-ins-change">+0.0% today</div>
        <div class="mi-ins-date" id="mi-ins-date">as at â€”</div>
      </div>
    </div>

    <div class="mi-ins-tags" id="mi-ins-tags">
      <!-- tags inserted here -->
    </div>

    <div class="mi-ins-section">
      <h3 class="mi-ins-section-title">Key stats</h3>
      <div class="mi-ins-stats-grid" id="mi-ins-stats">
        <!-- stats rows injected by JS -->
      </div>
    </div>

    <div class="mi-ins-section">
      <h3 class="mi-ins-section-title">Price history</h3>
      <div class="mi-ins-history">
        <div class="mi-ins-history-summary" id="mi-ins-history-summary">
          Showing last 6 months of daily closes.
        </div>
        <!-- Placeholder for a future chart -->
<div class="mi-ins-history">
  <div class="mi-ins-history-summary" id="mi-ins-history-summary"></div>
  <canvas id="mi-ins-chart" width="600" height="220"></canvas>
</div>
      </div>
    </div>
  </div>
</div>
<script>
  // -------- Fetch helper --------
  async function miFetchInstrumentDetails(type, code) {
    const url = `/.netlify/functions/instrument-details?type=${encodeURIComponent(
      type
    )}&code=${encodeURIComponent(code)}`;
    const res = await fetch(url);
    if (!res.ok) {
      throw new Error(`instrument-details failed: ${res.status}`);
    }
    return res.json();
  }

  // -------- Formatting helpers --------
  function miFormatCurrency(n, currency = "AUD") {
    if (typeof n !== "number" || !isFinite(n)) return null;
    try {
      return new Intl.NumberFormat("en-AU", {
        style: "currency",
        currency,
        maximumFractionDigits: 2,
      }).format(n);
    } catch {
      return n.toFixed(2);
    }
  }

  function miFormatCompactNumber(n) {
    if (typeof n !== "number" || !isFinite(n)) return null;
    // Turn big numbers into 51.3B, 206.3B etc
    const abs = Math.abs(n);
    if (abs >= 1_000_000_000) return (n / 1_000_000_000).toFixed(1) + "B";
    if (abs >= 1_000_000) return (n / 1_000_000).toFixed(1) + "M";
    if (abs >= 1_000) return (n / 1_000).toFixed(1) + "k";
    return n.toFixed(0);
  }

  function miFormatPercent(n, digits = 2) {
    if (typeof n !== "number" || !isFinite(n)) return null;
    return n.toFixed(digits) + "%";
  }

  function miFormatDate(dateStr) {
    if (!dateStr) return null;
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return null;
    return d.toLocaleDateString("en-AU", {
      day: "2-digit",
      month: "short",
      year: "numeric",
    });
  }

  // -------- Render modal --------
  function miOpenInstrumentModal(data) {
    const overlay = document.getElementById("mi-instrument-overlay");
    if (!overlay) return;

    const latest = data.latest || {};
    const f = data.fundamentals || {};

    // Header text
    const titleEl = document.getElementById("mi-ins-title");
    const subtitleEl = document.getElementById("mi-ins-subtitle");
    const priceEl = document.getElementById("mi-ins-price");
    const changeEl = document.getElementById("mi-ins-change");
    const dateEl = document.getElementById("mi-ins-date");
    const tagsEl = document.getElementById("mi-ins-tags");
    const statsEl = document.getElementById("mi-ins-stats");
    const historySummaryEl = document.getElementById("mi-ins-history-summary");

    const name = data.name || data.code || "";
    const code = data.code || "";
    const sector = f.sector || "";
    const industry = f.industry || "";
    const sizeBucket = f.sizeBucket || null;

    // Title & subtitle
    if (titleEl) titleEl.textContent = name;
    if (subtitleEl) {
      const bits = [];
      if (code) bits.push(code);
      if (sector) bits.push(sector);
      subtitleEl.textContent = bits.join(" â€¢ ") || "";
    }

    // Price & change
    const priceNum =
      typeof latest.price === "number" && isFinite(latest.price)
        ? latest.price
        : null;
    const pctChange =
      typeof latest.pctChange === "number" && isFinite(latest.pctChange)
        ? latest.pctChange
        : null;

    if (priceEl) {
      priceEl.textContent =
        priceNum !== null
          ? miFormatCurrency(priceNum, f.currency || "AUD")
          : "â€”";
    }

    if (changeEl) {
      changeEl.classList.remove("up", "down");
      if (pctChange === null) {
        changeEl.textContent = "Change: â€”";
      } else {
        const arrow = pctChange > 0 ? "â–²" : pctChange < 0 ? "â–¼" : "â€¢";
        changeEl.textContent =
          arrow + " " + pctChange.toFixed(2) + "% today";
        if (pctChange > 0) changeEl.classList.add("up");
        else if (pctChange < 0) changeEl.classList.add("down");
      }
    }

    if (dateEl) {
      const d = miFormatDate(latest.date);
      dateEl.textContent = d ? `as at ${d}` : "";
    }

    // Tags
    if (tagsEl) {
      tagsEl.innerHTML = "";
      const tags = [];

      if (sizeBucket) {
        const label =
          sizeBucket === "mega"
            ? "Mega cap"
            : sizeBucket === "large"
            ? "Large cap"
            : sizeBucket === "mid"
            ? "Mid cap"
            : sizeBucket === "small"
            ? "Small cap"
            : null;
        if (label) tags.push(label);
      }

      if (sector) tags.push(sector);
      if (industry) tags.push(industry);

      tags.forEach((t) => {
        const span = document.createElement("span");
        span.className = "mi-ins-tag";
        span.textContent = t;
        tagsEl.appendChild(span);
      });
    }

    // Stats grid
    if (statsEl) {
      statsEl.innerHTML = "";

      function addStat(label, valueStr) {
        if (!valueStr) return;
        const item = document.createElement("div");
        item.className = "mi-ins-stat-item";
        const lab = document.createElement("span");
        lab.className = "mi-ins-stat-label";
        lab.textContent = label;
        const val = document.createElement("span");
        val.className = "mi-ins-stat-value";
        val.textContent = valueStr;
        item.appendChild(lab);
        item.appendChild(val);
        statsEl.appendChild(item);
      }

      // Market cap
      if (typeof f.marketCap === "number" && isFinite(f.marketCap)) {
        addStat("Market cap", miFormatCompactNumber(f.marketCap));
      }

      // Revenue last year
      if (
        typeof f.revenueLastYear === "number" &&
        isFinite(f.revenueLastYear)
      ) {
        addStat(
          "Revenue (last year)",
          miFormatCompactNumber(f.revenueLastYear)
        );
      }

      // Net income last year (may be null for some)
      if (
        typeof f.netIncomeLastYear === "number" &&
        isFinite(f.netIncomeLastYear)
      ) {
        addStat(
          "Net profit (last year)",
          miFormatCompactNumber(f.netIncomeLastYear)
        );
      }

      // PE
      if (typeof f.pe === "number" && isFinite(f.pe)) {
        addStat("P/E ratio", f.pe.toFixed(2) + "Ã—");
      }

      // Dividend yield
      if (
        typeof f.dividendYield === "number" &&
        isFinite(f.dividendYield)
      ) {
        addStat("Dividend yield", miFormatPercent(f.dividendYield, 2));
      }

      // Pays dividend
      if (typeof f.paysDividend === "boolean") {
        addStat("Pays dividend", f.paysDividend ? "Yes" : "No");
      }

      // EPS
      if (typeof f.eps === "number" && isFinite(f.eps)) {
        addStat("Earnings per share", f.eps.toFixed(2));
      }
    }

    // History summary (just text for now)
    if (historySummaryEl) {
      const h = data.history;
      if (h && Array.isArray(h.points) && h.points.length > 1) {
        const start = miFormatDate(h.startDate);
        const end = miFormatDate(h.endDate);
        historySummaryEl.textContent =
          start && end
            ? `Showing daily closes from ${start} to ${end}.`
            : "Showing last 6 months of daily closes.";
      } else {
        historySummaryEl.textContent =
          "Price history not available at the moment.";
      }
    }
// Render the chart
if (data.history) {
  miRenderChart(data.history);
}
    // Show overlay
    overlay.style.display = "flex";
    overlay.setAttribute("aria-hidden", "false");
  }

  function miCloseInstrumentModal() {
    const overlay = document.getElementById("mi-instrument-overlay");
    if (!overlay) return;
    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden", "true");
  }
function miRenderChart(history) {
  const canvas = document.getElementById("mi-ins-chart");
  if (!canvas || !history || !Array.isArray(history.points)) return;

  const ctx = canvas.getContext("2d");

  // Extract numeric closes
  const pts = history.points.map(p => p[1]).filter(x => typeof x === "number");

  if (pts.length < 2) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#6b7280";
    ctx.fillText("No chart data available", 10, 20);
    return;
  }

  const w = canvas.width;
  const h = canvas.height;

  const min = Math.min(...pts);
  const max = Math.max(...pts);

  const padX = 20;
  const padY = 10;

  ctx.clearRect(0, 0, w, h);

  ctx.lineWidth = 2;
  ctx.strokeStyle = "#38bdf8"; // cyan-blue line
  ctx.beginPath();

  pts.forEach((v, i) => {
    const x = padX + (i / (pts.length - 1)) * (w - padX * 2);
    const y = h - padY - ((v - min) / (max - min)) * (h - padY * 2);

    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });

  ctx.stroke();

  // Fade fill under the line
  const gradient = ctx.createLinearGradient(0, padY, 0, h);
  gradient.addColorStop(0, "rgba(56,189,248,0.25)");
  gradient.addColorStop(1, "rgba(56,189,248,0.0)");

  ctx.lineTo(w - padX, h - padY);
  ctx.lineTo(padX, h - padY);
  ctx.closePath();
  ctx.fillStyle = gradient;
  ctx.fill();
}

  // -------- Wire up clicks --------
  document.addEventListener("click", async (e) => {
    // Close if clicking overlay background
    const overlay = document.getElementById("mi-instrument-overlay");
    if (overlay && e.target === overlay) {
      miCloseInstrumentModal();
      return;
    }

    // Close button
    const closeBtn = document.getElementById("mi-ins-close-btn");
    if (closeBtn && e.target === closeBtn) {
      miCloseInstrumentModal();
      return;
    }

    // Instrument chip (e.g. top 6 performers)
    const chip = e.target.closest(".mi-performer-chip[data-code]");
    if (!chip) return;

    const code = chip.getAttribute("data-code");
    const type = chip.getAttribute("data-type") || "equity";

    try {
      const data = await miFetchInstrumentDetails(type, code);
      miOpenInstrumentModal(data);
    } catch (err) {
      console.error("Failed to load instrument details", err);
      alert("Sorry, we couldn't load that company at the moment.");
    }
  });

  // Escape key closes modal
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      miCloseInstrumentModal();
    }
  });
</script>

</body>
</html>
