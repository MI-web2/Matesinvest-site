<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>MatesFeed â€“ Plain-English market summaries | MatesInvest</title>
  <meta name="description" content="MatesFeed delivers live market headlines and plain-English AI summaries built for Australian retail investors.">

  <link rel="icon" type="image/png" href="/assets/img/favicon.png">
  <link rel="apple-touch-icon" href="/assets/img/favicon.png">

  <style>
    :root{
      --bg: #050814;
      --card: linear-gradient(180deg, rgba(20,24,40,0.9), rgba(15,18,32,0.85));
      --muted: rgba(255,255,255,0.66);
      --muted-2: rgba(255,255,255,0.44);
      --accent: #3fbf7f;
      --accent-strong: #2ea668;
      --accent-soft: rgba(63,191,127,0.12);
      --border: rgba(255,255,255,0.06);
      --card-border: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.03);
      --radius: 14px;
      --gap: 1rem;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(circle at top left, #20274a 0, #050814 45%);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.4;
      padding-bottom:3rem;
    }

    .page-shell{
      max-width:1080px;
      margin:0 auto;
      padding:1rem 1.25rem 3rem;
    }

    /* Accessible visually-hidden utility (keeps H1 for SEO / screen readers) */
    .visually-hidden {
      position: absolute !important;
      height: 1px;
      width: 1px;
      overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap; /* prevent line breaks */
      border: 0;
      padding: 0;
      margin: -1px;
    }


    /* NAV */
    .nav{
      position:sticky;
      top:0;
      z-index:30;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(5,8,20,0.92), rgba(5,8,20,0.78));
      border-bottom: 1px solid var(--border);
    }
    .nav-inner{
      max-width:1080px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
      padding:0.9rem 1.25rem;
    }
    .nav-left{display:flex;align-items:center;gap:0.75rem}
    .nav-logo{height:44px;width:44px;border-radius:8px;object-fit:cover}
    .nav-title{font-weight:600;font-size:1.05rem}
    .nav-pill{padding:0.2rem 0.6rem;border-radius:999px;font-size:0.75rem;background:var(--accent-soft);color:var(--accent);border:1px solid rgba(63,191,127,0.26)}
    .nav-right{font-size:0.82rem;color:var(--muted);display:flex;gap:0.75rem;align-items:center}
    .nav-home-link{padding:0.35rem 0.8rem;border-radius:999px;border:1px solid var(--border);text-decoration:none;color:#fff;background:rgba(255,255,255,0.03)}
    .nav-home-link:hover{background:rgba(255,255,255,0.06)}

    /* Card */
    .card { background: var(--card); border-radius: var(--radius); padding:1.25rem; margin-bottom:1rem; border:1px solid var(--card-border) }
    .card-hero h1{margin:0;font-size:1.4rem}
    .card-hero p{margin:0.35rem 0 0;color:var(--muted)}

    /* Morning brief */
    .brief-header { display:flex; align-items:center; gap:0.75rem; justify-content:space-between; }
    .brief-controls { display:flex; gap:0.5rem; align-items:center; }
    .brief-toggle { padding:0.36rem 0.7rem; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer }
    .brief-toggle.primary { background:var(--accent); color:#00110a; font-weight:700; border:1px solid rgba(0,0,0,0.06) }

    .brief-content { margin-top:0.9rem; display:none; }
    .brief-loading { color:var(--muted); font-size:0.95rem }

    .brief-tldr { display:flex; gap:0.6rem; flex-direction:column; margin-top:0.5rem }
    .brief-bullet { background:rgba(255,255,255,0.02); padding:0.45rem; border-radius:8px; border:1px solid rgba(255,255,255,0.03) }

    /* Controls & chips (existing) */
    .controls { display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; margin-top:0.6rem; }
    .segmented { display:inline-flex; background:var(--glass); border-radius:999px; padding:3px; gap:4px; border:1px solid var(--border); }
    .segmented button{ background:transparent; border:0; padding:0.45rem 0.85rem; color:var(--muted); border-radius:999px; cursor:pointer; font-size:0.88rem; transition: all .16s ease; }
    .segmented button.active{ background: linear-gradient(180deg,var(--accent), var(--accent-strong)); color:#00110a; box-shadow: 0 6px 18px rgba(47,143,95,0.12), inset 0 -1px 0 rgba(0,0,0,0.06); }

    .chip-row{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.6rem}
    .chip{ padding:0.32rem 0.7rem;border-radius:999px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-size:0.82rem; transition: all .14s ease; }
    .chip:hover{background:rgba(255,255,255,0.02)}
    .chip-active{background:var(--accent-soft);color:#fff;border-color:var(--accent)}

    .sport-row{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.6rem}
    .sport-chip{ padding:0.28rem 0.6rem;border-radius:999px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer;font-size:0.82rem; }
    .sport-chip.active{background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.08);color:#fff;box-shadow:inset 0 -1px 0 rgba(0,0,0,0.05)}
    .sport-tag{display:inline-block;padding:0.12rem 0.5rem;border-radius:999px;background:rgba(255,255,255,0.03);font-size:0.78rem;color:var(--muted);border:1px solid rgba(255,255,255,0.03) }

    /* News list */
    #newsList{margin-top:0.85rem; display:flex;flex-direction:column; gap:0.85rem}
    .headline{ display:block; padding:0.95rem; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--card-border); transition: transform .12s ease, box-shadow .12s ease; }
    .headline:hover{ transform: translateY(-3px); box-shadow: 0 10px 30px rgba(2,6,23,0.55) }

    .meta-row{ display:flex; align-items:center; gap:0.6rem; justify-content:space-between }
    .meta-left{ display:flex; align-items:center; gap:0.65rem; min-width:0 }
    .headline h3{ margin:0 0 0.25rem 0; font-size:1rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .headline small{ color:var(--muted-2); font-size:0.82rem; display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .headline .actions{ display:flex; gap:0.6rem; align-items:center; margin-top:0.6rem }

    .btn{ background:var(--accent); border:none; padding:0.5rem 0.95rem; border-radius:999px; cursor:pointer; color:#00110a; font-weight:700; font-size:0.86rem; transition: transform .08s ease, opacity .12s ease; }
    .btn:active{ transform: translateY(1px) }
    .btn:disabled{ opacity:0.6; cursor:default }

    .link-min{ background:transparent; border:1px solid var(--border); color:var(--muted); padding:0.42rem 0.7rem; border-radius:999px; text-decoration:none; font-size:0.83rem }
    .link-min:hover{ background:rgba(255,255,255,0.02) }

    .summary-output{ margin-top:0.65rem }

    .summary-block{ margin-top:0.45rem; border-top:1px dashed rgba(255,255,255,0.04); padding-top:0.6rem; font-size:0.95rem; color: #fff; }
    .summary-block p{margin:0.45rem 0}
    .tldr-list{ margin:0.35rem 0 0 0.85rem; padding:0; list-style:none; color:var(--muted) }
    .tldr-list li{ margin:0.25rem 0; position:relative; padding-left:1.05rem }
    .tldr-list li::before{ content:""; width:8px;height:8px;border-radius:2px;background:var(--accent);position:absolute;left:0.15rem;top:0.55rem;box-shadow:0 1px 0 rgba(0,0,0,0.2) }

    .summary-meta{ color:var(--muted-2); font-size:0.82rem; margin-top:0.45rem }

    /* Timeline & stats styles */
    .event-timeline { display:flex; flex-direction:column; gap:0.45rem; margin-top:0.4rem; }
    .timeline-item { display:flex; gap:0.6rem; align-items:flex-start; font-size:0.92rem; color:var(--muted-2) }
    .timeline-bullet { width:10px; height:10px; border-radius:999px; background:var(--accent); margin-top:4px; flex-shrink:0 }
    .timeline-min { width:36px; color:var(--muted); font-weight:600 }
    .lineup-block { background:rgba(255,255,255,0.02); padding:0.6rem; border-radius:8px; margin-top:0.5rem; color:var(--muted-2) }
    .stat-row { display:flex; gap:1rem; flex-wrap:wrap; color:var(--muted-2); font-size:0.92rem; margin-top:0.45rem }
    .stat-pill { padding:0.18rem 0.6rem; border-radius:999px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02) }

    .skeleton{ background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.06), rgba(255,255,255,0.03)); border-radius:8px; height:68px; animation: shimmer 1.2s linear infinite; }
    @keyframes shimmer{ 0%{ background-position:-120px 0 } 100%{ background-position:220px 0 } }

    @media (max-width:640px){
      .meta-row{ flex-direction:column; align-items:flex-start; gap:0.5rem }
      .headline h3{ white-space:normal; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
    }

    /* === Morning brief: dark-card styles (inline so page doesn't depend on external stylesheet) === */

    /* Top meta (As of / source) */
    .brief-top-meta {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
      color:rgba(255,255,255,0.55); /* muted light on dark */
      font-size:0.9rem;
    }

    /* Percent badges */
    .brief-badge {
      display:inline-block;
      padding:4px 8px;
      border-radius:8px;
      font-weight:700;
      font-size:0.9rem;
    }

    .brief-badge.up {
      background:#052e1f;   /* very dark green background */
      color:#6ee7b7;        /* green text */
      border:1px solid rgba(110,231,183,0.14);
    }

    .brief-badge.down {
      background:#2a0b0b;   /* very dark red */
      color:#ffb4b4;        /* soft red text */
      border:1px solid rgba(255,180,180,0.06);
    }

    .brief-badge.neutral {
      background:rgba(255,255,255,0.03);
      color:rgba(255,255,255,0.75);
    }

    .brief-badge.no-data {
      background:transparent;
      color:rgba(255,255,255,0.6);
      font-weight:600;
      border-radius:6px;
      padding:3px 6px;
      opacity:0.95;
    }

    /* Horizontal-friendly grid: encourage multiple columns on desktop */
    .brief-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      margin-top: 8px;
      align-items: start;
    }

    /* Card styling tuned for dark theme (clear border + soft shadow + hover lift) */
    .card-metal {
      padding: 0.9rem;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(20,24,40,0.84), rgba(12,14,26,0.78));
      border: 1px solid rgba(255,255,255,0.04); /* subtle light border on dark bg */
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow:
        0 12px 30px rgba(2,6,23,0.45), /* main drop */
        0 1px 0 rgba(255,255,255,0.02) inset; /* tiny inset highlight */
      min-height: 84px;
      transition: transform 160ms ease, box-shadow 160ms ease;
    }

    /* Little hover lift for desktop */
    .card-metal:hover {
      transform: translateY(-6px);
      box-shadow:
        0 18px 44px rgba(2,6,23,0.55),
        0 2px 0 rgba(255,255,255,0.03) inset;
    }

    /* Head / price area inside card; align items center for neat horizontal layout */
    .metal-head {
      display:flex;
      justify-content:space-between;
      align-items:center; /* center vertically */
      gap:8px;
    }

    /* Left column: name */
    .metal-name {
      font-size:0.92rem;
      color:rgba(255,255,255,0.85); /* lighter heading */
    }

    /* Main price */
    .metal-price {
      font-weight:800;
      font-size:1.05rem;
      color:#ffffff; /* main price white */
      margin-top:6px;
    }

    /* Secondary text (units, USD) */
    .metal-sub {
      font-size:0.85rem;
      color:rgba(255,255,255,0.55); /* muted */
    }

    /* USD secondary text styling */
    .metal-sub.usd { color:rgba(255,255,255,0.46); font-weight:600; }

    /* Optional compact narrative (kept small) */
    .metal-note { color:rgba(255,255,255,0.6); font-size:0.92rem; }

    /* Responsive behaviour:
       - Very wide screens: grid uses the min width so multiple cards in a row
       - Medium screens: two columns for a horizontal feel
       - Small screens: single column and hide USD
    */
    @media (max-width: 1100px) and (min-width: 800px) {
      .brief-grid { grid-template-columns: repeat(2, minmax(220px, 1fr)); }
    }

    @media (max-width: 799px) {
      .brief-grid { grid-template-columns: 1fr; }
      .metal-sub.usd { display: none; } /* keep mobile tidy */
    }

  </style>

</head>

<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="nav-left">
        <img src="/assets/img/logo-placeholder.png" class="nav-logo" alt="MatesInvest logo">
        <div>
          <div class="nav-title">MatesInvest</div>
          <div class="nav-pill">MatesFeed Â· Prototype</div>
        </div>
      </div>
      <div class="nav-right">
        <span>Live AI summaries Â· Not financial advice</span>
        <a href="/" class="nav-home-link">Home</a>
      </div>
    </div>
  </div>

<div class="page-shell">

  <!-- HERO (kept for accessibility/SEO but visually hidden) -->
  <h1 class="visually-hidden">MatesFeed</h1>

  <!-- MORNING BRIEF -->
  <section id="morningBrief" class="card">
    <div class="brief-header">
      <div>
        <h2 style="margin:0">Morning Briefing</h2>
        <div style="color:var(--muted);font-size:0.92rem;margin-top:0.35rem">A short note on what could move markets in Australia today.</div>
      </div>

      <div class="brief-controls">
        <select id="briefRegion" class="brief-toggle" aria-label="Region">
          <option value="au" selected>Australia (ASX)</option>
          <option value="us">US</option>
          <option value="global">Global</option>
        </select>

        <button id="openBrief" class="brief-toggle primary">Open morning brief</button>
        <button id="refreshBrief" class="brief-toggle" title="Refresh">Refresh</button>
      </div>
    </div>

    <div id="briefContent" class="brief-content" aria-live="polite">
      <!-- injected by JS -->
    </div>
  </section>

    <!-- LATEST HEADLINES -->
    <section id="news" class="card" aria-labelledby="latest-headlines">
      <h2 id="latest-headlines">Latest Headlines</h2>

      <div class="controls">
        <div class="segmented" role="tablist" aria-label="View mode">
          <button id="toggleMarket" class="active" role="tab" aria-selected="true">Market Mode</button>
          <button id="toggleMates" role="tab" aria-selected="false">MatesMode</button>
        </div>

        <div style="flex:1"></div>

        <div style="display:flex;align-items:center;gap:0.5rem;color:var(--muted);font-size:0.88rem">
          <span id="feedStatus">Live</span>
        </div>
      </div>

      <div class="chip-row" id="categoryRow" aria-label="Categories">
        <button class="chip chip-active" data-category="all">All</button>
        <button class="chip" data-category="energy">Energy</button>
        <button class="chip" data-category="tech">Tech</button>
        <button class="chip" data-category="macro">Macro</button>
        <button class="chip" data-category="other">Other</button>
      </div>

      <div id="sportFilterRow" class="sport-row" style="display:none; margin-top:0.6rem;" aria-label="Filter sports"></div>

      <div id="newsList" style="margin-top:0.9rem;">Loadingâ€¦</div>
    </section>
  </div>

<script>
  /* ---------- Globals & helpers ---------- */
  const newsList = document.getElementById("newsList");
  const toggleMarket = document.getElementById("toggleMarket");
  const toggleMates = document.getElementById("toggleMates");
  const categoryRow = document.getElementById("categoryRow");
  const feedStatus = document.getElementById("feedStatus");
  const sportFilterRow = document.getElementById("sportFilterRow");

  const openBriefBtn = document.getElementById("openBrief");
  const briefContent = document.getElementById("briefContent");
  const refreshBriefBtn = document.getElementById("refreshBrief");
  const briefRegionSelect = document.getElementById("briefRegion");

  let allArticles = [];
  let currentCategory = "all";
  const selectedSports = new Set();
  let briefLoadedFor = null; // tracks which region the brief was loaded for

  function escapeHtml(str = "") {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  function formatTime(iso) {
    try {
      const d = new Date(iso);
      if (isNaN(d)) return "";
      return new Intl.DateTimeFormat(undefined, { dateStyle:'short', timeStyle:'short' }).format(d);
    } catch { return iso || ""; }
  }

  /* ---------- Feeds ---------- */
  async function getMarketFeed() {
    try {
      const res = await fetch("/.netlify/functions/newsFeed");
      const data = await res.json();
      return data.articles || [];
    } catch (e) {
      console.warn("Market feed failed", e);
      return [];
    }
  }

  async function getSportsFeed() {
    try {
      const res = await fetch("/.netlify/functions/sports-test");
      return await res.json();
    } catch (e) {
      console.warn("Sports feed failed", e);
      return [];
    }
  }

  function showSkeleton(count = 4) {
    newsList.innerHTML = "";
    for (let i=0;i<count;i++){
      const div = document.createElement("div");
      div.className = "headline";
      div.innerHTML = `<div style="display:flex;align-items:center;gap:0.75rem">
        <div style="flex:1">
          <div class="skeleton" style="height:14px;width:60%"></div>
          <div style="height:8px"></div>
          <div class="skeleton" style="height:12px;width:30%"></div>
        </div>
      </div>`;
      newsList.appendChild(div);
    }
  }

  /* ---------- Mates/OpenAI summary helper ---------- */
  async function callMatesSummary(payload) {
    const res = await fetch("/.netlify/functions/matesSummary", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload),
    });
    if (!res.ok) throw new Error("Summary request failed");
    return res.json();
  }

  /* ---------- Category detection ---------- */
  function categoryFromArticle(article) {
    const title = (article.title || "").toLowerCase();
    if (title.match(/energy|oil|coal|gas|mining/)) return "energy";
    if (title.match(/tech|software|ai|chip|cloud/)) return "tech";
    if (title.match(/inflation|rate|central bank|macro/)) return "macro";
    return "other";
  }

  /* ---------- Rendering market & mates mode (full) ---------- */

  function renderSummary(s) {
    if (!s) return `<div class="summary-block">No summary available.</div>`;
    const bullets = (s.tldrBullets || []).map(b => `<li>${escapeHtml(b)}</li>`).join("");
    return `
      <div class="summary-block">
        ${bullets ? `<strong>TL;DR</strong><ul class="tldr-list">${bullets}</ul>` : ""}
        <details open>
          <summary style="cursor:pointer;color:var(--muted-2)">Full summary</summary>
          <div style="margin-top:0.5rem">
            <p><strong>What's Happening:</strong><br>${escapeHtml(s.whatsHappening || "")}</p>
            <p><strong>Why It Matters:</strong><br>${escapeHtml(s.whyItMatters || "")}</p>
            <p><strong>Risks / Watch Outs:</strong><br>${escapeHtml(s.riskNote || "")}</p>
            <p class="summary-meta" style="opacity:0.7">${escapeHtml(s.disclaimer || "")}</p>
          </div>
        </details>
      </div>
    `;
  }

  function renderSportsSummary(s, icon) {
    return `
      <div class="summary-block">
        <strong>${escapeHtml(s.oneLiner || "")}</strong>
        <p><strong>What Actually Happened:</strong><br>${escapeHtml(s.whatsHappening || "")}</p>
      </div>
    `;
  }

  function getSportIcon(ev) {
    const league = (ev.league || "").toLowerCase();
    const sport = (ev.sport || "").toLowerCase();

    if (league.includes("nrl") || sport.includes("league")) return "ðŸ‰";
    if (league.includes("afl")) return "ðŸ‰";
    if (league.includes("nba") || sport.includes("basketball")) return "ðŸ€";
    if (league.includes("epl") || league.includes("premier") || sport.includes("soccer")) return "âš½";
    if (sport.includes("cricket") || league.includes("bbl")) return "ðŸ";
    if (league.includes("mlb") || sport.includes("baseball")) return "âš¾";
    if (league.includes("nfl") || sport.includes("football")) return "ðŸˆ";
    if (league.includes("nhl") || sport.includes("hockey")) return "ðŸ’";
    if (sport.includes("f1") || sport.includes("formula")) return "ðŸŽï¸";
    if (sport.includes("tennis")) return "ðŸŽ¾";
    if (sport.includes("golf")) return "â›³";
    return "ðŸŽ¯";
  }

  function renderSportFilters(sportLabels = []) {
    sportFilterRow.innerHTML = "";
    if (!sportLabels || !sportLabels.length) {
      sportFilterRow.style.display = "none";
      return;
    }
    sportFilterRow.style.display = "flex";

    const allBtn = document.createElement("button");
    allBtn.className = "sport-chip" + (selectedSports.size === 0 ? " active" : "");
    allBtn.textContent = "All sports";
    allBtn.dataset.sport = "all";
    allBtn.onclick = () => {
      selectedSports.clear();
      [...sportFilterRow.children].forEach(c => c.classList.remove("active"));
      allBtn.classList.add("active");
      renderMatesMode();
    };
    sportFilterRow.appendChild(allBtn);

    sportLabels.forEach(label => {
      const btn = document.createElement("button");
      btn.className = "sport-chip" + (selectedSports.has(label.toLowerCase()) ? " active" : "");
      btn.textContent = label;
      btn.dataset.sport = label.toLowerCase();
      btn.title = `Toggle ${label}`;
      btn.onclick = () => {
        const allChip = sportFilterRow.querySelector('button[data-sport="all"]');
        if (allChip) allChip.classList.remove("active");

        const key = label.toLowerCase();
        if (selectedSports.has(key)) {
          selectedSports.delete(key);
          btn.classList.remove("active");
          if (selectedSports.size === 0) {
            if (allChip) allChip.classList.add("active");
          }
        } else {
          selectedSports.add(key);
          btn.classList.add("active");
        }
        renderMatesMode();
      };
      sportFilterRow.appendChild(btn);
    });
  }

  async function renderMarketMode() {
    sportFilterRow.style.display = "none";
    newsList.innerHTML = "";
    const filtered = allArticles.filter(a =>
      currentCategory === "all" || categoryFromArticle(a) === currentCategory
    );

    if (!filtered.length) {
      newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">No market headlines yet.</small></div>`;
      return;
    }

    filtered.forEach(a => {
      const item = document.createElement("div");
      item.className = "headline";

      const published = formatTime(a.publishedAt || a.published || "");

      item.innerHTML = `
        <div class="meta-row">
          <div class="meta-left">
            <div style="min-width:0">
              <h3 title="${escapeHtml(a.title || '')}">${escapeHtml(a.title || '')}</h3>
              <small>${escapeHtml(a.source || "")} Â· ${escapeHtml(published)}</small>
            </div>
          </div>
          <div style="display:flex;gap:0.5rem;align-items:center">
            <a class="link-min" href="${a.url || "#"}" target="_blank" rel="noopener">Read original</a>
          </div>
        </div>

        <div class="actions">
          <button class="btn" aria-label="Generate summary for article">MatesInvest summary</button>
        </div>
        <div class="summary-output"></div>
      `;

      const btn = item.querySelector("button");
      const output = item.querySelector(".summary-output");
      let busy = false;

      btn.addEventListener("click", async () => {
        if (busy) return;
        busy = true;
        btn.disabled = true;
        const origText = btn.textContent;
        btn.textContent = "Summarisingâ€¦";

        try {
          const summary = await callMatesSummary({
            text: `${a.title}\n\n${a.description || ""}`,
            sourceType: "news_article",
            headline: a.title,
          });

          output.innerHTML = renderSummary(summary);
        } catch (err) {
          console.error(err);
          output.textContent = "Summary failed.";
        } finally {
          btn.disabled = false;
          btn.textContent = origText;
          busy = false;
        }
      });

      newsList.appendChild(item);
    });
  }

  async function renderMatesMode() {
    showSkeleton(5);
    try {
      const market = await getMarketFeed();
      const sports = await getSportsFeed() || [];

      const sportSet = new Set();
      (sports || []).forEach(ev => {
        const s = (ev.sport || ev.league || "").toString().trim();
        if (s) {
          const key = ev.sport ? ev.sport.toString().trim() : (ev.league || "").toString().trim();
          const label = key.split(" ").map(w => w && (w[0].toUpperCase() + w.slice(1).toLowerCase())).join(" ");
          sportSet.add(label);
        }
      });

      renderSportFilters(Array.from(sportSet));

      const sportsCards = (sports || []).map(ev => ({
        type: "sport",
        title: `${ev.home} vs ${ev.away}`,
        subtitle: ev.league || "",
        sportLabel: (ev.sport || ev.league || "").toString().trim(),
        time: ev.localTime || ev.utcTime || ev.time,
        raw: ev
      }));

      const marketCards = (market || []).map(a => ({
        type: "market",
        title: a.title,
        subtitle: a.source || "",
        url: a.url,
        description: a.description || "",
        time: a.publishedAt || a.published || new Date().toISOString(),
        raw: a
      }));

      let combined = [...marketCards, ...sportsCards]
        .sort((a,b) => new Date(b.time) - new Date(a.time));

      if (selectedSports.size > 0) {
        combined = combined.filter(item => {
          if (item.type !== "sport") return true;
          const sportVal = (item.sportLabel || "").toLowerCase();
          return selectedSports.has(sportVal);
        });
      }

      combined = combined.filter(item => {
        if (item.type === "market") {
          return currentCategory === "all" || categoryFromArticle(item.raw) === currentCategory;
        }
        return true;
      });

      newsList.innerHTML = "";

      combined.forEach(item => {
        const div = document.createElement("div");
        div.className = "headline";

        if (item.type === "sport") {
          const icon = getSportIcon(item.raw);
          const ev = item.raw;
          const when = formatTime(item.time);
          const sportBadge = escapeHtml((item.sportLabel || "").toString());

          div.innerHTML = `
            <div class="meta-row">
              <div class="meta-left" style="min-width:0">
                <div>
                  <h3>${escapeHtml(item.title || "")}</h3>
                  <small>${icon} ${escapeHtml(item.subtitle || "")} Â· ${escapeHtml(when)}</small>
                </div>
              </div>
              <div style="display:flex;gap:0.5rem;align-items:center">
                <span class="sport-tag">${sportBadge}</span>
              </div>
            </div>

            <div class="actions">
              <button class="btn">MatesInvest summary</button>
              <button class="link-min" data-toggle-stats>Stats</button>
            </div>

            <div class="summary-output"></div>
            <div class="sports-stats" style="margin-top:0.6rem; display:none;"></div>
          `;

          const btn = div.querySelector("button.btn");
          const output = div.querySelector(".summary-output");
          const statsBtn = div.querySelector('button[data-toggle-stats]');
          const statsArea = div.querySelector(".sports-stats");
          let busy = false;

          btn.onclick = async () => {
            if (busy) return;
            busy = true;
            btn.disabled = true;
            const prev = btn.textContent;
            btn.textContent = "Summarisingâ€¦";

            try {
              const summary = await callMatesSummary({
                sourceType: "sports_event",
                headline: `${ev.home} vs ${ev.away}`,
                text: `
League: ${ev.league}
Sport: ${ev.sport}
Score: ${ev.home} ${ev.homeScore} - ${ev.awayScore} ${ev.away}
Status: ${ev.status}
`,
              });

              output.innerHTML = renderSportsSummary(summary, icon);
            } catch (err) {
              console.error(err);
              output.textContent = "Summary failed.";
            } finally {
              btn.disabled = false;
              btn.textContent = prev;
              busy = false;
            }
          };

          // Attach stats handler (on-demand event-details)
          attachStatsHandler(statsBtn, statsArea, ev);

          newsList.appendChild(div);
        } else {
          const when = formatTime(item.time);
          div.innerHTML = `
            <div class="meta-row">
              <div class="meta-left">
                <div style="min-width:0">
                  <h3>${escapeHtml(item.title || "")}</h3>
                  <small>${escapeHtml(item.subtitle || "")} Â· ${escapeHtml(when)}</small>
                </div>
              </div>
              <div style="display:flex;gap:0.5rem;align-items:center">
                <a class="link-min" href="${item.url || "#"}" target="_blank" rel="noopener">Read original</a>
              </div>
            </div>

            <div class="actions">
              <button class="btn">MatesInvest summary</button>
            </div>
            <div class="summary-output"></div>
          `;

          const btn = div.querySelector("button");
          const output = div.querySelector(".summary-output");
          let busy = false;

          btn.onclick = async () => {
            if (busy) return;
            busy = true;
            btn.disabled = true;
            const prev = btn.textContent;
            btn.textContent = "Summarisingâ€¦";

            try {
              const summary = await callMatesSummary({
                text: `${item.title}\n\n${item.description}`,
                sourceType: "news_article",
                headline: item.title,
              });

              output.innerHTML = renderSummary(summary);
            } catch (err) {
              console.error(err);
              output.textContent = "Summary failed.";
            } finally {
              btn.disabled = false;
              btn.textContent = prev;
              busy = false;
            }
          };

          newsList.appendChild(div);
        }
      });

      if (!combined.length) {
        newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">No items found.</small></div>`;
      }

    } catch (err) {
      console.error("Error rendering MatesMode", err);
      newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">Failed to load feed.</small></div>`;
    }
  }

  /* ---------- RICH STATS HELPERS (event-details client) ---------- */

  async function fetchEventDetails(eventId) {
    const res = await fetch(`/.netlify/functions/event-details?id=${encodeURIComponent(eventId)}`);
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`Event details request failed: ${res.status} ${txt}`);
    }
    return res.json();
  }

  function parseGoalDetails(raw) {
    if (!raw || !raw.trim()) return [];
    const parts = raw.split(/;|\n/).map(p => p.trim()).filter(Boolean);
    const events = parts.map(p => {
      const m = p.match(/^(\d+\+?\d*)'?[\s-â€“:]?\s*(.+)$/);
      if (m) {
        return { minute: m[1] + "'", text: m[2] };
      }
      return { minute: '', text: p };
    });
    return events;
  }

  function renderLineupSection(title, lineupStr) {
    if (!lineupStr || !lineupStr.trim()) return '';
    const players = lineupStr.split(/, ?/).map(s => s.trim()).filter(Boolean);
    return `<div class="lineup-block" role="group" aria-label="${escapeHtml(title)}">
      <strong style="color:var(--muted)">${escapeHtml(title)}</strong>
      <div style="margin-top:0.35rem">${players.map(p => `<div>${escapeHtml(p)}</div>`).join('')}</div>
    </div>`;
  }

  function renderBoxScoreAndPlayers(ev) {
    if (!ev) return `<div style="color:var(--muted)">No stats available.</div>`;

    const home = escapeHtml(ev.home || '');
    const away = escapeHtml(ev.away || '');
    const homeScore = (ev.homeScore !== null && ev.homeScore !== undefined) ? escapeHtml(String(ev.homeScore)) : 'â€”';
    const awayScore = (ev.awayScore !== null && ev.awayScore !== undefined) ? escapeHtml(String(ev.awayScore)) : 'â€”';

    const shotsRow = (ev.homeShots !== null || ev.awayShots !== null)
      ? `<div class="stat-row"><div class="stat-pill">Shots: ${ev.homeShots !== null ? escapeHtml(String(ev.homeShots)) : 'â€”'} â€” ${ev.awayShots !== null ? escapeHtml(String(ev.awayShots)) : 'â€”'}</div></div>`
      : '';

    const timelineItems = [];
    (parseGoalDetails(ev.homeGoalDetails || ev.raw?.strHomeGoalDetails || '')).forEach(it => timelineItems.push({side:'home', ...it}));
    (parseGoalDetails(ev.awayGoalDetails || ev.raw?.strAwayGoalDetails || '')).forEach(it => timelineItems.push({side:'away', ...it}));

    const minuteToNumber = m => {
      if (!m) return 9999;
      const clean = m.replace("'", "");
      if (clean.includes('+')) {
        const [base, extra] = clean.split('+').map(Number);
        return base * 100 + (extra || 0);
      }
      return Number(clean);
    };
    timelineItems.sort((a,b) => minuteToNumber(a.minute) - minuteToNumber(b.minute));

    const timelineHtml = timelineItems.length ? `
      <div style="margin-top:0.45rem"><strong style="color:var(--muted-2)">Timeline</strong>
        <div class="event-timeline">
          ${timelineItems.map(it => `
            <div class="timeline-item">
              <div class="timeline-bullet" aria-hidden="true" style="background:${it.side === 'home' ? 'var(--accent)' : 'rgba(255,255,255,0.16)'}"></div>
              <div style="display:flex;gap:0.5rem;align-items:flex-start">
                <div class="timeline-min">${escapeHtml(it.minute || '')}</div>
                <div style="max-width:680px;color:var(--muted)">${escapeHtml(it.text || '')}</div>
              </div>
            </div>`).join('')}
        </div>
      </div>` : '';

    const homeLineupHtml = ev.homeLineupGoalkeeper || ev.homeLineupDefense || ev.homeLineupMidfield || ev.homeLineupForward
      ? renderLineupSection('Home lineups', (ev.homeLineupGoalkeeper || '') + (ev.homeLineupDefense ? ', ' + ev.homeLineupDefense : '') + (ev.homeLineupMidfield ? ', ' + ev.homeLineupMidfield : '') + (ev.homeLineupForward ? ', ' + ev.homeLineupForward : ''))
      : '';
    const awayLineupHtml = ev.awayLineupGoalkeeper || ev.awayLineupDefense || ev.awayLineupMidfield || ev.awayLineupForward
      ? renderLineupSection('Away lineups', (ev.awayLineupGoalkeeper || '') + (ev.awayLineupDefense ? ', ' + ev.awayLineupDefense : '') + (ev.awayLineupMidfield ? ', ' + ev.awayLineupMidfield : '') + (ev.awayLineupForward ? ', ' + ev.awayLineupForward : ''))
      : '';

    let playersHtml = '';
    if (Array.isArray(ev.raw?.player) && ev.raw.player.length) {
      playersHtml = `<div style="margin-top:0.5rem"><strong style="color:var(--muted-2)">Players</strong>
        <div style="margin-top:0.4rem">
          ${ev.raw.player.map(p => `<div style="display:flex;gap:0.8rem;align-items:center"><div style="width:36px">${escapeHtml(p.number || '')}</div><div><strong>${escapeHtml(p.name)}</strong> <div style="color:var(--muted-2);font-size:0.9rem">${escapeHtml(p.position || '')} ${p.goals ? `â€¢ Goals: ${escapeHtml(String(p.goals))}` : ''}</div></div></div>`).join('')}
        </div></div>`;
    } else {
      playersHtml = `<div style="margin-top:0.35rem;color:var(--muted)">Per-player box stats not available from TheSportsDB for this event. Use a sport-specific provider (e.g. balldontlie for NBA) for full box scores.</div>`;
    }

    const notesHtml = ev.description ? `<details style="margin-top:0.5rem"><summary style="cursor:pointer;color:var(--muted-2)">Match notes</summary><div style="margin-top:0.4rem;color:var(--muted-2)">${escapeHtml(ev.description)}</div></details>` : '';

    return `
      <div class="summary-block">
        <div class="stat-row">
          <div class="stat-pill"><strong>${home}</strong> ${homeScore}</div>
          <div style="align-self:center;color:var(--muted)">vs</div>
          <div class="stat-pill"><strong>${away}</strong> ${awayScore}</div>
          <div style="margin-left:auto;color:var(--muted)">${escapeHtml(ev.status || '')}</div>
        </div>

        ${shotsRow}
        ${timelineHtml}
        ${homeLineupHtml}
        ${awayLineupHtml}
        ${playersHtml}
        ${notesHtml}
      </div>
    `;
  }

  async function attachStatsHandler(statsBtn, statsArea, ev) {
    statsBtn.onclick = async () => {
      try {
        if (statsArea.style.display === 'block' && statsArea.innerHTML.trim()) {
          statsArea.style.display = "none";
          statsBtn.textContent = 'Stats';
          return;
        }

        statsBtn.disabled = true;
        const prev = statsBtn.textContent;
        statsBtn.textContent = 'Loadingâ€¦';

        const eventId = (ev && (ev.idEvent || ev.id || ev.eventId)) || (ev.raw && (ev.raw.idEvent || ev.raw.id));
        if (!eventId) throw new Error('Event id not available.');

        const details = await fetchEventDetails(eventId);
        statsArea.innerHTML = renderBoxScoreAndPlayers(details);
        statsArea.style.display = 'block';
        statsBtn.textContent = 'Hide';
      } catch (err) {
        console.error('Stats load failed', err);
        statsArea.innerHTML = `<div style="color:var(--muted)">Failed to load stats.</div>`;
        statsArea.style.display = 'block';
      } finally {
        statsBtn.disabled = false;
      }
    };
  }

  /* ---------- Morning brief handlers (compact cards, no timestamp, no per-card narrative) ---------- */

function formatMoney(n) {
  try {
    if (n === null || typeof n === 'undefined') return null;
    return Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  } catch { return String(n); }
}

function relativeTime(iso) {
  try {
    const date = new Date(iso);
    const now = new Date();
    const diffMs = now - date;
    const diffMin = Math.round(diffMs / 60000);
    if (Math.abs(diffMin) < 1) return 'just now';
    if (Math.abs(diffMin) < 60) return `${diffMin}m`;
    const diffHours = Math.round(diffMin / 60);
    if (Math.abs(diffHours) < 24) return `${diffHours}h`;
    const diffDays = Math.round(diffHours / 24);
    return `${diffDays}d`;
  } catch { return iso || ''; }
}

/*
  Render the morning brief.
  - Accepts payload that may contain either `payload.metals` or `payload.symbols`
  - Uses snapshot-provided unit when present (m.unit)
  - Shows AUD price using m.priceAUD (your snapshot function writes AUD already)
  - Shows a small api hint if apiPriceUSD is present
*/
function renderMorningBrief(payload) {
  if (!payload) {
    briefContent.innerHTML = `<div class="brief-loading">No briefing available.</div>`;
    return;
  }

  const sourceNote = (payload._debug && payload._debug.fxSource) ? `Source: Metals-API Â· FX: ${payload._debug.fxSource}` : 'Source: Metals-API';
  const cachedHint = (payload._debug && payload._debug.cached) ? '<span style="color:var(--muted);font-size:0.9rem"> Â· cached</span>' : '';

  // Accept either payload.metals (old) or payload.symbols (snapshot-metals.js)
  const metalsObj = (payload.metals && typeof payload.metals === 'object')
    ? payload.metals
    : (payload.symbols && typeof payload.symbols === 'object')
      ? payload.symbols
      : null;

  if (metalsObj) {
    const symbols = Object.keys(metalsObj);
    const friendly = { XAU: 'Gold', XAG: 'Silver', IRON: 'Iron', LITHIUM: 'Lithium', NI: 'Nickel', URANIUM: 'Uranium' };

    const topMetaHtml = `<div class="brief-top-meta"><div></div><div style="text-align:right">${escapeHtml(sourceNote)}${cachedHint}</div></div>`;

    const cards = symbols.map(sym => {
      const m = metalsObj[sym] || {};
      const priceAUDraw = (typeof m.priceAUD === 'number') ? m.priceAUD : null;
      const pct = (typeof m.pctChange === 'number') ? m.pctChange : null;

      // Prefer explicit unit from snapshot; fallback to heuristic
      const unitFromSnapshot = (m.unit || m.unit === '' ? m.unit : (m.unitName || '')).toString().trim();
      const unit = unitFromSnapshot || ((sym === 'XAU' || sym === 'XAG') ? 'oz' : (sym === 'IRON' ? 'tonne' : 'unit'));

      const priceDisplay = priceAUDraw !== null ? `$${formatMoney(priceAUDraw)} AUD` : '<span style="color:#ffd166">Unavailable</span>';

      // pct badge
      let pctHtml = `<span class="brief-badge no-data" aria-hidden="true">â€”</span>`;
      if (pct !== null) {
        if (pct > 0) pctHtml = `<span class="brief-badge up" aria-label="${pct}% up">â–² ${Math.abs(pct)}%</span>`;
        else if (pct < 0) pctHtml = `<span class="brief-badge down" aria-label="${pct}% down">â–¼ ${Math.abs(pct)}%</span>`;
        else pctHtml = `<span class="brief-badge neutral" aria-label="unchanged">â€” 0%</span>`;
      }

      // optional trace: show original API USD (apiPriceUSD) small hint if present
      const apiUsdRaw = (typeof m.apiPriceUSD === 'number') ? m.apiPriceUSD : (typeof m.apiPriceUsd === 'number' ? m.apiPriceUsd : null);
      const apiHint = (apiUsdRaw !== null) ? `<div style="font-size:0.72rem;color:var(--muted);margin-top:6px">api: $${formatMoney(apiUsdRaw)} USD</div>` : '';

      return `
        <div class="card-metal" role="group" aria-label="${escapeHtml(friendly[sym] || sym)} price card">
          <div class="metal-head">
            <div>
              <div class="metal-name"><strong>${escapeHtml(friendly[sym] || sym)}</strong> <small style="color:var(--muted)">(${escapeHtml(sym)})</small></div>
              <div class="metal-price">${priceDisplay} <small class="metal-sub" style="color:var(--muted);font-weight:600">${escapeHtml('/' + unit)}</small></div>
            </div>
            <div style="text-align:right">
              ${pctHtml}
            </div>
          </div>
          ${apiHint}
        </div>
      `;
    }).join("");

    briefContent.innerHTML = `${topMetaHtml}<div class="brief-grid">${cards}</div>`;
    return;
  }

  // Fallback: old single-gold payload shape
  const narrative = payload.narrative || (payload.priceAUD ? `The spot gold price is currently $${payload.priceAUD} AUD.` : 'The spot gold price is currently unavailable.');
  const fallbackHtml = `
    <div class="brief-top-meta">
      <div></div>
      <div style="text-align:right">${escapeHtml(sourceNote)}${cachedHint}</div>
    </div>
    <div style="padding:0.6rem;border-radius:8px;background:linear-gradient(180deg, rgba(20,24,40,0.84), rgba(12,14,26,0.78));border:1px solid rgba(255,255,255,0.03)">
      <div style="font-size:0.9rem;color:var(--muted)"><strong>Spot gold</strong></div>
      <div style="margin-top:0.35rem;color:#fff;font-weight:600">${escapeHtml(narrative)}</div>
    </div>
  `;
  briefContent.innerHTML = fallbackHtml;
}

/* ---------- open / refresh handlers (unchanged) ---------- */
openBriefBtn.addEventListener("click", async () => {
  const region = briefRegionSelect.value || "au";
  if (briefContent.style.display === "block") {
    briefContent.style.display = "none";
    openBriefBtn.textContent = "Open morning brief";
    return;
  }

  briefContent.style.display = "block";
  openBriefBtn.textContent = "Hide brief";

  briefContent.innerHTML = `<div class="brief-loading">Loading briefingâ€¦</div>`;
  try {
    const res = await fetch(`/.netlify/functions/morning-brief?region=${encodeURIComponent(region)}`);
    if (!res.ok) {
      const t = await res.text();
      throw new Error(t || 'Brief fetch failed');
    }
    const payload = await res.json();
    renderMorningBrief(payload);
  } catch (err) {
    console.error('Morning brief failed', err);
    briefContent.innerHTML = `<div class="brief-loading">Failed to load morning brief.</div>`;
  }
});

refreshBriefBtn.addEventListener("click", async () => {
  if (briefContent.style.display !== "block") {
    openBriefBtn.click();
    return;
  }
  try {
    briefContent.innerHTML = `<div class="brief-loading">Refreshing briefingâ€¦</div>`;
    const region = briefRegionSelect.value || "au";
    const res = await fetch(`/.netlify/functions/morning-brief?region=${encodeURIComponent(region)}`);
    if (!res.ok) throw new Error('Refresh failed');
    const payload = await res.json();
    renderMorningBrief(payload);
  } catch (err) {
    console.error('Refresh failed', err);
    briefContent.innerHTML = `<div class="brief-loading">Failed to refresh morning brief.</div>`;
  }
});
  /* ---------- Toggles & category handling ---------- */

  function setActiveToggle(isMarket) {
    if (isMarket) {
      toggleMarket.classList.add("active");
      toggleMarket.setAttribute("aria-selected","true");
      toggleMates.classList.remove("active");
      toggleMates.setAttribute("aria-selected","false");
    } else {
      toggleMates.classList.add("active");
      toggleMates.setAttribute("aria-selected","true");
      toggleMarket.classList.remove("active");
      toggleMarket.setAttribute("aria-selected","false");
    }
  }

  toggleMarket.onclick = async () => {
    setActiveToggle(true);
    feedStatus.textContent = "Market mode";
    showSkeleton(4);
    allArticles = await getMarketFeed();
    renderMarketMode();
  };

  toggleMates.onclick = () => {
    setActiveToggle(false);
    feedStatus.textContent = "MatesMode";
    renderMatesMode();
  };

  categoryRow.onclick = (e) => {
    const btn = e.target.closest(".chip");
    if (!btn) return;
    currentCategory = btn.dataset.category;

    [...categoryRow.children].forEach(b => b.classList.remove("chip-active"));
    btn.classList.add("chip-active");

    if (toggleMates.classList.contains("active")) {
      renderMatesMode();
    } else {
      renderMarketMode();
    }
  };

  /* ---------- Initial load ---------- */
  (async function init() {
    try {
      feedStatus.textContent = "Loadingâ€¦";
      showSkeleton(4);
      allArticles = await getMarketFeed();
      renderMarketMode();
      feedStatus.textContent = "Live";
    } catch (err) {
      console.error(err);
      newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">Failed to load initial feed.</small></div>`;
      feedStatus.textContent = "Offline";
    }
  })();
</script>

</body>
</html>