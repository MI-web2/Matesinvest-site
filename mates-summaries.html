<!--
Only the relevant script & small CSS snippets are shown below ‚Äî insert them into your existing mates-summaries.html script section.
This block replaces/augments the renderEventStats and related UI bits from earlier.
-->
<style>
  /* Add timeline styling (insert into your page CSS) */
  .event-timeline { display:flex; flex-direction:column; gap:0.45rem; margin-top:0.4rem; }
  .timeline-item { display:flex; gap:0.6rem; align-items:flex-start; font-size:0.92rem; color:var(--muted-2) }
  .timeline-bullet { width:10px; height:10px; border-radius:999px; background:var(--accent); margin-top:4px; flex-shrink:0 }
  .timeline-min { width:36px; color:var(--muted); font-weight:600 }
  .lineup-block { background:rgba(255,255,255,0.02); padding:0.6rem; border-radius:8px; margin-top:0.5rem; color:var(--muted-2) }
  .stat-row { display:flex; gap:1rem; flex-wrap:wrap; color:var(--muted-2); font-size:0.92rem; margin-top:0.45rem }
  .stat-pill { padding:0.18rem 0.6rem; border-radius:999px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02) }
</style>

<script>
  // Add these helper functions and replace the previous renderEventStats() with this richer one.

  function parseGoalDetails(raw) {
    // TheSportsDB often returns semicolon-separated events like "45' John Smith; 67' Joe Bloggs"
    if (!raw || !raw.trim()) return [];
    // normalize separators
    const parts = raw.split(/;|\n/).map(p => p.trim()).filter(Boolean);
    const events = parts.map(p => {
      // try to extract minute and the rest
      // examples: "45' John Smith (pen.)" or "90+2' Player Name"
      const m = p.match(/^(\d+\+?\d*)'?[\s-‚Äì:]?\s*(.+)$/);
      if (m) {
        return { minute: m[1] + "'", text: m[2] };
      }
      // fallback - return the whole string
      return { minute: '', text: p };
    });
    return events;
  }

  function renderLineupSection(title, lineupStr) {
    if (!lineupStr || !lineupStr.trim()) return '';
    // lineup strings often are comma separated: "Player1, Player2, Player3"
    const players = lineupStr.split(/, ?/).map(s => s.trim()).filter(Boolean);
    return `<div class="lineup-block" role="group" aria-label="${escapeHtml(title)}">
      <strong style="color:var(--muted)">${escapeHtml(title)}</strong>
      <div style="margin-top:0.35rem">${players.map(p => `<div>${escapeHtml(p)}</div>`).join('')}</div>
    </div>`;
  }

  function renderEventStats(ev = {}) {
    // fields from sports-test mapping
    const home = ev.home || ev.homeTeam || '';
    const away = ev.away || ev.awayTeam || '';
    const homeScore = (ev.homeScore !== undefined && ev.homeScore !== null) ? ev.homeScore : (ev.scoreHome || null);
    const awayScore = (ev.awayScore !== undefined && ev.awayScore !== null) ? ev.awayScore : (ev.scoreAway || null);
    const status = ev.status || ev.state || '';
    const venue = ev.venue || ev.location || '';
    const time = formatTime(ev.localTime || ev.utcTime || ev.time);
    const season = ev.season || '';
    const description = ev.description || '';

    const homeGoalsRaw = ev.homeGoalDetails || ev.homeGoalDetails === '' ? ev.homeGoalDetails : ev.raw?.strHomeGoalDetails || '';
    const awayGoalsRaw = ev.awayGoalDetails || ev.raw?.strAwayGoalDetails || '';
    const homeShots = (ev.homeShots !== undefined && ev.homeShots !== null) ? ev.homeShots : ev.raw?.intHomeShots || null;
    const awayShots = (ev.awayShots !== undefined && ev.awayShots !== null) ? ev.awayShots : ev.raw?.intAwayShots || null;

    const timeline = [];
    parseGoalDetails(homeGoalsRaw).forEach(it => timeline.push({side: 'home', ...it}));
    parseGoalDetails(awayGoalsRaw).forEach(it => timeline.push({side: 'away', ...it}));
    // sort timeline by minute numeric value if possible
    const minuteToNumber = m => {
      if (!m) return 9999;
      const clean = m.replace("'", "");
      if (clean.includes('+')) {
        const [base, extra] = clean.split('+').map(Number);
        return base * 100 + (extra || 0);
      }
      return Number(clean);
    };
    timeline.sort((a,b) => minuteToNumber(a.minute) - minuteToNumber(b.minute));

    // build HTML
    const rows = [];
    rows.push(`<div class="stat-row">
      <div class="stat-pill"><strong>${escapeHtml(String(home || ''))}</strong> ${homeScore !== null ? `<span style="opacity:0.9"> ${escapeHtml(String(homeScore))}</span>` : ''}</div>
      <div style="align-self:center;color:var(--muted)">vs</div>
      <div class="stat-pill"><strong>${escapeHtml(String(away || ''))}</strong> ${awayScore !== null ? `<span style="opacity:0.9"> ${escapeHtml(String(awayScore))}</span>` : ''}</div>
      <div style="margin-left:auto;color:var(--muted)">${escapeHtml(status)}</div>
    </div>`);

    if (venue || season || time) {
      rows.push(`<div class="stat-row">
        ${venue ? `<div class="stat-pill">üìç ${escapeHtml(venue)}</div>` : ''}
        ${season ? `<div class="stat-pill">Season: ${escapeHtml(season)}</div>` : ''}
        ${time ? `<div class="stat-pill">‚è± ${escapeHtml(time)}</div>` : ''}
      </div>`);
    }

    // Shots row (if available)
    if (homeShots !== null || awayShots !== null) {
      rows.push(`<div class="stat-row">
        <div class="stat-pill">Shots: ${homeShots !== null ? escapeHtml(String(homeShots)) : '‚Äî' } ‚Äî ${awayShots !== null ? escapeHtml(String(awayShots)) : '‚Äî'}</div>
      </div>`);
    }

    // Timeline
    if (timeline.length) {
      rows.push(`<div style="margin-top:0.45rem"><strong style="color:var(--muted-2)">Timeline</strong>
        <div class="event-timeline">
          ${timeline.map(evItem => `
            <div class="timeline-item">
              <div class="timeline-bullet" aria-hidden="true" style="background:${evItem.side === 'home' ? 'var(--accent)' : 'rgba(255,255,255,0.16)'}"></div>
              <div style="display:flex;gap:0.5rem;align-items:flex-start">
                <div class="timeline-min">${escapeHtml(evItem.minute || '')}</div>
                <div style="max-width:680px;color:var(--muted)">${escapeHtml(evItem.text || '')}</div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>`);
    }

    // Lineups and formations (collapsible)
    const homeLineup = renderLineupSection('Home goalkeeper & lineups', ev.homeLineupGoalkeeper + (ev.homeLineupDefense ? ', ' + ev.homeLineupDefense : '') + (ev.homeLineupMidfield ? ', ' + ev.homeLineupMidfield : '') + (ev.homeLineupForward ? ', ' + ev.homeLineupForward : ''));
    const awayLineup = renderLineupSection('Away goalkeeper & lineups', ev.awayLineupGoalkeeper + (ev.awayLineupDefense ? ', ' + ev.awayLineupDefense : '') + (ev.awayLineupMidfield ? ', ' + ev.awayLineupMidfield : '') + (ev.awayLineupForward ? ', ' + ev.awayLineupForward : ''));

    if (homeLineup || awayLineup) {
      rows.push(`<details style="margin-top:0.6rem">
        <summary style="cursor:pointer;color:var(--muted-2)"><strong>Lineups & formations</strong></summary>
        <div style="margin-top:0.45rem">
          ${ev.homeFormation ? `<div style="margin-bottom:0.4rem"><strong style="color:var(--muted-2)">Home formation:</strong> ${escapeHtml(ev.homeFormation)}</div>` : ''}
          ${homeLineup || ''}
          ${ev.awayFormation ? `<div style="margin-top:0.45rem;margin-bottom:0.4rem"><strong style="color:var(--muted-2)">Away formation:</strong> ${escapeHtml(ev.awayFormation)}</div>` : ''}
          ${awayLineup || ''}
        </div>
      </details>`);
    }

    // Description / notes
    if (description) {
      rows.push(`<details style="margin-top:0.6rem">
        <summary style="cursor:pointer;color:var(--muted-2)"><strong>Match notes</strong></summary>
        <div style="margin-top:0.45rem;color:var(--muted-2)">${escapeHtml(description)}</div>
      </details>`);
    }

    return rows.join('');
  }

  // Keep escapeHtml and formatTime helpers that already exist in your page
  function escapeHtml(str = "") {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  function formatTime(iso) {
    try {
      const d = new Date(iso);
      if (isNaN(d)) return "";
      return new Intl.DateTimeFormat(undefined, { dateStyle:'short', timeStyle:'short' }).format(d);
    } catch { return iso || ""; }
  }
</script>