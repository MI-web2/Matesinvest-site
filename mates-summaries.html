<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Open Graph -->
  <meta property="og:title" content="MatesFeed ‚Äì Plain-English market summaries | MatesInvest" />
  <meta property="og:description" content="MatesFeed delivers live market headlines and plain-English AI summaries built for Australian retail investors." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://matesinvest.com/mates-summaries" />
  <meta property="og:image" content="https://matesinvest.com/assets/img/matesfeed-og.png" />
  <meta property="og:image:width" content="945" />
  <meta property="og:image:height" content="630" />
  <meta property="og:site_name" content="MatesInvest" />

  <!-- Twitter / X -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="MatesFeed ‚Äì Plain-English market summaries | MatesInvest" />
  <meta name="twitter:description" content="MatesFeed delivers live market headlines and plain-English AI summaries built for Australian retail investors." />
  <meta name="twitter:image" content="https://matesinvest.com/assets/img/matesfeed-og.png" />

  <link rel="icon" type="image/png" href="/assets/img/favicon.png">
  <link rel="apple-touch-icon" href="/assets/img/favicon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

  <style>
    :root{
      --navy: #002040;
      --cyan: #00BFFF;
      --bg: #f5f7fb;
      --card: #ffffff;
      --muted: #64748b;
      --muted-2: #94a3b8;
      --accent: var(--cyan);
      --accent-strong: #0093cc;
      --accent-soft: rgba(0,191,255,0.10);
      --border: #e2e8f0;
      --card-border: #e2e8f0;
      --glass: rgba(255,255,255,0.9);
      --radius: 18px;
      --gap: 1rem;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(circle at top left, #e2ebff 0, #f5f7fb 55%);
      color:#0b1220;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.4;
      padding-bottom:3rem;
    }

    .page-shell{
      max-width:1080px;
      margin:0 auto;
      padding:1.5rem 1.25rem 3rem;
      position:relative;
    }

    /* Decorative square pattern in top-right */
    .corner-pattern {
      position:absolute;
      top:-18px;
      right:0;
      width:150px;
      height:150px;
      background:
        linear-gradient(135deg, rgba(0,191,255,0.25), rgba(0,32,64,0.05)),
        linear-gradient(90deg, rgba(148,163,184,0.35) 1px, transparent 1px),
        linear-gradient(180deg, rgba(148,163,184,0.35) 1px, transparent 1px);
      background-size: 100% 100%, 18px 18px, 18px 18px;
      border-radius: 24px;
      opacity:0.7;
      pointer-events:none;
      z-index:-1;
    }

    /* Accessible visually-hidden utility (keeps H1 for SEO / screen readers) */
    .visually-hidden {
      position: absolute !important;
      height: 1px;
      width: 1px;
      overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap;
      border: 0;
      padding: 0;
      margin: -1px;
    }

    /* NAV ‚Äì aligned to main site/app */
    .nav{
      position:sticky;
      top:0;
      z-index:30;
      backdrop-filter: blur(12px);
      background: rgba(255,255,255,0.96);
      border-bottom: 1px solid #eef1f6;
    }
    .nav-inner{
      max-width:1080px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
      padding:0.7rem 1.25rem;
    }
    .nav-tagline-short {
  display: none;
}

@media (max-width:640px) {
  .nav-tagline-full {
    display: none;
  }
  .nav-tagline-short {
    display: inline;
    font-size: 0.78rem;
  }
}

    .nav-left{display:flex;align-items:center;gap:0.75rem}
    .nav-logo{height:40px;width:40px;border-radius:10px;object-fit:cover}
    .nav-title{font-weight:700;font-size:1.05rem;color:var(--navy)}
    .nav-pill{
      padding:0.15rem 0.65rem;
      border-radius:999px;
      font-size:0.75rem;
      background:#e7f7ff;
      color:#083a59;
      border:1px solid #c5e5ff;
    }
    .nav-right{
      font-size:0.82rem;
      color:var(--muted);
      display:flex;
      gap:0.75rem;
      align-items:center
    }
    .nav-home-link{
      padding:0.4rem 0.9rem;
      border-radius:999px;
      border:1px solid #cfd8e3;
      text-decoration:none;
      color:#0b1220;
      background:#ffffff;
      font-weight:600;
      font-size:0.86rem;
    }
    .nav-home-link:hover{
      background:#f3f6fb;
    }

    /* Generic card */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding:1.25rem 1.4rem;
      margin-bottom:1.1rem;
      border:1px solid var(--card-border);
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
    }
    .card h2{
      margin:0;
      font-size:1.25rem;
      color:var(--navy);
    }

    /* Morning brief header */
    .brief-header {
      display:flex;
      align-items:center;
      gap:0.75rem;
      justify-content:space-between;
    }
    .brief-header small {
      color:var(--muted);
    }
    .brief-controls {
      display:flex;
      gap:0.5rem;
      align-items:center;
    }
    .brief-toggle {
      padding:0.4rem 0.8rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:#ffffff;
      color:var(--muted);
      cursor:pointer;
      font-size:0.85rem;
    }
    .brief-toggle.primary {
      background:var(--accent);
      color:#001220;
      font-weight:700;
      border:1px solid rgba(0,0,0,0.04);
    }

    .brief-content {
      margin-top:0.9rem;
      display:none;
    }
    .brief-loading {
      color:var(--muted);
      font-size:0.95rem;
    }

    /* Top meta (As of / source) */
    .brief-top-meta {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
      color:var(--muted);
      font-size:0.9rem;
    }

    /* Percent badges */
    .brief-badge {
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-weight:700;
      font-size:0.9rem;
    }
    .brief-badge.up {
      background:rgba(22,163,74,0.08);
      color:#15803d;
      border:1px solid rgba(22,163,74,0.25);
    }
    .brief-badge.down {
      background:rgba(220,38,38,0.06);
      color:#b91c1c;
      border:1px solid rgba(220,38,38,0.22);
    }
    .brief-badge.neutral {
      background:rgba(148,163,184,0.1);
      color:#475569;
    }
    .brief-badge.no-data {
      background:transparent;
      color:var(--muted);
      font-weight:600;
      border-radius:999px;
      padding:3px 6px;
      opacity:0.9;
    }

    /* Morning brief grid & cards */
.brief-grid {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 8px;
}
    .metals-header-row {
  padding: 0 2px 2px;
}
.metals-title {
  font-size: 1.02rem;
  font-weight: 600;
}
/* Stack commodity cards full-width */
.metals-grid {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

@media (max-width: 480px) {
  .metals-grid {
    grid-template-columns: 1fr; /* Single column on small phones */
  }
}


    .brief-top-cards {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width:800px) {
      .brief-top-cards { grid-template-columns: 1fr; }
    }

.card-metal {
  padding: 0.85rem 1rem;
  border-radius: 16px;
  background: #f9fbff;
  border: 1px solid #e2e8f0;
  box-shadow: 0 14px 30px rgba(15,23,42,0.10);
  transition: transform 140ms ease, box-shadow 140ms ease, background 140ms ease;
  color: #0f172a;
  width: 100%;
  text-align: left;
}
.card-metal:hover {
  transform: translateY(-3px);
  background: #ffffff;
  box-shadow: 0 18px 40px rgba(15,23,42,0.16);
}
.metal-head {
  display: grid;
  grid-template-columns: minmax(0, 1fr) auto;
  column-gap: 8px;
  align-items: center;
}
.metal-name {
  font-size: 0.9rem;
  font-weight: 600;
  color: #0f172a;
}
.metal-price {
  margin-top: 4px;
  font-weight: 800;
  font-size: 1.05rem;
  color: #0f172a;
  display: inline-flex;
  align-items: baseline;
  gap: 4px;
}
.metal-sub {
  font-size: 0.82rem;
  color: var(--muted-2);
}

    /* Mates Morning Note & SOTD cards */
    .mates-note {
      background:#f9fbff;
      border: 1px solid #dbeafe;
      padding: 0.9rem 1rem;
      border-radius: 14px;
    }
    .mates-note-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:0.4rem;
    }
    .mates-note-header .pill {
      background: var(--accent-soft);
      color: var(--accent-strong);
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      border:1px solid rgba(0,191,255,0.35);
    }
    .mates-note-body { font-size:0.92rem; color:#0b1220; line-height:1.45; }
    .mates-note .timestamp { font-size:0.78rem; color: var(--muted-2); }

    .sotd-card {
      background:#f9fbff;
      border: 1px solid #dbeafe;
      border-radius: 14px;
      padding: 0.9rem 1rem;
    }
    .sotd-header { display:flex; justify-content:space-between; align-items:center; gap:0.75rem; flex-wrap:wrap; margin-bottom:0.4rem; }
    .sotd-title-left { display:flex; align-items:center; gap:0.4rem; flex-wrap:wrap; }
    .sotd-pill { background: var(--accent-soft); color: var(--accent-strong); padding: 3px 10px; border-radius: 999px; font-size: 0.78rem; border:1px solid rgba(0,191,255,0.35); }
    .sotd-ticker { font-weight:600; letter-spacing:0.04em; font-size:0.9rem; color:var(--navy); }
    .sotd-name { font-size:0.9rem; color:var(--muted); }
    .sotd-exchange { font-size:0.8rem; color:var(--muted-2); }
    .sotd-summary { font-size:0.9rem; line-height:1.45; color:#0b1220; margin-bottom:0.35rem; }
    .sotd-disclaimer { font-size:0.78rem;color:var(--muted-2); }

    /* Top performers UI */
    .top-performers {
      margin-top: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
    }
    .perf-card {
      background:#f9fafb;
      border: 1px solid #e2e8f0;
      padding: 10px;
      border-radius: 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:72px;
      justify-content:center;
    }
    .perf-top { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .perf-symbol { font-weight:800; font-size:1rem; color:#0f172a; }
    .perf-exch { font-size:0.78rem; color:var(--muted-2); }
    .perf-last { font-size:0.95rem; font-weight:700; color:#0f172a; }
    .perf-pct { font-weight:700; font-size:0.86rem; padding:4px 8px; border-radius:999px; align-self:flex-start; }
    .perf-pct.up { background: rgba(22,163,74,0.06); color: #15803d; border: 1px solid rgba(22,163,74,0.22); }
    .perf-pct.down { background: rgba(220,38,38,0.06); color: #b91c1c; border: 1px solid rgba(220,38,38,0.22); }
    .perf-pct.neutral { background:rgba(148,163,184,0.08); color:#475569; }
    .perf-note { color:var(--muted-2); font-size:0.82rem; }
    @media (max-width:560px) {
      .top-performers { grid-template-columns: repeat(2, 1fr); }
    }

    /* Controls & chips */
    .controls {
      display:flex;
      gap:var(--gap);
      align-items:center;
      flex-wrap:wrap;
      margin-top:0.6rem;
    }
    .segmented {
      display:inline-flex;
      background:#f1f5f9;
      border-radius:999px;
      padding:3px;
      gap:4px;
      border:1px solid var(--border);
    }
    .segmented button{
      background:transparent;
      border:0;
      padding:0.45rem 0.85rem;
      color:var(--muted);
      border-radius:999px;
      cursor:pointer;
      font-size:0.88rem;
      transition: all .16s ease;
    }
    .segmented button.active{
      background: linear-gradient(180deg,var(--accent), var(--accent-strong));
      color:#001220;
      box-shadow: 0 6px 18px rgba(15,23,42,0.2);
    }

    .chip-row{
      display:flex;
      gap:0.5rem;
      flex-wrap:wrap;
      margin-top:0.6rem;
    }
    .chip{
      padding:0.32rem 0.7rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:#ffffff;
      color:var(--muted);
      cursor:pointer;
      font-size:0.82rem;
      transition: all .14s ease;
    }
    .chip:hover{background:#f8fafc}
    .chip-active{
      background:var(--accent-soft);
      color:#001220;
      border-color:var(--accent);
      font-weight:600;
    }

    .sport-row{
      display:flex;
      gap:0.5rem;
      flex-wrap:wrap;
      margin-top:0.6rem;
    }
    .sport-chip{
      padding:0.28rem 0.6rem;
      border-radius:999px;
      border:1px solid #e2e8f0;
      background:#f9fafb;
      color:var(--muted);
      cursor:pointer;
      font-size:0.82rem;
    }
    .sport-chip.active{
      background:#e0f2fe;
      border-color:#bae6fd;
      color:#0b1220;
      box-shadow:0 1px 0 rgba(15,23,42,0.07);
    }
    .sport-tag{
      display:inline-block;
      padding:0.12rem 0.5rem;
      border-radius:999px;
      background:#e2e8f0;
      font-size:0.78rem;
      color:#475569;
      border:1px solid #cbd5e1;
    }

    /* News list */
    #newsList{
      margin-top:0.85rem;
      display:flex;
      flex-direction:column;
      gap:0.85rem;
    }
.headline{
  display:block;
  padding:0.75rem 0.8rem;              /* slightly tighter */
  border-radius:12px;
  background:#f9fbff;
  border:1px solid #e2e8f0;
  transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
}
    .headline:hover{
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(15,23,42,0.18);
      background:#ffffff;
    }

    .meta-row{
      display:flex;
      align-items:center;
      gap:0.6rem;
      justify-content:space-between;
    }
    .meta-left{
      display:flex;
      align-items:center;
      gap:0.65rem;
      min-width:0;
    }
    .meta-actions{
  display:flex;
  gap:0.5rem;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}

@media (max-width:640px){
  .meta-actions{
    justify-content:flex-start; /* on mobile, line up under the title */
  }
.headline h3{
  margin:0 0 0.18rem 0;
  font-size:0.9rem;                    /* smaller headline text */
  line-height:1.3;
  color:#0b1220;
  display:-webkit-box;                 /* allow 2-line wrap */
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  text-overflow:ellipsis;
}
.headline small{
  color:var(--muted-2);
  font-size:0.78rem;                   /* slightly smaller meta line */
  display:block;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
    .headline .actions{
      display:flex;
      gap:0.6rem;
      align-items:center;
      margin-top:0.6rem;
    }

    .btn{
      background:var(--accent);
      border:none;
      padding:0.5rem 0.95rem;
      border-radius:999px;
      cursor:pointer;
      color:#001220;
      font-weight:700;
      font-size:0.86rem;
      transition: transform .08s ease, opacity .12s ease, box-shadow .12s ease;
      box-shadow:0 5px 14px rgba(15,23,42,0.22);
    }
    .btn:active{ transform: translateY(1px) }
    .btn:disabled{ opacity:0.6; cursor:default }

    .link-min{
      background:#ffffff;
      border:1px solid var(--border);
      color:#0b1220;
      padding:0.42rem 0.7rem;
      border-radius:999px;
      text-decoration:none;
      font-size:0.83rem;
    }
    .link-min:hover{ background:#f8fafc }

    .summary-output{ margin-top:0.65rem }

    .summary-block{
      margin-top:0.45rem;
      border-top:1px dashed #e2e8f0;
      padding-top:0.6rem;
      font-size:0.95rem;
      color:#0b1220;
    }
    .summary-block p{margin:0.45rem 0}
    .tldr-list{
      margin:0.35rem 0 0 0.85rem;
      padding:0;
      list-style:none;
      color:var(--muted);
    }
    .tldr-list li{
      margin:0.25rem 0;
      position:relative;
      padding-left:1.05rem;
    }
    .tldr-list li::before{
      content:"";
      width:8px;height:8px;
      border-radius:2px;
      background:var(--accent);
      position:absolute;
      left:0.15rem;
      top:0.55rem;
      box-shadow:0 1px 0 rgba(15,23,42,0.25);
    }

    .summary-meta{
      color:var(--muted-2);
      font-size:0.82rem;
      margin-top:0.45rem;
    }

    /* Timeline & stats styles */
    .event-timeline {
      display:flex;
      flex-direction:column;
      gap:0.45rem;
      margin-top:0.4rem;
    }
    .timeline-item {
      display:flex;
      gap:0.6rem;
      align-items:flex-start;
      font-size:0.92rem;
      color:var(--muted-2);
    }
    .timeline-bullet {
      width:10px;
      height:10px;
      border-radius:999px;
      background:var(--accent);
      margin-top:4px;
      flex-shrink:0;
    }
    .timeline-min {
      width:36px;
      color:var(--muted);
      font-weight:600;
    }
    .lineup-block {
      background:#f9fafb;
      padding:0.6rem;
      border-radius:8px;
      margin-top:0.5rem;
      color:var(--muted-2);
      border:1px solid #e2e8f0;
    }
    .stat-row {
      display:flex;
      gap:1rem;
      flex-wrap:wrap;
      color:var(--muted-2);
      font-size:0.92rem;
      margin-top:0.45rem;
    }
    .stat-pill {
      padding:0.18rem 0.6rem;
      border-radius:999px;
      background:#f9fafb;
      border:1px solid #e2e8f0;
    }

    .skeleton{
      background:linear-gradient(90deg, #e5e7eb, #f3f4f6, #e5e7eb);
      border-radius:8px;
      height:68px;
      animation: shimmer 1.2s linear infinite;
      background-size:220px 100%;
    }
    @keyframes shimmer{
      0%{ background-position:-120px 0 }
      100%{ background-position:220px 0 }
    }

@media (max-width:640px){
  .meta-row{ flex-direction:column; align-items:flex-start; gap:0.5rem }
}
    }

    /* MOBILE tidy-up */
    @media (max-width: 480px) {
      .page-shell { padding: 0.9rem 1rem 2rem; }

      .nav-inner { padding: 0.55rem 1rem; gap:0.5rem; }
      .nav-logo { height:32px; width:32px; }
      .nav-title { font-size:0.98rem; }
      .nav-pill { display:none; }
      .nav-right { font-size:0.78rem; gap:0.5rem; }

      .brief-header {
        flex-direction: column;
        align-items:flex-start;
        gap:0.6rem;
      }
      .brief-controls {
        width:100%;
        flex-wrap:wrap;
      }

      .card { padding:1rem; border-radius:16px; }
      .card-metal { padding:0.7rem; min-height:72px; }

      .chip-row {
        overflow-x:auto;
        -webkit-overflow-scrolling:touch;
        padding-bottom:6px;
      }
      .chip { white-space:nowrap; }

      .btn, .link-min { padding:0.42rem 0.75rem; font-size:0.82rem; }

      body { padding-bottom:2rem; }
    }
    /* Overlay */
.mi-ins-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.55); /* slate-ish overlay */
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* Modal */
.mi-ins-modal {
  background: #0b1020;
  color: #f9fafb;
  border-radius: 18px;
  max-width: 700px;
  max-height: 90vh;       /* don‚Äôt let it grow taller than the screen */
  overflow-y: auto;       /* scroll inside the modal */
  width: 100%;
  padding: 20px 22px 22px;
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
  border: 1px solid rgba(148, 163, 184, 0.25);
  position: relative;
}

/* Close button */
.mi-ins-close {
  position: absolute;   /* not absolute anymore */
  top: 8px;
  right: 12px;
  font-size: 20px;
  color: #9ca3af;
  background: transparent;
  border: none;
  cursor: pointer;
  z-index: 200;          /* extra safety */
}

.mi-ins-close:hover {
  color: #e5e7eb;
}

/* Header */
.mi-ins-header {
  display: flex;
  justify-content: space-between;
  gap: 16px;
  margin-bottom: 14px;

  position: sticky;
  top: 0;
  background: #0b1020;
  z-index: 50; /* bump this up */
  padding-bottom: 8px;
  padding-top: 6px;
  position: relative;
}

.mi-ins-title {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
}

.mi-ins-subtitle {
  margin-top: 4px;
  font-size: 13px;
  color: #9ca3af;
}

/* Price block */
.mi-ins-price-block {
  text-align: right;
}

.mi-ins-price {
  font-size: 20px;
  font-weight: 600;
}

.mi-ins-change {
  font-size: 13px;
  margin-top: 2px;
}

.mi-ins-change.up {
  color: #4ade80; /* green-ish */
}

.mi-ins-change.down {
  color: #f97373; /* red-ish */
}

.mi-ins-date {
  font-size: 11px;
  color: #6b7280;
  margin-top: 3px;
}

/* Tags */
.mi-ins-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 16px;
}

.mi-ins-tag {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 999px;
  background: rgba(31, 41, 55, 0.85);
  color: #e5e7eb;
  border: 1px solid rgba(55, 65, 81, 0.9);
}

/* Sections */
.mi-ins-section {
  margin-bottom: 14px;
}

.mi-ins-section-title {
  font-size: 13px;
  font-weight: 600;
  margin: 0 0 8px;
  color: #d1d5db;
}

/* Stats grid */
.mi-ins-stats-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px 16px;
}

.mi-ins-stat-item {
  font-size: 12px;
}

.mi-ins-stat-label {
  color: #9ca3af;
  display: block;
  margin-bottom: 2px;
}

.mi-ins-stat-value {
  font-weight: 500;
}

/* History placeholder */
.mi-ins-history-summary {
  font-size: 12px;
  color: #9ca3af;
  margin-bottom: 6px;
}

.mi-ins-history-placeholder {
  font-size: 11px;
  color: #6b7280;
  padding: 10px;
  border-radius: 12px;
  border: 1px dashed rgba(75, 85, 99, 0.8);
}

/* Mobile */
@media (max-width: 640px) {
  .mi-ins-modal {
    margin: 10px;
    padding: 16px 14px 18px;
  }

  .mi-ins-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .mi-ins-price-block {
    text-align: left;
  }

  .mi-ins-stats-grid {
    grid-template-columns: 1fr;
  }
}
    #mi-ins-chart {
  width: 100%;
  height: 220px;
  margin-top: 10px;
}
    .mi-ins-ai-summary {
  font-size: 0.9rem;
  color: #e5e7eb;
  background: rgba(15, 23, 42, 0.65);
  border-radius: 12px;
  padding: 10px 12px;
  border: 1px solid rgba(148, 163, 184, 0.3);
  line-height: 1.4;
}
    .brief-subtitle {
  color: var(--muted);
  font-size: 0.9rem;
  margin-top: 0.25rem;
  max-width: 30rem;
}

@media (max-width:640px) {
  .brief-subtitle {
    font-size: 0.8rem;
    line-height: 1.35;
    max-width: 100%;
  }
}
.segmented {
  background: #f1f5f9;
  border-radius: 999px;
  padding: 3px;
  gap: 4px;
  border: 1px solid var(--border);
  display: inline-flex;
  align-items: center;
}

/* make the individual segment buttons compact and pill-shaped */
.segmented button {
  background: transparent;
  border: 1px solid transparent;
  padding: 0.28rem 0.65rem;
  color: var(--muted);
  border-radius: 999px;
  cursor: pointer;
  font-size: 0.82rem;
  line-height: 1;
  transition: all .12s ease;
  box-shadow: none;
}

/* active segment: subtle filled pill like mobile */
.segmented button.active {
  background: var(--accent-soft);
  color: #001220;
  font-weight: 600;
  border-color: var(--accent);
  box-shadow: none;
}

/* chips (All / Energy / Tech / Macro / ...) same compact style on desktop */
.chip, .chip-row .chip {
  padding: 0.32rem 0.7rem;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: #ffffff;
  color: var(--muted);
  cursor: pointer;
  font-size: 0.82rem;
  white-space: nowrap;
  transition: background .12s ease, border-color .12s ease;
}
.chip:hover { background: #f8fafc; }
.chip-active,
.chip-row .chip-active {
  background: var(--accent-soft);        /* subtle light-blue */
  border-color: var(--accent);           /* bright cyan border */
  color: var(--navy);                    /* strong contrast */
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(0, 32, 64, 0.12); /* light clean shadow */
}

/* headline action buttons on the right ("Read original", "MatesInvest summary") */
.headline .meta-actions a,
.headline .meta-actions .link-min,
.headline .meta-actions .btn,
.headline .meta-actions button {
  display: inline-block;
  padding: 0.28rem 0.65rem;
  border-radius: 999px;
  font-size: 0.82rem;
  line-height: 1;
  text-decoration: none;
  border: 1px solid var(--border);
  background: #ffffff;
  color: #0b1220;
  cursor: pointer;
  white-space: nowrap;
  box-shadow: none;
}

/* accent "primary" style for the small CTA buttons when used inside headline actions */
.headline .meta-actions .btn {
  background: var(--accent);
  color: #001220;
  border-color: transparent;
}

/* make sure these compact styles apply on larger screens too */
@media (min-width: 641px) {
  .segmented button,
  .chip,
  .headline .meta-actions a,
  .headline .meta-actions .link-min,
  .headline .meta-actions .btn {
    /* same as above ‚Äî ensures desktop uses these compact values */
    padding: 0.28rem 0.65rem;
    border-radius: 999px;
    font-size: 0.82rem;
  }
}

/* small layout tweak so the meta-actions align similarly on desktop */
.meta-actions {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  justify-content: flex-end;
}

/* if you still see big/gradient segmented button on desktop, it may come
   from a rule that uses a background gradient ‚Äî add this to force the simple look */
.segmented button {
  background-image: none !important;
}
/* Reusable pill button matching "MatesInvest summary" */
.btn-pill {
  display:inline-block;
  padding:0.28rem 0.65rem;
  border-radius:999px;
  font-size:0.82rem;
  line-height:1;
  text-decoration:none;
  border:1px solid var(--border);
  background:#ffffff;
  color:#0b1220;
  cursor:pointer;
  white-space:nowrap;
  box-shadow:none;
  transition:background .12s ease, border-color .12s ease, transform .08s ease;
}

.btn-pill-primary {
  background:var(--accent);
  color:#001220;
  border-color:transparent;
}

.btn-pill-primary:active {
  transform:translateY(1px);
}
/* Floating Explain button */
.mi-explain-floating {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: var(--cyan);
  color: #ffffff;
  border: none;
  border-radius: 999px;
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0,0,0,0.16);
  z-index: 9998; /* below instrument overlay (9999), above content */
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
}

.mi-explain-floating:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 24px rgba(0,0,0,0.2);
  background: var(--accent-strong, #0093cc);
}

.mi-explain-icon {
  font-size: 16px;
  line-height: 1;
}

.mi-explain-label {
  font-size: 13px;
}

@media (max-width: 640px) {
  .mi-explain-floating {
    bottom: 16px;
    right: 16px;
    padding: 9px 14px;
    font-size: 13px;
  }
}

/* Modal backdrop */
.mi-explain-modal {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.55);
  display: none; /* toggled via JS */
  align-items: center;
  justify-content: center;
  z-index: 9997;
}

/* Show modal */
.mi-explain-modal.mi-open {
  display: flex;
}

/* Modal dialog */
.mi-explain-dialog {
  background: var(--card, #ffffff);
  color: var(--navy, #0f172a);
  border-radius: 20px;
  padding: 24px 24px 20px;
  max-width: 640px;
  width: 100%;
  max-height: 90vh;        /* a little taller is okay */
  box-shadow: 0 24px 60px rgba(15,23,42,0.45);
  position: relative;
  display: flex;
  flex-direction: column;

  /* NEW: allow the dialog itself to scroll */
  overflow-y: auto;
  overscroll-behavior: contain;
}


@media (max-width: 640px) {
  .mi-explain-dialog {
    border-radius: 18px;
    margin: 0 12px;
    padding: 20px 16px 16px;
  }
}

/* Close button */
.mi-explain-close {
  position: absolute;
  right: 16px;
  top: 12px;
  border: none;
  background: transparent;
  font-size: 22px;
  cursor: pointer;
  color: var(--muted, #64748b);
}

.mi-explain-dialog h2 {
  margin: 0 0 4px;
  font-size: 20px;
}

.mi-explain-subtitle {
  margin: 0 0 16px;
  font-size: 14px;
  color: var(--muted, #64748b);
}

/* Search row */
.mi-explain-search-row {
  position: relative;
  margin-bottom: 12px;
}

#miExplainSearch {
  width: 100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--border, #e2e8f0);
  font-size: 14px;
}

/* Suggestions dropdown */
.mi-explain-suggestions {
  position: absolute;
  left: 0;
  right: 0;
  top: 100%;
  margin-top: 4px;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.18);
  overflow: hidden;
  display: none;
  z-index: 5;
}

.mi-explain-suggestions.mi-visible {
  display: block;
}

.mi-explain-suggestions button {
  width: 100%;
  border: none;
  background: transparent;
  padding: 8px 12px;
  text-align: left;
  font-size: 13px;
  cursor: pointer;
}

.mi-explain-suggestions button:hover {
  background: var(--accent-soft, rgba(0,191,255,0.06));
}

/* Category chips */
.mi-explain-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 12px;
}

.mi-explain-chips button {
  border-radius: 999px;
  border: 1px solid var(--border, #e2e8f0);
  padding: 6px 10px;
  background: #ffffff;
  font-size: 12px;
  cursor: pointer;
  color: var(--muted, #64748b);
}

.mi-explain-chips button.active {
  background: var(--accent-soft, rgba(0,191,255,0.12));
  border-color: var(--cyan, #00BFFF);
  color: var(--navy, #0f172a);
}

/* List of explainers */
.mi-explain-list {
  flex: 1;
  overflow-y: auto;
  padding-right: 4px;
  margin-bottom: 12px;
  border-radius: 12px;
}

.mi-explain-item {
  padding: 10px 8px;
  border-bottom: 1px solid var(--border, #e2e8f0);
}

.mi-explain-item:last-child {
  border-bottom: none;
}

.mi-explain-term {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 2px;
}

.mi-explain-category {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--muted-2, #94a3b8);
  margin-bottom: 4px;
}

.mi-explain-text {
  font-size: 13px;
  color: var(--muted, #475569);
}

/* Random button */
.mi-explain-random {
  align-self: flex-start;
  border-radius: 999px;
  border: none;
  background: var(--accent-soft, rgba(0,191,255,0.12));
  padding: 8px 14px;
  font-size: 13px;
  cursor: pointer;
  color: var(--navy, #0f172a);
}
    /* MatesBook tabs */
.mi-book-tabs {
  display: flex;
  gap: 6px;
  margin: 6px 0 10px;
}

.mi-book-tab {
  border-radius: 999px;
  border: 1px solid var(--border);
  background: #ffffff;
  padding: 5px 10px;
  font-size: 0.82rem;
  cursor: pointer;
  color: var(--muted);
  transition: background .12s ease, border-color .12s ease, color .12s ease;
}

.mi-book-tab.active {
  background: var(--accent-soft);
  border-color: var(--accent);
  color: var(--navy);
  font-weight: 600;
}

/* hide inactive panes */
.mi-book-pane[hidden] {
  display: none;
}

/* Stories styling inside MatesBook */
/* Stories feed inside MatesBook ‚Äì match explainer look */
.mi-stories-body {
  flex: 1;                 /* fill the modal height like explainers */
  overflow-y: auto;
  padding-right: 4px;
  margin-top: 6px;
  margin-bottom: 12px;
  border-radius: 12px;      /* same rounding as explainer list */
}

/* each story acts like an explainer row */
.mi-stories-card {
  padding: 10px 8px;
  border-bottom: 1px solid var(--border);
  background: transparent;
}

.mi-stories-card:last-child {
  border-bottom: none;
}

/* small tag, like a category label */
.mi-stories-tag {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted-2);
  margin-bottom: 2px;
}

/* title similar to .mi-explain-term */
.mi-stories-title {
  font-size: 14px;
  font-weight: 600;
  margin: 0 0 2px;
  color: var(--navy);
}

.mi-stories-meta-line {
  display: flex;
  gap: 8px;
  align-items: baseline;
  margin-bottom: 2px;
}

/* date + byline small & muted, like explainer category */
.mi-stories-date,
.mi-stories-byline {
  font-size: 11px;
  color: var(--muted-2);
}
.mi-stories-text {
  font-size: 13px;
  line-height: 1.4;
  margin: 2px 0 0;
  color: var(--muted, #475569);   /* same as explainer body */
}


.mi-stories-byline {
  margin-top: 2px;
}

  </style>

</head>

<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="nav-left">
        <img src="/assets/img/logo-placeholder.png" class="nav-logo" alt="MatesInvest logo">
        <div>
          <div class="nav-title">MatesInvest</div>
          <div class="nav-pill">MatesFeed ¬∑ Prototype</div>
        </div>
      </div>
<div class="nav-right">
  <span class="nav-tagline nav-tagline-full">
    Live AI summaries ¬∑ Not financial advice
  </span>
  <span class="nav-tagline nav-tagline-short">
    Live AI ¬∑ NFA
  </span>
  <a href="/" class="nav-home-link">Home</a>
</div>

    </div>
  </div>

  <div class="page-shell">
    <div class="corner-pattern" aria-hidden="true"></div>

    <!-- HERO (kept for accessibility/SEO but visually hidden) -->
    <h1 class="visually-hidden">MatesFeed</h1>
    <!-- MORNING BRIEF -->
    <section id="morningBrief" class="card">
      <div class="brief-header">
<div>
  <h2 style="margin:0">Morning Briefing</h2>
  <div class="brief-subtitle">
    A short note on what could move markets in Australia today.
  </div>
</div>


<div class="brief-controls">
  <button id="openBrief" class="brief-toggle primary">Open morning brief</button>
</div>

      </div>

      <div id="briefContent" class="brief-content" aria-live="polite">
        <!-- injected by JS -->
      </div>
    </section>
<a href="/join.html"
   style="
     font-size:0.9rem;
     color:var(--navy);
     text-decoration:none;
     font-weight:600;
   ">
   Subscribe to the Daily Email ‚Üí
</a>


    <!-- LATEST HEADLINES -->
    <section id="news" class="card" aria-labelledby="latest-headlines">
      <h2 id="latest-headlines">Latest Headlines</h2>

      <div class="controls">
        <div class="segmented" role="tablist" aria-label="View mode">
          <button id="toggleMarket" class="active" role="tab" aria-selected="true">Market Mode</button>
          <button id="toggleMates" role="tab" aria-selected="false" style="display:none">MatesMode</button>
        </div>

        <div style="flex:1"></div>

        <div style="display:flex;align-items:center;gap:0.5rem;color:var(--muted);font-size:0.88rem">
          <span id="feedStatus">Live</span>
        </div>
      </div>

      <div class="chip-row" id="categoryRow" aria-label="Categories">
        <button class="chip chip-active" data-category="all">All</button>
        <button class="chip" data-category="energy">Energy</button>
        <button class="chip" data-category="tech">Tech</button>
        <button class="chip" data-category="macro">Macro</button>
        <button class="chip" data-category="other">Other</button>
      </div>

      <div id="sportFilterRow" class="sport-row" style="display:none; margin-top:0.6rem;" aria-label="Filter sports"></div>

      <div id="newsList" style="margin-top:0.9rem;">Loading‚Ä¶</div>
    </section>

    <!-- DAILY BRIEF SIGNUP CARD -->
<section id="subscribe" class="card" style="margin-top:1.5rem;">
  <h2 style="margin:0 0 0.4rem 0;">Get the MatesMorning Daily Email</h2>
  <p style="margin:0 0 0.75rem 0;font-size:0.9rem;color:var(--muted);max-width:32rem;">
    One short ASX morning briefing each day, plus the weekly wrap and early access to the app.
  </p>

  <a href="/join.html" class="btn-pill btn-pill-primary">
    Join with your name &amp; email
  </a>

  <div style="margin-top:0.6rem;font-size:0.85rem;color:var(--muted);">
    Already on the list? You‚Äôll get the emails automatically.
  </div>

  <div style="margin-top:1rem;font-size:0.85rem;">
    <a href="#top"
       style="
         color:var(--navy);
         text-decoration:none;
         font-weight:600;
       ">
       Back to top ‚Üí
    </a>
  </div>
</section>

  </div> <!-- end .page-shell -->

  <!-- All JS from your existing page, unchanged -->
<!-- Floating "MatesBook" button -->
<button
  id="miBookBtn"
  class="mi-explain-floating"
  aria-label="Open MatesBook"
>
  <span class="mi-explain-icon">üìò</span>
  <span class="mi-explain-label">MatesBook</span>
</button>

<!-- MatesBook Modal (explainers + stories) -->
<div id="miBookModal" class="mi-explain-modal" aria-hidden="true">
  <div class="mi-explain-dialog" role="dialog" aria-modal="true" aria-labelledby="miBookTitle">
    <button class="mi-explain-close" id="miBookClose" aria-label="Close">
      √ó
    </button>

    <h2 id="miBookTitle">MatesBook</h2>
    <p class="mi-explain-subtitle">
      Plain-English market explainers and short stories from everyday investors.
    </p>

    <!-- Tabs -->
    <div class="mi-book-tabs" id="miBookTabs">
      <button type="button" class="mi-book-tab active" data-pane="explain">
        Market explainers
      </button>
      <button type="button" class="mi-book-tab" data-pane="stories">
        Mates stories
      </button>
    </div>

    <!-- Explain pane -->
    <div class="mi-book-pane" id="miBookExplainPane">
      <div class="mi-explain-search-row">
        <input
          id="miExplainSearch"
          type="text"
          placeholder="Search a market term..."
          autocomplete="off"
        />
        <div id="miExplainSuggestions" class="mi-explain-suggestions"></div>
      </div>

      <div class="mi-explain-chips" id="miExplainChips">
        <button type="button" class="active" data-category="all">All</button>
        <button type="button" data-category="ASX basics">ASX basics</button>
        <button type="button" data-category="Daily terms">Daily terms</button>
        <button type="button" data-category="Company metrics">Company metrics</button>
        <button type="button" data-category="Macro">Macro</button>
        <button type="button" data-category="Trading">Trading</button>
        <button type="button" data-category="Commodities & Crypto">Commodities & Crypto</button>
      </div>

      <div id="miExplainList" class="mi-explain-list"></div>

      <button id="miExplainRandom" class="mi-explain-random">
        Pick a term for me
      </button>
    </div>

<!-- Stories pane -->
<div class="mi-book-pane" id="miBookStoriesPane" hidden>
  <!-- Share story CTA + inline form -->
  <div style="margin-bottom:8px;font-size:0.85rem;color:var(--muted);">
    Want to share your own investing story?
    <button
      type="button"
      id="miStoryOpenForm"
      class="btn-pill"
      style="margin-left:6px;padding:0.24rem 0.6rem;font-size:0.8rem;"
    >
      Share your story
    </button>
  </div>

  <form id="miStoryForm" style="display:none;margin-bottom:10px;font-size:0.85rem;">
    <div style="margin-bottom:6px;">
      <label style="display:block;margin-bottom:3px;">Title</label>
      <input
        id="miStoryTitle"
        type="text"
        maxlength="120"
        required
        style="width:100%;padding:6px 8px;border-radius:10px;border:1px solid var(--border);font-size:0.85rem;"
        placeholder="E.g. My first ETF, chasing a hot tip‚Ä¶"
      />
    </div>

    <div style="margin-bottom:6px;">
      <label style="display:block;margin-bottom:3px;">Story (what happened?)</label>
      <textarea
        id="miStoryText"
        rows="4"
        required
        style="width:100%;padding:6px 8px;border-radius:10px;border:1px solid var(--border);font-size:0.85rem;resize:vertical;"
        placeholder="Keep it short and honest. No stock tips or personal details."
      ></textarea>
    </div>

    <div style="margin-bottom:6px;">
      <label style="display:block;margin-bottom:3px;">How should we show your name? (optional)</label>
      <input
        id="miStoryByline"
        type="text"
        maxlength="80"
        style="width:100%;padding:6px 8px;border-radius:10px;border:1px solid var(--border);font-size:0.85rem;"
        placeholder="E.g. Anon, 27 ‚Ä¢ Brisbane"
      />
    </div>

    <div style="margin-bottom:6px;">
      <label style="display:block;margin-bottom:3px;">Tag (optional)</label>
      <select
        id="miStoryTag"
        style="width:100%;padding:6px 8px;border-radius:10px;border:1px solid var(--border);font-size:0.85rem;"
      >
        <option value="">No tag</option>
        <option value="Beginner story">Beginner story</option>
        <option value="Lesson learned">Lesson learned</option>
        <option value="Small win">Small win</option>
      </select>
    </div>

    <div style="margin-bottom:6px;font-size:0.78rem;color:var(--muted-2);">
      Stories are anonymous and will be reviewed before appearing here.
      Please don‚Äôt share any personal contact details.
    </div>
<div style="margin-bottom:6px;font-size:0.78rem;color:var(--muted-2);">
  <label style="display:flex;align-items:flex-start;gap:6px;cursor:pointer;">
    <input
      type="checkbox"
      id="miStoryConsent"
      style="margin-top:2px;"
      required
    />
    <span>
      I‚Äôm happy for this story to be shared (anonymously) with other MatesInvest users.
    </span>
  </label>
</div>
    <div style="display:flex;align-items:center;gap:8px;">
      <button
        type="submit"
        id="miStorySubmit"
        class="btn-pill btn-pill-primary"
        style="font-size:0.84rem;"
      >
        Submit story
      </button>
      <span id="miStoryStatus" style="font-size:0.78rem;color:var(--muted-2);"></span>
    </div>
  </form>

  <div id="miStoriesBody" class="mi-stories-body"></div>
</div>
    </div>
  </div>
</div>

  <script>
    /* ---------- Globals & helpers ---------- */
    const newsList = document.getElementById("newsList");
    const toggleMarket = document.getElementById("toggleMarket");
    const toggleMates = document.getElementById("toggleMates");
    const categoryRow = document.getElementById("categoryRow");
    const feedStatus = document.getElementById("feedStatus");
    const sportFilterRow = document.getElementById("sportFilterRow");

const openBriefBtn = document.getElementById("openBrief");
const briefContent = document.getElementById("briefContent");


    let allArticles = [];
    let currentCategory = "all";
    const selectedSports = new Set();
    let briefLoadedFor = null; // tracks which region the brief was loaded for

    function escapeHtml(str = "") {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function formatTime(iso) {
      try {
        const d = new Date(iso);
        if (isNaN(d)) return "";
        return new Intl.DateTimeFormat(undefined, { dateStyle:'short', timeStyle:'short' }).format(d);
      } catch { return iso || ""; }
    }

/* ---------- Mates Morning Note & Stock of the Day loaders ---------- */
async function loadMatesMorningNote() {
  const container = document.getElementById("matesMorningNote");
  const textBox = document.getElementById("matesNoteText");
  const timeBox = document.getElementById("matesNoteTimestamp");

  if (!container || !textBox || !timeBox) return;

  try {
    const res = await fetch("/.netlify/functions/matesMorningNote");
    const data = await res.json();

    const note = data.note || "No update available.";
    textBox.textContent = note;

    // FIXED DAILY TIMESTAMP (matches scheduled 6am AEST generation)
    timeBox.textContent = "Updated 6:00am AEST";

    container.style.display = "block";
  } catch (err) {
    console.error("Failed to load Morning Note", err);
    if (textBox) textBox.textContent = "Unable to load today‚Äôs note.";
    if (container) container.style.display = "block";
  }
}


// replace the start of loadStockOfTheDay() with this version

  async function loadStockOfTheDay() {
    const container = document.getElementById("stockOfDay");
    if (!container) return;

    const tickerEl = document.getElementById("sotdTicker");
    const nameEl = document.getElementById("sotdName");
    const exchEl = document.getElementById("sotdExchange");
    const summaryEl = document.getElementById("sotdSummary");

    if (!tickerEl || !nameEl || !exchEl || !summaryEl) return;

    // Use the same stock that was chosen in renderMorningBrief()
    // Try the global first, then fall back to data- attributes on the placeholder
    let candidate = window._mates_sotd || null;
    if (!candidate || !candidate.symbol) {
      // fallback: read from placeholder dataset
      const ds = container.dataset || {};
      if (ds.symbol) {
        candidate = {
          symbol: ds.symbol,
          name: ds.name || ""
        };
      }
    }

    if (!candidate || !candidate.symbol) {
      // Nothing selected ‚Äì hide the card quietly
      container.style.display = "none";
      return;
    }

    try {
      const params = new URLSearchParams();
      params.set("symbol", candidate.symbol);
      if (candidate.name) params.set("name", candidate.name);
      params.set("exchange", "ASX");

      const res = await fetch(
        "/.netlify/functions/stockOfTheDay?" + params.toString()
      );
      const data = await res.json();

      tickerEl.textContent = data.ticker || candidate.symbol || "‚Äî";
      nameEl.textContent = data.name || candidate.name || "";
      exchEl.textContent = (data.exchange || "ASX").toUpperCase();
      summaryEl.textContent =
        data.summary || "No snapshot available today.";

      container.style.display = "block";
    } catch (err) {
      console.error("loadStockOfTheDay failed", err);
      summaryEl.textContent =
        "Unable to load today‚Äôs Stock of the Day.";
      container.style.display = "block"; // still show the card with message
    }
  }
    /* ---------- Feeds ---------- */
    async function getMarketFeed() {
      try {
        const res = await fetch("/.netlify/functions/newsFeed");
        const data = await res.json();
        return data.articles || [];
      } catch (e) {
        console.warn("Market feed failed", e);
        return [];
      }
    }

    async function getSportsFeed() {
      try {
        const res = await fetch("/.netlify/functions/sports-test");
        return await res.json();
      } catch (e) {
        console.warn("Sports feed failed", e);
        return [];
      }
    }

    function showSkeleton(count = 4) {
      newsList.innerHTML = "";
      for (let i=0;i<count;i++){
        const div = document.createElement("div");
        div.className = "headline";
        div.innerHTML = `<div style="display:flex;align-items:center;gap:0.75rem">
          <div style="flex:1">
            <div class="skeleton" style="height:14px;width:60%"></div>
            <div style="height:8px"></div>
            <div class="skeleton" style="height:12px;width:30%"></div>
          </div>
        </div>`;
        newsList.appendChild(div);
      }
    }

    /* ---------- Mates/OpenAI summary helper ---------- */
    async function callMatesSummary(payload) {
      const res = await fetch("/.netlify/functions/matesSummary", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("Summary request failed");
      return res.json();
    }

    /* ---------- Category detection ---------- */
    function categoryFromArticle(article) {
      const title = (article.title || "").toLowerCase();
      if (title.match(/energy|oil|coal|gas|mining/)) return "energy";
      if (title.match(/tech|software|ai|chip|cloud/)) return "tech";
      if (title.match(/inflation|rate|central bank|macro/)) return "macro";
      return "other";
    }

    /* ---------- Rendering market & mates mode ---------- */
    function renderSummary(s) {
      if (!s) return `<div class="summary-block">No summary available.</div>`;
      const bullets = (s.tldrBullets || []).map(b => `<li>${escapeHtml(b)}</li>`).join("");
      return `
        <div class="summary-block">
          ${bullets ? `<strong>TL;DR</strong><ul class="tldr-list">${bullets}</ul>` : ""}
          <details open>
            <summary style="cursor:pointer;color:var(--muted-2)">Full summary</summary>
            <div style="margin-top:0.5rem">
              <p><strong>What's Happening:</strong><br>${escapeHtml(s.whatsHappening || "")}</p>
              <p><strong>Why It Matters:</strong><br>${escapeHtml(s.whyItMatters || "")}</p>
              <p><strong>Risks / Watch Outs:</strong><br>${escapeHtml(s.riskNote || "")}</p>
              <p class="summary-meta" style="opacity:0.7">${escapeHtml(s.disclaimer || "")}</p>
            </div>
          </details>
        </div>
      `;
    }

    function renderSportsSummary(s, icon) {
      return `
        <div class="summary-block">
          <strong>${escapeHtml(s.oneLiner || "")}</strong>
          <p><strong>What Actually Happened:</strong><br>${escapeHtml(s.whatsHappening || "")}</p>
        </div>
      `;
    }

    function getSportIcon(ev) {
      const league = (ev.league || "").toLowerCase();
      const sport = (ev.sport || "").toLowerCase();

      if (league.includes("nrl") || sport.includes("league")) return "üèâ";
      if (league.includes("afl")) return "üèâ";
      if (league.includes("nba") || sport.includes("basketball")) return "üèÄ";
      if (league.includes("epl") || league.includes("premier") || sport.includes("soccer")) return "‚öΩ";
      if (sport.includes("cricket") || league.includes("bbl")) return "üèè";
      if (league.includes("mlb") || sport.includes("baseball")) return "‚öæ";
      if (league.includes("nfl") || sport.includes("football")) return "üèà";
      if (league.includes("nhl") || sport.includes("hockey")) return "üèí";
      if (sport.includes("f1") || sport.includes("formula")) return "üèéÔ∏è";
      if (sport.includes("tennis")) return "üéæ";
      if (sport.includes("golf")) return "‚õ≥";
      return "üéØ";
    }

    async function renderMarketMode() {
      sportFilterRow.style.display = "none";
      newsList.innerHTML = "";
      const filtered = allArticles.filter(a =>
        currentCategory === "all" || categoryFromArticle(a) === currentCategory
      );

      if (!filtered.length) {
        newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">No market headlines yet.</small></div>`;
        return;
      }

      filtered.forEach(a => {
        const item = document.createElement("div");
        item.className = "headline";

        const published = formatTime(a.publishedAt || a.published || "");

item.innerHTML = `
  <div class="meta-row">
    <div class="meta-left">
      <div style="min-width:0">
        <h3 title="${escapeHtml(a.title || '')}">${escapeHtml(a.title || '')}</h3>
        <small>${escapeHtml(a.source || "")} ¬∑ ${escapeHtml(published)}</small>
      </div>
    </div>
    <div class="meta-actions">
      <a class="link-min" href="${a.url || "#"}" target="_blank" rel="noopener">Read original</a>
      <button class="btn" aria-label="Generate summary for article">MatesInvest summary</button>
    </div>
  </div>

  <div class="summary-output"></div>
`;


        const btn = item.querySelector("button");
        const output = item.querySelector(".summary-output");
        let busy = false;

        btn.addEventListener("click", async () => {
          if (busy) return;
          busy = true;
          btn.disabled = true;
          const origText = btn.textContent;
          btn.textContent = "Summarising‚Ä¶";

          try {
            const summary = await callMatesSummary({
              text: `${a.title}\n\n${a.description || ""}`,
              sourceType: "news_article",
              headline: a.title,
            });

            output.innerHTML = renderSummary(summary);
          } catch (err) {
            console.error(err);
            output.textContent = "Summary failed.";
          } finally {
            btn.disabled = false;
            btn.textContent = origText;
            busy = false;
          }
        });

        newsList.appendChild(item);
      });
    }

  async function renderMatesMode() {
    showSkeleton(5);
    try {
      const market = await getMarketFeed();
      const sports = await getSportsFeed() || [];

      const sportSet = new Set();
      (sports || []).forEach(ev => {
        const s = (ev.sport || ev.league || "").toString().trim();
        if (s) {
          const key = ev.sport ? ev.sport.toString().trim() : (ev.league || "").toString().trim();
          const label = key.split(" ").map(w => w && (w[0].toUpperCase() + w.slice(1).toLowerCase())).join(" ");
          sportSet.add(label);
        }
      });

      renderSportFilters(Array.from(sportSet));

      const sportsCards = (sports || []).map(ev => ({
        type: "sport",
        title: `${ev.home} vs ${ev.away}`,
        subtitle: ev.league || "",
        sportLabel: (ev.sport || ev.league || "").toString().trim(),
        time: ev.localTime || ev.utcTime || ev.time,
        raw: ev
      }));

      const marketCards = (market || []).map(a => ({
        type: "market",
        title: a.title,
        subtitle: a.source || "",
        url: a.url,
        description: a.description || "",
        time: a.publishedAt || a.published || new Date().toISOString(),
        raw: a
      }));

      let combined = [...marketCards, ...sportsCards]
        .sort((a,b) => new Date(b.time) - new Date(a.time));

      if (selectedSports.size > 0) {
        combined = combined.filter(item => {
          if (item.type !== "sport") return true;
          const sportVal = (item.sportLabel || "").toLowerCase();
          return selectedSports.has(sportVal);
        });
      }

      combined = combined.filter(item => {
        if (item.type === "market") {
          return currentCategory === "all" || categoryFromArticle(item.raw) === currentCategory;
        }
        return true;
      });

      newsList.innerHTML = "";

      combined.forEach(item => {
        const div = document.createElement("div");
        div.className = "headline";

        if (item.type === "sport") {
          const icon = getSportIcon(item.raw);
          const ev = item.raw;
          const when = formatTime(item.time);
          const sportBadge = escapeHtml((item.sportLabel || "").toString());

div.innerHTML = `
  <div class="meta-row">
    <div class="meta-left">
      <div style="min-width:0">
        <h3>${escapeHtml(item.title || "")}</h3>
        <small>${escapeHtml(item.subtitle || "")} ¬∑ ${escapeHtml(when)}</small>
      </div>
    </div>
    <div class="meta-actions">
      <a class="link-min" href="${item.url || "#"}" target="_blank" rel="noopener">Read original</a>
      <button class="btn">MatesInvest summary</button>
    </div>
  </div>

  <div class="summary-output"></div>
`;


          const btn = div.querySelector("button.btn");
          const output = div.querySelector(".summary-output");
          const statsBtn = div.querySelector('button[data-toggle-stats]');
          const statsArea = div.querySelector(".sports-stats");
          let busy = false;

          btn.onclick = async () => {
            if (busy) return;
            busy = true;
            btn.disabled = true;
            const prev = btn.textContent;
            btn.textContent = "Summarising‚Ä¶";

            try {
              const summary = await callMatesSummary({
                sourceType: "sports_event",
                headline: `${ev.home} vs ${ev.away}`,
                text: `
League: ${ev.league}
Sport: ${ev.sport}
Score: ${ev.home} ${ev.homeScore} - ${ev.awayScore} ${ev.away}
Status: ${ev.status}
`,
              });

              output.innerHTML = renderSportsSummary(summary, icon);
            } catch (err) {
              console.error(err);
              output.textContent = "Summary failed.";
            } finally {
              btn.disabled = false;
              btn.textContent = prev;
              busy = false;
            }
          };

          // Attach stats handler (on-demand event-details)
          attachStatsHandler(statsBtn, statsArea, ev);

          newsList.appendChild(div);
        } else {
          const when = formatTime(item.time);
          div.innerHTML = `
            <div class="meta-row">
              <div class="meta-left">
                <div style="min-width:0">
                  <h3>${escapeHtml(item.title || "")}</h3>
                  <small>${escapeHtml(item.subtitle || "")} ¬∑ ${escapeHtml(when)}</small>
                </div>
              </div>
              <div style="display:flex;gap:0.5rem;align-items:center">
                <a class="link-min" href="${item.url || "#"}" target="_blank" rel="noopener">Read original</a>
              </div>
            </div>

            <div class="actions">
              <button class="btn">MatesInvest summary</button>
            </div>
            <div class="summary-output"></div>
          `;

          const btn = div.querySelector("button");
          const output = div.querySelector(".summary-output");
          let busy = false;

          btn.onclick = async () => {
            if (busy) return;
            busy = true;
            btn.disabled = true;
            const prev = btn.textContent;
            btn.textContent = "Summarising‚Ä¶";

            try {
              const summary = await callMatesSummary({
                text: `${item.title}\n\n${item.description}`,
                sourceType: "news_article",
                headline: item.title,
              });

              output.innerHTML = renderSummary(summary);
            } catch (err) {
              console.error(err);
              output.textContent = "Summary failed.";
            } finally {
              btn.disabled = false;
              btn.textContent = prev;
              busy = false;
            }
          };

          newsList.appendChild(div);
        }
      });

      if (!combined.length) {
        newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">No items found.</small></div>`;
      }

    } catch (err) {
      console.error("Error rendering MatesMode", err);
      newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">Failed to load feed.</small></div>`;
    }
  }

  /* ---------- RICH STATS HELPERS (event-details client) ---------- */

  async function fetchEventDetails(eventId) {
    const res = await fetch(`/.netlify/functions/event-details?id=${encodeURIComponent(eventId)}`);
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`Event details request failed: ${res.status} ${txt}`);
    }
    return res.json();
  }

  function parseGoalDetails(raw) {
    if (!raw || !raw.trim()) return [];
    const parts = raw.split(/;|\n/).map(p => p.trim()).filter(Boolean);
    const events = parts.map(p => {
      const m = p.match(/^(\d+\+?\d*)'?[\s-‚Äì:]?\s*(.+)$/);
      if (m) {
        return { minute: m[1] + "'", text: m[2] };
      }
      return { minute: '', text: p };
    });
    return events;
  }

  function renderLineupSection(title, lineupStr) {
    if (!lineupStr || !lineupStr.trim()) return '';
    const players = lineupStr.split(/, ?/).map(s => s.trim()).filter(Boolean);
    return `<div class="lineup-block" role="group" aria-label="${escapeHtml(title)}">
      <strong style="color:var(--muted)">${escapeHtml(title)}</strong>
      <div style="margin-top:0.35rem">${players.map(p => `<div>${escapeHtml(p)}</div>`).join('')}</div>
    </div>`;
  }

  function renderBoxScoreAndPlayers(ev) {
    if (!ev) return `<div style="color:var(--muted)">No stats available.</div>`;

    const home = escapeHtml(ev.home || '');
    const away = escapeHtml(ev.away || '');
    const homeScore = (ev.homeScore !== null && ev.homeScore !== undefined) ? escapeHtml(String(ev.homeScore)) : '‚Äî';
    const awayScore = (ev.awayScore !== null && ev.awayScore !== undefined) ? escapeHtml(String(ev.awayScore)) : '‚Äî';

    const shotsRow = (ev.homeShots !== null || ev.awayShots !== null)
      ? `<div class="stat-row"><div class="stat-pill">Shots: ${ev.homeShots !== null ? escapeHtml(String(ev.homeShots)) : '‚Äî'} ‚Äî ${ev.awayShots !== null ? escapeHtml(String(ev.awayShots)) : '‚Äî'}</div></div>`
      : '';

    const timelineItems = [];
    (parseGoalDetails(ev.homeGoalDetails || ev.raw?.strHomeGoalDetails || '')).forEach(it => timelineItems.push({side:'home', ...it}));
    (parseGoalDetails(ev.awayGoalDetails || ev.raw?.strAwayGoalDetails || '')).forEach(it => timelineItems.push({side:'away', ...it}));

    const minuteToNumber = m => {
      if (!m) return 9999;
      const clean = m.replace("'", "");
      if (clean.includes('+')) {
        const [base, extra] = clean.split('+').map(Number);
        return base * 100 + (extra || 0);
      }
      return Number(clean);
    };
    timelineItems.sort((a,b) => minuteToNumber(a.minute) - minuteToNumber(b.minute));

    const timelineHtml = timelineItems.length ? `
      <div style="margin-top:0.45rem"><strong style="color:var(--muted-2)">Timeline</strong>
        <div class="event-timeline">
          ${timelineItems.map(it => `
            <div class="timeline-item">
              <div class="timeline-bullet" aria-hidden="true" style="background:${it.side === 'home' ? 'var(--accent)' : 'rgba(255,255,255,0.16)'}"></div>
              <div style="display:flex;gap:0.5rem;align-items:flex-start">
                <div class="timeline-min">${escapeHtml(it.minute || '')}</div>
                <div style="max-width:680px;color:var(--muted)">${escapeHtml(it.text || '')}</div>
              </div>
            </div>`).join('')}
        </div>
      </div>` : '';

    const homeLineupHtml = ev.homeLineupGoalkeeper || ev.homeLineupDefense || ev.homeLineupMidfield || ev.homeLineupForward
      ? renderLineupSection('Home lineups', (ev.homeLineupGoalkeeper || '') + (ev.homeLineupDefense ? ', ' + ev.homeLineupDefense : '') + (ev.homeLineupMidfield ? ', ' + ev.homeLineupMidfield : '') + (ev.homeLineupForward ? ', ' + ev.homeLineupForward : ''))
      : '';
    const awayLineupHtml = ev.awayLineupGoalkeeper || ev.awayLineupDefense || ev.awayLineupMidfield || ev.awayLineupForward
      ? renderLineupSection('Away lineups', (ev.awayLineupGoalkeeper || '') + (ev.awayLineupDefense ? ', ' + ev.awayLineupDefense : '') + (ev.awayLineupMidfield ? ', ' + ev.awayLineupMidfield : '') + (ev.awayLineupForward ? ', ' + ev.awayLineupForward : ''))
      : '';

    let playersHtml = '';
    if (Array.isArray(ev.raw?.player) && ev.raw.player.length) {
      playersHtml = `<div style="margin-top:0.5rem"><strong style="color:var(--muted-2)">Players</strong>
        <div style="margin-top:0.4rem">
          ${ev.raw.player.map(p => `<div style="display:flex;gap:0.8rem;align-items:center"><div style="width:36px">${escapeHtml(p.number || '')}</div><div><strong>${escapeHtml(p.name)}</strong> <div style="color:var(--muted-2);font-size:0.9rem">${escapeHtml(p.position || '')} ${p.goals ? `‚Ä¢ Goals: ${escapeHtml(String(p.goals))}` : ''}</div></div></div>`).join('')}
        </div></div>`;
    } else {
      playersHtml = `<div style="margin-top:0.35rem;color:var(--muted)">Per-player box stats not available from TheSportsDB for this event. Use a sport-specific provider (e.g. balldontlie for NBA) for full box scores.</div>`;
    }

    const notesHtml = ev.description ? `<details style="margin-top:0.5rem"><summary style="cursor:pointer;color:var(--muted-2)">Match notes</summary><div style="margin-top:0.4rem;color:var(--muted-2)">${escapeHtml(ev.description)}</div></details>` : '';

    return `
      <div class="summary-block">
        <div class="stat-row">
          <div class="stat-pill"><strong>${home}</strong> ${homeScore}</div>
          <div style="align-self:center;color:var(--muted)">vs</div>
          <div class="stat-pill"><strong>${away}</strong> ${awayScore}</div>
          <div style="margin-left:auto;color:var(--muted)">${escapeHtml(ev.status || '')}</div>
        </div>

        ${shotsRow}
        ${timelineHtml}
        ${homeLineupHtml}
        ${awayLineupHtml}
        ${playersHtml}
        ${notesHtml}
      </div>
    `;
  }

  /* ---------- Morning brief handlers (cleaned & robust) ---------- */

function formatMoney(n) {
  try {
    if (n === null || typeof n === 'undefined') return null;
    return Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  } catch { return String(n); }
}

function relativeTime(iso) {
  try {
    const date = new Date(iso);
    const now = new Date();
    const diffMs = now - date;
    const diffMin = Math.round(diffMs / 60000);
    if (Math.abs(diffMin) < 1) return 'just now';
    if (Math.abs(diffMin) < 60) return `${diffMin}m`;
    const diffHours = Math.round(diffMin / 60);
    if (Math.abs(diffHours) < 24) return `${diffHours}h`;
    const diffDays = Math.round(diffHours / 24);
    return `${diffDays}d`;
  } catch { return iso || ''; }
}

/*
/*
  Render the morning brief:
  - Inserts placeholders for Mates Morning Note and Stock of the Day (so loaders can populate them)
  - Renders metals grid using payload.symbols or payload.metals
  - Renders topPerformers (from EODHD) if present
*/
function renderMorningBrief(payload) {
  if (!payload) {
    briefContent.innerHTML = `<div class="brief-loading">No briefing available.</div>`;
    return;
  }

  const sourceNote =
    payload._debug && payload._debug.fxSource
      ? `Source: Metals-API ¬∑ FX: ${payload._debug.fxSource}`
      : "Source: Metals-API";

  const cachedHint =
    payload._debug && payload._debug.cached
      ? '<span style="color:var(--muted);font-size:0.7rem"> ¬∑ cached</span>'
      : "";

  // Accept either payload.metals (old) or payload.symbols (snapshot-metals.js)
  const metalsObj =
    payload.metals && typeof payload.metals === "object"
      ? payload.metals
      : payload.symbols && typeof payload.symbols === "object"
      ? payload.symbols
      : null;

  // Crypto snapshot from morning-brief payload
  const cryptoObj =
    payload.crypto && typeof payload.crypto === "object"
      ? payload.crypto
      : null;

  // Build top performers HTML if present
  let topPerfHtml = "";
  if (Array.isArray(payload.topPerformers) && payload.topPerformers.length) {
    const items = payload.topPerformers
      .map((tp) => {
        const pct =
          typeof tp.pctGain === "number"
            ? tp.pctGain
            : tp.pctGain
            ? Number(tp.pctGain)
            : null;
        const pctClass =
          pct === null
            ? "perf-pct neutral"
            : pct > 0
            ? "perf-pct up"
            : pct < 0
            ? "perf-pct down"
            : "perf-pct neutral";
        const lastClose =
          typeof tp.lastClose === "number"
            ? `$${formatMoney(tp.lastClose)}`
            : tp.lastClose
            ? escapeHtml(String(tp.lastClose))
            : "‚Äî";
        return `
          <button
            type="button"
            class="perf-card mi-performer-chip"
            data-type="equity"
            data-code="${escapeHtml(tp.symbol || "")}"
            aria-label="Top performer ${escapeHtml(tp.symbol || "")}"
          >
            <div class="perf-top">
              <div>
                <div class="perf-symbol">${escapeHtml(tp.symbol || "")}</div>
              </div>
              <div>
                <div class="perf-last">${lastClose}</div>
                <div class="${pctClass}">
                  ${
                    pct === null
                      ? "‚Äî"
                      : pct > 0
                      ? "‚ñ≤ " + Math.abs(pct).toFixed(2) + "%"
                      : pct < 0
                      ? "‚ñº " + Math.abs(pct).toFixed(2) + "%"
                      : `${pct}%`
                  }
                </div>
              </div>
            </div>
            <div class="perf-note">${escapeHtml(tp.name || "")}</div>
          </button>
        `;
      })
      .join("");
    topPerfHtml = `
      <div>
        <strong style="display:block;margin-bottom:6px">Yesterday's Top Performers</strong>
        <div class="top-performers">
          ${items}
        </div>
      </div>
    `;
  }

  // Top meta row
  const topMetaHtml = `<div class="brief-top-meta"><div></div><div style="text-align:right">${escapeHtml(
    sourceNote
  )}${cachedHint}</div></div>`;

  // Choose "Stock of the Day" candidate from top performers (if any)
  let sotdCandidate = null;
  if (Array.isArray(payload.topPerformers) && payload.topPerformers.length) {
    const pool = payload.topPerformers.slice(0, 5); // only the first 5
    const idx = Math.floor(Math.random() * pool.length);
    sotdCandidate = pool[idx] || pool[0];
  }
  // Expose globally so loadStockOfTheDay() can use the same stock
  window._mates_sotd = sotdCandidate;

  // Mates Morning Note placeholder
  const matesPlaceholder = `
    <div id="matesMorningNote" class="mates-note" style="display:none;">
      <div class="mates-note-header">
        <span class="pill">Mates Morning Note</span>
        <span id="matesNoteTimestamp" class="timestamp">Updated ‚Äî</span>
      </div>
      <div id="matesNoteText" class="mates-note-body">Loading today‚Äôs note‚Ä¶</div>
    </div>
  `;

  // SOTD placeholder
  const sotdTickerText =
    sotdCandidate && (sotdCandidate.symbol || sotdCandidate.ticker)
      ? escapeHtml(sotdCandidate.symbol || sotdCandidate.ticker)
      : "‚Äî";
  const sotdNameText =
    sotdCandidate && sotdCandidate.name
      ? escapeHtml(sotdCandidate.name)
      : "";
  const sotdPlaceholder = `
    <div id="stockOfDay" class="sotd-card" style="display:none;"
         data-symbol="${
           sotdCandidate
             ? escapeHtml(sotdCandidate.symbol || sotdCandidate.ticker || "")
             : ""
         }"
         data-name="${
           sotdCandidate ? escapeHtml(sotdCandidate.name || "") : ""
         }">
      <div class="sotd-header">
        <div class="sotd-title-left">
          <span class="sotd-pill">Stock of the Day</span>
          <span id="sotdTicker" class="sotd-ticker">${sotdTickerText}</span>
          <span id="sotdName" class="sotd-name">${sotdNameText}</span>
        </div>
        <span id="sotdExchange" class="sotd-exchange">ASX</span>
      </div>

      <div id="sotdSummary" class="sotd-summary" style="min-height:48px;color:#0b1220">
        Loading Stock of the Day‚Ä¶
      </div>

      <div class="sotd-disclaimer" style="margin-top:8px;color:var(--muted-2);font-size:0.78rem">
        Not financial advice ‚Äî brief informational snapshot only.
      </div>
    </div>
  `;

  // ---------- METALS SECTION (clickable; feeds instrument modal) ----------
  if (metalsObj) {
    const metalSymbols = Object.keys(metalsObj);
    const friendlyMetals = {
      XAU: "Gold",
      XAG: "Silver",
      IRON: "Iron Ore 62% Fe",
      "LITH-CAR": "Lithium Carbonate",
      NI: "Nickel",
      URANIUM: "Uranium",
    };

    const metalCards = metalSymbols
      .map((sym) => {
        const m = metalsObj[sym] || {};

        const priceAUDraw =
          typeof m.priceAUD === "number" ? m.priceAUD : null;
        const pct =
          typeof m.pctChange === "number" && Number.isFinite(m.pctChange)
            ? m.pctChange
            : null;

        // Unit from snapshot, fallback heuristic
        const unitFromSnapshot = (
          m.unit || m.unit === "" ? m.unit : m.unitName || ""
        )
          .toString()
          .trim();
        const unit =
          unitFromSnapshot ||
          (sym === "XAU" || sym === "XAG"
            ? "oz"
            : sym === "IRON"
            ? "tonne"
            : "unit");

        const priceDisplay =
          priceAUDraw !== null
            ? `$${formatMoney(priceAUDraw)}`
            : '<span style="color:#ffd166">Unavailable</span>';

        // pct badge
        let pctHtml =
          '<span class="brief-badge no-data" aria-hidden="true">‚Äî</span>';
        if (pct !== null) {
          if (pct > 0) {
            pctHtml = `<span class="brief-badge up" aria-label="${pct.toFixed(
              2
            )}% up">‚ñ≤ ${pct.toFixed(2)}%</span>`;
          } else if (pct < 0) {
            pctHtml = `<span class="brief-badge down" aria-label="${pct.toFixed(
              2
            )}% down">‚ñº ${Math.abs(pct).toFixed(2)}%</span>`;
          } else {
            pctHtml =
              '<span class="brief-badge neutral" aria-label="unchanged">‚Äî 0%</span>';
          }
        }

        return `
          <button
            type="button"
            class="card-metal mi-performer-chip"
            data-type="metal"
            data-code="${escapeHtml(sym)}"
            aria-label="View recent price chart for ${escapeHtml(
              friendlyMetals[sym] || sym
            )}"
          >
            <div class="metal-head">
              <div>
                <div class="metal-name">
                  <strong>${escapeHtml(friendlyMetals[sym] || sym)}</strong>
                  <small style="color:var(--muted)"> (${escapeHtml(
                    sym
                  )})</small>
                </div>
                <div class="metal-price">
                  ${priceDisplay}
                  <small class="metal-sub" style="color:var(--muted);font-weight:600">
                    ${escapeHtml("/" + unit)}
                  </small>
                </div>
              </div>
              <div style="text-align:right">
                ${pctHtml}
              </div>
            </div>
          </button>
        `;
      })
      .join("");

    // ---------- CRYPTO SECTION (non-modal, ‚Äúlike the commodity cards‚Äù) ----------
    let cryptoSectionHtml = "";
    if (cryptoObj && Object.keys(cryptoObj).length) {
      const cryptoOrder = ["BTC", "ETH", "SOL", "ADA"];
      const friendlyCrypto = {
        BTC: "Bitcoin",
        ETH: "Ethereum",
        SOL: "Solana",
        ADA: "Cardano",
      };

      const cryptoCards = cryptoOrder
        .filter((sym) => cryptoObj[sym])
        .map((sym) => {
          const c = cryptoObj[sym] || {};

          const priceAUDraw =
            typeof c.priceAUD === "number" ? c.priceAUD : null;
          const pct =
            typeof c.pctChange === "number" && Number.isFinite(c.pctChange)
              ? c.pctChange
              : null;

          const unit = (c.unit || "coin").toString().trim() || "coin";

          const priceDisplay =
            priceAUDraw !== null
              ? `$${formatMoney(priceAUDraw)}`
              : '<span style="color:#ffd166">Unavailable</span>';

          let pctHtml =
            '<span class="brief-badge no-data" aria-hidden="true">‚Äî</span>';
          if (pct !== null) {
            if (pct > 0) {
              pctHtml = `<span class="brief-badge up" aria-label="${pct.toFixed(
                2
              )}% up">‚ñ≤ ${pct.toFixed(2)}%</span>`;
            } else if (pct < 0) {
              pctHtml = `<span class="brief-badge down" aria-label="${pct.toFixed(
                2
              )}% down">‚ñº ${Math.abs(pct).toFixed(2)}%</span>`;
            } else {
              pctHtml =
                '<span class="brief-badge neutral" aria-label="unchanged">‚Äî 0%</span>';
            }
          }

          return `
            <div class="card-metal">
              <div class="metal-head">
                <div>
                  <div class="metal-name">
                    <strong>${escapeHtml(friendlyCrypto[sym] || sym)}</strong>
                    <small style="color:var(--muted)"> (${escapeHtml(
                      sym
                    )})</small>
                  </div>
                  <div class="metal-price">
                    ${priceDisplay}
                    <small class="metal-sub" style="color:var(--muted);font-weight:600">
                      ${escapeHtml("/" + unit)}
                    </small>
                  </div>
                </div>
                <div style="text-align:right">
                  ${pctHtml}
                </div>
              </div>
            </div>
          `;
        })
        .join("");

      cryptoSectionHtml = `
        <div class="metals-header-row" style="margin-top:0.75rem">
          <div class="metals-title">Crypto snapshot</div>
        </div>
        <div class="metals-grid">
          ${cryptoCards}
        </div>
      `;
    }

    // Final HTML: top meta, top performers, note + SOTD, then metals & crypto grids
    briefContent.innerHTML = `
      ${topMetaHtml}
      ${topPerfHtml}
      <div class="brief-top-cards">
        ${matesPlaceholder}
        ${sotdPlaceholder}
      </div>
      <div class="brief-grid">
        <div class="metals-header-row">
          <div class="metals-title">Key Commodities</div>
        </div>
        <div class="metals-grid">
          ${metalCards}
        </div>
        ${cryptoSectionHtml}
      </div>
    `;

    return;
  }

  // Fallback: old single-gold payload shape ‚Äî include top performers if present
  const narrative =
    payload.narrative ||
    (payload.priceAUD
      ? `The spot gold price is currently $${payload.priceAUD} AUD.`
      : "The spot gold price is currently unavailable.");
  const fallbackHtml = `
    ${topMetaHtml}
    ${topPerfHtml}
    <div style="padding:0.6rem;border-radius:8px;background:linear-gradient(180deg, rgba(20,24,40,0.84), rgba(12,14,26,0.78));border:1px solid rgba(255,255,255,0.03)">
      <div style="font-size:0.9rem;color:var(--muted)"><strong>Spot gold</strong></div>
      <div style="margin-top:0.35rem;color:#fff;font-weight:600">${escapeHtml(
        narrative
      )}</div>
    </div>
  `;
  briefContent.innerHTML = fallbackHtml;
}

/* ---------- open / refresh handlers (updated to load Mates note + SOTD after rendering) ---------- */
openBriefBtn.addEventListener("click", async () => {
  const region = "au";
  if (briefContent.style.display === "block") {
    briefContent.style.display = "none";
    openBriefBtn.textContent = "Open morning brief";
    return;
  }

  briefContent.style.display = "block";
  openBriefBtn.textContent = "Hide brief";

  briefContent.innerHTML = `<div class="brief-loading">Loading briefing‚Ä¶</div>`;
  try {
    const res = await fetch(`/.netlify/functions/morning-brief?region=${encodeURIComponent(region)}`);
    if (!res.ok) {
      const t = await res.text();
      throw new Error(t || 'Brief fetch failed');
    }
    const payload = await res.json();
    renderMorningBrief(payload);

    // Now load the Mates Morning Note and Stock of the Day into the placeholders we injected
    loadMatesMorningNote();
    loadStockOfTheDay();

  } catch (err) {
    console.error('Morning brief failed', err);
    briefContent.innerHTML = `<div class="brief-loading">Failed to load morning brief.</div>`;
  }
});

/* ---------- Toggles & category handling (unchanged) ---------- */

function setActiveToggle(isMarket) {
  if (isMarket) {
    toggleMarket.classList.add("active");
    toggleMarket.setAttribute("aria-selected","true");
    toggleMates.classList.remove("active");
    toggleMates.setAttribute("aria-selected","false");
  } else {
    toggleMates.classList.add("active");
    toggleMates.setAttribute("aria-selected","true");
    toggleMarket.classList.remove("active");
    toggleMarket.setAttribute("aria-selected","false");
  }
}

toggleMarket.onclick = async () => {
  setActiveToggle(true);
  feedStatus.textContent = "Market mode";
  showSkeleton(4);
  allArticles = await getMarketFeed();
  renderMarketMode();
};

toggleMates.onclick = () => {
  setActiveToggle(false);
  feedStatus.textContent = "MatesMode";
  renderMatesMode();
};

categoryRow.onclick = (e) => {
  const btn = e.target.closest(".chip");
  if (!btn) return;
  currentCategory = btn.dataset.category;

  [...categoryRow.children].forEach(b => b.classList.remove("chip-active"));
  btn.classList.add("chip-active");

  if (toggleMates.classList.contains("active")) {
    renderMatesMode();
  } else {
    renderMarketMode();
  }
};

/* ---------- Initial load ---------- */
(async function init() {
  try {
    feedStatus.textContent = "Loading‚Ä¶";
    showSkeleton(4);
    allArticles = await getMarketFeed();
    renderMarketMode();
    feedStatus.textContent = "Live";

    // Note: Mates Morning Note and Stock of the Day are loaded when the morning brief is opened.
  } catch (err) {
    console.error(err);
    newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">Failed to load initial feed.</small></div>`;
    feedStatus.textContent = "Offline";
  }
})();
</script>
<!-- Instrument details modal -->
<div id="mi-instrument-overlay" class="mi-ins-overlay" aria-hidden="true">
  <div class="mi-ins-modal" role="dialog" aria-modal="true" aria-labelledby="mi-ins-title">
    <div class="mi-ins-header">
      <div>
        <h2 id="mi-ins-title" class="mi-ins-title">Instrument name</h2>
        <div class="mi-ins-subtitle" id="mi-ins-subtitle">TICKER ‚Ä¢ Sector</div>
      </div>
      <div class="mi-ins-price-block">
        <div class="mi-ins-price" id="mi-ins-price">$0.00</div>
        <div class="mi-ins-change" id="mi-ins-change">+0.0% today</div>
        <div class="mi-ins-date" id="mi-ins-date">as at ‚Äî</div>
      </div>
      <!-- Single close button, inside sticky header -->
      <button class="mi-ins-close" type="button" id="mi-ins-close-btn" aria-label="Close">
        ‚úï
      </button>
    </div>

    <div class="mi-ins-tags" id="mi-ins-tags">
      <!-- tags inserted here -->
    </div>

    <div class="mi-ins-section">
      <h3 class="mi-ins-section-title">Key stats</h3>
      <div class="mi-ins-stats-grid" id="mi-ins-stats">
        <!-- stats rows injected by JS -->
      </div>
    </div>

    <div class="mi-ins-section">
      <h3 class="mi-ins-section-title">Price history</h3>
      <div class="mi-ins-history">
        <div class="mi-ins-history-summary" id="mi-ins-history-summary">
          Showing last 6 months of daily closes.
        </div>
        <canvas id="mi-ins-chart" width="600" height="220"></canvas>
      </div>
    </div>

    <div class="mi-ins-section">
      <h3 class="mi-ins-section-title">Company snapshot</h3>
      <div id="mi-ins-ai-summary" class="mi-ins-ai-summary">
        We‚Äôre loading a short AI summary for this company‚Ä¶
      </div>
    </div>
  </div>
</div>
<script>
  // -------- Fetch helper --------
  async function miFetchInstrumentDetails(type, code) {
    const url = `/.netlify/functions/instrument-details?type=${encodeURIComponent(
      type
    )}&code=${encodeURIComponent(code)}`;
    const res = await fetch(url);
    if (!res.ok) {
      throw new Error(`instrument-details failed: ${res.status}`);
    }
    return res.json();
  }
  async function miFetchAiSummary(type, code) {
  const url = `/.netlify/functions/instrument-ai-summary?type=${encodeURIComponent(
    type
  )}&code=${encodeURIComponent(code)}`;

  const res = await fetch(url);
  if (!res.ok) {
    throw new Error(`instrument-ai-summary failed: ${res.status}`);
  }
  return res.json();
}

  // -------- Formatting helpers --------
  function miFormatCurrency(n, currency = "AUD") {
    if (typeof n !== "number" || !isFinite(n)) return null;
    try {
      return new Intl.NumberFormat("en-AU", {
        style: "currency",
        currency,
        maximumFractionDigits: 2,
      }).format(n);
    } catch {
      return n.toFixed(2);
    }
  }

  function miFormatCompactNumber(n) {
    if (typeof n !== "number" || !isFinite(n)) return null;
    // Turn big numbers into 51.3B, 206.3B etc
    const abs = Math.abs(n);
    if (abs >= 1_000_000_000) return (n / 1_000_000_000).toFixed(1) + "B";
    if (abs >= 1_000_000) return (n / 1_000_000).toFixed(1) + "M";
    if (abs >= 1_000) return (n / 1_000).toFixed(1) + "k";
    return n.toFixed(0);
  }

  function miFormatPercent(n, digits = 2) {
    if (typeof n !== "number" || !isFinite(n)) return null;
    return n.toFixed(digits) + "%";
  }

  function miFormatDate(dateStr) {
    if (!dateStr) return null;
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return null;
    return d.toLocaleDateString("en-AU", {
      day: "2-digit",
      month: "short",
      year: "numeric",
    });
  }

  // -------- Render modal --------
  function miOpenInstrumentModal(data) {
    const overlay = document.getElementById("mi-instrument-overlay");
    if (!overlay) return;

    const latest = data.latest || {};
    const f = data.fundamentals || {};

    // Header text
    const titleEl = document.getElementById("mi-ins-title");
    const subtitleEl = document.getElementById("mi-ins-subtitle");
    const priceEl = document.getElementById("mi-ins-price");
    const changeEl = document.getElementById("mi-ins-change");
    const dateEl = document.getElementById("mi-ins-date");
    const tagsEl = document.getElementById("mi-ins-tags");
    const statsEl = document.getElementById("mi-ins-stats");
    const historySummaryEl = document.getElementById("mi-ins-history-summary");

    const name = data.name || data.code || "";
    const code = data.code || "";
    const sector = f.sector || "";
    const industry = f.industry || "";
    const sizeBucket = f.sizeBucket || null;

    // Title & subtitle
    if (titleEl) titleEl.textContent = name;
    if (subtitleEl) {
      const bits = [];
      if (code) bits.push(code);
      if (sector) bits.push(sector);
      subtitleEl.textContent = bits.join(" ‚Ä¢ ") || "";
    }

    // Price & change
    const priceNum =
      typeof latest.price === "number" && isFinite(latest.price)
        ? latest.price
        : null;
    const pctChange =
      typeof latest.pctChange === "number" && isFinite(latest.pctChange)
        ? latest.pctChange
        : null;

    if (priceEl) {
      priceEl.textContent =
        priceNum !== null
          ? miFormatCurrency(priceNum, f.currency || "AUD")
          : "‚Äî";
    }

    if (changeEl) {
      changeEl.classList.remove("up", "down");
      if (pctChange === null) {
        changeEl.textContent = "Change: ‚Äî";
      } else {
        const arrow = pctChange > 0 ? "‚ñ≤" : pctChange < 0 ? "‚ñº" : "‚Ä¢";
        changeEl.textContent =
          arrow + " " + pctChange.toFixed(2) + "% yesterday";
        if (pctChange > 0) changeEl.classList.add("up");
        else if (pctChange < 0) changeEl.classList.add("down");
      }
    }

    if (dateEl) {
      const d = miFormatDate(latest.date);
      dateEl.textContent = d ? `as at ${d}` : "";
    }

    // Tags
    if (tagsEl) {
      tagsEl.innerHTML = "";
      const tags = [];

      if (sizeBucket) {
        const label =
          sizeBucket === "mega"
            ? "Mega cap"
            : sizeBucket === "large"
            ? "Large cap"
            : sizeBucket === "mid"
            ? "Mid cap"
            : sizeBucket === "small"
            ? "Small cap"
            : null;
        if (label) tags.push(label);
      }

      if (sector) tags.push(sector);
      if (industry) tags.push(industry);

      tags.forEach((t) => {
        const span = document.createElement("span");
        span.className = "mi-ins-tag";
        span.textContent = t;
        tagsEl.appendChild(span);
      });
    }

    // Stats grid
    if (statsEl) {
      statsEl.innerHTML = "";

      function addStat(label, valueStr) {
        if (!valueStr) return;
        const item = document.createElement("div");
        item.className = "mi-ins-stat-item";
        const lab = document.createElement("span");
        lab.className = "mi-ins-stat-label";
        lab.textContent = label;
        const val = document.createElement("span");
        val.className = "mi-ins-stat-value";
        val.textContent = valueStr;
        item.appendChild(lab);
        item.appendChild(val);
        statsEl.appendChild(item);
      }

      // Market cap
      if (typeof f.marketCap === "number" && isFinite(f.marketCap)) {
        addStat("Market cap", miFormatCompactNumber(f.marketCap));
      }

      // Revenue last year
      if (
        typeof f.revenueLastYear === "number" &&
        isFinite(f.revenueLastYear)
      ) {
        addStat(
          "Revenue (last year)",
          miFormatCompactNumber(f.revenueLastYear)
        );
      }

      // Net income last year (may be null for some)
      if (
        typeof f.netIncomeLastYear === "number" &&
        isFinite(f.netIncomeLastYear)
      ) {
        addStat(
          "Net profit (last year)",
          miFormatCompactNumber(f.netIncomeLastYear)
        );
      }

      // PE
      if (typeof f.pe === "number" && isFinite(f.pe)) {
        addStat("P/E ratio", f.pe.toFixed(2) + "√ó");
      }

      // Dividend yield
      if (
        typeof f.dividendYield === "number" &&
        isFinite(f.dividendYield)
      ) {
        addStat("Dividend yield", miFormatPercent(f.dividendYield, 2));
      }

      // Pays dividend
      if (typeof f.paysDividend === "boolean") {
        addStat("Pays dividend", f.paysDividend ? "Yes" : "No");
      }

      // EPS
      if (typeof f.eps === "number" && isFinite(f.eps)) {
        addStat("Earnings per share", f.eps.toFixed(2));
      }
    }

    // History summary (just text for now)
    if (historySummaryEl) {
      const h = data.history;
      if (h && Array.isArray(h.points) && h.points.length > 1) {
        const start = miFormatDate(h.startDate);
        const end = miFormatDate(h.endDate);
        historySummaryEl.textContent =
          start && end
            ? `Showing daily closes from ${start} to ${end}.`
            : "Showing last 6 months of daily closes.";
      } else {
        historySummaryEl.textContent =
          "Price history not available at the moment.";
      }
    }
// Render the chart
if (data.history) {
  miRenderChart(data.history);
}
    // AI summary
    const summaryEl = document.getElementById("mi-ins-ai-summary");
    if (summaryEl) {
      const aiSection = summaryEl.closest(".mi-ins-section");
      const instrumentType = (data.type || "equity").toLowerCase();

      // For commodities/metals: hide the AI section completely
      if (instrumentType === "metal") {
        if (aiSection) aiSection.style.display = "none";
      } else {
        // For equities: show AI summary as normal
        if (aiSection) aiSection.style.display = "";
        summaryEl.textContent =
          "We‚Äôre loading a short AI snapshot for this company‚Ä¶";

        miFetchAiSummary(instrumentType, data.code || "")
          .then((s) => {
            if (s && s.summary) {
              summaryEl.textContent = s.summary;
            } else {
              summaryEl.textContent =
                "We couldn‚Äôt generate a summary right now.";
            }
          })
          .catch((err) => {
            console.error("AI summary error", err);
            summaryEl.textContent =
              "We couldn‚Äôt generate a summary right now.";
          });
      }
    }    
    // Show overlay
    overlay.style.display = "flex";
    overlay.setAttribute("aria-hidden", "false");
  }

  function miCloseInstrumentModal() {
    const overlay = document.getElementById("mi-instrument-overlay");
    if (!overlay) return;
    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden", "true");
  }
function miRenderChart(history) {
  const canvas = document.getElementById("mi-ins-chart");
  if (!canvas || !history || !Array.isArray(history.points)) return;

  const ctx = canvas.getContext("2d");

  // Extract numeric closes
  const pts = history.points.map(p => p[1]).filter(x => typeof x === "number");

  if (pts.length < 2) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#6b7280";
    ctx.fillText("No chart data available", 10, 20);
    return;
  }

  const w = canvas.width;
  const h = canvas.height;

  const min = Math.min(...pts);
  const max = Math.max(...pts);

  const padX = 20;
  const padY = 10;

  ctx.clearRect(0, 0, w, h);

  ctx.lineWidth = 2;
  ctx.strokeStyle = "#38bdf8"; // cyan-blue line
  ctx.beginPath();

  pts.forEach((v, i) => {
    const x = padX + (i / (pts.length - 1)) * (w - padX * 2);
    const y = h - padY - ((v - min) / (max - min)) * (h - padY * 2);

    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });

  ctx.stroke();

  // Fade fill under the line
  const gradient = ctx.createLinearGradient(0, padY, 0, h);
  gradient.addColorStop(0, "rgba(56,189,248,0.25)");
  gradient.addColorStop(1, "rgba(56,189,248,0.0)");

  ctx.lineTo(w - padX, h - padY);
  ctx.lineTo(padX, h - padY);
  ctx.closePath();
  ctx.fillStyle = gradient;
  ctx.fill();
}

  // -------- Wire up clicks --------
  document.addEventListener("click", async (e) => {
    // Close if clicking overlay background
    const overlay = document.getElementById("mi-instrument-overlay");
    if (overlay && e.target === overlay) {
      miCloseInstrumentModal();
      return;
    }

    // Close button
    const closeBtn = document.getElementById("mi-ins-close-btn");
    if (closeBtn && e.target === closeBtn) {
      miCloseInstrumentModal();
      return;
    }

    // Instrument chip (e.g. top 6 performers)
    const chip = e.target.closest(".mi-performer-chip[data-code]");
    if (!chip) return;

    const code = chip.getAttribute("data-code");
    const type = chip.getAttribute("data-type") || "equity";

    try {
      const data = await miFetchInstrumentDetails(type, code);
      miOpenInstrumentModal(data);
    } catch (err) {
      console.error("Failed to load instrument details", err);
      alert("Sorry, we couldn't load that company at the moment.");
    }
  });

  // Escape key closes modal
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      miCloseInstrumentModal();
    }
  });
/* Robust price extraction + modal population for commodities */

/* Keep a ref to the currently clicked card as a fallback */
let __mi_lastClickedCard = null;
document.addEventListener('click', (e) => {
  const card = e.target.closest('.card-metal, .metal-card, .card'); // adjust selectors if needed
  if (card) __mi_lastClickedCard = card;
});

function getPriceFromItem(item) {
  if (!item || typeof item !== 'object') return null;

  // Common keys to try
  const fields = [
    'price','last','close','value','last_price','mid','current','lastPrice','last_trade_price','last_trade'
  ];

  for (const f of fields) {
    if (item[f] !== undefined && item[f] !== null && item[f] !== '') {
      return item[f];
    }
  }

  // Nested quote containers
  if (item.quote && typeof item.quote === 'object') {
    const q = getPriceFromItem(item.quote);
    if (q !== null) return q;
  }
  if (item.quoteData && typeof item.quoteData === 'object') {
    const q = getPriceFromItem(item.quoteData);
    if (q !== null) return q;
  }

  // If there's a history/time-series, use the last close/price
  if (Array.isArray(item.history) && item.history.length) {
    const lastEntry = item.history[item.history.length - 1];
    if (lastEntry) {
      if (lastEntry.close !== undefined && lastEntry.close !== null) return lastEntry.close;
      if (lastEntry.price !== undefined && lastEntry.price !== null) return lastEntry.price;
    }
  }

  return null;
}

function formatPriceForModal(raw, unit) {
  if (raw === null || raw === undefined || raw === '') return '‚Äî';

  // try parse number; if not a number, return raw string
  const numeric = Number(String(raw).replace(/[, ]+/g,''));
  if (Number.isNaN(numeric)) {
    return String(raw);
  }
  const formatted = numeric.toLocaleString('en-AU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  return (unit ? '' : '$') + formatted + (unit ? `/${unit}` : '');
}

/* Read visual price from the card DOM (fallback)
   Expects .metal-price inside the clicked card; adjust selector if your markup differs. */
function getPriceFromLastClickedCard() {
  if (!__mi_lastClickedCard) return null;
  const priceEl = __mi_lastClickedCard.querySelector('.metal-price, .price, .perf-last');
  if (!priceEl) return null;
  const txt = priceEl.textContent.trim();
  // strip currency symbols/commas and try return numeric
  const cleaned = txt.replace(/[^\d\.\-]+/g,'').trim();
  if (cleaned === '') return null;
  return cleaned;
}

/* Call this from your modal-open routine, passing the item object that the modal should show */
function populateModalPrice(item) {
  console.log('populateModalPrice item:', item);
  const priceEl = document.querySelector('.mi-ins-price');
  if (!priceEl) return;

  let raw = getPriceFromItem(item);

  // fallback: read from clicked card text if still missing
  if (raw === null) {
    raw = getPriceFromLastClickedCard();
  }

  // fallback: look for a 'priceText' or similar
  if (raw === null && item && typeof item === 'object') {
    if (item.priceText) raw = item.priceText;
    if (item.display && item.display.price) raw = item.display.price;
  }

  const unit = (item && (item.unit || item.uom || item.unitOfMeasure || item.quoteUnit)) || '';
  priceEl.textContent = formatPriceForModal(raw, unit);
}

/* Example: attach to commodity cards automatically if your list is static.
   If you already have a modal open function, call populateModalPrice(item) from it instead.
*/
document.querySelectorAll('.card-metal').forEach(card => {
  card.addEventListener('click', (ev) => {
    // If you have a data object serialized on the element, parse that:
    // const item = card.dataset.item ? JSON.parse(card.dataset.item) : null;
    // If you keep the item in a JS array, look it up by symbol/id here.
    // For now we'll attempt to use dataset.* fallbacks:
    const item = (card.dataset && card.dataset.item) ? JSON.parse(card.dataset.item) : null;

    // populate price using what we have
    populateModalPrice(item);

    // If you have an existing openModal(item) function, call it so the modal shows:
    if (typeof openModal === 'function') {
      openModal(item);
    } else {
      // fallback: show overlay/modal element if you manage it manually
      const overlay = document.querySelector('.mi-ins-overlay');
      if (overlay) overlay.style.display = 'flex';
    }
  });
});
/* Daily Brief email signup */
(function setupDailyBriefSignup() {
  const form = document.getElementById("dailyBriefForm");
  const emailInput = document.getElementById("dailyBriefEmail");
  const statusEl = document.getElementById("dailyBriefStatus");

  if (!form) return;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = emailInput.value.trim();
    if (!email) {
      statusEl.textContent = "Please enter an email address.";
      statusEl.style.color = "#dc2626";
      return;
    }

    statusEl.textContent = "Subscribing‚Ä¶";
    statusEl.style.color = "var(--muted)";

    try {
      const res = await fetch("/.netlify/functions/subscribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email }),
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || !data.ok) {
        const msg = data?.error || "Something went wrong. Try again.";
        statusEl.textContent = msg;
        statusEl.style.color = "#dc2626";
        return;
      }

      statusEl.textContent = "You're in! The briefing will arrive every morning.";
      statusEl.style.color = "#15803d";
      emailInput.value = "";
    } catch (err) {
      statusEl.textContent = "Network error, try again shortly.";
      statusEl.style.color = "#dc2626";
    }
  });
  })();
</script>

<!-- MatesBook JS: explainers + stories -->
<script>
  // ---------- 1. Data: explainers with categories ----------

  const miExplainers = [
    // ASX basics
    { id: "ASX", title: "ASX", category: "ASX basics",
      text: "The ASX is Australia‚Äôs big marketplace for buying and selling company shares. Like a giant shopping centre, but instead of shoes or toys, people buy pieces of companies." },
    { id: "ASX200", title: "ASX200", category: "ASX basics",
      text: "A list of the 200 biggest and most important companies on the ASX. Like the top 200 players in a footy league." },
    { id: "Stock", title: "What is a stock?", category: "ASX basics",
      text: "A stock is a tiny piece of a company. If you own one, you own a slice of the business." },
    { id: "Exchange", title: "Stock exchange", category: "ASX basics",
      text: "A safe place where people trade shares with rules, scoreboards, and referees." },
    { id: "PriceMovement", title: "Why prices move", category: "ASX basics",
      text: "Prices move because buyers and sellers disagree. More buyers = price goes up. More sellers = price goes down." },

    // Daily terms
    { id: "Futures", title: "Futures", category: "Daily terms",
      text: "Futures are like tomorrow‚Äôs predicted price. A guess ‚Äî sometimes close, sometimes very wrong." },
    { id: "ClosedHigher", title: "Closed higher/lower", category: "Daily terms",
      text: "If the market 'closed higher', it ended the day above where it started. 'Closed lower' means it finished below." },
    { id: "PointMove", title: "Point move", category: "Daily terms",
      text: "A point is just a unit on an index like the ASX200. A 30-point move means the whole market shifted a bit." },
    { id: "Volatility", title: "Volatility", category: "Daily terms",
      text: "Volatility means how jumpy prices are. Lots of bouncing up and down = high volatility." },
    { id: "Sentiment", title: "Market sentiment", category: "Daily terms",
      text: "Market sentiment is the mood of investors. Confident and excited = prices tend to rise. Scared and nervous = prices tend to fall." },

    // Company metrics
    { id: "MarketCap", title: "Market cap", category: "Company metrics",
      text: "Market cap is what a company is worth on the market. Share price √ó number of shares." },
    { id: "PERatio", title: "PE ratio", category: "Company metrics",
      text: "The PE ratio shows how many dollars investors are paying for $1 of company profit." },
    { id: "EPS", title: "EPS (earnings per share)", category: "Company metrics",
      text: "EPS shows how much profit the company makes for each share someone owns." },
    { id: "DividendYield", title: "Dividend yield", category: "Company metrics",
      text: "Dividend yield is how much a company pays you each year in dividends, as a % of the current share price." },
    { id: "Revenue", title: "Revenue", category: "Company metrics",
      text: "Revenue is all the money a company brings in from selling its products or services, before paying any bills." },
    { id: "Profit", title: "Profit", category: "Company metrics",
      text: "Profit is what‚Äôs left after the company has paid all its costs and bills." },
    { id: "Guidance", title: "Guidance", category: "Company metrics",
      text: "Guidance is when a company tells investors what it expects for its future sales and profits." },
    { id: "CashFlow", title: "Cash flow", category: "Company metrics",
      text: "Cash flow measures how much real cash moves in and out of a company‚Äôs bank accounts." },
    { id: "BalanceSheet", title: "Balance sheet", category: "Company metrics",
      text: "A balance sheet is like a company‚Äôs report card ‚Äî showing what it owns, what it owes, and what‚Äôs left over." },
    { id: "Debt", title: "Debt", category: "Company metrics",
      text: "Debt is money a company has borrowed and must pay back later, usually with interest." },

    // Macro
    { id: "Inflation", title: "Inflation", category: "Macro",
      text: "Inflation means things slowly get more expensive over time, like your grocery bill creeping up." },
    { id: "InterestRates", title: "Interest rates", category: "Macro",
      text: "Interest rates are the cost of borrowing money. Higher rates make loans more expensive, so people and businesses may spend less." },
    { id: "GDP", title: "GDP", category: "Macro",
      text: "GDP is the total value of everything a country produces. Bigger GDP usually means a stronger economy." },
    { id: "Unemployment", title: "Unemployment", category: "Macro",
      text: "Unemployment counts people who want a job but can‚Äôt find one." },
    { id: "BondYields", title: "Bond yields", category: "Macro",
      text: "Bond yields show the return governments or companies pay to people who lend them money." },
    { id: "RBA", title: "RBA", category: "Macro",
      text: "The RBA (Reserve Bank of Australia) is the team that sets interest rates and tries to keep the economy stable." },
    { id: "Recession", title: "Recession", category: "Macro",
      text: "A recession is when the economy shrinks for a while and people cut back on spending." },
    { id: "SoftLanding", title: "Soft landing", category: "Macro",
      text: "A soft landing is when inflation falls back down without the economy crashing or lots of people losing jobs." },
    { id: "GDPGrowth", title: "GDP growth", category: "Macro",
      text: "GDP growth shows whether the economy is getting bigger (positive) or smaller (negative)." },
    { id: "RateCut", title: "Rate cut", category: "Macro",
      text: "A rate cut is when the RBA lowers interest rates to make borrowing cheaper and encourage spending." },

    // Trading
    { id: "MarketOrder", title: "Market order", category: "Trading",
      text: "A market order buys or sells a stock instantly at the best available current price." },
    { id: "LimitOrder", title: "Limit order", category: "Trading",
      text: "A limit order only buys or sells at the price you choose (or better)." },
    { id: "Liquidity", title: "Liquidity", category: "Trading",
      text: "Liquidity tells you how easy it is to buy or sell a stock quickly without moving the price too much." },
    { id: "Spread", title: "Spread", category: "Trading",
      text: "The spread is the small gap between what buyers are willing to pay and what sellers are asking." },
    { id: "Volume", title: "Volume", category: "Trading",
      text: "Volume is how many shares are traded in a day ‚Äî like how busy the shop is." },
    { id: "Rally", title: "Rally", category: "Trading",
      text: "A rally is when prices climb for a while, often because investors feel positive." },
    { id: "SellOff", title: "Sell-off", category: "Trading",
      text: "A sell-off is when lots of people rush to sell, and prices drop quickly." },
    { id: "TakeProfit", title: "Take profit", category: "Trading",
      text: "Taking profit means selling after a price rise so you lock in your gains." },
    { id: "StopLoss", title: "Stop loss", category: "Trading",
      text: "A stop loss is an order that sells automatically if the price falls to a level you set, to limit your losses." },
    { id: "AveragingDown", title: "Averaging down", category: "Trading",
      text: "Averaging down means buying more shares at a cheaper price so your average cost per share goes lower." },

    // Commodities & Crypto
    { id: "Commodities", title: "Commodities", category: "Commodities & Crypto",
      text: "Commodities are raw materials like gold, oil, and iron ore that people use to make things." },
    { id: "CommodityPrices", title: "Commodity prices", category: "Commodities & Crypto",
      text: "Commodity prices move mainly because of supply and demand ‚Äî if something becomes harder to get, the price usually jumps." },
    { id: "Gold", title: "Gold", category: "Commodities & Crypto",
      text: "Gold is used for jewellery and electronics, and many investors treat it as a 'safe haven' in tough times." },
    { id: "Oil", title: "Oil", category: "Commodities & Crypto",
      text: "Oil is used for fuel, plastics, and chemicals ‚Äî it touches almost everything in modern life." },
    { id: "IronOre", title: "Iron ore", category: "Commodities & Crypto",
      text: "Iron ore is a rock that gets turned into steel. It‚Äôs a huge export for Australia." },
    { id: "AUD", title: "Aussie dollar (AUD)", category: "Commodities & Crypto",
      text: "The Aussie dollar is Australia‚Äôs currency and often rises and falls with commodity prices." },
    { id: "Bitcoin", title: "Bitcoin", category: "Commodities & Crypto",
      text: "Bitcoin is digital money that isn‚Äôt controlled by any government." },
    { id: "CryptoVolatility", title: "Crypto volatility", category: "Commodities & Crypto",
      text: "Crypto is new and emotional, so prices can swing wildly in a short time." },
    { id: "Blockchain", title: "Blockchain", category: "Commodities & Crypto",
      text: "A blockchain is a secure digital ledger that records who owns what." },
    { id: "Stablecoin", title: "Stablecoin", category: "Commodities & Crypto",
      text: "Stablecoins are cryptocurrencies designed to stay around the same price, often pegged to $1 USD." }
  ];
// ---------- 2. Data: Mates stories (now loaded from backend) ----------

// Will be filled from /.netlify/functions/matesStory-feed
let miStories = [];
let miStoriesLoaded = false;
let miStoriesLoading = false;

async function miFetchStories() {
  if (miStoriesLoaded || miStoriesLoading) return;

  miStoriesLoading = true;
  try {
const res = await fetch("/.netlify/functions/stories-feed");
    if (!res.ok) {
      console.error("miFetchStories failed", res.status);
      return;
    }
    const data = await res.json().catch(() => null);

    // Expect shape: { stories: [...] } or plain array
    const list = Array.isArray(data?.stories) ? data.stories :
                 Array.isArray(data) ? data : [];

    miStories = list;
    miStoriesLoaded = true;
  } catch (err) {
    console.error("miFetchStories error", err);
  } finally {
    miStoriesLoading = false;
  }
}



  // ---------- 3. Helpers for explainers ----------

  function miFilterExplainers(query, category) {
    const q = (query || "").trim().toLowerCase();
    return miExplainers.filter(item => {
      const matchesCategory = category === "all" || item.category === category;
      const matchesQuery =
        !q ||
        item.title.toLowerCase().includes(q) ||
        item.text.toLowerCase().includes(q);
      return matchesCategory && matchesQuery;
    });
  }

  function miBuildSuggestions(query) {
    const q = (query || "").trim().toLowerCase();
    if (!q) return [];
    const startsWith = [];
    const contains = [];

    for (const item of miExplainers) {
      const title = item.title.toLowerCase();
      if (title.startsWith(q)) {
        startsWith.push(item);
      } else if (title.includes(q)) {
        contains.push(item);
      }
    }

    return [...startsWith, ...contains].slice(0, 5);
  }

  // ---------- 4. MatesBook UI wiring ----------

  (function miInitMatesBook() {
    const bookBtn = document.getElementById("miBookBtn");
    const modal = document.getElementById("miBookModal");
    const closeBtn = document.getElementById("miBookClose");

    const tabs = document.querySelectorAll(".mi-book-tab");
    const explainPane = document.getElementById("miBookExplainPane");
    const storiesPane = document.getElementById("miBookStoriesPane");

    // explain elements
    const listEl = document.getElementById("miExplainList");
    const searchInput = document.getElementById("miExplainSearch");
    const chipsEl = document.getElementById("miExplainChips");
    const randomExplainBtn = document.getElementById("miExplainRandom");
    const suggestionsEl = document.getElementById("miExplainSuggestions");

// stories elements
const storiesBodyEl = document.getElementById("miStoriesBody");
const storyOpenBtn = document.getElementById("miStoryOpenForm");
const storyFormEl  = document.getElementById("miStoryForm");
const storyTitleEl = document.getElementById("miStoryTitle");
const storyTextEl  = document.getElementById("miStoryText");
const storyBylineEl= document.getElementById("miStoryByline");
const storyTagEl   = document.getElementById("miStoryTag");
const storyStatusEl= document.getElementById("miStoryStatus");
const storySubmitEl= document.getElementById("miStorySubmit");
    const storyConsentEl = document.getElementById("miStoryConsent");


    if (!bookBtn || !modal) return;

    let currentCategory = "all";
    let currentQuery = "";

    // ---- explain rendering ----
    function hideSuggestions() {
      if (suggestionsEl) {
        suggestionsEl.classList.remove("mi-visible");
        suggestionsEl.innerHTML = "";
      }
    }

    function renderExplainList() {
      const items = miFilterExplainers(currentQuery, currentCategory);
      if (!listEl) return;
      if (items.length === 0) {
        listEl.innerHTML = '<p class="mi-explain-text">No matches. Try another word like "ASX", "inflation" or "PE ratio".</p>';
        return;
      }
      listEl.innerHTML = items.map(item => `
        <div class="mi-explain-item">
          <div class="mi-explain-term">${item.title}</div>
          <div class="mi-explain-category">${item.category}</div>
          <div class="mi-explain-text">${item.text}</div>
        </div>
      `).join("");
    }

    function renderExplainSuggestions() {
      if (!suggestionsEl) return;
      const suggestions = miBuildSuggestions(currentQuery);
      if (suggestions.length === 0) {
        hideSuggestions();
        return;
      }
      suggestionsEl.innerHTML = suggestions
        .map(item => `<button type="button" data-id="${item.id}">${item.title}</button>`)
        .join("");
      suggestionsEl.classList.add("mi-visible");
    }
    // ---- story form handlers ----
    if (storyOpenBtn && storyFormEl) {
      storyOpenBtn.addEventListener("click", () => {
        const isHidden = storyFormEl.style.display === "none" || !storyFormEl.style.display;
        storyFormEl.style.display = isHidden ? "block" : "none";
        if (isHidden && storyTitleEl) {
          storyTitleEl.focus();
        }
      });
    }

    if (storyFormEl) {
      storyFormEl.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!storyTitleEl || !storyTextEl || !storyStatusEl || !storySubmitEl) return;

const title = storyTitleEl.value.trim();
const text  = storyTextEl.value.trim();
const byline = (storyBylineEl?.value || "").trim();
const tag    = (storyTagEl?.value || "").trim();
const consent = !!(storyConsentEl && storyConsentEl.checked);

        if (!title || !text) {
          storyStatusEl.textContent = "Please add a title and a short story.";
          storyStatusEl.style.color = "#dc2626";
          return;
        }

        storySubmitEl.disabled = true;
        storyStatusEl.textContent = "Sending your story‚Ä¶";
        storyStatusEl.style.color = "var(--muted)";

        try {
const res = await fetch("/.netlify/functions/submit-story", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
body: JSON.stringify({
  title,
  text,
  tag,
  consent,
  // split byline into simple bits for now
  name: byline || "Anon",
}),
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok || data.error) {
            const msg = data.error || "Something went wrong. Try again later.";
            storyStatusEl.textContent = msg;
            storyStatusEl.style.color = "#dc2626";
          } else {
            storyStatusEl.textContent =
              "Thanks for sharing ‚Äî your story will appear once it‚Äôs approved.";
            storyStatusEl.style.color = "#15803d";
            storyTitleEl.value = "";
            storyTextEl.value = "";
            if (storyBylineEl) storyBylineEl.value = "";
            if (storyTagEl) storyTagEl.value = "";
          }
        } catch (err) {
          console.error("matesStory-submit failed", err);
          storyStatusEl.textContent = "Network error, please try again.";
          storyStatusEl.style.color = "#dc2626";
        } finally {
          storySubmitEl.disabled = false;
        }
      });
    }
    // ---- stories rendering ----
async function renderStoriesFeed() {
  if (!storiesBodyEl) return;

  // Load from backend on first visit
  if (!miStoriesLoaded && !miStoriesLoading) {
    storiesBodyEl.innerHTML =
      '<p class="mi-stories-text">Loading mates‚Äô stories‚Ä¶</p>';
    await miFetchStories();
  }

  if (!miStories.length) {
    storiesBodyEl.innerHTML =
      '<p class="mi-stories-text">No stories yet. Be the first to share yours.</p>';
    return;
  }

  // sort by date descending (newest first)
  const sorted = [...miStories].sort((a, b) => {
    const da = new Date(a.date || a.createdAt || 0);
    const db = new Date(b.date || b.createdAt || 0);
    return db - da;
  });

  storiesBodyEl.innerHTML = sorted
    .map((story) => {
      let displayDate = story.date || story.createdAt || "";
      const d = new Date(displayDate);
      if (!isNaN(d.getTime())) {
        displayDate = d.toLocaleDateString("en-AU", {
          day: "numeric",
          month: "short",
          year: "numeric",
        });
      }

      const tag = story.tag || "";
      const title = story.title || "";
      const text = story.text || story.body || "";
      const byline = story.byline || "Anon";

      return `
        <article class="mi-stories-card">
          ${tag ? `<div class="mi-stories-tag">${tag}</div>` : ""}
          <div class="mi-stories-title">${title}</div>
          <div class="mi-stories-meta-line">
            <span class="mi-stories-date">${displayDate}</span>
          </div>
          <p class="mi-stories-text">${text}</p>
          <p class="mi-stories-byline">${byline}</p>
        </article>
      `;
    })
    .join("");
}

    // ---- tab switching ----
    function setActivePane(pane) {
      tabs.forEach(tab => {
        const isActive = tab.getAttribute("data-pane") === pane;
        tab.classList.toggle("active", isActive);
      });

      if (pane === "explain") {
        explainPane.removeAttribute("hidden");
        storiesPane.setAttribute("hidden", "true");
        renderExplainList();
} else {
  storiesPane.removeAttribute("hidden");
  explainPane.setAttribute("hidden", "true");
  renderStoriesFeed();
}

    }

    // ---- open / close ----
    function openModal(defaultPane = "explain") {
      modal.classList.add("mi-open");
      modal.setAttribute("aria-hidden", "false");
      setActivePane(defaultPane);
      // no auto-focus on mobile to avoid keyboard pop-up
      if (window.innerWidth > 700 && defaultPane === "explain" && searchInput) {
        setTimeout(() => searchInput.focus(), 150);
      }
    }

    function closeModal() {
      modal.classList.remove("mi-open");
      modal.setAttribute("aria-hidden", "true");
      currentQuery = "";
      if (searchInput) searchInput.value = "";
      hideSuggestions();
    }

    // ---- event wiring ----
    bookBtn.addEventListener("click", () => openModal("explain"));
    closeBtn && closeBtn.addEventListener("click", closeModal);

    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal.classList.contains("mi-open")) {
        closeModal();
      }
    });

    // tabs
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const pane = tab.getAttribute("data-pane") || "explain";
        setActivePane(pane);
      });
    });

    // Explain search
    if (searchInput) {
      searchInput.addEventListener("input", (e) => {
        currentQuery = e.target.value || "";
        renderExplainList();
        renderExplainSuggestions();
      });
      searchInput.addEventListener("focus", () => {
        renderExplainSuggestions();
      });
    }

    if (suggestionsEl) {
      suggestionsEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const id = btn.getAttribute("data-id");
        const item = miExplainers.find(x => x.id === id);
        if (item) {
          currentQuery = item.title;
          if (searchInput) searchInput.value = item.title;
          hideSuggestions();
          renderExplainList();
        }
      });
    }

    // Explain category chips
    if (chipsEl) {
      chipsEl.addEventListener("click", (e) => {
        const chip = e.target.closest("button[data-category]");
        if (!chip) return;
        const cat = chip.getAttribute("data-category") || "all";
        currentCategory = cat;
        chipsEl.querySelectorAll("button").forEach(b => b.classList.remove("active"));
        chip.classList.add("active");
        renderExplainList();
      });
    }

    // Explain random button
    if (randomExplainBtn) {
      randomExplainBtn.addEventListener("click", () => {
        const randomIndex = Math.floor(Math.random() * miExplainers.length);
        const item = miExplainers[randomIndex];
        currentCategory = "all";
        currentQuery = item.title;
        if (searchInput) searchInput.value = item.title;
        // reset chips
        chipsEl && chipsEl.querySelectorAll("button").forEach(b => {
          b.classList.toggle("active", b.getAttribute("data-category") === "all");
        });
        renderExplainList();
        hideSuggestions();
      });
    }
  })();
</script>

</body>
</html>
