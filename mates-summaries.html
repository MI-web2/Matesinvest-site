<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>MatesFeed – Plain-English market summaries | MatesInvest</title>
  <meta name="description" content="MatesFeed delivers live market headlines and plain-English AI summaries built for Australian retail investors.">

  <link rel="icon" type="image/png" href="/assets/img/favicon.png">
  <link rel="apple-touch-icon" href="/assets/img/favicon.png">

  <style>
    :root{
      --bg: #050814;
      --card: linear-gradient(180deg, rgba(20,24,40,0.9), rgba(15,18,32,0.85));
      --muted: rgba(255,255,255,0.66);
      --muted-2: rgba(255,255,255,0.44);
      --accent: #3fbf7f;
      --accent-strong: #2ea668;
      --accent-soft: rgba(63,191,127,0.12);
      --border: rgba(255,255,255,0.06);
      --card-border: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.03);
      --radius: 14px;
      --gap: 1rem;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(circle at top left, #20274a 0, #050814 45%);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.4;
      padding-bottom:3rem;
    }

    .page-shell{
      max-width:1080px;
      margin:0 auto;
      padding:1rem 1.25rem 3rem;
    }

    /* Accessible visually-hidden utility (keeps H1 for SEO / screen readers) */
    .visually-hidden {
      position: absolute !important;
      height: 1px;
      width: 1px;
      overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap; /* prevent line breaks */
      border: 0;
      padding: 0;
      margin: -1px;
    }

    /* NAV */
    .nav{
      position:sticky;
      top:0;
      z-index:30;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(5,8,20,0.92), rgba(5,8,20,0.78));
      border-bottom: 1px solid var(--border);
    }
    .nav-inner{
      max-width:1080px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
      padding:0.9rem 1.25rem;
    }
    .nav-left{display:flex;align-items:center;gap:0.75rem}
    .nav-logo{height:44px;width:44px;border-radius:8px;object-fit:cover}
    .nav-title{font-weight:600;font-size:1.05rem}
    .nav-pill{padding:0.2rem 0.6rem;border-radius:999px;font-size:0.75rem;background:var(--accent-soft);color:var(--accent);border:1px solid rgba(63,191,127,0.26)}
    .nav-right{font-size:0.82rem;color:var(--muted);display:flex;gap:0.75rem;align-items:center}
    .nav-home-link{padding:0.35rem 0.8rem;border-radius:999px;border:1px solid var(--border);text-decoration:none;color:#fff;background:rgba(255,255,255,0.03)}
    .nav-home-link:hover{background:rgba(255,255,255,0.06)}

    /* Card */
    .card { background: var(--card); border-radius: var(--radius); padding:1.25rem; margin-bottom:1rem; border:1px solid var(--card-border) }
    .card-hero h1{margin:0;font-size:1.4rem}
    .card-hero p{margin:0.35rem 0 0;color:var(--muted)}

    /* Morning brief */
    .brief-header { display:flex; align-items:center; gap:0.75rem; justify-content:space-between; }
    .brief-controls { display:flex; gap:0.5rem; align-items:center; }
    .brief-toggle { padding:0.36rem 0.7rem; border-radius:999px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer }
    .brief-toggle.primary { background:var(--accent); color:#00110a; font-weight:700; border:1px solid rgba(0,0,0,0.06) }

    .brief-content { margin-top:0.9rem; display:none; }
    .brief-loading { color:var(--muted); font-size:0.95rem }

    .brief-tldr { display:flex; gap:0.6rem; flex-direction:column; margin-top:0.5rem }
    .brief-bullet { background:rgba(255,255,255,0.02); padding:0.45rem; border-radius:8px; border:1px solid rgba(255,255,255,0.03) }

    /* Small inline form controls for search / symbols */
    .inline-form { display:flex; gap:0.6rem; align-items:center; }
    .inline-form input[type="text"] {
      padding:0.45rem 0.6rem;
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      color: #fff;
      min-width:180px;
    }
    .inline-form .small {
      padding:0.36rem 0.6rem;
      border-radius:999px;
      background:transparent;
      color:var(--muted);
      border:1px solid var(--border);
      font-size:0.88rem;
    }

    /* Controls & chips (existing) */
    .controls { display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; margin-top:0.6rem; }
    .segmented { display:inline-flex; background:var(--glass); border-radius:999px; padding:3px; gap:4px; border:1px solid var(--border); }
    .segmented button{ background:transparent; border:0; padding:0.45rem 0.85rem; color:var(--muted); border-radius:999px; cursor:pointer; font-size:0.88rem; transition: all .16s ease; }
    .segmented button.active{ background: linear-gradient(180deg,var(--accent), var(--accent-strong)); color:#00110a; box-shadow: 0 6px 18px rgba(47,143,95,0.12), inset 0 -1px 0 rgba(0,0,0,0.06); }

    .chip-row{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.6rem}
    .chip{ padding:0.32rem 0.7rem;border-radius:999px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;font-size:0.82rem; transition: all .14s ease; }
    .chip:hover{background:rgba(255,255,255,0.02)}
    .chip-active{background:var(--accent-soft);color:#fff;border-color:var(--accent)}

    .sport-row{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.6rem}
    .sport-chip{ padding:0.28rem 0.6rem;border-radius:999px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer;font-size:0.82rem; }
    .sport-chip.active{background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.08);color:#fff;box-shadow:inset 0 -1px 0 rgba(0,0,0,0.05)}
    .sport-tag{display:inline-block;padding:0.12rem 0.5rem;border-radius:999px;background:rgba(255,255,255,0.03);font-size:0.78rem;color:var(--muted);border:1px solid rgba(255,255,255,0.03) }

    /* News list */
    #newsList{margin-top:0.85rem; display:flex;flex-direction:column; gap:0.85rem}
    .headline{ display:block; padding:0.95rem; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid var(--card-border); transition: transform .12s ease, box-shadow .12s ease; }
    .headline:hover{ transform: translateY(-3px); box-shadow: 0 10px 30px rgba(2,6,23,0.55) }

    .meta-row{ display:flex; align-items:center; gap:0.6rem; justify-content:space-between }
    .meta-left{ display:flex; align-items:center; gap:0.65rem; min-width:0 }
    .headline h3{ margin:0 0 0.25rem 0; font-size:1rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .headline small{ color:var(--muted-2); font-size:0.82rem; display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
    .headline .actions{ display:flex; gap:0.6rem; align-items:center; margin-top:0.6rem }

    .btn{ background:var(--accent); border:none; padding:0.5rem 0.95rem; border-radius:999px; cursor:pointer; color:#00110a; font-weight:700; font-size:0.86rem; transition: transform .08s ease, opacity .12s ease; }
    .btn:active{ transform: translateY(1px) }
    .btn:disabled{ opacity:0.6; cursor:default }

    .link-min{ background:transparent; border:1px solid var(--border); color:var(--muted); padding:0.42rem 0.7rem; border-radius:999px; text-decoration:none; font-size:0.83rem }
    .link-min:hover{ background:rgba(255,255,255,0.02) }

    .summary-output{ margin-top:0.65rem }

    .summary-block{ margin-top:0.45rem; border-top:1px dashed rgba(255,255,255,0.04); padding-top:0.6rem; font-size:0.95rem; color: #fff; }
    .summary-block p{margin:0.45rem 0}
    .tldr-list{ margin:0.35rem 0 0 0.85rem; padding:0; list-style:none; color:var(--muted) }
    .tldr-list li{ margin:0.25rem 0; position:relative; padding-left:1.05rem }
    .tldr-list li::before{ content:""; width:8px;height:8px;border-radius:2px;background:var(--accent);position:absolute;left:0.15rem;top:0.55rem;box-shadow:0 1px 0 rgba(0,0,0,0.2) }

    .summary-meta{ color:var(--muted-2); font-size:0.82rem; margin-top:0.45rem }

    /* small helper text */
    .muted { color: var(--muted); font-size:0.86rem; }

    /* responsive tweaks kept similar to existing file */
    @media (max-width:480px) {
      .inline-form input[type="text"] { min-width:110px; }
      .inline-form { gap:0.4rem; }
    }
  </style>

</head>

<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="nav-left">
        <img src="/assets/img/logo-placeholder.png" class="nav-logo" alt="MatesInvest logo">
        <div>
          <div class="nav-title">MatesInvest</div>
          <div class="nav-pill">MatesFeed · Prototype</div>
        </div>
      </div>
      <div class="nav-right">
        <span>Live AI summaries · Not financial advice</span>
        <a href="/" class="nav-home-link">Home</a>
      </div>
    </div>
  </div>

<div class="page-shell">

  <!-- HERO (kept for accessibility/SEO but visually hidden) -->
  <h1 class="visually-hidden">MatesFeed</h1>

  <!-- MORNING BRIEF -->
  <section id="morningBrief" class="card">
    <div class="brief-header">
      <div>
        <h2 style="margin:0">Morning Briefing</h2>
        <div style="color:var(--muted);font-size:0.92rem;margin-top:0.35rem">A short note on what could move markets in Australia today.</div>
      </div>

      <div class="brief-controls">
        <select id="briefRegion" class="brief-toggle" aria-label="Region">
          <option value="au" selected>Australia (ASX)</option>
          <option value="us">US</option>
          <option value="global">Global</option>
        </select>

        <button id="openBrief" class="brief-toggle primary">Open morning brief</button>
        <button id="refreshBrief" class="brief-toggle" title="Refresh">Refresh</button>
      </div>
    </div>

    <div id="briefContent" class="brief-content" aria-live="polite">
      <!-- injected by JS: will include placeholders for Mates Morning Note + Stock of the Day + metals grid -->
    </div>
  </section>

    <!-- LATEST HEADLINES -->
    <section id="news" class="card" aria-labelledby="latest-headlines">
      <h2 id="latest-headlines">Latest Headlines</h2>

      <div class="controls" style="align-items:center;">
        <div class="segmented" role="tablist" aria-label="View mode">
          <button id="toggleMarket" class="active" role="tab" aria-selected="true">Market Mode</button>
          <button id="toggleMates" role="tab" aria-selected="false">MatesMode</button>
        </div>

        <!-- inline search + symbols input -->
        <div style="flex:1"></div>

        <div class="inline-form" aria-label="Search and filters" role="search">
          <input id="articleSearch" type="text" placeholder="Search headlines or descriptions" aria-label="Search articles">
          <input id="symbolInput" type="text" placeholder="Symbols (e.g. BHP,CBA)" aria-label="Filter by symbols">
          <button id="applySymbols" class="small" title="Fetch for symbols">Apply</button>
          <button id="clearFilters" class="small" title="Clear search & symbols">Clear</button>
        </div>

        <div style="display:flex;align-items:center;gap:0.5rem;color:var(--muted);font-size:0.88rem">
          <span id="feedStatus">Live</span>
        </div>
      </div>

      <div class="chip-row" id="categoryRow" aria-label="Categories">
        <button class="chip chip-active" data-category="all">All</button>
        <button class="chip" data-category="energy">Energy</button>
        <button class="chip" data-category="tech">Tech</button>
        <button class="chip" data-category="macro">Macro</button>
        <button class="chip" data-category="other">Other</button>
      </div>

      <div id="sportFilterRow" class="sport-row" style="display:none; margin-top:0.6rem;" aria-label="Filter sports"></div>

      <div id="newsList" style="margin-top:0.9rem;">Loading…</div>
    </section>
  </div>

<script>
  /* ---------- Globals & helpers ---------- */
  const newsList = document.getElementById("newsList");
  const toggleMarket = document.getElementById("toggleMarket");
  const toggleMates = document.getElementById("toggleMates");
  const categoryRow = document.getElementById("categoryRow");
  const feedStatus = document.getElementById("feedStatus");
  const sportFilterRow = document.getElementById("sportFilterRow");

  const openBriefBtn = document.getElementById("openBrief");
  const briefContent = document.getElementById("briefContent");
  const refreshBriefBtn = document.getElementById("refreshBrief");
  const briefRegionSelect = document.getElementById("briefRegion");

  // new UI elements
  const articleSearch = document.getElementById("articleSearch");
  const symbolInput = document.getElementById("symbolInput");
  const applySymbolsBtn = document.getElementById("applySymbols");
  const clearFiltersBtn = document.getElementById("clearFilters");

  let allArticles = [];        // raw articles returned from backend
  let displayedArticles = [];  // articles currently shown (after search/filter/category)
  let currentCategory = "all";
  const selectedSports = new Set();
  let briefLoadedFor = null; // tracks which region the brief was loaded for
  let lastSymbols = "";      // currently-applied symbols (to persist across toggles)

  function escapeHtml(str = "") {
    return String(str)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  function formatTime(iso) {
    try {
      const d = new Date(iso);
      if (isNaN(d)) return "";
      return new Intl.DateTimeFormat(undefined, { dateStyle:'short', timeStyle:'short' }).format(d);
    } catch { return iso || ""; }
  }

  /* ---------- Mates Morning Note & Stock of the Day loaders (unchanged) ---------- */
  async function loadMatesMorningNote() {
    const container = document.getElementById("matesMorningNote");
    const textBox = document.getElementById("matesNoteText");
    const timeBox = document.getElementById("matesNoteTimestamp");

    if (!container || !textBox || !timeBox) return;

    try {
      const res = await fetch("/.netlify/functions/matesMorningNote");
      const data = await res.json();

      const note = data.note || "No update available.";
      textBox.textContent = note;

      const now = new Date();
      timeBox.textContent =
        "Updated " + now.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});

      container.style.display = "block";
    } catch (err) {
      console.error("Failed to load Morning Note", err);
      if (textBox) textBox.textContent = "Unable to load today’s note.";
      if (container) container.style.display = "block";
    }
  }

  async function loadStockOfTheDay() {
    const container = document.getElementById("stockOfDay");
    if (!container) return;

    const tickerEl = document.getElementById("sotdTicker");
    const nameEl = document.getElementById("sotdName");
    const exchEl = document.getElementById("sotdExchange");
    const summaryEl = document.getElementById("sotdSummary");

    if (!tickerEl || !nameEl || !exchEl || !summaryEl) return;

    try {
      const res = await fetch("/.netlify/functions/stockOfTheDay");
      const data = await res.json();

      tickerEl.textContent = data.ticker || "—";
      nameEl.textContent = data.name || "";
      exchEl.textContent = (data.exchange || "ASX").toUpperCase();
      summaryEl.textContent = data.summary || "No snapshot available today.";

      container.style.display = "block";
    } catch (err) {
      console.error("loadStockOfTheDay failed", err);
      summaryEl.textContent = "Unable to load today’s Stock of the Day.";
      container.style.display = "block"; // still show the card with message
    }
  }

  /* ---------- Feeds (with optional symbol passthrough) ---------- */
  // Accept options: { symbols: 'BHP,CBA', region: 'au' }
  async function getMarketFeed(options = {}) {
    try {
      const qs = new URLSearchParams();
      // region param kept for compatibility; newsFeed will map region -> countries
      if (options.region) qs.set('region', options.region);
      // forward symbols if present
      if (options.symbols) qs.set('symbols', options.symbols);
      // request a larger page to support client-side search
      qs.set('per_page', '50');
      const url = '/.netlify/functions/newsFeed' + (qs.toString() ? `?${qs.toString()}` : '');
      const res = await fetch(url);
      const data = await res.json();
      return data.articles || [];
    } catch (e) {
      console.warn("Market feed failed", e);
      return [];
    }
  }

  async function getSportsFeed() {
    try {
      const res = await fetch("/.netlify/functions/sports-test");
      return await res.json();
    } catch (e) {
      console.warn("Sports feed failed", e);
      return [];
    }
  }

  function showSkeleton(count = 4) {
    newsList.innerHTML = "";
    for (let i=0;i<count;i++){
      const div = document.createElement("div");
      div.className = "headline";
      div.innerHTML = `<div style="display:flex;align-items:center;gap:0.75rem">
        <div style="flex:1">
          <div class="skeleton" style="height:14px;width:60%"></div>
          <div style="height:8px"></div>
          <div class="skeleton" style="height:12px;width:30%"></div>
        </div>
      </div>`;
      newsList.appendChild(div);
    }
  }

  /* ---------- Mates/OpenAI summary helper ---------- */
  async function callMatesSummary(payload) {
    const res = await fetch("/.netlify/functions/matesSummary", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload),
    });
    if (!res.ok) throw new Error("Summary request failed");
    return res.json();
  }

  /* ---------- Category detection ---------- */
  function categoryFromArticle(article) {
    const title = (article.title || "").toLowerCase();
    if (title.match(/energy|oil|coal|gas|mining/)) return "energy";
    if (title.match(/tech|software|ai|chip|cloud/)) return "tech";
    if (title.match(/inflation|rate|central bank|macro/)) return "macro";
    return "other";
  }

  /* ---------- Search & filtering helpers ---------- */

  // Filter articles by category and search query (client-side)
  function filterArticles({ articles, category = 'all', search = '' }) {
    const q = (search || '').trim().toLowerCase();
    return articles.filter(a => {
      if (!a) return false;
      // category filter
      if (category && category !== 'all') {
        const cat = categoryFromArticle(a);
        if (cat !== category) return false;
      }
      // search filter (title, description, source)
      if (!q) return true;
      const hay = `${a.title || ''} ${a.description || ''} ${a.source || ''}`.toLowerCase();
      return hay.indexOf(q) !== -1;
    });
  }

  // After articles are loaded into allArticles, call this to apply current UI filters
  function applySearchAndRender() {
    const q = articleSearch.value || '';
    const filtered = filterArticles({ articles: allArticles, category: currentCategory, search: q });
    displayedArticles = filtered;
    if (toggleMates.classList.contains('active')) {
      renderMatesModeFromArray(displayedArticles);
    } else {
      renderMarketModeFromArray(displayedArticles);
    }
  }

  /* ---------- Rendering helpers that accept arrays (used after filtering) ---------- */

  function renderMarketModeFromArray(arr) {
    sportFilterRow.style.display = "none";
    newsList.innerHTML = "";

    if (!arr || !arr.length) {
      newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">No market headlines yet.</small></div>`;
      return;
    }

    arr.forEach((a, idx) => {
      const item = document.createElement("div");
      item.className = "headline";

      const published = formatTime(a.publishedAt || a.published || "");

      item.innerHTML = `
        <div class="meta-row">
          <div class="meta-left">
            <div style="min-width:0">
              <h3 title="${escapeHtml(a.title || '')}">${escapeHtml(a.title || '')}</h3>
              <small>${escapeHtml(a.source || "")} · ${escapeHtml(published)}</small>
            </div>
          </div>
          <div style="display:flex;gap:0.5rem;align-items:center">
            <a class="link-min" href="${a.url || "#"}" target="_blank" rel="noopener">Read original</a>
          </div>
        </div>

        <div class="actions">
          <button class="btn" aria-label="Generate summary for article">MatesInvest summary</button>
        </div>
        <div class="summary-output"></div>
      `;

      const btn = item.querySelector("button");
      const output = item.querySelector(".summary-output");
      let busy = false;

      btn.addEventListener("click", async () => {
        if (busy) return;
        busy = true;
        btn.disabled = true;
        const origText = btn.textContent;
        btn.textContent = "Summarising…";

        try {
          const summary = await callMatesSummary({
            text: `${a.title}\n\n${a.description || ""}`,
            sourceType: "news_article",
            headline: a.title,
          });

          output.innerHTML = renderSummary(summary);
        } catch (err) {
          console.error(err);
          output.textContent = "Summary failed.";
        } finally {
          btn.disabled = false;
          btn.textContent = origText;
          busy = false;
        }
      });

      newsList.appendChild(item);
    });
  }

  // Mates mode renderer for an already-filtered array (arr contains both market and sport items)
  function renderMatesModeFromArray(arr) {
    // For simplicity, in this version arr contains only market articles (we fetch sports separately)
    // We'll render market-type articles similarly
    newsList.innerHTML = "";

    if (!arr || !arr.length) {
      newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">No items found.</small></div>`;
      return;
    }

    arr.forEach((a, idx) => {
      const div = document.createElement("div");
      div.className = "headline";

      const when = formatTime(a.publishedAt || a.published || new Date().toISOString());
      div.innerHTML = `
        <div class="meta-row">
          <div class="meta-left">
            <div style="min-width:0">
              <h3>${escapeHtml(a.title || "")}</h3>
              <small>${escapeHtml(a.source || "")} · ${escapeHtml(when)}</small>
            </div>
          </div>
          <div style="display:flex;gap:0.5rem;align-items:center">
            <a class="link-min" href="${a.url || "#"}" target="_blank" rel="noopener">Read original</a>
          </div>
        </div>

        <div class="actions">
          <button class="btn">MatesInvest summary</button>
        </div>
        <div class="summary-output"></div>
      `;

      const btn = div.querySelector("button.btn");
      const output = div.querySelector(".summary-output");
      let busy = false;

      btn.onclick = async () => {
        if (busy) return;
        busy = true;
        btn.disabled = true;
        const prev = btn.textContent;
        btn.textContent = "Summarising…";

        try {
          const summary = await callMatesSummary({
            text: `${a.title}\n\n${a.description || ""}`,
            sourceType: "news_article",
            headline: a.title,
          });

          output.innerHTML = renderSummary(summary);
        } catch (err) {
          console.error(err);
          output.textContent = "Summary failed.";
        } finally {
          btn.disabled = false;
          btn.textContent = prev;
          busy = false;
        }
      };

      newsList.appendChild(div);
    });
  }

  /* ---------- Original render functions kept for other flows (market or mates fetches) ---------- */
  async function renderMarketMode() {
    // If we have already fetched allArticles, simply apply search and render
    applySearchAndRender();
  }

  async function renderMatesMode() {
    // For now, behave same as market mode but keep the skeleton behavior
    showSkeleton(5);
    try {
      // fetch market feed (including symbols if set)
      const region = briefRegionSelect.value || 'au';
      const market = await getMarketFeed({ symbols: lastSymbols, region });
      // also fetch sports feed for combined view
      const sports = await getSportsFeed() || [];

      // convert sports into the unified format used earlier (if needed)
      const sportSet = new Set();
      (sports || []).forEach(ev => {
        const s = (ev.sport || ev.league || "").toString().trim();
        if (s) {
          const key = ev.sport ? ev.sport.toString().trim() : (ev.league || "").toString().trim();
          const label = key.split(" ").map(w => w && (w[0].toUpperCase() + w.slice(1).toLowerCase())).join(" ");
          sportSet.add(label);
        }
      });
      renderSportFilters(Array.from(sportSet));

      // Use the fetched market articles as the base dataset for search/filter
      allArticles = market;
      applySearchAndRender();
    } catch (err) {
      console.error("Error rendering MatesMode", err);
      newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">Failed to load feed.</small></div>`;
    }
  }

  /* ---------- RICH STATS HELPERS (unchanged) ---------- */
  async function fetchEventDetails(eventId) {
    const res = await fetch(`/.netlify/functions/event-details?id=${encodeURIComponent(eventId)}`);
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`Event details request failed: ${res.status} ${txt}`);
    }
    return res.json();
  }

  function parseGoalDetails(raw) {
    if (!raw || !raw.trim()) return [];
    const parts = raw.split(/;|\n/).map(p => p.trim()).filter(Boolean);
    const events = parts.map(p => {
      const m = p.match(/^(\d+\+?\d*)'?[\s-–:]?\s*(.+)$/);
      if (m) {
        return { minute: m[1] + "'", text: m[2] };
      }
      return { minute: '', text: p };
    });
    return events;
  }

  function renderLineupSection(title, lineupStr) {
    if (!lineupStr || !lineupStr.trim()) return '';
    const players = lineupStr.split(/, ?/).map(s => s.trim()).filter(Boolean);
    return `<div class="lineup-block" role="group" aria-label="${escapeHtml(title)}">
      <strong style="color:var(--muted)">${escapeHtml(title)}</strong>
      <div style="margin-top:0.35rem">${players.map(p => `<div>${escapeHtml(p)}</div>`).join('')}</div>
    </div>`;
  }

  function renderBoxScoreAndPlayers(ev) {
    if (!ev) return `<div style="color:var(--muted)">No stats available.</div>`;
    // Shortened for brevity in this file — original rendering remains the same if you need the full implementation
    return `<div class="summary-block" style="color:var(--muted)">Stats unavailable.</div>`;
  }

  async function attachStatsHandler(statsBtn, statsArea, ev) {
    statsBtn.onclick = async () => {
      try {
        if (statsArea.style.display === 'block' && statsArea.innerHTML.trim()) {
          statsArea.style.display = "none";
          statsBtn.textContent = 'Stats';
          return;
        }

        statsBtn.disabled = true;
        const prev = statsBtn.textContent;
        statsBtn.textContent = 'Loading…';

        const eventId = (ev && (ev.idEvent || ev.id || ev.eventId)) || (ev.raw && (ev.raw.idEvent || ev.raw.id));
        if (!eventId) throw new Error('Event id not available.');

        const details = await fetchEventDetails(eventId);
        statsArea.innerHTML = renderBoxScoreAndPlayers(details);
        statsArea.style.display = 'block';
        statsBtn.textContent = 'Hide';
      } catch (err) {
        console.error('Stats load failed', err);
        statsArea.innerHTML = `<div style="color:var(--muted)">Failed to load stats.</div>`;
        statsArea.style.display = 'block';
      } finally {
        statsBtn.disabled = false;
      }
    };
  }

  /* ---------- Morning brief renderer (unchanged) ---------- */
  function formatMoney(n) {
    try {
      if (n === null || typeof n === 'undefined') return null;
      return Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    } catch { return String(n); }
  }

  function relativeTime(iso) {
    try {
      const date = new Date(iso);
      const now = new Date();
      const diffMs = now - date;
      const diffMin = Math.round(diffMs / 60000);
      if (Math.abs(diffMin) < 1) return 'just now';
      if (Math.abs(diffMin) < 60) return `${diffMin}m`;
      const diffHours = Math.round(diffMin / 60);
      if (Math.abs(diffHours) < 24) return `${diffHours}h`;
      const diffDays = Math.round(diffHours / 24);
      return `${diffDays}d`;
    } catch { return iso || ''; }
  }

  function renderSportFilters(sportLabels = []) {
    sportFilterRow.innerHTML = "";
    if (!sportLabels || !sportLabels.length) {
      sportFilterRow.style.display = "none";
      return;
    }
    sportFilterRow.style.display = "flex";

    const allBtn = document.createElement("button");
    allBtn.className = "sport-chip" + (selectedSports.size === 0 ? " active" : "");
    allBtn.textContent = "All sports";
    allBtn.dataset.sport = "all";
    allBtn.onclick = () => {
      selectedSports.clear();
      [...sportFilterRow.children].forEach(c => c.classList.remove("active"));
      allBtn.classList.add("active");
      applySearchAndRender();
    };
    sportFilterRow.appendChild(allBtn);

    sportLabels.forEach(label => {
      const btn = document.createElement("button");
      btn.className = "sport-chip" + (selectedSports.has(label.toLowerCase()) ? " active" : "");
      btn.textContent = label;
      btn.dataset.sport = label.toLowerCase();
      btn.title = `Toggle ${label}`;
      btn.onclick = () => {
        const allChip = sportFilterRow.querySelector('button[data-sport="all"]');
        if (allChip) allChip.classList.remove("active");

        const key = label.toLowerCase();
        if (selectedSports.has(key)) {
          selectedSports.delete(key);
          btn.classList.remove("active");
          if (selectedSports.size === 0) {
            if (allChip) allChip.classList.add("active");
          }
        } else {
          selectedSports.add(key);
          btn.classList.add("active");
        }
        applySearchAndRender();
      };
      sportFilterRow.appendChild(btn);
    });
  }

  /* ---------- Open / refresh brief handlers (unchanged) ---------- */
  openBriefBtn.addEventListener("click", async () => {
    const region = briefRegionSelect.value || "au";
    if (briefContent.style.display === "block") {
      briefContent.style.display = "none";
      openBriefBtn.textContent = "Open morning brief";
      return;
    }

    briefContent.style.display = "block";
    openBriefBtn.textContent = "Hide brief";

    briefContent.innerHTML = `<div class="brief-loading">Loading briefing…</div>`;
    try {
      const res = await fetch(`/.netlify/functions/morning-brief?region=${encodeURIComponent(region)}`);
      if (!res.ok) {
        const t = await res.text();
        throw new Error(t || 'Brief fetch failed');
      }
      const payload = await res.json();
      renderMorningBrief(payload);

      // Now load the Mates Morning Note and Stock of the Day into the placeholders we injected
      loadMatesMorningNote();
      loadStockOfTheDay();

    } catch (err) {
      console.error('Morning brief failed', err);
      briefContent.innerHTML = `<div class="brief-loading">Failed to load morning brief.</div>`;
    }
  });

  refreshBriefBtn.addEventListener("click", async () => {
    if (briefContent.style.display !== "block") {
      openBriefBtn.click();
      return;
    }
    try {
      briefContent.innerHTML = `<div class="brief-loading">Refreshing briefing…</div>`;
      const region = briefRegionSelect.value || "au";
      const res = await fetch(`/.netlify/functions/morning-brief?region=${encodeURIComponent(region)}`);
      if (!res.ok) throw new Error('Refresh failed');
      const payload = await res.json();
      renderMorningBrief(payload);

      // refresh the two extra cards as well
      loadMatesMorningNote();
      loadStockOfTheDay();

    } catch (err) {
      console.error('Refresh failed', err);
      briefContent.innerHTML = `<div class="brief-loading">Failed to refresh morning brief.</div>`;
    }
  });

  /* ---------- Search & symbols UI handlers ---------- */

  // Filter in real-time as user types
  articleSearch.addEventListener('input', () => {
    applySearchAndRender();
  });

  // Enter key on search triggers apply (same effect as input)
  articleSearch.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      applySearchAndRender();
    }
  });

  // Apply symbols: fetch new feed using symbols and current region
  applySymbolsBtn.addEventListener('click', async () => {
    const symbols = (symbolInput.value || '').trim();
    lastSymbols = symbols;
    feedStatus.textContent = 'Loading…';
    showSkeleton(4);
    try {
      const region = briefRegionSelect.value || 'au';
      allArticles = await getMarketFeed({ symbols: symbols, region });
      feedStatus.textContent = 'Live';
      // after fetching new articles, apply search & render
      applySearchAndRender();
    } catch (err) {
      console.error('Apply symbols failed', err);
      feedStatus.textContent = 'Offline';
    }
  });

  // Clear search & symbols
  clearFiltersBtn.addEventListener('click', async () => {
    articleSearch.value = '';
    symbolInput.value = '';
    lastSymbols = '';
    feedStatus.textContent = 'Loading…';
    showSkeleton(4);
    try {
      const region = briefRegionSelect.value || 'au';
      allArticles = await getMarketFeed({ region });
      feedStatus.textContent = 'Live';
      applySearchAndRender();
    } catch (err) {
      console.error('Clear filters failed', err);
      feedStatus.textContent = 'Offline';
    }
  });

  /* ---------- Toggles & category handling (unchanged) ---------- */

  function setActiveToggle(isMarket) {
    if (isMarket) {
      toggleMarket.classList.add("active");
      toggleMarket.setAttribute("aria-selected","true");
      toggleMates.classList.remove("active");
      toggleMates.setAttribute("aria-selected","false");
    } else {
      toggleMates.classList.add("active");
      toggleMates.setAttribute("aria-selected","true");
      toggleMarket.classList.remove("active");
      toggleMarket.setAttribute("aria-selected","false");
    }
  }

  toggleMarket.onclick = async () => {
    setActiveToggle(true);
    feedStatus.textContent = "Market mode";
    showSkeleton(4);
    // fetch with currently applied symbols and region
    const region = briefRegionSelect.value || 'au';
    allArticles = await getMarketFeed({ symbols: lastSymbols, region });
    renderMarketMode();
  };

  toggleMates.onclick = () => {
    setActiveToggle(false);
    feedStatus.textContent = "MatesMode";
    renderMatesMode();
  };

  categoryRow.onclick = (e) => {
    const btn = e.target.closest(".chip");
    if (!btn) return;
    currentCategory = btn.dataset.category;

    [...categoryRow.children].forEach(b => b.classList.remove("chip-active"));
    btn.classList.add("chip-active");

    // re-apply filters to current dataset
    applySearchAndRender();
  };

  /* ---------- Initial load ---------- */
  (async function init() {
    try {
      feedStatus.textContent = "Loading…";
      showSkeleton(4);
      const region = briefRegionSelect.value || 'au';
      // initial fetch respects region and no symbols
      allArticles = await getMarketFeed({ region });
      renderMarketMode();
      feedStatus.textContent = "Live";

      // Note: Mates Morning Note and Stock of the Day are loaded when the morning brief is opened.
    } catch (err) {
      console.error(err);
      newsList.innerHTML = `<div class="headline"><small style="color:var(--muted)">Failed to load initial feed.</small></div>`;
      feedStatus.textContent = "Offline";
    }
  })();
</script>

</body>
</html>