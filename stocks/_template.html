<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>{{CODE}} – MatesInvest ASX snapshot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --navy: #002040;
        --cyan: #00bfff;
        --bg: #f5f7fb;
        --card: #ffffff;
        --muted: #64748b;
        --muted-2: #94a3b8;
        --accent: var(--cyan);
        --accent-strong: #0093cc;
        --accent-soft: rgba(0, 191, 255, 0.1);
        --border: #e2e8f0;
        --card-border: #e2e8f0;
        --glass: rgba(255, 255, 255, 0.96);
        --radius: 18px;
        --gap: 1rem;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        max-width: 100%;
        overflow-x: hidden;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #dbeafe 0, #f5f7fb 55%);
        color: var(--navy);
      }

      .page {
        max-width: 1100px;
        margin: 0 auto;
        padding: 1.5rem 1.25rem 2.5rem;
      }

      /* ---------- TOP NAV ---------- */

      .top-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
      }

      .nav-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-logo {
        display: flex;
        align-items: center;
        gap: 0.45rem;
        text-decoration: none;
        color: inherit;
      }

      .nav-logo-img {
        height: 32px;
        width: auto;
        display: block;
      }

      .nav-logo-text {
        font-weight: 700;
        letter-spacing: -0.02em;
        font-size: 1rem;
      }

      .nav-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .nav-link {
        font-size: 0.85rem;
        text-decoration: none;
        color: var(--navy);
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
        border: 1px solid transparent;
      }

      .nav-link:hover {
        background: rgba(15, 23, 42, 0.02);
      }

      .nav-pill {
        font-size: 0.85rem;
        text-decoration: none;
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        background: var(--accent);
        color: #001220;
        font-weight: 600;
        border: 1px solid transparent;
        box-shadow: 0 7px 16px rgba(15, 23, 42, 0.18);
      }

      .nav-pill:hover {
        background: var(--accent-strong);
      }

      /* ---------- PAGE LAYOUT ---------- */

      .instrument-page {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
      }

      .instrument-hero {
        background: var(--glass);
        border-radius: var(--radius);
        border: 1px solid var(--card-border);
        padding: 1.1rem 1.1rem 1.1rem;
        box-shadow: 0 16px 32px rgba(15, 23, 42, 0.14);
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 1.2rem;
      }

      .hero-left {
        flex: 2 1 280px;
        min-width: 0;
      }

      .hero-title-row {
        display: flex;
        align-items: baseline;
        flex-wrap: wrap;
        gap: 0.35rem 0.6rem;
        margin-bottom: 0.4rem;
      }

      .hero-name {
        font-size: 1.4rem;
        font-weight: 600;
        letter-spacing: -0.02em;
      }

      .hero-code-pill {
        padding: 0.1rem 0.55rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 0.75rem;
        font-weight: 600;
        background: #f8fafc;
      }

      .hero-subline {
        font-size: 0.85rem;
        color: var(--muted);
        margin-bottom: 0.6rem;
      }

      .hero-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
      }

      .tag-pill {
        font-size: 0.7rem;
        padding: 0.2rem 0.55rem;
        border-radius: 999px;
        background: #e0f2fe;
        color: #0b1220;
        border: 1px solid #bae6fd;
      }

      .hero-right {
        flex: 1.2 1 220px;
        min-width: 0;
        text-align: right;
      }

      .hero-price {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0.15rem;
      }

      .hero-change {
        font-size: 0.85rem;
        margin-bottom: 0.2rem;
      }

      .hero-change.up {
        color: #16a34a;
      }

      .hero-change.down {
        color: #dc2626;
      }

      .hero-date {
        font-size: 0.75rem;
        color: var(--muted-2);
      }

      .hero-links {
        margin-top: 0.6rem;
        display: flex;
        justify-content: flex-end;
        gap: 0.4rem;
        flex-wrap: wrap;
      }

      .hero-link-btn {
        font-size: 0.8rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #f8fafc;
        color: #0b1220;
        text-decoration: none;
      }

      .hero-link-btn.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: #001220;
        font-weight: 600;
        box-shadow: 0 7px 16px rgba(15, 23, 42, 0.16);
      }

      /* ---------- MAIN GRID ---------- */

      .instrument-main {
        display: grid;
        grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
        gap: 1.1rem;
        align-items: flex-start;
      }

      @media (max-width: 840px) {
        .instrument-main {
          grid-template-columns: minmax(0, 1fr);
        }
        .hero-right {
          text-align: left;
        }
        .hero-links {
          justify-content: flex-start;
        }
      }

      .card {
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--card-border);
        box-shadow: 0 10px 22px rgba(15, 23, 42, 0.09);
        padding: 0.9rem 1rem 1rem;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.4rem;
        margin-bottom: 0.4rem;
      }

      .card-title {
        font-size: 0.9rem;
        font-weight: 600;
      }

      .card-subtitle {
        font-size: 0.78rem;
        color: var(--muted);
      }

      /* ---------- FUNDAMENTALS GRID ---------- */

.fundamentals-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.6rem 0.8rem;
}

@media (max-width: 500px) {
  .fundamentals-grid {
    grid-template-columns: 1fr 1fr; /* still 2 columns even on mobile */
  }
}

.fundamentals-item {
  padding: 0.35rem 0.6rem;
  border-radius: 12px;
  background: #f1f5f9;
  border: 1px solid #e2e8f0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  min-height: 64px; /* tighter, uniform height */
}

.fund-label {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  color: #64748b;
  margin-bottom: 0.15rem;
}

.fund-value {
  font-size: 0.92rem;
  font-weight: 600;
  color: #0f172a;
}


      /* ---------- CHART ---------- */

      .chart-container {
        margin-top: 0.4rem;
        background: #020617;
        border-radius: 0.9rem;
        padding: 0.5rem 0.65rem 0.6rem;
        border: 1px solid #1e293b;
        color: #e5e7eb;
      }

      .chart-caption {
        font-size: 0.75rem;
        color: #9ca3af;
        margin-bottom: 0.2rem;
      }

      #mi-ins-chart {
        width: 100%;
        height: 220px;
        display: block;
      }

      /* ---------- SNAPSHOT + NEWS ---------- */

      .snapshot-text {
        font-size: 0.85rem;
        color: var(--muted);
        line-height: 1.5;
        margin-top: 0.3rem;
      }

      .snapshot-placeholder {
        color: var(--muted-2);
      }

      .news-list {
        display: flex;
        flex-direction: column;
        gap: 0.55rem;
        margin-top: 0.4rem;
        font-size: 0.82rem;
      }

      .news-item {
        padding: 0.5rem 0.55rem;
        border-radius: 0.7rem;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
      }

      .news-title {
        font-weight: 500;
        margin-bottom: 0.2rem;
      }

      .news-meta {
        font-size: 0.75rem;
        color: var(--muted-2);
        margin-bottom: 0.15rem;
      }

      .news-item a {
        font-size: 0.78rem;
        text-decoration: none;
        color: #0369a1;
      }

      .news-item a:hover {
        text-decoration: underline;
      }

      .empty-state {
        font-size: 0.8rem;
        color: var(--muted-2);
        margin-top: 0.35rem;
      }

      /* Small tweaks on short-height / landscape devices */
      @media screen and (max-height: 500px),
        screen and (orientation: landscape) and (max-width: 1024px) {
        .page {
          padding-inline: 0.85rem;
        }
        .instrument-hero {
          padding: 0.85rem 0.85rem 0.9rem;
        }
        .instrument-main {
          gap: 0.85rem;
        }
      }
    </style>
  </head>
  <body data-code="{{CODE}}">
    <div class="page">
      <nav class="top-nav">
        <div class="nav-left">
          <a href="/" class="nav-logo">
            <img
              src="/assets/img/logo-placeholder.png"
              alt="MatesInvest"
              class="nav-logo-img"
            />
            <div class="nav-logo-text">MatesInvest</div>
          </a>
        </div>
        <div class="nav-right">
          <a href="/" class="nav-link">Home</a>
          <a href="/mates-summaries.html" class="nav-link">ASX Daily Brief</a>
          <a href="/equity-screener.html" class="nav-pill">ASX Explorer</a>
        </div>
      </nav>

      <main class="instrument-page">
        <!-- HERO -->
        <section class="instrument-hero" id="hero">
          <div class="hero-left">
            <div class="hero-title-row">
              <h1 class="hero-name" id="hero-name">Loading…</h1>
              <span class="hero-code-pill" id="hero-code">{{CODE}}</span>
            </div>
            <div class="hero-subline" id="hero-subline">
              ASX equity snapshot.
            </div>
            <div class="hero-tags" id="hero-tags"></div>
          </div>
          <div class="hero-right">
            <div class="hero-price" id="hero-price">—</div>
            <div class="hero-change" id="hero-change">Change: —</div>
            <div class="hero-date" id="hero-date"></div>

            <div class="hero-links">
              <a
                href="/equity-screener.html"
                class="hero-link-btn"
              >
                View in screener
              </a>
              <a
                href="/mates-summaries.html"
                class="hero-link-btn primary"
              >
                Back to daily brief
              </a>
            </div>
          </div>
        </section>

        <!-- MAIN GRID -->
        <section class="instrument-main">
          <!-- LEFT: FUNDAMENTALS + CHART -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Key fundamentals</div>
                <div class="card-subtitle">
                  Same data as the ASX Explorer, simplified for one company.
                </div>
              </div>
            </div>

            <div id="fundamentals-grid" class="fundamentals-grid">
              <!-- Filled by JS -->
            </div>

            <div class="chart-container">
              <div class="chart-caption" id="chart-caption">
                Loading price history…
              </div>
              <canvas id="mi-ins-chart" width="640" height="220"></canvas>
            </div>
          </div>

          <!-- RIGHT: SNAPSHOT + NEWS -->
          <div class="card">
            <div class="card-header">
              <div>
                <div class="card-title">Plain-English snapshot</div>
                <div class="card-subtitle">
                  Quick context and latest headlines.
                </div>
              </div>
            </div>

            <div class="snapshot-text">
              <div id="snapshot-text" class="snapshot-placeholder">
                We’re loading a short AI summary for this company…
              </div>
            </div>

            <div class="card-header" style="margin-top:0.75rem;">
              <div class="card-title">Latest news</div>
            </div>

            <div id="news-list" class="news-list">
              <!-- Filled by JS -->
            </div>

            <div id="news-empty" class="empty-state" style="display:none;">
              No recent headlines found for this code.
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      const CODE =
        document.body.getAttribute("data-code")?.trim().toUpperCase() || "CODE";

      // ---------- API HELPERS (reuse from screener modal) ----------

      async function miFetchInstrumentDetails(type, code) {
        const url = `/.netlify/functions/instrument-details?type=${encodeURIComponent(
          type
        )}&code=${encodeURIComponent(code)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("instrument-details failed: " + res.status);
        return res.json();
      }

      async function miFetchAiSummary(type, code) {
        const url = `/.netlify/functions/instrument-ai-summary?type=${encodeURIComponent(
          type
        )}&code=${encodeURIComponent(code)}`;
        const res = await fetch(url);
        if (!res.ok)
          throw new Error("instrument-ai-summary failed: " + res.status);
        return res.json();
      }

      async function miFetchInstrumentNews(code) {
        const params = new URLSearchParams({
          symbols: `${code}.AX`,
          per_page: "8",
        });
        const res = await fetch(
          "/.netlify/functions/newsFeed?" + params.toString()
        );
        if (!res.ok) throw new Error("newsFeed failed: " + res.status);
        const data = await res.json();
        return data.articles || [];
      }

      async function fetchScreenerRow(code) {
        const res = await fetch("/.netlify/functions/equity-screener");
        if (!res.ok)
          throw new Error("equity-screener failed: " + res.status);
        const data = await res.json();
        const items = data.items || [];
        return items.find((i) => (i.code || "").toUpperCase() === code) || null;
      }

      // ---------- FORMATTERS (borrowed from screener) ----------

      function miFormatCurrency(n, currency = "AUD") {
        if (typeof n !== "number" || !isFinite(n)) return "—";
        try {
          return new Intl.NumberFormat("en-AU", {
            style: "currency",
            currency,
            maximumFractionDigits: 2,
          }).format(n);
        } catch {
          return n.toFixed(2);
        }
      }

      function miFormatCompactNumber(n) {
        if (typeof n !== "number" || !isFinite(n)) return "—";
        const abs = Math.abs(n);
        if (abs >= 1_000_000_000) return (n / 1_000_000_000).toFixed(1) + "B";
        if (abs >= 1_000_000) return (n / 1_000_000).toFixed(1) + "M";
        if (abs >= 1_000) return (n / 1_000).toFixed(1) + "k";
        return n.toFixed(0);
      }

      function formatNumber(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "—";
        return n.toLocaleString(undefined, { maximumFractionDigits: 2 });
      }

      function formatPercentFrac(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "—";
        const pct = Math.abs(n) <= 1 ? n * 100 : n;
        return pct.toFixed(2) + "%";
      }

      function miFormatPercent(n, digits = 2) {
        if (typeof n !== "number" || !isFinite(n)) return "—";
        return n.toFixed(digits) + "%";
      }

      function miFormatDate(dateStr) {
        if (!dateStr) return null;
        const d = new Date(dateStr);
        if (Number.isNaN(d.getTime())) return null;
        return d.toLocaleDateString("en-AU", {
          day: "2-digit",
          month: "short",
          year: "numeric",
        });
      }

      function toMillions(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "—";
        const m = n / 1_000_000;
        return m.toLocaleString(undefined, { maximumFractionDigits: 1 });
      }

      // ---------- CHART (same look as modal) ----------

      function miRenderChart(history) {
        const canvas = document.getElementById("mi-ins-chart");
        const caption = document.getElementById("chart-caption");
        if (!canvas || !history || !Array.isArray(history.points)) {
          if (caption) caption.textContent = "Price history not available.";
          return;
        }

        const ctx = canvas.getContext("2d");
        const pts = history.points
          .map((p) => p[1])
          .filter((x) => typeof x === "number");

        const w = canvas.width;
        const h = canvas.height;

        ctx.clearRect(0, 0, w, h);

        if (pts.length < 2) {
          ctx.fillStyle = "#9ca3af";
          ctx.font = "12px system-ui";
          ctx.fillText("No chart data available", 12, 20);
          if (caption) caption.textContent = "Price history not available.";
          return;
        }

        const min = Math.min(...pts);
        const max = Math.max(...pts);
        const padX = 20;
        const padY = 10;

        ctx.lineWidth = 2;
        ctx.strokeStyle = "#38bdf8";
        ctx.beginPath();

        pts.forEach((v, i) => {
          const x = padX + (i / (pts.length - 1)) * (w - padX * 2);
          const y = h - padY - ((v - min) / (max - min)) * (h - padY * 2);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });

        ctx.stroke();

        const gradient = ctx.createLinearGradient(0, padY, 0, h);
        gradient.addColorStop(0, "rgba(56,189,248,0.25)");
        gradient.addColorStop(1, "rgba(56,189,248,0.0)");

        ctx.lineTo(w - padX, h - padY);
        ctx.lineTo(padX, h - padY);
        ctx.closePath();
        ctx.fillStyle = gradient;
        ctx.fill();

        const start = miFormatDate(history.startDate);
        const end = miFormatDate(history.endDate);
        if (caption) {
          caption.textContent =
            start && end
              ? `Showing daily closes from ${start} to ${end}.`
              : "Showing last 6 months of daily closes.";
        }
      }

      // ---------- RENDERING ----------

      function renderHero(details) {
        const latest = details.latest || {};
        const f = details.fundamentals || {};

        const name = details.name || details.code || CODE;
        const sector = f.sector || "";
        const industry = f.industry || "";
        const sizeBucket = f.sizeBucket || null;

        const heroName = document.getElementById("hero-name");
        const heroCode = document.getElementById("hero-code");
        const heroSubline = document.getElementById("hero-subline");
        const heroTags = document.getElementById("hero-tags");
        const heroPrice = document.getElementById("hero-price");
        const heroChange = document.getElementById("hero-change");
        const heroDate = document.getElementById("hero-date");

        if (heroName) heroName.textContent = name;
        if (heroCode) heroCode.textContent = CODE;
        if (heroSubline)
          heroSubline.textContent = "ASX listed • live snapshot from MatesInvest";

        if (heroTags) {
          heroTags.innerHTML = "";
          const tags = [];
          if (sizeBucket) {
            const label =
              sizeBucket === "mega"
                ? "Mega cap"
                : sizeBucket === "large"
                ? "Large cap"
                : sizeBucket === "mid"
                ? "Mid cap"
                : sizeBucket === "small"
                ? "Small cap"
                : null;
            if (label) tags.push(label);
          }
          if (sector) tags.push(sector);
          if (industry) tags.push(industry);
          tags.forEach((t) => {
            const span = document.createElement("span");
            span.className = "tag-pill";
            span.textContent = t;
            heroTags.appendChild(span);
          });
        }

        const priceNum =
          typeof latest.price === "number" && isFinite(latest.price)
            ? latest.price
            : null;
        const pctChange =
          typeof latest.pctChange === "number" && isFinite(latest.pctChange)
            ? latest.pctChange
            : null;

        if (heroPrice) {
          heroPrice.textContent =
            priceNum !== null
              ? miFormatCurrency(priceNum, f.currency || "AUD")
              : "—";
        }

        if (heroChange) {
          heroChange.classList.remove("up", "down");
          if (pctChange === null) {
            heroChange.textContent = "Change: —";
          } else {
            const arrow = pctChange > 0 ? "▲" : pctChange < 0 ? "▼" : "•";
            heroChange.textContent = `${arrow} ${pctChange.toFixed(
              2
            )}% yesterday`;
            if (pctChange > 0) heroChange.classList.add("up");
            else if (pctChange < 0) heroChange.classList.add("down");
          }
        }

        if (heroDate) {
          const d = miFormatDate(latest.date);
          heroDate.textContent = d ? `as at ${d}` : "";
        }
      }

      function renderFundamentals(row) {
        const grid = document.getElementById("fundamentals-grid");
        if (!grid) return;

        if (!row) {
          grid.innerHTML =
            '<div class="empty-state">Couldn’t find fundamentals for this code in the screener.</div>';
          return;
        }

        const bits = [];

        bits.push({
          label: "Market cap (A$m)",
          value: toMillions(row.marketCap),
        });
        bits.push({
          label: "Price (yesterday)",
          value: formatNumber(row.price),
        });
        bits.push({ label: "P/E", value: formatNumber(row.peRatio) });
        bits.push({
          label: "Div. yield",
          value: formatPercentFrac(row.dividendYield),
        });
        bits.push({ label: "EPS", value: formatNumber(row.eps) });
        bits.push({
          label: "Profit margin",
          value: formatPercentFrac(row.profitMargin),
        });
        bits.push({
          label: "Operating margin",
          value: formatPercentFrac(row.operatingMargin),
        });
        bits.push({
          label: "ROE",
          value: formatPercentFrac(row.returnOnEquity),
        });
        bits.push({
          label: "Revenue (A$m)",
          value: toMillions(row.revenue),
        });
        bits.push({
          label: "Gross profit (A$m)",
          value: toMillions(row.grossProfit),
        });
        bits.push({
          label: "EV (A$m)",
          value: toMillions(row.enterpriseValue),
        });
        bits.push({
          label: "EV / revenue",
          value: formatNumber(row.evToRevenue),
        });

        grid.innerHTML = bits
          .map(
            (b) => `
          <div class="fundamentals-item">
            <div class="fund-label">${b.label}</div>
            <div class="fund-value">${b.value}</div>
          </div>
        `
          )
          .join("");
      }

      function renderSnapshot(ai) {
        const el = document.getElementById("snapshot-text");
        if (!el) return;
        if (ai && ai.summary) {
          el.textContent = ai.summary;
        } else {
          el.textContent =
            "We couldn’t generate a summary right now, but you can still use the numbers and chart on this page for quick context.";
        }
      }

      function renderNews(articles) {
        const list = document.getElementById("news-list");
        const empty = document.getElementById("news-empty");
        if (!list || !empty) return;

        if (!articles.length) {
          list.innerHTML = "";
          empty.style.display = "block";
          return;
        }

        empty.style.display = "none";

        list.innerHTML = articles
          .map((a) => {
            const when = a.publishedAt || a.published || "";
            const d = miFormatDate(when) || "";
            const source = a.source || "";
            const title = a.title || "";
            const url = a.url || "#";
            return `
              <article class="news-item">
                <div class="news-title">${title}</div>
                <div class="news-meta">
                  ${source}${d ? " • " + d : ""}
                </div>
                ${
                  url && url !== "#"
                    ? `<a href="${url}" target="_blank" rel="noopener">Read original →</a>`
                    : ""
                }
              </article>
            `;
          })
          .join("");
      }

      // ---------- PAGE INIT ----------

      (async function init() {
        try {
          const [details, screenerRow] = await Promise.all([
            miFetchInstrumentDetails("equity", CODE),
            fetchScreenerRow(CODE),
          ]);

          renderHero(details);
          renderFundamentals(screenerRow);
          miRenderChart(details.history);

          // AI summary
          miFetchAiSummary("equity", CODE)
            .then(renderSnapshot)
            .catch(() => renderSnapshot(null));

          // News
          miFetchInstrumentNews(CODE)
            .then(renderNews)
            .catch(() => renderNews([]));
        } catch (err) {
          console.error("Instrument page error", err);
          const heroName = document.getElementById("hero-name");
          if (heroName)
            heroName.textContent = `Problem loading data for ${CODE}`;
        }
      })();
    </script>
  </body>
</html>
