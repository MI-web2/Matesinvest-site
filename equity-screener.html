<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MatesInvest – ASX Screener</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --navy: #002040;
        --cyan: #00bfff;
        --bg: #f5f7fb;
        --card: #ffffff;
        --muted: #64748b;
        --border: #e2e8f0;
        --radius: 16px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--navy);
      }

      .page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1.5rem;
      }

      header {
        margin-bottom: 1.5rem;
      }

      h1 {
        margin: 0 0 0.5rem;
        font-size: 1.8rem;
      }

      .muted {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
        margin-bottom: 1rem;
        background: var(--card);
        padding: 0.75rem;
        border-radius: var(--radius);
        border: 1px solid var(--border);
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .filter-label {
        font-size: 0.8rem;
        color: var(--muted);
      }

      input,
      select {
        font: inherit;
        padding: 0.35rem 0.45rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        outline: none;
      }

      input:focus,
      select:focus {
        border-color: var(--cyan);
      }

      .table-wrapper {
        background: var(--card);
        border-radius: var(--radius);
        border: 1px solid var(--border);
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      thead {
        background: #f1f5f9;
      }

      th,
      td {
        padding: 0.55rem 0.75rem;
        text-align: right;
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
      }

      th:first-child,
      td:first-child {
        text-align: left;
      }

      th:nth-child(2),
      td:nth-child(2) {
        text-align: left;
      }

      th.sortable {
        cursor: pointer;
        user-select: none;
      }

      th.sortable span {
        margin-left: 0.25rem;
        font-size: 0.7rem;
        opacity: 0.7;
      }

      tbody tr:nth-child(even) {
        background: #f8fafc;
      }

      .pill {
        display: inline-block;
        padding: 0.1rem 0.5rem;
        border-radius: 999px;
        background: #e0f2fe;
        font-size: 0.75rem;
      }

      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        color: var(--muted);
        padding: 0.4rem 0.75rem;
        border-top: 1px solid var(--border);
        background: #f8fafc;
      }

      .status-bar span {
        white-space: nowrap;
      }

      @media (max-width: 768px) {
        th,
        td {
          padding: 0.45rem 0.4rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <h1>ASX Explorer</h1>
        <p class="muted">
          Filter, sort, and scan through ASX companies and their fundamentals —
          like a simple Excel view, but in your browser.
        </p>
      </header>

      <section class="filters">
        <div class="filter-group">
          <label class="filter-label" for="searchInput">Search</label>
          <input
            id="searchInput"
            type="text"
            placeholder="Code or name (e.g. BHP, CSL)"
          />
        </div>

        <div class="filter-group">
          <label class="filter-label" for="sectorSelect">Sector</label>
          <select id="sectorSelect">
            <option value="">All sectors</option>
          </select>
        </div>

        <div class="filter-group">
          <label class="filter-label">P/E (min – max)</label>
          <div style="display: flex; gap: 0.25rem">
            <input
              id="peMin"
              type="number"
              step="0.1"
              placeholder="0"
              style="flex: 1"
            />
            <input
              id="peMax"
              type="number"
              step="0.1"
              placeholder="50"
              style="flex: 1"
            />
          </div>
        </div>

        <div class="filter-group">
          <label class="filter-label">Market cap (A$ bn, min – max)</label>
          <div style="display: flex; gap: 0.25rem">
            <input
              id="mcMin"
              type="number"
              step="1"
              placeholder="0"
              style="flex: 1"
            />
            <input
              id="mcMax"
              type="number"
              step="1"
              placeholder="300"
              style="flex: 1"
            />
          </div>
        </div>
      </section>

      <section class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th class="sortable" data-sort="code">
                Code <span>↕</span>
              </th>
              <th class="sortable" data-sort="name">
                Name <span>↕</span>
              </th>
              <th>Sector</th>
              <th class="sortable" data-sort="price">
                Price <span>↕</span>
              </th>
              <th class="sortable" data-sort="marketCap">
                Mkt Cap (A$bn) <span>↕</span>
              </th>
              <th class="sortable" data-sort="pe">
                P/E <span>↕</span>
              </th>
              <th class="sortable" data-sort="dividendYield">
                Div. Yield % <span>↕</span>
              </th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="7" style="text-align: center; padding: 1rem">
                Loading companies…
              </td>
            </tr>
          </tbody>
        </table>

        <div class="status-bar">
          <span id="statusCount">0 companies</span>
          <span id="statusMeta"></span>
        </div>
      </section>
    </div>

    <script>
      const API_URL = "/.netlify/functions/equity-screener";

      const tableBody = document.getElementById("tableBody");
      const searchInput = document.getElementById("searchInput");
      const sectorSelect = document.getElementById("sectorSelect");
      const peMinInput = document.getElementById("peMin");
      const peMaxInput = document.getElementById("peMax");
      const mcMinInput = document.getElementById("mcMin");
      const mcMaxInput = document.getElementById("mcMax");
      const statusCount = document.getElementById("statusCount");
      const statusMeta = document.getElementById("statusMeta");
      const ths = document.querySelectorAll("th.sortable");

      let rawItems = [];
      let filteredItems = [];
      let sortState = { key: "code", direction: "asc" };

      async function loadData() {
        try {
          const res = await fetch(API_URL);
          if (!res.ok) {
            throw new Error("Network error " + res.status);
          }
          const data = await res.json();
          rawItems = data.items || [];
          statusMeta.textContent = `Last updated: ${
            data.generatedAt
              ? new Date(data.generatedAt).toLocaleString()
              : "n/a"
          }`;

          populateSectorFilter(rawItems);
          applyFilters();
        } catch (e) {
          console.error(e);
          tableBody.innerHTML =
            '<tr><td colspan="7" style="text-align:center;padding:1rem;color:#dc2626">Failed to load data. Refresh to try again.</td></tr>';
        }
      }

      function populateSectorFilter(items) {
        const sectors = Array.from(
          new Set(
            items
              .map((i) => i.sector || "Unknown")
              .filter((s) => s && s.trim() !== "")
          )
        ).sort();

        sectors.forEach((sector) => {
          const opt = document.createElement("option");
          opt.value = sector;
          opt.textContent = sector;
          sectorSelect.appendChild(opt);
        });
      }

      function applyFilters() {
        const q = searchInput.value.trim().toLowerCase();
        const sector = sectorSelect.value;
        const peMin = parseFloat(peMinInput.value);
        const peMax = parseFloat(peMaxInput.value);
        const mcMinBn = parseFloat(mcMinInput.value);
        const mcMaxBn = parseFloat(mcMaxInput.value);

        filteredItems = rawItems.filter((item) => {
          // Search filter
          if (q) {
            const haystack = `${item.code} ${item.name}`.toLowerCase();
            if (!haystack.includes(q)) return false;
          }

          // Sector filter
          if (sector && item.sector !== sector) return false;

          // P/E filter
          const pe = Number(item.pe);
          if (!Number.isNaN(pe)) {
            if (!Number.isNaN(peMin) && pe < peMin) return false;
            if (!Number.isNaN(peMax) && pe > peMax) return false;
          }

          // Market cap filter (convert to billions)
          const mc = Number(item.marketCap);
          const mcBn = Number.isNaN(mc) ? NaN : mc / 1_000_000_000;
          if (!Number.isNaN(mcBn)) {
            if (!Number.isNaN(mcMinBn) && mcBn < mcMinBn) return false;
            if (!Number.isNaN(mcMaxBn) && mcBn > mcMaxBn) return false;
          }

          return true;
        });

        applySort();
        renderTable();
      }

      function applySort() {
        const { key, direction } = sortState;
        const dir = direction === "asc" ? 1 : -1;

        filteredItems.sort((a, b) => {
          const va = a[key];
          const vb = b[key];

          // Handle numeric vs text sorts
          const na = Number(va);
          const nb = Number(vb);
          const bothNumeric =
            !Number.isNaN(na) && !Number.isNaN(nb) && key !== "name";

          if (bothNumeric) {
            if (na < nb) return -1 * dir;
            if (na > nb) return 1 * dir;
            return 0;
          } else {
            const sa = (va ?? "").toString().toLowerCase();
            const sb = (vb ?? "").toString().toLowerCase();
            if (sa < sb) return -1 * dir;
            if (sa > sb) return 1 * dir;
            return 0;
          }
        });
      }

      function renderTable() {
        if (!filteredItems.length) {
          tableBody.innerHTML =
            '<tr><td colspan="7" style="text-align:center;padding:1rem;">No companies match your filters.</td></tr>';
          statusCount.textContent = "0 companies";
          return;
        }

        const rows = filteredItems
          .map((item) => {
            const mcBn = Number(item.marketCap) / 1_000_000_000;
            const mcBnStr = Number.isNaN(mcBn)
              ? "-"
              : mcBn.toLocaleString(undefined, {
                  maximumFractionDigits: 1,
                });

            return `
            <tr>
              <td><strong>${item.code}</strong></td>
              <td>${item.name || ""}</td>
              <td><span class="pill">${item.sector || "Unknown"}</span></td>
              <td>${formatNumber(item.price)}</td>
              <td>${mcBnStr}</td>
              <td>${formatNumber(item.pe)}</td>
              <td>${formatNumber(item.dividendYield)}</td>
            </tr>
          `;
          })
          .join("");

        tableBody.innerHTML = rows;
        statusCount.textContent = `${filteredItems.length} compan${
          filteredItems.length === 1 ? "y" : "ies"
        }`;
      }

      function formatNumber(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "-";
        return n.toLocaleString(undefined, {
          maximumFractionDigits: 2,
        });
      }

      // Event listeners
      searchInput.addEventListener("input", () => applyFilters());
      sectorSelect.addEventListener("change", () => applyFilters());
      peMinInput.addEventListener("input", () => applyFilters());
      peMaxInput.addEventListener("input", () => applyFilters());
      mcMinInput.addEventListener("input", () => applyFilters());
      mcMaxInput.addEventListener("input", () => applyFilters());

      ths.forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.sort;
          if (!key) return;
          if (sortState.key === key) {
            sortState.direction =
              sortState.direction === "asc" ? "desc" : "asc";
          } else {
            sortState.key = key;
            sortState.direction = "asc";
          }
          applySort();
          renderTable();
        });
      });

      loadData();
    </script>
  </body>
</html>
