<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MatesInvest – ASX Screener</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --navy: #002040;
        --cyan: #00bfff;
        --bg: #f5f7fb;
        --card: #ffffff;
        --muted: #64748b;
        --muted-2: #94a3b8;
        --accent: var(--cyan);
        --accent-strong: #0093cc;
        --accent-soft: rgba(0, 191, 255, 0.1);
        --border: #e2e8f0;
        --card-border: #e2e8f0;
        --glass: rgba(255, 255, 255, 0.92);
        --radius: 18px;
        --gap: 1rem;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        max-width: 100%;
        overflow-x: hidden;
        font-family: Inter, system-ui, -apple-system, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #dbeafe 0, #f5f7fb 55%);
        color: var(--navy);
      }

      .page {
        max-width: 1240px;
        margin: 0 auto;
        padding: 1.5rem 1.25rem 2.5rem;
      }

      /* ---------- TOP NAV ---------- */

      .top-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.25rem;
      }

      .nav-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-logo {
        display: flex;
        align-items: center;
        gap: 0.45rem;
        text-decoration: none;
        color: inherit;
      }

      .nav-logo-img {
        height: 32px;
        width: auto;
        display: block;
      }

      .nav-logo-text {
        font-weight: 700;
        letter-spacing: -0.02em;
        font-size: 1rem;
      }

      .nav-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-link {
        font-size: 0.85rem;
        text-decoration: none;
        color: var(--navy);
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
        border: 1px solid transparent;
      }

      .nav-link:hover {
        background: rgba(15, 23, 42, 0.02);
      }

      .nav-pill {
        font-size: 0.85rem;
        text-decoration: none;
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        background: var(--accent);
        color: #001220;
        font-weight: 600;
        border: 1px solid transparent;
        box-shadow: 0 7px 16px rgba(15, 23, 42, 0.18);
      }

      .nav-pill:hover {
        background: var(--accent-strong);
      }

      header {
        margin-bottom: 1rem;
      }

      h1 {
        margin: 0 0 0.25rem;
        font-size: 1.8rem;
        letter-spacing: -0.02em;
      }

      .muted {
        color: var(--muted);
        font-size: 0.9rem;
      }

      /* ---------- FILTER CARD (COLLAPSIBLE) ---------- */

      .filters-card {
        background: var(--glass);
        border-radius: var(--radius);
        border: 1px solid var(--card-border);
        box-shadow: 0 10px 26px rgba(15, 23, 42, 0.09);
        padding: 0.4rem 0.75rem 0.45rem;
        margin-bottom: 0.9rem;
      }

      .filters-toggle {
        all: unset;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        cursor: pointer;
      }

      .filters-toggle-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 0;
      }

      .filters-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.72rem;
        padding: 0.15rem 0.6rem;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--navy);
        font-weight: 500;
        flex-shrink: 0;
      }

      .filters-chip-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: var(--accent-strong);
      }

      .filters-caption {
        font-size: 0.75rem;
        color: var(--muted-2);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .filters-toggle-icon {
        font-size: 0.9rem;
        color: var(--muted-2);
        margin-left: 0.5rem;
        transition: transform 0.18s ease;
      }

      .filters-card.open .filters-toggle-icon {
        transform: rotate(180deg);
      }

      .filters-body {
        display: none;
        margin-top: 0.45rem;
      }

      .filters-card.open .filters-body {
        display: block;
      }

      .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 0.6rem;
        align-items: flex-end;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
      }

      .filter-label {
        font-size: 0.72rem;
        color: var(--muted-2);
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      input,
      select {
        font: inherit;
        padding: 0.28rem 0.55rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        outline: none;
        background: #f8fafc;
        font-size: 0.82rem;
        width: 100%;
      }

      input::placeholder {
        color: #cbd5f5;
      }

      input:focus,
      select:focus {
        border-color: var(--accent);
        background: #ffffff;
        box-shadow: 0 0 0 1px rgba(0, 191, 255, 0.08);
      }

      /* ---------- TABLE / LAYOUT ---------- */

      .table-wrapper {
        background: var(--glass);
        border-radius: var(--radius);
        border: 1px solid var(--card-border);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
        overflow: hidden;
      }

      .table-scroll {
        width: 100%;
        max-height: calc(100vh - 260px);
        overflow-x: auto;
        overflow-y: auto;
        position: relative;
      }

      table {
        width: 100%;
        min-width: 2200px;
        border-collapse: collapse;
        font-size: 0.84rem;
      }

      thead {
        background: #f1f5f9;
      }

      thead th {
        position: sticky;
        top: 0;
        z-index: 3;
        background: #f1f5f9;
      }

      th,
      td {
        padding: 0.5rem 0.6rem;
        text-align: right;
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
      }

      th:first-child,
      td:first-child {
        text-align: left;
      }

      th:nth-child(2),
      td:nth-child(2),
      th:nth-child(3),
      td:nth-child(3) {
        text-align: left;
      }

      th.sortable {
        cursor: pointer;
        user-select: none;
        font-weight: 500;
        font-size: 0.8rem;
        color: #0b1220;
      }

      th.sortable span {
        margin-left: 0.25rem;
        font-size: 0.65rem;
        opacity: 0.6;
      }

      tbody tr:nth-child(even) {
        background: #f8fafc;
      }

      .pill {
        display: inline-block;
        padding: 0.1rem 0.5rem;
        border-radius: 999px;
        background: #e0f2fe;
        font-size: 0.72rem;
      }

      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.78rem;
        color: var(--muted);
        padding: 0.45rem 0.75rem;
        border-top: 1px solid var(--border);
        background: #f8fafc;
      }

      .status-bar span {
        white-space: nowrap;
      }

      /* ---------- STICKY FIRST COLUMN (CODE) ---------- */

      th.sticky-col {
        position: sticky;
        top: 0;
        left: 0;
        z-index: 4; /* above other headers */
        background: #f1f5f9;
      }

      td.sticky-col {
        position: sticky;
        left: 0;
        z-index: 2; /* above body cells, below headers */
        background: #ffffff;
      }

      tbody tr:nth-child(even) td.sticky-col {
        background: #f8fafc;
      }

      /* ---------- MOBILE TWEAKS ---------- */

      @media (max-width: 768px) {
        .page {
          padding-inline: 0.85rem;
        }

        th,
        td {
          padding: 0.45rem 0.4rem;
        }

        h1 {
          font-size: 1.5rem;
        }

        .filters-card {
          padding-inline: 0.55rem;
        }
      }

      @media (max-width: 640px) {
        .filters {
          grid-template-columns: 1fr;
        }

        .filters-caption {
          display: none; /* hide long caption on very small screens */
        }
      }
      /* ---------- Instrument modal (shared with mates-summaries) ---------- */

.mi-ins-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15, 23, 42, 0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.mi-ins-modal {
  background: #0b1020;
  color: #f9fafb;
  border-radius: 18px;
  max-width: 700px;
  max-height: 90vh;
  overflow-y: auto;
  width: 100%;
  padding: 20px 22px 22px;
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
  border: 1px solid rgba(148, 163, 184, 0.25);
  position: relative;
}

.mi-ins-header {
  display: flex;
  justify-content: space-between;
  gap: 16px;
  margin-bottom: 14px;
  position: sticky;
  top: 0;
  background: #0b1020;
  z-index: 50;
  padding-bottom: 8px;
  padding-top: 6px;
}

.mi-ins-title {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
}

.mi-ins-subtitle {
  margin-top: 4px;
  font-size: 13px;
  color: #9ca3af;
}

.mi-ins-price-block {
  text-align: right;
}

.mi-ins-price {
  font-size: 20px;
  font-weight: 600;
}

.mi-ins-change {
  font-size: 13px;
  margin-top: 2px;
}

.mi-ins-change.up {
  color: #4ade80;
}

.mi-ins-change.down {
  color: #f97373;
}

.mi-ins-date {
  font-size: 11px;
  color: #6b7280;
  margin-top: 3px;
}

.mi-ins-close {
  position: absolute;
  top: 8px;
  right: 12px;
  font-size: 20px;
  color: #9ca3af;
  background: transparent;
  border: none;
  cursor: pointer;
  z-index: 200;
}

.mi-ins-close:hover {
  color: #e5e7eb;
}

.mi-ins-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 16px;
}

.mi-ins-tag {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 999px;
  background: rgba(31, 41, 55, 0.85);
  color: #e5e7eb;
  border: 1px solid rgba(55, 65, 81, 0.9);
}

.mi-ins-section {
  margin-bottom: 14px;
}

.mi-ins-section-title {
  font-size: 13px;
  font-weight: 600;
  margin: 0 0 8px;
  color: #d1d5db;
}

.mi-ins-stats-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px 16px;
}

.mi-ins-stat-item {
  font-size: 12px;
}

.mi-ins-stat-label {
  color: #9ca3af;
  display: block;
  margin-bottom: 2px;
}

.mi-ins-stat-value {
  font-weight: 500;
}

.mi-ins-history-summary {
  font-size: 12px;
  color: #9ca3af;
  margin-bottom: 6px;
}

#mi-ins-chart {
  width: 100%;
  height: 220px;
  margin-top: 10px;
  background: rgba(15, 23, 42, 0.7);
  border-radius: 12px;
}

.mi-ins-ai-summary {
  font-size: 0.9rem;
  color: #e5e7eb;
  background: rgba(15, 23, 42, 0.65);
  border-radius: 12px;
  padding: 10px 12px;
  border: 1px solid rgba(148, 163, 184, 0.3);
  line-height: 1.4;
}

/* News list inside modal */
.mi-ins-news-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  font-size: 0.82rem;
}

.mi-ins-news-item {
  padding: 8px 9px;
  border-radius: 10px;
  border: 1px solid rgba(148, 163, 184, 0.4);
  background: rgba(15, 23, 42, 0.6);
}

.mi-ins-news-item-title {
  font-weight: 500;
  margin-bottom: 2px;
}

.mi-ins-news-item-meta {
  font-size: 0.75rem;
  color: #9ca3af;
}

.mi-ins-news-item a {
  color: #38bdf8;
  text-decoration: none;
  font-size: 0.8rem;
}

.mi-ins-news-item a:hover {
  text-decoration: underline;
}

@media (max-width: 640px) {
  .mi-ins-modal {
    margin: 10px;
    padding: 16px 14px 18px;
  }

  .mi-ins-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .mi-ins-price-block {
    text-align: left;
  }

  .mi-ins-stats-grid {
    grid-template-columns: 1fr;
  }
}
    </style>
  </head>
  <body>
    <div class="page">
      <nav class="top-nav">
        <div class="nav-left">
          <a href="/" class="nav-logo">
            <img
              src="/assets/img/logo-placeholder.png"
              alt="MatesInvest"
              class="nav-logo-img"
            />
            <div class="nav-logo-text">MatesInvest</div>
          </a>
        </div>
        <div class="nav-right">
          <a href="/" class="nav-link">Home</a>
          <a href="/mates-summaries.html" class="nav-pill">ASX Daily Brief</a>
        </div>
      </nav>

      <header>
        <h1>ASX Explorer</h1>
        <p class="muted">
          Scan the ASX with filters and sorting like a simple spreadsheet, without leaving your browser.
        </p>
      </header>

      <section class="filters-card" id="filtersCard">
        <button type="button" class="filters-toggle" id="filtersToggle">
          <div class="filters-toggle-left">
            <div class="filters-chip">
              <span class="filters-chip-dot"></span>
              Filters
            </div>
            <div class="filters-caption">
              Search, narrow by sector, and screen for value or income ideas.
            </div>
          </div>
          <span class="filters-toggle-icon" id="filtersToggleIcon">▾</span>
        </button>

        <div class="filters-body" id="filtersBody">
          <div class="filters">
            <div class="filter-group">
              <label class="filter-label" for="searchInput">Search</label>
              <input
                id="searchInput"
                type="text"
                placeholder="Code or name (e.g. BHP, CSL)"
              />
            </div>

            <div class="filter-group">
              <label class="filter-label" for="sectorSelect">Sector</label>
              <select id="sectorSelect">
                <option value="">All sectors</option>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">P/E (min – max)</label>
              <div style="display: flex; gap: 0.25rem">
                <input
                  id="peMin"
                  type="number"
                  step="0.1"
                  placeholder="0"
                  style="flex: 1"
                />
                <input
                  id="peMax"
                  type="number"
                  step="0.1"
                  placeholder="50"
                  style="flex: 1"
                />
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Mkt cap (A$bn, min – max)</label>
              <div style="display: flex; gap: 0.25rem">
                <input
                  id="mcMin"
                  type="number"
                  step="1"
                  placeholder="0"
                  style="flex: 1"
                />
                <input
                  id="mcMax"
                  type="number"
                  step="1"
                  placeholder="300"
                  style="flex: 1"
                />
              </div>
            </div>

            <div class="filter-group">
              <label class="filter-label">Div. yield (min %)</label>
              <input
                id="dyMin"
                type="number"
                step="0.1"
                placeholder="0"
              />
            </div>
            <div class="filter-group">
  <label class="filter-label" for="hideEtfs">
    <span style="display:flex;align-items:center;gap:0.35rem;">
      <input
        id="hideEtfs"
        type="checkbox"
        checked
        style="width:auto;margin:0;"
      />
      <span>Hide ETFs (name ends in “ETF”)</span>
    </span>
  </label>
</div>
          </div>
        </div>
      </section>

      <section class="table-wrapper">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th class="sortable sticky-col" data-sort="code">
                  Code <span>↕</span>
                </th>
                <th class="sortable" data-sort="name">
                  Name <span>↕</span>
                </th>
                <th class="sortable" data-sort="sector">
                  Sector <span>↕</span>
                </th>

                <th class="sortable" data-sort="price">
                  Price (Y'day) <span>↕</span>
                </th>
                <th class="sortable" data-sort="marketCap">
                  Mkt Cap (A$bn) <span>↕</span>
                </th>
                <th class="sortable" data-sort="pctChange">
                  Daily move % <span>↕</span>
                </th>

                <th class="sortable" data-sort="ebitda">
                  EBITDA (A$bn) <span>↕</span>
                </th>
                <th class="sortable" data-sort="peRatio">
                  P/E <span>↕</span>
                </th>
                <th class="sortable" data-sort="pegRatio">
                  PEG <span>↕</span>
                </th>
                <th class="sortable" data-sort="eps">
                  EPS <span>↕</span>
                </th>
                <th class="sortable" data-sort="bookValue">
                  Book value <span>↕</span>
                </th>
                <th class="sortable" data-sort="dividendPerShare">
                  Div / share <span>↕</span>
                </th>
                <th class="sortable" data-sort="dividendYield">
                  Div yield % <span>↕</span>
                </th>

                <th class="sortable" data-sort="profitMargin">
                  Profit margin % <span>↕</span>
                </th>
                <th class="sortable" data-sort="operatingMargin">
                  Operating margin % <span>↕</span>
                </th>
                <th class="sortable" data-sort="returnOnAssets">
                  ROA % <span>↕</span>
                </th>
                <th class="sortable" data-sort="returnOnEquity">
                  ROE % <span>↕</span>
                </th>

                <th class="sortable" data-sort="revenue">
                  Revenue (A$bn) <span>↕</span>
                </th>
                <th class="sortable" data-sort="revenuePerShare">
                  Revenue / share <span>↕</span>
                </th>
                <th class="sortable" data-sort="grossProfit">
                  Gross profit (A$bn) <span>↕</span>
                </th>
                <th class="sortable" data-sort="dilutedEps">
                  Diluted EPS <span>↕</span>
                </th>
                <th class="sortable" data-sort="quarterlyRevenueGrowthYoy">
                  Q rev growth YoY % <span>↕</span>
                </th>
                <th class="sortable" data-sort="quarterlyEarningsGrowthYoy">
                  Q EPS growth YoY % <span>↕</span>
                </th>

                <th class="sortable" data-sort="trailingPE">
                  Trailing P/E <span>↕</span>
                </th>
                <th class="sortable" data-sort="forwardPE">
                  Forward P/E <span>↕</span>
                </th>
                <th class="sortable" data-sort="priceToSales">
                  Price / sales <span>↕</span>
                </th>
                <th class="sortable" data-sort="priceToBook">
                  Price / book <span>↕</span>
                </th>
                <th class="sortable" data-sort="enterpriseValue">
                  EV (A$bn) <span>↕</span>
                </th>
                <th class="sortable" data-sort="evToRevenue">
                  EV / revenue <span>↕</span>
                </th>
                <th class="sortable" data-sort="evToEbitda">
                  EV / EBITDA <span>↕</span>
                </th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td colspan="30" style="text-align: center; padding: 1rem">
                  Loading companies…
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="status-bar">
          <span id="statusCount">0 companies</span>
          <span id="statusMeta"></span>
        </div>
      </section>
    </div>
    <!-- Instrument details modal for screener -->
<div id="mi-instrument-overlay" class="mi-ins-overlay" aria-hidden="true">
  <div class="mi-ins-modal" role="dialog" aria-modal="true" aria-labelledby="mi-ins-title">
    <div class="mi-ins-header">
      <div>
        <h2 id="mi-ins-title" class="mi-ins-title">Instrument name</h2>
        <div id="mi-ins-subtitle" class="mi-ins-subtitle">CODE • Sector</div>
      </div>
      <div class="mi-ins-price-block">
        <div id="mi-ins-price" class="mi-ins-price">$0.00</div>
        <div id="mi-ins-change" class="mi-ins-change">+0.0% today</div>
        <div id="mi-ins-date" class="mi-ins-date">as at —</div>
      </div>
      <button
        class="mi-ins-close"
        type="button"
        id="mi-ins-close-btn"
        aria-label="Close"
      >
        ✕
      </button>
    </div>

    <div id="mi-ins-tags" class="mi-ins-tags"></div>

    <div class="mi-ins-section">
      <h3 class="mi-ins-section-title">Key stats</h3>
      <div id="mi-ins-stats" class="mi-ins-stats-grid"></div>
    </div>

    <div class="mi-ins-section">
      <h3 class="mi-ins-section-title">Price history</h3>
      <div class="mi-ins-history">
        <div id="mi-ins-history-summary" class="mi-ins-history-summary">
          Showing last 6 months of daily closes.
        </div>
        <canvas id="mi-ins-chart" width="600" height="220"></canvas>
      </div>
    </div>

    <div class="mi-ins-section">
      <h3 class="mi-ins-section-title">Company snapshot</h3>
      <div id="mi-ins-ai-summary" class="mi-ins-ai-summary">
        We’re loading a short AI summary for this company…
      </div>
    </div>

    <div class="mi-ins-section">
      <h3 class="mi-ins-section-title">Latest news</h3>
      <div id="mi-ins-news">
        Loading headlines for this name…
      </div>
    </div>
  </div>
</div>
    <script>
      const API_URL = "/.netlify/functions/equity-screener";

      const tableBody = document.getElementById("tableBody");
      const searchInput = document.getElementById("searchInput");
      const sectorSelect = document.getElementById("sectorSelect");
      const peMinInput = document.getElementById("peMin");
      const peMaxInput = document.getElementById("peMax");
      const mcMinInput = document.getElementById("mcMin");
      const mcMaxInput = document.getElementById("mcMax");
      const dyMinInput = document.getElementById("dyMin");
      const statusCount = document.getElementById("statusCount");
      const statusMeta = document.getElementById("statusMeta");
      const ths = document.querySelectorAll("th.sortable");
      const hideEtfsInput = document.getElementById("hideEtfs");

      const filtersCard = document.getElementById("filtersCard");
      const filtersToggle = document.getElementById("filtersToggle");
      const filtersToggleIcon = document.getElementById("filtersToggleIcon");

      let rawItems = [];
      let filteredItems = [];
let sortState = { key: "marketCap", direction: "desc" };


      // Filters dropdown toggle
      filtersToggle.addEventListener("click", () => {
        const isOpen = filtersCard.classList.toggle("open");
        filtersToggleIcon.textContent = isOpen ? "▴" : "▾";
      });

      async function loadData() {
        try {
          const res = await fetch(API_URL);
          if (!res.ok) {
            throw new Error("Network error " + res.status);
          }
          const data = await res.json();
          rawItems = data.items || [];
          statusMeta.textContent = `Last updated: ${
            data.generatedAt
              ? new Date(data.generatedAt).toLocaleString()
              : "n/a"
          }`;

          populateSectorFilter(rawItems);
          applyFilters();
        } catch (e) {
          console.error(e);
          tableBody.innerHTML =
            '<tr><td colspan="30" style="text-align:center;padding:1rem;color:#dc2626">Failed to load data. Refresh to try again.</td></tr>';
        }
      }

      function populateSectorFilter(items) {
        const sectors = Array.from(
          new Set(
            items
              .map((i) => i.sector || "Unknown")
              .filter((s) => s && s.trim() !== "")
          )
        ).sort();

        sectors.forEach((sector) => {
          const opt = document.createElement("option");
          opt.value = sector;
          opt.textContent = sector;
          sectorSelect.appendChild(opt);
        });
      }

      function applyFilters() {
        const q = searchInput.value.trim().toLowerCase();
        const sector = sectorSelect.value;
        const peMin = parseFloat(peMinInput.value);
        const peMax = parseFloat(peMaxInput.value);
        const mcMinBn = parseFloat(mcMinInput.value);
        const mcMaxBn = parseFloat(mcMaxInput.value);
        const dyMin = parseFloat(dyMinInput.value);
        const hideEtfs = hideEtfsInput && hideEtfsInput.checked;


        filteredItems = rawItems.filter((item) => {
          if (q) {
            const haystack = `${item.code} ${item.name}`.toLowerCase();
            if (!haystack.includes(q)) return false;
          }

          if (sector && item.sector !== sector) return false;

          const pe = Number(item.peRatio);
          if (!Number.isNaN(pe)) {
            if (!Number.isNaN(peMin) && pe < peMin) return false;
            if (!Number.isNaN(peMax) && pe > peMax) return false;
          }

          const mc = Number(item.marketCap);
          const mcBn = Number.isNaN(mc) ? NaN : mc / 1_000_000_000;
          if (!Number.isNaN(mcBn)) {
            if (!Number.isNaN(mcMinBn) && mcBn < mcMinBn) return false;
            if (!Number.isNaN(mcMaxBn) && mcBn > mcMaxBn) return false;
          }

                   const dy = Number(item.dividendYield);
          if (!Number.isNaN(dy) && !Number.isNaN(dyMin)) {
            const dyPct = dy <= 1 && dy >= -1 ? dy * 100 : dy;
            if (dyPct < dyMin) return false;
          }

          // NEW: hide ETFs by name
          if (
            hideEtfs &&
            typeof item.name === "string" &&
            item.name.trim().toUpperCase().endsWith("ETF")
          ) {
            return false;
          }

          return true;
        });
        
        applySort();
        renderTable();
      }

      function applySort() {
        const { key, direction } = sortState;
        const dir = direction === "asc" ? 1 : -1;

        filteredItems.sort((a, b) => {
          const va = a[key];
          const vb = b[key];

          const na = Number(va);
          const nb = Number(vb);
          const bothNumeric =
            !Number.isNaN(na) && !Number.isNaN(nb) && key !== "name";

          if (bothNumeric) {
            if (na < nb) return -1 * dir;
            if (na > nb) return 1 * dir;
            return 0;
          } else {
            const sa = (va ?? "").toString().toLowerCase();
            const sb = (vb ?? "").toString().toLowerCase();
            if (sa < sb) return -1 * dir;
            if (sa > sb) return 1 * dir;
            return 0;
          }
        });
      }

      function renderTable() {
        if (!filteredItems.length) {
          tableBody.innerHTML =
            '<tr><td colspan="30" style="text-align:center;padding:1rem;">No companies match your filters.</td></tr>';
          statusCount.textContent = "0 companies";
          return;
        }

        const rows = filteredItems
          .map((item) => {
            const mcBn = toBillions(item.marketCap);
            const ebitdaBn = toBillions(item.ebitda);
            const revBn = toBillions(item.revenue);
            const gpBn = toBillions(item.grossProfit);
            const evBn = toBillions(item.enterpriseValue);

            return `
  <tr data-code="${item.code}" data-type="equity">
    <td class="sticky-col"><strong>${item.code}</strong></td>

                <td>${item.name || ""}</td>
                <td><span class="pill">${item.sector || "Unknown"}</span></td>

                <td>${formatNumber(item.price)}</td>
                <td>${mcBn}</td>
                <td>${formatPercentRaw(item.pctChange)}</td>

                <td>${ebitdaBn}</td>
                <td>${formatNumber(item.peRatio)}</td>
                <td>${formatNumber(item.pegRatio)}</td>
                <td>${formatNumber(item.eps)}</td>
                <td>${formatNumber(item.bookValue)}</td>
                <td>${formatNumber(item.dividendPerShare)}</td>
                <td>${formatPercentFrac(item.dividendYield)}</td>

                <td>${formatPercentFrac(item.profitMargin)}</td>
                <td>${formatPercentFrac(item.operatingMargin)}</td>
                <td>${formatPercentFrac(item.returnOnAssets)}</td>
                <td>${formatPercentFrac(item.returnOnEquity)}</td>

                <td>${revBn}</td>
                <td>${formatNumber(item.revenuePerShare)}</td>
                <td>${gpBn}</td>
                <td>${formatNumber(item.dilutedEps)}</td>
                <td>${formatPercentFrac(item.quarterlyRevenueGrowthYoy)}</td>
                <td>${formatPercentFrac(item.quarterlyEarningsGrowthYoy)}</td>

                <td>${formatNumber(item.trailingPE)}</td>
                <td>${formatNumber(item.forwardPE)}</td>
                <td>${formatNumber(item.priceToSales)}</td>
                <td>${formatNumber(item.priceToBook)}</td>
                <td>${evBn}</td>
                <td>${formatNumber(item.evToRevenue)}</td>
                <td>${formatNumber(item.evToEbitda)}</td>
              </tr>
            `;
          })
          .join("");

        tableBody.innerHTML = rows;
        statusCount.textContent = `${filteredItems.length} compan${
          filteredItems.length === 1 ? "y" : "ies"
        }`;
      }

      function toBillions(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "-";
        const bn = n / 1_000_000_000;
        return bn.toLocaleString(undefined, {
          maximumFractionDigits: 1,
        });
      }

      function formatNumber(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "-";
        return n.toLocaleString(undefined, {
          maximumFractionDigits: 2,
        });
      }

      // Treat n as 0.045 => 4.5%
      function formatPercentFrac(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "-";
        const pct = Math.abs(n) <= 1 ? n * 100 : n;
        return `${pct.toFixed(2)}%`;
      }

      // Treat n as already in percent points
      function formatPercentRaw(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "-";
        return `${n.toFixed(2)}%`;
      }

      searchInput.addEventListener("input", applyFilters);
      sectorSelect.addEventListener("change", applyFilters);
      peMinInput.addEventListener("input", applyFilters);
      peMaxInput.addEventListener("input", applyFilters);
      mcMinInput.addEventListener("input", applyFilters);
      mcMaxInput.addEventListener("input", applyFilters);
      dyMinInput.addEventListener("input", applyFilters);
      hideEtfsInput.addEventListener("change", applyFilters);

      ths.forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.sort;
          if (!key) return;
          if (sortState.key === key) {
            sortState.direction =
              sortState.direction === "asc" ? "desc" : "asc";
          } else {
            sortState.key = key;
            sortState.direction = "asc";
          }
          applySort();
          renderTable();
        });
      });

      loadData();
      // ---------- Instrument helpers (reuse instrument-details from mates-summaries) ----------

async function miFetchInstrumentDetails(type, code) {
  const url = `/.netlify/functions/instrument-details?type=${encodeURIComponent(
    type
  )}&code=${encodeURIComponent(code)}`;
  const res = await fetch(url);
  if (!res.ok) {
    throw new Error(`instrument-details failed: ${res.status}`);
  }
  return res.json();
}

async function miFetchAiSummary(type, code) {
  const url = `/.netlify/functions/instrument-ai-summary?type=${encodeURIComponent(
    type
  )}&code=${encodeURIComponent(code)}`;
  const res = await fetch(url);
  if (!res.ok) {
    throw new Error(`instrument-ai-summary failed: ${res.status}`);
  }
  return res.json();
}

// Use your existing newsFeed function, but scoped to a single symbol
async function miFetchInstrumentNews(code) {
  // MarketAux + EODHD-backed news feed supports symbols= param already on mates-summaries. :contentReference[oaicite:4]{index=4}
  const params = new URLSearchParams({
    symbols: `${code}.AX`,
    per_page: "6",
  });
  const res = await fetch("/.netlify/functions/newsFeed?" + params.toString());
  if (!res.ok) {
    throw new Error(`newsFeed failed: ${res.status}`);
  }
  const data = await res.json();
  return data.articles || [];
}

// ---------- Formatting helpers ----------

function miFormatCurrency(n, currency = "AUD") {
  if (typeof n !== "number" || !isFinite(n)) return null;
  try {
    return new Intl.NumberFormat("en-AU", {
      style: "currency",
      currency,
      maximumFractionDigits: 2,
    }).format(n);
  } catch {
    return n.toFixed(2);
  }
}

function miFormatCompactNumber(n) {
  if (typeof n !== "number" || !isFinite(n)) return null;
  const abs = Math.abs(n);
  if (abs >= 1_000_000_000) return (n / 1_000_000_000).toFixed(1) + "B";
  if (abs >= 1_000_000) return (n / 1_000_000).toFixed(1) + "M";
  if (abs >= 1_000) return (n / 1_000).toFixed(1) + "k";
  return n.toFixed(0);
}

function miFormatPercent(n, digits = 2) {
  if (typeof n !== "number" || !isFinite(n)) return null;
  return n.toFixed(digits) + "%";
}

function miFormatDate(dateStr) {
  if (!dateStr) return null;
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return null;
  return d.toLocaleDateString("en-AU", {
    day: "2-digit",
    month: "short",
    year: "numeric",
  });
}

// ---------- Chart renderer (same idea as mates-summaries) ----------

function miRenderChart(history) {
  const canvas = document.getElementById("mi-ins-chart");
  if (!canvas || !history || !Array.isArray(history.points)) return;

  const ctx = canvas.getContext("2d");
  const pts = history.points.map((p) => p[1]).filter((x) => typeof x === "number");

  const w = canvas.width;
  const h = canvas.height;

  ctx.clearRect(0, 0, w, h);

  if (pts.length < 2) {
    ctx.fillStyle = "#9ca3af";
    ctx.font = "12px system-ui";
    ctx.fillText("No chart data available", 12, 20);
    return;
  }

  const min = Math.min(...pts);
  const max = Math.max(...pts);
  const padX = 20;
  const padY = 10;

  ctx.lineWidth = 2;
  ctx.strokeStyle = "#38bdf8";
  ctx.beginPath();

  pts.forEach((v, i) => {
    const x = padX + (i / (pts.length - 1)) * (w - padX * 2);
    const y = h - padY - ((v - min) / (max - min)) * (h - padY * 2);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });

  ctx.stroke();

  const gradient = ctx.createLinearGradient(0, padY, 0, h);
  gradient.addColorStop(0, "rgba(56,189,248,0.25)");
  gradient.addColorStop(1, "rgba(56,189,248,0.0)");

  ctx.lineTo(w - padX, h - padY);
  ctx.lineTo(padX, h - padY);
  ctx.closePath();
  ctx.fillStyle = gradient;
  ctx.fill();
}

// ---------- Modal open/close + populate ----------

function miOpenInstrumentModal(data) {
  const overlay = document.getElementById("mi-instrument-overlay");
  if (!overlay) return;

  const latest = data.latest || {};
  const f = data.fundamentals || {};

  const titleEl = document.getElementById("mi-ins-title");
  const subtitleEl = document.getElementById("mi-ins-subtitle");
  const priceEl = document.getElementById("mi-ins-price");
  const changeEl = document.getElementById("mi-ins-change");
  const dateEl = document.getElementById("mi-ins-date");
  const tagsEl = document.getElementById("mi-ins-tags");
  const statsEl = document.getElementById("mi-ins-stats");
  const historySummaryEl = document.getElementById("mi-ins-history-summary");
  const aiSummaryEl = document.getElementById("mi-ins-ai-summary");
  const newsEl = document.getElementById("mi-ins-news");

  const name = data.name || data.code || "";
  const code = data.code || "";
  const sector = f.sector || "";
  const industry = f.industry || "";
  const sizeBucket = f.sizeBucket || null;

  // Header
  if (titleEl) titleEl.textContent = name;
  if (subtitleEl) {
    const bits = [];
    if (code) bits.push(code);
    if (sector) bits.push(sector);
    subtitleEl.textContent = bits.join(" • ") || "";
  }

  // Price + change
  const priceNum =
    typeof latest.price === "number" && isFinite(latest.price)
      ? latest.price
      : null;
  const pctChange =
    typeof latest.pctChange === "number" && isFinite(latest.pctChange)
      ? latest.pctChange
      : null;

  if (priceEl) {
    priceEl.textContent =
      priceNum !== null
        ? miFormatCurrency(priceNum, f.currency || "AUD")
        : "—";
  }

  if (changeEl) {
    changeEl.classList.remove("up", "down");
    if (pctChange === null) {
      changeEl.textContent = "Change: —";
    } else {
      const arrow = pctChange > 0 ? "▲" : pctChange < 0 ? "▼" : "•";
      changeEl.textContent = `${arrow} ${pctChange.toFixed(2)}% yesterday`;
      if (pctChange > 0) changeEl.classList.add("up");
      else if (pctChange < 0) changeEl.classList.add("down");
    }
  }

  if (dateEl) {
    const d = miFormatDate(latest.date);
    dateEl.textContent = d ? `as at ${d}` : "";
  }

  // Tags
  if (tagsEl) {
    tagsEl.innerHTML = "";
    const tags = [];
    if (sizeBucket) {
      const label =
        sizeBucket === "mega"
          ? "Mega cap"
          : sizeBucket === "large"
          ? "Large cap"
          : sizeBucket === "mid"
          ? "Mid cap"
          : sizeBucket === "small"
          ? "Small cap"
          : null;
      if (label) tags.push(label);
    }
    if (sector) tags.push(sector);
    if (industry) tags.push(industry);

    tags.forEach((t) => {
      const span = document.createElement("span");
      span.className = "mi-ins-tag";
      span.textContent = t;
      tagsEl.appendChild(span);
    });
  }

  // Stats
  if (statsEl) {
    statsEl.innerHTML = "";
    const addStat = (label, valueStr) => {
      if (!valueStr) return;
      const item = document.createElement("div");
      item.className = "mi-ins-stat-item";
      const lab = document.createElement("span");
      lab.className = "mi-ins-stat-label";
      lab.textContent = label;
      const val = document.createElement("span");
      val.className = "mi-ins-stat-value";
      val.textContent = valueStr;
      item.appendChild(lab);
      item.appendChild(val);
      statsEl.appendChild(item);
    };

    if (typeof f.marketCap === "number" && isFinite(f.marketCap)) {
      addStat("Market cap", miFormatCompactNumber(f.marketCap));
    }
    if (typeof f.revenueLastYear === "number" && isFinite(f.revenueLastYear)) {
      addStat("Revenue (last year)", miFormatCompactNumber(f.revenueLastYear));
    }
    if (typeof f.netIncomeLastYear === "number" && isFinite(f.netIncomeLastYear)) {
      addStat("Net profit (last year)", miFormatCompactNumber(f.netIncomeLastYear));
    }
    if (typeof f.pe === "number" && isFinite(f.pe)) {
      addStat("P/E ratio", f.pe.toFixed(2) + "×");
    }
    if (typeof f.dividendYield === "number" && isFinite(f.dividendYield)) {
      addStat("Dividend yield", miFormatPercent(f.dividendYield, 2));
    }
    if (typeof f.paysDividend === "boolean") {
      addStat("Pays dividend", f.paysDividend ? "Yes" : "No");
    }
    if (typeof f.eps === "number" && isFinite(f.eps)) {
      addStat("Earnings per share", f.eps.toFixed(2));
    }
  }

  // History summary + chart
  const h = data.history;
  if (historySummaryEl) {
    if (h && Array.isArray(h.points) && h.points.length > 1) {
      const start = miFormatDate(h.startDate);
      const end = miFormatDate(h.endDate);
      historySummaryEl.textContent =
        start && end
          ? `Showing daily closes from ${start} to ${end}.`
          : "Showing last 6 months of daily closes.";
    } else {
      historySummaryEl.textContent = "Price history not available.";
    }
  }
  if (h) miRenderChart(h);

  // AI summary
  if (aiSummaryEl) {
    aiSummaryEl.textContent =
      "We’re loading a short AI snapshot for this company…";
    miFetchAiSummary("equity", data.code || "")
      .then((s) => {
        if (s && s.summary) {
          aiSummaryEl.textContent = s.summary;
        } else {
          aiSummaryEl.textContent =
            "We couldn’t generate a summary right now.";
        }
      })
      .catch((err) => {
        console.error("AI summary error", err);
        aiSummaryEl.textContent =
          "We couldn’t generate a summary right now.";
      });
  }

  // News
  if (newsEl) {
    newsEl.textContent = "Loading headlines for this name…";
    miFetchInstrumentNews(code)
      .then((articles) => {
        if (!articles.length) {
          newsEl.textContent = "No recent headlines found for this code.";
          return;
        }
        const html = articles
          .slice(0, 6)
          .map((a) => {
            const when = a.publishedAt || a.published || "";
            const d = miFormatDate(when) || "";
            const source = a.source || "";
            const title = a.title || "";
            return `
              <div class="mi-ins-news-item">
                <div class="mi-ins-news-item-title">${title}</div>
                <div class="mi-ins-news-item-meta">
                  ${source}${d ? " • " + d : ""}
                </div>
                ${
                  a.url
                    ? `<a href="${a.url}" target="_blank" rel="noopener">Read original →</a>`
                    : ""
                }
              </div>
            `;
          })
          .join("");
        newsEl.innerHTML = `<div class="mi-ins-news-list">${html}</div>`;
      })
      .catch((err) => {
        console.error("Instrument news error", err);
        newsEl.textContent = "Couldn’t load news right now.";
      });
  }

  overlay.style.display = "flex";
  overlay.setAttribute("aria-hidden", "false");
}

function miCloseInstrumentModal() {
  const overlay = document.getElementById("mi-instrument-overlay");
  if (!overlay) return;
  overlay.style.display = "none";
  overlay.setAttribute("aria-hidden", "true");
}

// ---------- Wire up row clicks to open modal ----------

tableBody.addEventListener("click", async (e) => {
  const row = e.target.closest("tr[data-code]");
  if (!row) return;

  const code = row.getAttribute("data-code");
  const type = row.getAttribute("data-type") || "equity";

  try {
    const data = await miFetchInstrumentDetails(type, code);
    miOpenInstrumentModal(data);
  } catch (err) {
    console.error("Failed to load instrument details", err);
    alert("Sorry, we couldn't load that company at the moment.");
  }
});

// Close from X button or clicking backdrop
document.getElementById("mi-ins-close-btn")?.addEventListener("click", miCloseInstrumentModal);

document.getElementById("mi-instrument-overlay")?.addEventListener("click", (e) => {
  if (e.target.id === "mi-instrument-overlay") {
    miCloseInstrumentModal();
  }
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    miCloseInstrumentModal();
  }
});
    </script>

  </body>
</html>
