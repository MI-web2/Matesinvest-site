<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MatesInvest – ASX Screener</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --navy: #002040;
        --cyan: #00bfff;
        --bg: #f5f7fb;
        --card: #ffffff;
        --muted: #64748b;
        --muted-2: #94a3b8;
        --accent: var(--cyan);
        --accent-strong: #0093cc;
        --accent-soft: rgba(0, 191, 255, 0.1);
        --border: #e2e8f0;
        --card-border: #e2e8f0;
        --glass: rgba(255, 255, 255, 0.92);
        --radius: 18px;
        --gap: 1rem;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        max-width: 100%;
        overflow-x: hidden; /* stop whole page from sliding sideways */
        font-family: Inter, system-ui, -apple-system, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #dbeafe 0, #f5f7fb 55%);
        color: var(--navy);
      }

      .page {
        max-width: 1240px;
        margin: 0 auto;
        padding: 1.5rem 1.25rem 2.5rem;
      }

      /* ---------- TOP NAV ---------- */

      .top-nav {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.25rem;
      }

      .nav-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-logo {
        display: flex;
        align-items: center;
        gap: 0.45rem;
        text-decoration: none;
        color: inherit;
      }

      .nav-logo-img {
        height: 32px;
        width: auto;
        display: block;
      }

      .nav-logo-text {
        font-weight: 700;
        letter-spacing: -0.02em;
        font-size: 1rem;
      }

      .nav-right {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .nav-link {
        font-size: 0.85rem;
        text-decoration: none;
        color: var(--navy);
        padding: 0.35rem 0.6rem;
        border-radius: 999px;
        border: 1px solid transparent;
      }

      .nav-link:hover {
        background: rgba(15, 23, 42, 0.02);
      }

      .nav-pill {
        font-size: 0.85rem;
        text-decoration: none;
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        background: var(--accent);
        color: #001220;
        font-weight: 600;
        border: 1px solid transparent;
        box-shadow: 0 7px 16px rgba(15, 23, 42, 0.18);
      }

      .nav-pill:hover {
        background: var(--accent-strong);
      }

      header {
        margin-bottom: 1rem;
      }

      h1 {
        margin: 0 0 0.25rem;
        font-size: 1.8rem;
        letter-spacing: -0.02em;
      }

      .muted {
        color: var(--muted);
        font-size: 0.9rem;
      }

      /* ---------- FILTER CARD ---------- */

      .filters-card {
        background: var(--glass);
        border-radius: var(--radius);
        border: 1px solid var(--card-border);
        box-shadow: 0 10px 26px rgba(15, 23, 42, 0.09);
        padding: 0.55rem 0.75rem 0.65rem;
        margin-bottom: 0.9rem;
      }

      .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.35rem;
      }

      .filters-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.72rem;
        padding: 0.15rem 0.6rem;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--navy);
        font-weight: 500;
      }

      .filters-chip-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: var(--accent-strong);
      }

      .filters-caption {
        font-size: 0.75rem;
        color: var(--muted-2);
      }

      .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 0.6rem;
        align-items: flex-end;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
      }

      .filter-label {
        font-size: 0.72rem;
        color: var(--muted-2);
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      input,
      select {
        font: inherit;
        padding: 0.28rem 0.55rem;
        border-radius: 999px;
        border: 1px solid var(--border);
        outline: none;
        background: #f8fafc;
        font-size: 0.82rem;
        width: 100%;
      }

      input::placeholder {
        color: #cbd5f5;
      }

      input:focus,
      select:focus {
        border-color: var(--accent);
        background: #ffffff;
        box-shadow: 0 0 0 1px rgba(0, 191, 255, 0.08);
      }

      /* ---------- TABLE / LAYOUT ---------- */

      .table-wrapper {
        background: var(--glass);
        border-radius: var(--radius);
        border: 1px solid var(--card-border);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
        overflow: hidden;
      }

      .table-scroll {
        width: 100%;
        max-height: calc(100vh - 260px);
        overflow-x: auto; /* horizontal scroll only inside here */
        overflow-y: auto;
        position: relative;
      }

      table {
        width: 100%;
        min-width: 2200px;
        border-collapse: collapse;
        font-size: 0.84rem;
      }

      thead {
        position: sticky;
        top: 0;
        z-index: 1;
        background: #f1f5f9;
      }

      th,
      td {
        padding: 0.5rem 0.6rem;
        text-align: right;
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
      }

      th:first-child,
      td:first-child {
        text-align: left;
      }

      th:nth-child(2),
      td:nth-child(2),
      th:nth-child(3),
      td:nth-child(3) {
        text-align: left;
      }

      th.sortable {
        cursor: pointer;
        user-select: none;
        font-weight: 500;
        font-size: 0.8rem;
        color: #0b1220;
      }

      th.sortable span {
        margin-left: 0.25rem;
        font-size: 0.65rem;
        opacity: 0.6;
      }

      tbody tr:nth-child(even) {
        background: #f8fafc;
      }

      .pill {
        display: inline-block;
        padding: 0.1rem 0.5rem;
        border-radius: 999px;
        background: #e0f2fe;
        font-size: 0.72rem;
      }

      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.78rem;
        color: var(--muted);
        padding: 0.45rem 0.75rem;
        border-top: 1px solid var(--border);
        background: #f8fafc;
      }

      .status-bar span {
        white-space: nowrap;
      }

      /* ---------- STICKY FIRST COLUMN (CODE) ---------- */

      th.sticky-col {
        position: sticky;
        left: 0;
        z-index: 3;
        background: #f1f5f9;
      }

      td.sticky-col {
        position: sticky;
        left: 0;
        z-index: 2;
        background: #ffffff;
      }

      tbody tr:nth-child(even) td.sticky-col {
        background: #f8fafc;
      }

      /* ---------- MOBILE TWEAKS ---------- */

      @media (max-width: 768px) {
        .page {
          padding-inline: 0.85rem;
        }

        th,
        td {
          padding: 0.45rem 0.4rem;
        }

        h1 {
          font-size: 1.5rem;
        }

        .filters-card {
          padding-inline: 0.55rem;
        }
      }

      /* stack filters fully on smaller phones so they don't overflow */
      @media (max-width: 640px) {
        .filters {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <nav class="top-nav">
        <div class="nav-left">
          <a href="/" class="nav-logo">
            <img
              src="/assets/logo-placeholder.svg"
              alt="MatesInvest"
              class="nav-logo-img"
            />
            <div class="nav-logo-text">MatesInvest</div>
          </a>
        </div>
        <div class="nav-right">
          <a href="/" class="nav-link">Home</a>
          <a href="/mates-summaries.html" class="nav-pill">ASX Daily Brief</a>
        </div>
      </nav>

      <header>
        <h1>ASX Explorer</h1>
        <p class="muted">
          Scan the ASX 200 with plain-English fundamentals. Use filters and
          sorting like a simple spreadsheet, without leaving your browser.
        </p>
      </header>

      <section class="filters-card">
        <div class="filters-header">
          <div class="filters-chip">
            <span class="filters-chip-dot"></span>
            Filters
          </div>
          <div class="filters-caption">
            Search, narrow by sector, and screen for value or income ideas.
          </div>
        </div>

        <div class="filters">
          <div class="filter-group">
            <label class="filter-label" for="searchInput">Search</label>
            <input
              id="searchInput"
              type="text"
              placeholder="Code or name (e.g. BHP, CSL)"
            />
          </div>

          <div class="filter-group">
            <label class="filter-label" for="sectorSelect">Sector</label>
            <select id="sectorSelect">
              <option value="">All sectors</option>
            </select>
          </div>

          <div class="filter-group">
            <label class="filter-label">P/E (min – max)</label>
            <div style="display: flex; gap: 0.25rem">
              <input
                id="peMin"
                type="number"
                step="0.1"
                placeholder="0"
                style="flex: 1"
              />
              <input
                id="peMax"
                type="number"
                step="0.1"
                placeholder="50"
                style="flex: 1"
              />
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label">Mkt cap (A$bn, min – max)</label>
            <div style="display: flex; gap: 0.25rem">
              <input
                id="mcMin"
                type="number"
                step="1"
                placeholder="0"
                style="flex: 1"
              />
              <input
                id="mcMax"
                type="number"
                step="1"
                placeholder="300"
                style="flex: 1"
              />
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label">Div. yield (min %)</label>
            <input
              id="dyMin"
              type="number"
              step="0.1"
              placeholder="0"
            />
          </div>
        </div>
      </section>

      <section class="table-wrapper">
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th class="sortable sticky-col" data-sort="code">
                  Code <span>↕</span>
                </th>
                <th class="sortable" data-sort="name">
                  Name <span>↕</span>
                </th>
                <th class="sortable" data-sort="sector">
                  Sector <span>↕</span>
                </th>

                <th class="sortable" data-sort="price">
                  Price (Y'day) <span>↕</span>
                </th>
                <th class="sortable" data-sort="marketCap">
                  Mkt Cap (A$bn) <span>↕</span>
                </th>
                <th class="sortable" data-sort="pctChange">
                  Daily move % <span>↕</span>
                </th>

                <th class="sortable" data-sort="ebitda">
                  EBITDA (A$bn) <span>↕</span>
                </th>
                <th class="sortable" data-sort="peRatio">
                  P/E <span>↕</span>
                </th>
                <th class="sortable" data-sort="pegRatio">
                  PEG <span>↕</span>
                </th>
                <th class="sortable" data-sort="eps">
                  EPS <span>↕</span>
                </th>
                <th class="sortable" data-sort="bookValue">
                  Book value <span>↕</span>
                </th>
                <th class="sortable" data-sort="dividendPerShare">
                  Div / share <span>↕</span>
                </th>
                <th class="sortable" data-sort="dividendYield">
                  Div yield % <span>↕</span>
                </th>

                <th class="sortable" data-sort="profitMargin">
                  Profit margin % <span>↕</span>
                </th>
                <th class="sortable" data-sort="operatingMargin">
                  Operating margin % <span>↕</span>
                </th>
                <th class="sortable" data-sort="returnOnAssets">
                  ROA % <span>↕</span>
                </th>
                <th class="sortable" data-sort="returnOnEquity">
                  ROE % <span>↕</span>
                </th>

                <th class="sortable" data-sort="revenue">
                  Revenue (A$bn) <span>↕</span>
                </th>
                <th class="sortable" data-sort="revenuePerShare">
                  Revenue / share <span>↕</span>
                </th>
                <th class="sortable" data-sort="grossProfit">
                  Gross profit (A$bn) <span>↕</span>
                </th>
                <th class="sortable" data-sort="dilutedEps">
                  Diluted EPS <span>↕</span>
                </th>
                <th class="sortable" data-sort="quarterlyRevenueGrowthYoy">
                  Q rev growth YoY % <span>↕</span>
                </th>
                <th class="sortable" data-sort="quarterlyEarningsGrowthYoy">
                  Q EPS growth YoY % <span>↕</span>
                </th>

                <th class="sortable" data-sort="trailingPE">
                  Trailing P/E <span>↕</span>
                </th>
                <th class="sortable" data-sort="forwardPE">
                  Forward P/E <span>↕</span>
                </th>
                <th class="sortable" data-sort="priceToSales">
                  Price / sales <span>↕</span>
                </th>
                <th class="sortable" data-sort="priceToBook">
                  Price / book <span>↕</span>
                </th>
                <th class="sortable" data-sort="enterpriseValue">
                  EV (A$bn) <span>↕</span>
                </th>
                <th class="sortable" data-sort="evToRevenue">
                  EV / revenue <span>↕</span>
                </th>
                <th class="sortable" data-sort="evToEbitda">
                  EV / EBITDA <span>↕</span>
                </th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td colspan="30" style="text-align: center; padding: 1rem">
                  Loading companies…
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="status-bar">
          <span id="statusCount">0 companies</span>
          <span id="statusMeta"></span>
        </div>
      </section>
    </div>

    <script>
      const API_URL = "/.netlify/functions/equity-screener";

      const tableBody = document.getElementById("tableBody");
      const searchInput = document.getElementById("searchInput");
      const sectorSelect = document.getElementById("sectorSelect");
      const peMinInput = document.getElementById("peMin");
      const peMaxInput = document.getElementById("peMax");
      const mcMinInput = document.getElementById("mcMin");
      const mcMaxInput = document.getElementById("mcMax");
      const dyMinInput = document.getElementById("dyMin");
      const statusCount = document.getElementById("statusCount");
      const statusMeta = document.getElementById("statusMeta");
      const ths = document.querySelectorAll("th.sortable");

      let rawItems = [];
      let filteredItems = [];
      let sortState = { key: "code", direction: "asc" };

      async function loadData() {
        try {
          const res = await fetch(API_URL);
          if (!res.ok) {
            throw new Error("Network error " + res.status);
          }
          const data = await res.json();
          rawItems = data.items || [];
          statusMeta.textContent = `Last updated: ${
            data.generatedAt
              ? new Date(data.generatedAt).toLocaleString()
              : "n/a"
          }`;

          populateSectorFilter(rawItems);
          applyFilters();
        } catch (e) {
          console.error(e);
          tableBody.innerHTML =
            '<tr><td colspan="30" style="text-align:center;padding:1rem;color:#dc2626">Failed to load data. Refresh to try again.</td></tr>';
        }
      }

      function populateSectorFilter(items) {
        const sectors = Array.from(
          new Set(
            items
              .map((i) => i.sector || "Unknown")
              .filter((s) => s && s.trim() !== "")
          )
        ).sort();

        sectors.forEach((sector) => {
          const opt = document.createElement("option");
          opt.value = sector;
          opt.textContent = sector;
          sectorSelect.appendChild(opt);
        });
      }

      function applyFilters() {
        const q = searchInput.value.trim().toLowerCase();
        const sector = sectorSelect.value;
        const peMin = parseFloat(peMinInput.value);
        const peMax = parseFloat(peMaxInput.value);
        const mcMinBn = parseFloat(mcMinInput.value);
        const mcMaxBn = parseFloat(mcMaxInput.value);
        const dyMin = parseFloat(dyMinInput.value);

        filteredItems = rawItems.filter((item) => {
          if (q) {
            const haystack = `${item.code} ${item.name}`.toLowerCase();
            if (!haystack.includes(q)) return false;
          }

          if (sector && item.sector !== sector) return false;

          const pe = Number(item.peRatio);
          if (!Number.isNaN(pe)) {
            if (!Number.isNaN(peMin) && pe < peMin) return false;
            if (!Number.isNaN(peMax) && pe > peMax) return false;
          }

          const mc = Number(item.marketCap);
          const mcBn = Number.isNaN(mc) ? NaN : mc / 1_000_000_000;
          if (!Number.isNaN(mcBn)) {
            if (!Number.isNaN(mcMinBn) && mcBn < mcMinBn) return false;
            if (!Number.isNaN(mcMaxBn) && mcBn > mcMaxBn) return false;
          }

          const dy = Number(item.dividendYield);
          if (!Number.isNaN(dy) && !Number.isNaN(dyMin)) {
            const dyPct = dy <= 1 && dy >= -1 ? dy * 100 : dy;
            if (dyPct < dyMin) return false;
          }

          return true;
        });

        applySort();
        renderTable();
      }

      function applySort() {
        const { key, direction } = sortState;
        const dir = direction === "asc" ? 1 : -1;

        filteredItems.sort((a, b) => {
          const va = a[key];
          const vb = b[key];

          const na = Number(va);
          const nb = Number(vb);
          const bothNumeric =
            !Number.isNaN(na) && !Number.isNaN(nb) && key !== "name";

          if (bothNumeric) {
            if (na < nb) return -1 * dir;
            if (na > nb) return 1 * dir;
            return 0;
          } else {
            const sa = (va ?? "").toString().toLowerCase();
            const sb = (vb ?? "").toString().toLowerCase();
            if (sa < sb) return -1 * dir;
            if (sa > sb) return 1 * dir;
            return 0;
          }
        });
      }

      function renderTable() {
        if (!filteredItems.length) {
          tableBody.innerHTML =
            '<tr><td colspan="30" style="text-align:center;padding:1rem;">No companies match your filters.</td></tr>';
          statusCount.textContent = "0 companies";
          return;
        }

        const rows = filteredItems
          .map((item) => {
            const mcBn = toBillions(item.marketCap);
            const ebitdaBn = toBillions(item.ebitda);
            const revBn = toBillions(item.revenue);
            const gpBn = toBillions(item.grossProfit);
            const evBn = toBillions(item.enterpriseValue);

            return `
              <tr>
                <td class="sticky-col"><strong>${item.code}</strong></td>
                <td>${item.name || ""}</td>
                <td><span class="pill">${item.sector || "Unknown"}</span></td>

                <td>${formatNumber(item.price)}</td>
                <td>${mcBn}</td>
                <td>${formatPercentRaw(item.pctChange)}</td>

                <td>${ebitdaBn}</td>
                <td>${formatNumber(item.peRatio)}</td>
                <td>${formatNumber(item.pegRatio)}</td>
                <td>${formatNumber(item.eps)}</td>
                <td>${formatNumber(item.bookValue)}</td>
                <td>${formatNumber(item.dividendPerShare)}</td>
                <td>${formatPercentFrac(item.dividendYield)}</td>

                <td>${formatPercentFrac(item.profitMargin)}</td>
                <td>${formatPercentFrac(item.operatingMargin)}</td>
                <td>${formatPercentFrac(item.returnOnAssets)}</td>
                <td>${formatPercentFrac(item.returnOnEquity)}</td>

                <td>${revBn}</td>
                <td>${formatNumber(item.revenuePerShare)}</td>
                <td>${gpBn}</td>
                <td>${formatNumber(item.dilutedEps)}</td>
                <td>${formatPercentFrac(item.quarterlyRevenueGrowthYoy)}</td>
                <td>${formatPercentFrac(item.quarterlyEarningsGrowthYoy)}</td>

                <td>${formatNumber(item.trailingPE)}</td>
                <td>${formatNumber(item.forwardPE)}</td>
                <td>${formatNumber(item.priceToSales)}</td>
                <td>${formatNumber(item.priceToBook)}</td>
                <td>${evBn}</td>
                <td>${formatNumber(item.evToRevenue)}</td>
                <td>${formatNumber(item.evToEbitda)}</td>
              </tr>
            `;
          })
          .join("");

        tableBody.innerHTML = rows;
        statusCount.textContent = `${filteredItems.length} compan${
          filteredItems.length === 1 ? "y" : "ies"
        }`;
      }

      function toBillions(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "-";
        const bn = n / 1_000_000_000;
        return bn.toLocaleString(undefined, {
          maximumFractionDigits: 1,
        });
      }

      function formatNumber(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "-";
        return n.toLocaleString(undefined, {
          maximumFractionDigits: 2,
        });
      }

      // Treat n as 0.045 => 4.5%
      function formatPercentFrac(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "-";
        const pct = Math.abs(n) <= 1 ? n * 100 : n;
        return `${pct.toFixed(2)}%`;
      }

      // Treat n as already in percent points (e.g. 1.23 => 1.23%)
      function formatPercentRaw(value) {
        const n = Number(value);
        if (Number.isNaN(n)) return "-";
        return `${n.toFixed(2)}%`;
      }

      searchInput.addEventListener("input", applyFilters);
      sectorSelect.addEventListener("change", applyFilters);
      peMinInput.addEventListener("input", applyFilters);
      peMaxInput.addEventListener("input", applyFilters);
      mcMinInput.addEventListener("input", applyFilters);
      mcMaxInput.addEventListener("input", applyFilters);
      dyMinInput.addEventListener("input", applyFilters);

      ths.forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.sort;
          if (!key) return;
          if (sortState.key === key) {
            sortState.direction =
              sortState.direction === "asc" ? "desc" : "asc";
          } else {
            sortState.key = key;
            sortState.direction = "asc";
          }
          applySort();
          renderTable();
        });
      });

      loadData();
    </script>
  </body>
</html>
